<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=0.45"/>
  <title>æœ«æ—¥æ§åˆ¶ä¸­å¿ƒ - æ­£å¼ç‰ˆv.1.102 pve-coop update</title>
  <style>
    /* å½ˆçª—ç³»çµ± */
    .modal-overlay {
	  position: fixed;
	  top: -50px;
	  left: -50px;
	  right: -50px;
	  bottom: -100px;
	  background: rgba(0,0,0,0.7);
	  display: none;
	  z-index: 1000;
	  pointer-events: auto;
	  overscroll-behavior: none;
	  transform: translateZ(0);
	}

	.modal-content {
	  background: #2d2d2d;
	  padding: 2rem;
	  border-radius: 12px;
	  width: min(90vw, 500px);
	  max-height: 80vh;
	  overflow-y: auto;
	  overflow-x: visible; /* å…è¨±æ°´å¹³é¡¯ç¤º */
	  overscroll-behavior-y: contain; /* ä»…å¯¹å‚ç›´æ–¹å‘é˜»æ­¢æ»šåŠ¨ä¼ æ’­ */
	  overscroll-behavior-x: auto;    /* æ°´å¹³æ–¹å‘å…è¨±é»˜è®¤å¤„ç† */
	  -webkit-overflow-scrolling: touch; /* å¯ç”¨å¼¹æ€§æ»šåŠ¨ */
	  position: fixed !important; /* æ”¹ç”¨fixedå®šä½ */
	  left: 50% !important;
	  top: 20vh;
	}
	.modal-overlay.nested {
	  overflow: hidden;
	  position: absolute !important;      /* ä»¥ç›¸å°æ–¼çˆ¶å®¹å™¨å®šä½ */
	  top: 0 !important;                  /* ä¸Šç·£è²¼é½Šå®¹å™¨é ‚éƒ¨ */
	  left: 0;
	  width: 100%;
	  height: 100%;
	  background: rgba(0,0,0,0.7);
	  display: none;
	  z-index: 1000;
	  scrollbar-width: none;
	}
	.modal-overlay.nested::-webkit-scrollbar {
	  display: none;           /* Chrome, Safari, Opera éš±è—æ»¾å‹•æ¢ */
	}

	/* åµŒå¥—å½ˆçª—å…§éƒ¨ï¼šä¸Šç·£è²¼é½Šã€æ°´å¹³å±…ä¸­ï¼ˆä¸åšå‚ç›´å±…ä¸­ï¼‰ */
	.modal-overlay.nested .modal-content {
	  position: absolute !important;
	  top: 0 !important;                 /* ä¸Šç·£ç·Šè²¼åŸºåœ°å»ºè¨­å®¹å™¨ä¸Šç·£ */
	  left: 50% !important;              /* æ°´å¹³å±…ä¸­ */
	  transform: translateX(-50%) !important;
	  background: #2d2d2d !important;
	  padding: 2rem;
	  border-radius: 12px;
	  width: min(90vw, 500px);
	  max-height: 80vh;
	  box-sizing: border-box;
	}

	#upgradeModal .modal-content {
	  position: absolute;
	  left: 50%;
	  transform: translate(-50%, 0); /* ä½¿å…¶å±…ä¸­ */
	}
	#resultModal .modal-content {
	  position: absolute;
	  left: 50%;
	  transform: translate(-50%, 0);
	}
	#resultModal .modal-content,
	#resultModal .modal-content p {
		text-align: center;
	}
	#buildModal .modal-content {
	  background: #2d2d2d;
	  padding: 2rem;
	  border-radius: 12px;
	  width: 450px;
	  height: 500px;
	  overflow-y: hidden;
	  position: fixed;
	  left: 50%;
	  top: 70%; 
	  transform: translate(-50%, -60%);
	}
	/* å»ºé€ å½ˆçª—ä¸­é¸é …å…§å®¹å€è®“å…¶å…§éƒ¨æ»¾å‹• */
	#buildModal .build-options {
	  max-height: 400px; /* æ ¹æ“šå¯¦éš›éœ€æ±‚èª¿æ•´ */
	  overflow-y: auto;
	}




	/* æ”¶è—å½ˆçª—ç¹¼æ‰¿ç¾æœ‰ modal çš„æ¨£å¼ï¼Œè‹¥éœ€è¦èˆ‡è¡Œå‹•æ—¥èªŒå€é‡åˆï¼Œå¯åŠ å…¥å¦‚ä¸‹è¨­å®š */
	#favoritesModal .modal-content,
	#productionCollectionModal .modal-content {
	  width: 60%;         /* æˆ–ç›´æ¥èˆ‡è¡Œå‹•æ—¥èªŒå€åŒå¯¬ */
	  max-width: 400px;    /* æ ¹æ“šè¡Œå‹•æ—¥èªŒæ‰€åœ¨å€åŸŸèª¿æ•´ */
	  overflow-x: visible;
	}
	html {
	  touch-action: manipulation;
	}
	html, body {
	  overscroll-behavior: none;
	}
	
	.log {
	  overflow-y: scroll;
	  overflow-anchor: none;
	  scrollbar-gutter: stable;
	}

    :root {
	  --btr-frame-height: 120px;
	  --btr-frame-width: calc(2000 * var(--btr-frame-height) / 500);  /* 1000 * 120/500 = 240px */
	  --btr-sprite-total-width: calc(4 * var(--btr-frame-width));
	
	  --exploration-height: 120px;
	  /* æ— ç¼èƒŒæ™¯å›¾åŸå§‹æ¯”ä¾‹ä¸º3:1ï¼Œtile å®½åº¦æ ¹æ®çª—å£é«˜åº¦è‡ªåŠ¨è®¡ç®— */
	  --tile-width: calc(var(--exploration-height) * 3);
	  --zombie-size: 90px;
	  /* ç²¾éˆåœ–ç¸½å¯¬åº¦ = å¹€æ•¸ Ã— å–®å¸§å¯¬åº¦ï¼Œç”±æ–¼å…± 4 å¹€ */
	  --zombie-sprite-total-width: calc(4 * var(--zombie-size));
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --border-color: #4a4a4a;
      --hover-bg: #333333;
       /* åŸºç¡€çº§åˆ« - æå‡äº®åº¦å’Œé¥±å’Œåº¦ */
	  --junk: #ab4826;     /* äº®æ£•è‰² (åŸè‰²äº®åº¦â†‘35%) */
	  --old: #d68569;      /* æµ…ç°æ£• (åŸè‰²äº®åº¦â†‘30%) */
	  --damaged: #d69e69;  /* æµ…ç±³ç° (åŸè‰²äº®åº¦â†‘25%) */
	  
	  /* æ™®é€šçº§åˆ« - å¢å¼ºå¯¹æ¯”åº¦ */
	  --common: #BDBDBD;   /* äº®ç°è‰² (åŸè‰²äº®åº¦â†‘30%) */
	  --decent: #66BB6A;   /* é²œç»¿è‰² (åŸè‰²äº®åº¦â†‘15%) */
	  --sealed: #26A69A;   /* äº®é’ç»¿ (åŸè‰²äº®åº¦â†‘20%) */
	  
	  /* ç²¾è‰¯çº§åˆ« - ä¿æŒä¸“ä¸šæ„Ÿä½†æäº® */
	  --selected: #42A5F5; /* äº®è“è‰² (åŸè‰²äº®åº¦â†‘15%) */
	  --tested: #5C6BC0;   /* æµ…ç¾¤é’ (åŸè‰²äº®åº¦â†‘10%) */
	  
	  /* é«˜çº§åˆ« - å¢å¼ºå‘å…‰æ•ˆæœ */
	  --rare: #AB47BC;     /* äº®ç´«è‰² (åŸè‰²äº®åº¦â†‘10%) */
	  --epic: #EC407A;     /* å“çº¢è‰² (åŸè‰²äº®åº¦â†‘10%) */
	  
	  /* é¡¶çº§çº§åˆ« - ä¿æŒé†’ç›®ç‰¹æ€§ */
	  --legendary: #FF9800; /* äº®æ©™è‰² (åŸè‰²äº®åº¦â†‘5%) */
	  --divine: #FFEE58;    /* è§å…‰é»„ (åŸè‰²äº®åº¦â†‘15%) */
      --danger: #d32f2f;
      --warning: #fbc02d;
      --efficiency-green: #66BB6A;
      --production-blue: #42A5F5;
    }
	.log-entry.junk {
	  color: var(--junk) !important;
	}
	.log-entry.zombie-event {
	  background-color: rgba(16, 102, 21, 0.2); /* åŠé€æ˜æ©™ç´…è‰²èƒŒæ™¯ */
	  color: #2f9936; /* ç¶ è‰² */
	  border-left: 4px solid #106615; /* ç”¨ä¸€æ¢é†’ç›®çš„é‚Šæ¡†åšå¼·èª¿ */
	  font-weight: bold;
	  white-space: normal;
	}
	/* æ”¶è—é ç°½ä¸­ï¼Œé‡å°ä»¥ junk æ¨™è¨˜çš„ç‰©å“ï¼Œå¼·åˆ¶é¡¯ç¤ºæ­£ç¢ºé¡è‰² */
	#collectionContent tr.junk,
	#collectionContent tr.junk td {
		color: var(--junk) !important;
	}
	#collectionContent,
	#collectionContent td,
	#collectionContent th {
		font-weight: bold;
	}
	/* ä½¿ç”Ÿç”¢æ”¶è—é é¢çš„æ‰€æœ‰æ–‡å­—åŠ ç²— */
	#productionCollectionContent,
	#productionCollectionContent td,
	#productionCollectionContent th {
		font-weight: bold;
	}



    /* åŸºç¤å¸ƒå±€ */
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Microsoft YaHei', system-ui, sans-serif;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
      min-height: 100vh;
	  overscroll-behavior-y: contain;
	  -webkit-font-smoothing: antialiased;
	  -moz-osx-font-smoothing: grayscale;
	  text-rendering: optimizeLegibility;
    }
	@media (max-width: 480px) {
	  body {
		font-size: 16px;
		line-height: 1.5;
	  }
	}
	
    .container {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 25px;
      max-width: 1400px;
      margin: 0 auto;
    }
    /* è³‡æºå„€è¡¨ç›¤ */
	.main-grid-container {
	  display: grid;
	  grid-template-columns: 1fr 1fr;         /* å…©åˆ—ç­‰åˆ† */
	  grid-template-rows: auto auto auto;      /* ä¸‰è¡Œï¼Œç¬¬äºŒè¡Œçš„é«˜åº¦è‡ªå‹•èª¿æ•´ï¼Œç¬¬ä¸€è¡Œèˆ‡ç¬¬äºŒè¡Œä¿æŒç­‰é«˜ */
	  gap: 20px;
	  margin-top: 20px;
	}
	.grid-container {
	  display: grid;
	  grid-template-columns: 1fr 1fr;
	  grid-auto-rows: minmax(300px, auto);
	  gap: 20px;
	  margin-top: 20px;
	}
	.grid-item {
	  background: #262626;
	  padding: 1rem;
	  border-radius: 12px;
	  border: 1px solid var(--border-color);
	  box-sizing: border-box;
	}
	/* ç¬¬ä¸€è¡Œèˆ‡ç¬¬äºŒè¡Œçš„ grid-item  */
	#resourceDashboard,
	#zombieCommand,
	#explorationLogContainer,
	#productionLogContainer {
	  position: relative;
	  /* å›ºå®šé«˜åº¦ï¼ˆæ ¹æ“šéœ€æ±‚èª¿æ•´æ•¸å€¼ï¼‰ï¼Œä¾‹å¦‚ 350px */
	  height: 600px;
	  overflow: hidden;  /* è‹¥å…§å®¹è¶…å‡ºï¼Œå¯è‡ªè¡ŒåŠ å…¥ overflow è¨­å®š */
	}
	/* åŸºåœ°å»ºè¨­å®¹å™¨ï¼Œè·¨å…©åˆ— */
	.building-system-container {
	  position: relative; /* ä¿ç•™ç›¸å°å®šä½ï¼Œä½†ä¸è¦å¼·åˆ¶è¦†è“‹ */
	  grid-column: 1 / span 2;
	  height: 600px;      /* ä¿æŒåŸä¾†é«˜åº¦ */
	  overflow: auto;
	}
    .dashboard {
      background: #262626;
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      height: fit-content;
    }
    .resource-group {
      margin-bottom: 1rem;
      background: #2d2d2d;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .resource-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      cursor: pointer;
      transition: background 0.3s ease;
      background: #373737;
    }
    .resource-header:hover {
      background: var(--hover-bg);
    }
    .resource-details {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .resource-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 15px;
      font-size: 0.9em;
      background: linear-gradient(to right, #2d2d2d 50%, #373737);
      border-top: 1px solid var(--border-color);
    }
	
	.reset-cycle-container {
	  display: flex;
	  justify-content: space-between; /* å·¦å³åˆ†æ•£ */
	  align-items: center;            /* å‚ç›´å±…ä¸­ */
	  font-size: 1em;                 /* èˆ‡é£Ÿç‰©ã€æ­¦å™¨å¡ä¸€è‡´çš„å­—é«”å¤§å° */
	  padding: 1px;                  /* å¯ä¾éœ€è¦èª¿æ•´å…§é–“è· */
	}

	.reset-cycle-card {
	  margin-top: 15px;
	  background: #262626;
	  border-radius: 12px;
	  border: 1px solid var(--border-color);
	  height: 30px;
	  padding: 10px;
	}

	/* æ–°å¢ï¼šæˆå°±ç³»çµ±é¸é …å¡æ¨£å¼ï¼ŒåŒ reset-cycle-card çš„æ¨£å¼ */
	.achievement-card {
	  margin-top: 15px;
	  background: #262626;
	  border-radius: 12px;
	  border: 1px solid var(--border-color);
	  height: 80px; /* èª¿æ•´é«˜åº¦ï¼Œå¯æ ¹æ“šéœ€è¦èª¿æ•´ */
	  padding: 10px;
	}

	.achievement-header {
	  display: flex;
	  justify-content: space-between;
	  align-items: center;
	  margin-bottom: 5px;
	  font-weight: bold;
	  font-size: 1em;
	}

	/* 3x2 æˆå°±ç¶²æ ¼ */
	.achievement-grid {
	  display: grid;
	  grid-template-columns: repeat(3, 1fr);
	  grid-gap: 5px;
	}

	/* æ¯å€‹æˆå°±å–®å…ƒï¼šä¸å¸¶é‚Šæ¡†ï¼ŒåŠ ç²—æ–‡å­— */
	.achievement-cell {
	  /* ç§»é™¤é‚Šæ¡† */
	  border: none;
	  background: transparent;
	  font-weight: bold;
	  text-align: center;
	  /* ç¨€æœ‰åº¦é¡ï¼šcommon, uncommon, rare, epic, legendary, divineï¼›è«‹ç¢ºä¿é€™äº›é¡è¨­å®šå°æ‡‰é¡è‰²å’Œå‹•ç•« */
	}

	/* ç¨±è™Ÿåº«æ¨¡æ…‹è¦–çª—ï¼Œå…©æ¬„è¡¨æ ¼ */
	#titlesModal .modal-content {
	  width: 60%;
	  max-width: 400px;
	  overflow-x: visible;
	  position: fixed;
	  left: 50%;
	  transform: translateX(-50%);
	  max-height: 600px;
	  background: #2d2d2d;
	  border-radius: 12px;
	  padding: 2rem;
	}
	#titlesModal .modal-content .collection-table th:first-child,
	#titlesModal .modal-content .collection-table td:first-child {
	  width: 40%;
	}


	/* æ”¶è—å½ˆçª— */
	.collection-table {
	  width: 100%;
	  border-collapse: collapse;
	  font-family: inherit; /* ä½¿ç”¨å…¨å±€å­—é«” */
	}

	.collection-table th,
	.collection-table td {
	  border: 1px solid var(--border-color); /* ä½¿ç”¨ä½ å®šç¾©çš„é‚Šæ¡†é¡è‰² */
	  padding: 5px;
	}

	/* å° th é€²è¡Œå±…ä¸­å±¬æ€§ */
	.collection-table th,
	.collection-table td{
	  text-align: center;
	  vertical-align: middle;
	  font-weight: bold;
	}



		
    /* éƒ¨é–€ç®¡ç†ç•Œé¢ */
    .operations-panel {
      display: flex;
      flex-direction: column;
	  gap: 10px;          /* å¡ç‰‡é–“è· */
	  height: 100%;       /* æˆ–æŒ‡å®šå›ºå®šé«˜åº¦ï¼Œå¦‚350px */
      box-sizing: border-box;
    }
    .department-card {
	  flex: 1;
      background: #262626;
      padding: 0.5rem;
	  border: 1px solid #4a4a4a !important;
      border-radius: 5px;
	  height:80px;
	  margin-bottom: 0.3rem;
    }
	.dept-header h3 {
	  font-size: 1em;        /* èª¿å°æ¨™é¡Œå­—é«” */
	  margin: 0;
	  line-height: 1.2;
	}
    .department {
      background: #2d2d2d;
      border-left: 4px solid;
      border-radius: 8px;
      margin: 1rem 0;
      padding: 1rem;
      transition: transform 0.2s;
    }
    .department:hover {
      transform: translateX(5px);
    }
    #exploration { border-color: var(--danger); }
    #farming { border-color: var(--uncommon); }
    #recycling { border-color: var(--warning); }
    #research { border-color: var(--rare); }
    .zombie-control {
      display: flex;
	  justify-content: space-evenly;
      align-items: center;
      gap: 10px;
	  padding: 0 10px;
      margin-top: 12px;
    }
    .zombie-btn {
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 50%;
      background: #404040;
      color: white;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s;
    }
    .zombie-btn:hover {
      background: #4a4a4a;
      transform: scale(1.1);
    }
	.large-btn {
	  font-size: 1.2em;
	  padding: 0.6em 1em;
	}

    /* å»ºç¯‰ç³»çµ± */
    .building-system {
      background: #262626;
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }
    .construction-grid {
      display: grid;
      grid-template-columns: repeat(3, 120px);
      gap: 15px;
      justify-content: center;
    }
    .tile {
      width: 120px;
      height: 120px;
      background: #2d2d2d;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      position: relative;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tile:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .upgradable {
      border-color: var(--uncommon);
      animation: pulse-border 2s infinite;
    }
    .building-icon {
      font-size: 2.5rem;
      margin-bottom: 8px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }
    .building-info { text-align: center; }
    .building-name {
      font-weight: 500;
      font-size: 0.9em;
    }
    .building-level {
      font-size: 0.8em;
      color: var(--common);
    }
    .upgrade-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--uncommon);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      box-shadow: 0 0 10px var(--uncommon);
    }
	 .build-box {
	  height: 150px;
	  display: flex;
	  flex-direction: column;
	  border: 1px solid var(--border-color);  /* å§‹çµ‚é¡¯ç¤ºé‚Šæ¡† */
	  background-color: #2d2d2d;
	  border-radius: 8px;
	  padding: 10px;
	  margin: 10px 0;
	  margin-bottom: 10px;
	  transition: background 0.2s;
	  cursor: pointer;
	}

	/* æ‡¸åœæ™‚åƒ…æ”¹è®ŠèƒŒæ™¯è‰²ï¼Œä½†é‚Šæ¡†ä¿æŒä¸è®Š */
	.build-box:hover {
	  background-color: #3a3a3a;
	}

	.build-top {
	  display: flex;
	  align-items: center;
	  gap: 10px;
	  margin-bottom: 5px;
	}

	.build-icon {
	  font-size: 2rem;
	  width: 50px;
	  text-align: center;
	}

	.build-name {
	  font-size: 1.1rem;
	  font-weight: bold;
	}


	.cost-item {
	  display: inline-block;
	  margin-right: 8px;
	}

	.build-box.empty {
	  /* ä¿æŒèˆ‡å»ºé€ å¡ç‰‡ç›¸åŒçš„é«˜åº¦ã€é‚Šæ¡†é‚è¼¯ */
	  height: 150px;        /* èˆ‡å…¶ä»– build-box å›ºå®šé«˜åº¦ä¸€è‡´ */
	  border: 1px solid var(--border-color);
	  background-color: transparent; /* ä¹Ÿå¯ä»¥è¨­ç‚º #2d2d2d çœ‹çœ‹æ•ˆæœ */
	  border-radius: 8px;
	  margin-bottom: 10px;
	  padding: 10px;
	  cursor: default;      /* ä½¿å…¶æ²’æœ‰é»æ“Šæ•ˆæœ */
	  /* å…§å®¹ç½®ç©ºï¼Œä¸é¡¯ç¤ºæ–‡å­— */
	}
	
	/* ä¸ŠåŠéƒ¨åˆ†å®¹å™¨ï¼Œä½”æ»¿å‰©é¤˜ç©ºé–“ä¸¦å‚ç›´å±…ä¸­ */
	.build-top-container {
	  flex: 1;
	  display: flex;
	  align-items: center;  /* å‚ç›´å±…ä¸­ */
	  justify-content: center;
	}

	/* ä¸‹æ–¹è³‡æºä¿¡æ¯éƒ¨åˆ†ï¼Œä¸è®Š */
	.build-resources {
	  text-align: center;
	  margin-top: 5px;
	}

	/* å·¦å³å®¹å™¨ï¼Œå…§éƒ¨åˆ†æ¬„ */
	.build-row {
	  display: flex;
	  width: 100%;
	}

	/* å·¦é‚Šï¼šå»ºç¯‰åœ–ç¤ºèˆ‡åç¨±ï¼Œ50% å¯¬åº¦ï¼Œå·¦å°é½Šï¼Œå³å´æœ‰åˆ†ç•Œç·š */
	.build-left {
	  flex: 1;
	  text-align: left;
	  border-right: 1px solid var(--border-color);
	  padding-right: 10px;
	}

	/* å³é‚Šï¼šåŠ æˆæè¿°ï¼Œ50% å¯¬åº¦ï¼Œå·¦å°é½Š */
	.build-right {
	  flex: 1;
	  text-align: left;
	  padding-left: 10px;
	}
	.building-info {
	  display: flex;
	  flex-direction: column;
	  justify-content: center; /* å‚ç›´å±…ä¸­ */
	  text-align: center;
	}




	
    /* äº‹ä»¶æ—¥èªŒç³»çµ± */
    .log {
      height: 320px;
      background: #1f1f1f;
      border-radius: 8px;
      padding: 15px;
      margin-top: 1.5rem;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border-color) transparent;
    }
    .log-entry {
      padding: 10px;
      margin: 8px 0;
      background: #2d2d2d;
      border-left: 3px solid;
      border-radius: 4px;
      animation: fadeIn 0.4s ease;
      display: flex;
      align-items: baseline;
      gap: 8px;
      font-size: 0.9em;
	  font-weight: bold;
    }
    .log-entry::before {
      content: "â€¢";
      color: currentColor;
      font-weight: bold;
    }
	#favoritesModal .modal-content {
	  /* ç¢ºä¿ä½¿ç”¨å›ºå®šå®šä½ */
	  position: fixed !important;
	  left: 50% !important;
	  /* ç‚ºäº†è®“æ•´å€‹å½ˆçª—ä»¥è‡ªèº«ä¸­å¿ƒä½œæ°´å¹³å®šä½ */
	  transform: translateX(-50%) !important;
	  max-height: 600px; 
	}
	#productionCollectionModal .modal-content {
	  position: fixed !important;
	  left: 50% !important;
	  transform: translateX(-50%) !important;
	  max-height: 600px;
	}
	#productionLog .log-entry {
	  white-space: normal;      /* å…è®¸è‡ªåŠ¨æ¢è¡Œ */
	  word-break: normal;     /* ä¿æŒä¸­æ–‡ä¸æ‹†æ–­ï¼›æ³¨æ„ï¼šå¯¹äºè‹±æ–‡ï¼Œkeep-all é€šå¸¸ä¸ä¼šåœ¨å•è¯å†…éƒ¨æ‹†åˆ† */
	  overflow-wrap: break-word; /* å¦‚æœå•è¯å¤ªé•¿ï¼Œå…è®¸åœ¨å•è¯è¾¹ç•Œæ–­å¼€ */
	}

	
    /* ç¨€æœ‰åº¦é¡è‰² */
    /* åŸºç¡€çº§åˆ« */
	.junk { color: var(--junk) !important; }
	.old { color: var(--old); }
	.damaged { color: var(--damaged); }

	/* æ™®é€šçº§åˆ« */
	.common { color: var(--common); }
	.decent { color: var(--decent); }
	.sealed { 
	  color: var(--sealed);
	  animation: pulse 1.5s infinite;
	}

	/* ç²¾è‰¯çº§åˆ« */
	.selected { 
	  color: var(--selected);
	  text-shadow: 0 0 5px rgba(30, 136, 229, 0.5);
	}
	.tested {
	  color: var(--tested);
	  animation: float 2s ease-in-out infinite;
	}

	/* é«˜çº§åˆ« */
	.rare {
	  color: var(--rare);
	  animation: rare-glow 2s infinite alternate;
	}
	.epic {
	  color: var(--epic);
	  text-shadow: 0 0 8px rgba(142, 36, 170, 0.7);
	  animation: epic-pulse 1.5s infinite;
	}

	/* é¡¶çº§çº§åˆ« */
	.legendary {
	  color: var(--legendary);
	  animation: 
		legendary-glow 2s infinite alternate,
		shake 0.5s infinite alternate;
	}
	.divine {
	  color: var(--divine);
	  text-shadow: 
		0 0 10px rgba(255, 214, 0, 0.8),
		0 0 20px rgba(255, 214, 0, 0.4);
	  animation: 
		divine-shine 3s infinite alternate;
	}
	.upgrade-indicator.upgrade-available {
	  color: green;
	}


	/* åŠ¨ç”»å®šä¹‰ */
	@keyframes pulse {
	  0%, 100% { opacity: 0.9; }
	  50% { opacity: 1; transform: scale(1.02); }
	}
	@keyframes float {
	  0%, 100% { transform: translateY(0); }
	  50% { transform: translateY(-3px); }
	}
	@keyframes rare-glow {
	  from { text-shadow: 0 0 5px rgba(142, 36, 170, 0.3); }
	  to { text-shadow: 0 0 15px rgba(142, 36, 170, 0.7); }
	}
	@keyframes epic-pulse {
	  0%, 100% { transform: scale(1); }
	  50% { transform: scale(1.05); }
	}
	@keyframes legendary-glow {
	  from { text-shadow: 0 0 5px rgba(245, 124, 0, 0.5); }
	  to { text-shadow: 0 0 20px rgba(245, 124, 0, 0.9); }
	}
	@keyframes shake {
	  0% { transform: translateX(-1px); }
	  100% { transform: translateX(1px); }
	}
	@keyframes divine-shine {
	  from { 
		filter: brightness(1);
		text-shadow: 0 0 10px rgba(255, 214, 0, 0.8);
	  }
	  to { 
		filter: brightness(1.2);
		text-shadow: 0 0 25px rgba(255, 214, 0, 1);
	  }
	}
    }
    
  
    @keyframes pulse-border {
      0% { border-color: var(--uncommon); }
      50% { border-color: rgba(76,175,80,0.5); }
      100% { border-color: var(--uncommon); }
    }
    @keyframes resource-glow {
      0% { box-shadow: 0 0 5px currentColor; }
      50% { box-shadow: 0 0 15px currentColor; }
      100% { box-shadow: 0 0 5px currentColor; }
    }
    @media (max-width: 768px) {
      .container { grid-template-columns: 1fr; padding: 10px; }
      .construction-grid { grid-template-columns: repeat(3, 1fr); }
      .tile { width: 100%; height: 100px; }
      .zombie-control { flex-wrap: wrap; }
	  .modal-content {
		width: min(41vw, 400px);
		margin: 0 auto;
		touch-action: auto;        /* å…è¨±åŸç”Ÿæ»¾å‹•è™•ç† */
		overscroll-behavior: contain;  /* æŠ‘åˆ¶æ»¾å‹•é€£é–æ•ˆæ‡‰ */
      }
	}
    @media (max-width: 480px) {
      .building-system { padding: 1rem; }
      .construction-grid { grid-template-columns: repeat(2, 1fr); }
    }
    .efficiency-badge {
      color: var(--efficiency-green);
      font-size: 0.8em;
      padding: 2px 8px;
      border-radius: 4px;
      background: rgba(76,175,80,0.1);
    }
    .production-rate {
      color: var(--production-blue);
      font-size: 0.9em;
      margin-top: 5px;
    }
    .pending-zombies {
      color: var(--warning);
      animation: resource-glow 1.5s infinite;
    }
	
	/* å‹•ç•«çª—å£çš„å…¬å…±æ¨£å¼ï¼Œå¯¬åº¦èˆ‡æ—¥èªŒä¸€æ¨£ï¼Œé«˜åº¦ç´„ 120pxï¼Œå¯æ ¹æ“šéœ€è¦èª¿æ•´ */
	.anim-window {
	  width: 100%;
	  height: 120px;
	  position: relative;
	  overflow: hidden;
	  background-color: #000; /* å¯ä½œç‚ºé è¨­èƒŒæ™¯ */
	}

	/* ç”Ÿç”¢æ—¥èªŒå‹•ç•«çª—å£ä¸‰æ¬„ä½ˆå±€ */
	#productionAnim .prod-col {
	  float: left;
	  width: 33.33%;
	  height: 100%;
	  position: relative;
	  overflow: hidden;
	  /* å¯è¨­å®šèƒŒæ™¯æˆ–é‚Šæ¡†ä¾¿æ–¼å€åˆ† */
	}

	/* æ¸…é™¤æµ®å‹• */
	#productionAnim::after {
	  content: "";
	  display: block;
	  clear: both;
	}

	/* æ¢ç´¢å‹•ç•«èƒŒæ™¯æ»¾å‹•æ•ˆæœ */
	#explorationAnim {
	  width: 100%;
	  height: var(--exploration-height);
	  position: relative; /* ä½œä¸ºç»å¯¹å®šä½å­å…ƒç´ çš„å‚ç…§ */
	  background-image: url('images/location_day_1.png');
	  background-repeat: repeat-x;
	  /* è®¾ç½®èƒŒæ™¯å•å…ƒå°ºå¯¸ä¸º 432pt Ã— 144pt */
	  background-size: var(--tile-width) var(--exploration-height);
	  background-position: 0 0;
	  /* ä½¿ç”¨æ˜ç¡®çš„åƒç´ ï¼ˆptï¼‰å€¼ï¼Œè®©èƒŒæ™¯ä» 0 æ»šåŠ¨åˆ° 432ptï¼Œå³ä¸€ä¸ªå®Œæ•´å¹³é“ºå•å…ƒ */
	  animation: scrollBgRight 30s linear infinite;
	}


	@keyframes scrollBgRight {
	  from {
		background-position: 0 0;
	  }
	  to {
		background-position: 432pt 0;
	  }
	}

	/* 1.1 åƒµå°¸å¯»æ‰¾åŠ¨ç”» */
	.zombie-search {
	  position: absolute;
	  left: 50%;
	  top: 50%;
	  transform: translate(-50%, -50%);
	  width: var(--zombie-size);
	  height: var(--zombie-size);
	  background-image: url('images/zombie_search_sprite.png');
	  /* å°†èƒŒæ™¯è®¾ä¸ºå…¨ç²¾çµå›¾ */
	  background-size: var(--zombie-sprite-total-width) var(--zombie-size);
	  animation: zombieSearchAnim 3s steps(4) infinite;
	}
	@keyframes zombieSearchAnim {
	  from { background-position: 0 0; }
	  to { background-position: calc(-1 * var(--zombie-sprite-total-width)) 0; }
	}


	/* 1.3 åƒµå°¸å…¥åœºåŠ¨ç”»ï¼ˆåƒµå°¸å¢åŠ äº‹ä»¶è§¦å‘ï¼‰ */
	.zombie-entry {
      position: absolute;
      top: 50%;
      right: -200px; /* åˆå§‹ä½ç½®åœ¨å±å¹•å¤–æ›´å³ä¾§ */
      width: var(--zombie-size);
      height: var(--zombie-size);
      background-image: url('images/zombie_entry_sprite.png');
      background-size: var(--zombie-sprite-total-width) var(--zombie-size);
      background-repeat: no-repeat;
      transform: translateY(-50%);
      animation: 
        zombieEntryMove 4s linear forwards,
        zombieEntryFrames 0.8s steps(4) infinite;
      z-index: 10;
      opacity: 1;
      transition: opacity 0.5s; /* å¹³æ»‘æ·¡å‡ºæ•ˆæœ */
    }
    
    @keyframes zombieEntryMove {
      0% { 
        right: -200px; /* èµ·å§‹ä½ç½® */
        opacity: 1;
      }
      95% { 
        right: calc(100% + 100px); /* ç»“æŸä½ç½® */
        opacity: 1;
      }
      100% {
        right: calc(100% + 100px);
        opacity: 0; /* åŠ¨ç”»ç»“æŸæ—¶æ·¡å‡º */
      }
    }
    
    @keyframes zombieEntryFrames {
      0% { background-position: 0 0; }
      100% { background-position: calc(-1 * var(--zombie-sprite-total-width)) 0; }
    }

    /* é˜²æ­¢å…¶ä»–æ ·å¼å½±å“ */
    .zombie-entry * {
      animation: none !important;
    }

    
    @keyframes zombieEntryFrames {
      0% { background-position: 0 0; }
      100% { background-position: calc(-1 * var(--zombie-sprite-total-width)) 0; }
    }

    /* é˜²æ­¢å…¶ä»–æ ·å¼å½±å“ */
    .zombie-entry * {
      animation: none !important;
    }

    
	

	/* 1.4 åƒµå°¸å€’åœ°åŠ¨ç”»ï¼ˆåƒµå°¸å‡å°‘äº‹ä»¶è§¦å‘ï¼‰ */
	.zombie-lying {
	  position: absolute;
	  top: 65%; /* ä½ç½®ç•¥ä½äºæœç´¢åŠ¨ç”» */
	  left: -100px;
	  width: var(--zombie-size);
	  height: var(--zombie-size);
	  background-image: url('images/zombie_lying_sprite.png');
	  background-size: 100% 100%;
	  transform: translateY(-50%);
	  z-index: 12; /* ç¡®ä¿ä½äºæœç´¢åŠ¨ç”» */
	  opacity: 0;
	  
	  
	  /* åˆ†ç¦»ç§»åŠ¨å’Œæ·¡å…¥æ·¡å‡ºåŠ¨ç”» */
	  animation: 
		zombieLyingAnim 20s linear forwards,
		zombieLyingFade 20s linear forwards;
	}

	@keyframes zombieLyingAnim {
	  0% { 
		left: -100px;
	  }
	  100% { 
		left: calc(100% + 100px);
	  }
	}

	@keyframes zombieLyingFade {
	  0% { 
		opacity: 0;
	  }
	  5% { 
		opacity: 1;
	  }
	  95% { 
		opacity: 1;
	  }
	  100% {
		opacity: 0;
	  }
	}
	/* å¤–å±¤åŒ…è£¹å®¹å™¨ï¼Œè² è²¬ç§»å‹•å‹•ç•«ï¼Œå®šä½åƒç…§ #explorationAnim */
	.btr-wrapper {
	  position: absolute;
	  bottom: 0;
	  /* ä½¿ç”¨ç™¾åˆ†æ¯”ç›¸å°æ–¼ #explorationAnim å®½åº¦é€²è¡Œç§»å‹• */
	  animation: btrMove 10s ease-in-out forwards;
	  z-index: 11;
	}

	/* å…§å±¤ BTR ç²¾éˆåœ–å…ƒç´ ï¼Œå°ºå¯¸å›ºå®šç‚ºå–®å¹€å¤§å° */
	.btr-animation {
	  width: var(--btr-frame-width);      /* 240px */
	  height: var(--btr-frame-height);      /* 120px */
	  background-image: url('images/btr_sprite.png');
	  background-size: var(--btr-sprite-total-width) var(--btr-frame-height); /* 960px x 120px */
	  background-repeat: no-repeat;   /* ä¸é‡è¤‡ */
	  /* ç²¾éˆåœ–å¹€å‹•ç•«ï¼Œæ¯1ç§’å¾ªç’°ä¸€æ¬¡ï¼Œå…±4å¸§ */
	  animation: btrFrame 0.5s steps(4) infinite;
	}

	/* ç§»å‹•å‹•ç•«ï¼šä½¿ç”¨ç™¾åˆ†æ¯”ï¼Œç›¸å°æ–¼çˆ¶å®¹å™¨å¯¬åº¦ */
	@keyframes btrMove {
	  0%   { transform: translateX(100%); }   /* é–‹å§‹å®Œå…¨åœ¨å³å´å¤– */
	  20%  { transform: translateX(50%); }    /* 2ç§’å…§ç§»å‹•åˆ°çˆ¶å®¹å™¨å³å´ä½ç½®75% */
	  60%  { transform: translateX(50%); }    /* ä¿æŒä½ç½® */
	  100% { transform: translateX(100%); }   /* 10ç§’å…§é€€å›å³å´å¤– */
	}

	/* ç²¾éˆåœ–å¹€å‹•ç•«ï¼Œå¾0ç§»å‹•åˆ° -960px */
	@keyframes btrFrame {
	  from { background-position: 0 0; }
	  to { background-position: -1920px 0; }
	}

	.log-entry.btr-active {
	  background-color: yellow;
	  color: red;
	  font-weight: bold;
	  border: 2px solid red;
	  padding: 5px;
	  text-shadow: 0 0 5px orange;
	}
	
	/* T-80 Animation CSS */
	.t80-animation {
	  /* ä»¥èˆ‡ BTR ç›¸åŒé«˜åº¦ï¼Œè¨ˆç®—å¯¬åº¦ï¼š480px */
	  width: var(--btr-frame-width);       /* 480px */
	  height: var(--btr-frame-height);                /* 120px */
	  background-image: url('images/t-80_sprite.png');
	  /* è¨­ç½® Tâ€‘80 ç²¾éˆåœ–ç¸½å¯¬åº¦ï¼š4 å¸§ Ã— 480px = 1920px */
	  background-size: var(--btr-sprite-total-width) var(--btr-frame-height);  /* 1920px x 120px */
	  background-repeat: no-repeat;
	}
	@keyframes t80Idle {
	  0% { background-position: 0 0; }          
	  50% { background-position: -1440px 0; }   /* ç¬¬4 å¹€ï¼š-3Ã—480 = -1440px */
	  100% { background-position: 0 0; }
	}
	.t80-idle {
	  animation: t80Idle 1s steps(2, end) infinite;
	}

	/* Full (é–‹ç‚®) ç‹€æ…‹ï¼šå®Œæ•´æ’­æ”¾ 4 å¹€ä¸€æ¬¡ */
	@keyframes t80Full {
	  from { background-position: 0 0; }
	  to { background-position: -1920px 0; }
	}
	.t80-full {
	  animation: t80Full 1s steps(4, end) 1;
	}

	
	/* ä»¥ä¸‹ç‚ºç¤ºä¾‹ï¼Œæ ¹æ“šéœ€è¦æ“´å±• productionã€exploration å‹•ç•« CSS */

	/* ============================================================================
	   ç”Ÿç”¢æ—¥èªŒå‹•ç•«çª—å£ - èƒŒæ™¯éƒ¨åˆ† (å›ºå®šåœ–ç‰‡)
	============================================================================ */

	#productionAnim {
	  width: 100%;
	  height: 120px;             /* æ•´ä¸ªç”Ÿäº§åŒºåŸŸé«˜åº¦ */
	  position: relative;
	  display: flex;
	  /* ä¸å†ç»Ÿä¸€è®¾ç½®èƒŒæ™¯å›¾ç‰‡ï¼Œå› ä¸ºæ­¤åŒºåŸŸä¸‹å„æ èƒŒæ™¯åˆ†å¼€è®¾ç½® */
	  background: none;
	}

	/* æ¯ä¸€æ ï¼ˆprod-colï¼‰ä¿æŒç°æœ‰å¸ƒå±€ */
	#productionAnim .prod-col {
	  float: left;
	  flex: 1;
	  height: 100%;
	  position: relative;
	  overflow: hidden;
	}

	/* æ¸…é™¤æµ®åŠ¨ */
	#productionAnim::after {
	  content: "";
	  display: block;
	  clear: both;
	}

	/* è®¾ç½®å·¦æ èƒŒæ™¯ */
	#prodAnimLeft {
	  background-size: cover;        /* å¡«æ»¡æ•´ä¸ªåŒºåŸŸ */
	  background-repeat: no-repeat;
	  background-position: center center;
	}

	/* è®¾ç½®ä¸­æ èƒŒæ™¯ */
	#prodAnimMid {
	  background-size: cover;
	  background-repeat: no-repeat;
	  background-position: center center;
	}

	/* è®¾ç½®å³æ èƒŒæ™¯ */
	#prodAnimRight {
	  background-size: cover;
	  background-repeat: no-repeat;
	  background-position: center center;
	}

	/* ç”Ÿäº§åŒºåŸŸä¸‰æ å¸ƒå±€ */
	#productionAnim .prod-col {
	  float: left;
	  width: 33.33%;
	  height: 100%;
	  position: relative;
	  overflow: hidden;
	}
	#productionAnim::after {
	  content: "";
	  display: block;
	  clear: both;
	}

	/* 2.1 å·¦æ ï¼šåƒµå°¸è€•ç”°åŠ¨ç”» */
	.prod-zombie-plow {
	  position: absolute;
	  bottom: 10%;
	  left: 50%;
	  transform: translateX(-50%);
	  width: var(--zombie-size);
	  height: var(--zombie-size);
	  background-image: url('images/zombie_plow_sprite.png');
	  background-size: calc(4 * var(--zombie-size)) var(--zombie-size);
	  animation: prodPlowAnim 2s steps(4) infinite;
	}
	@keyframes prodPlowAnim {
	  from { background-position: 0 0; }
	  to { background-position: calc(-1 * 4 * var(--zombie-size)) 0; }
	}

	/* 2.2 ä¸­æ ï¼šåƒµå°¸ç„Šæ¥åŠ¨ç”» */
	.prod-zombie-weld {
	  position: absolute;
	  bottom: 10%;
	  left: 50%;
	  transform: translateX(-50%);
	  width: var(--zombie-size);
	  height: var(--zombie-size);
	  background-image: url('images/zombie_weld_sprite.png');
	  background-size: calc(4 * var(--zombie-size)) var(--zombie-size);
	  animation: prodWeldAnim 2s steps(4) infinite;
	}
	@keyframes prodWeldAnim {
	  from { background-position: 0 0; }
	  to { background-position: calc(-1 * 4 * var(--zombie-size)) 0; }
	}

	/* 2.3 å³æ ï¼šåƒµå°¸å®éªŒå®¤åŠ¨ç”» */
	.prod-zombie-lab {
	  position: absolute;
	  bottom: 10%;
	  left: 50%;
	  transform: translateX(-50%);
	  width: var(--zombie-size);
	  height: var(--zombie-size);
	  background-image: url('images/zombie_lab_sprite.png');
	  background-size: calc(4 * var(--zombie-size)) var(--zombie-size);
	  animation: prodLabAnim 2s steps(4) infinite;
	}
	@keyframes prodLabAnim {
	  from { background-position: 0 0; }
	  to { background-position: calc(-1 * 4 * var(--zombie-size)) 0; }
	}

	/* ============================== */
	/* å…¶ä»–è¾…åŠ©æ ·å¼ï¼ˆä¾‹å¦‚èŠ±å±è¿‡æ¸¡æ•ˆæœ .glitch åŠåŠ¨ç”»å…¬å…±æ ·å¼ï¼‰ */
	/* ============================== */

	.transition-overlay {
	  position: absolute;
	  top: 0;
	  left: 0;
	  width: 100%;
	  height: 100%;
	  background-size: cover;
	  z-index: 15;
	  animation: fadeInOut 0.3s linear;
	}

	@keyframes fadeInOut {
	  0% { opacity: 0; }
	  50% { opacity: 1; }
	  100% { opacity: 0; }
	}
	.accident-overlay {
	  position: absolute;
	  top: 0;
	  left: 0;
	  width: 100%;
	  height: 100%;
	  background-size: cover;
	  z-index: 10;
	}
	.achievement-header {
	  display: inline-flex;
	  align-items: center;
	  gap: 10px;
	}
	/* å°ç¨±è™Ÿåº«èˆ‡æ”¶è—è¨˜éŒ„å½ˆçª—å…§çš„ .modal-content å–æ¶ˆæ‰€æœ‰å‹•ç•«æ•ˆæœ */
	/* è¦†å¯«ç¨±è™Ÿåº«ã€æ”¶è—è¨˜éŒ„ã€ä»¥åŠç”Ÿç”¢è¨˜éŒ„å½ˆçª—å…§çš„æ‰€æœ‰å…ƒç´ å‹•ç•«èˆ‡éæ¸¡ */
	#titlesModal *,
	#favoritesModal *,
	#productionCollectionModal * {
	  animation: none !important;
	  transition: none !important;
	}
	/* ===== æ–°å¢ï¼šå°æˆ°æ¨¡å¼ CSS ===== */
	.battle-overlay {
	  position: fixed;
	  top: 0;
	  left: 0;
	  right: 0;
	  bottom: 0;
	  background: rgba(0,0,0,0.8);
	  z-index: 2000;
	  display: none; /* åˆå§‹éš±è— */
	}

	.battle-container {
	  position: fixed;
	  top: 0%; 
	  left: 50%;
	  transform: translateX(-50%);
	  width: 100vw;
	  height: 300px;
	  z-index: 2100;
	}

	.battle-header {
	  padding: 15px;
	  background: #333;
	  display: flex;
	  flex-direction: column; /* ä¿®æ”¹ä¸ºçºµå‘æ’åˆ— */
	  justify-content: center;
	  align-items: stretch; /* ä½¿å­å…ƒç´ æ‹‰ä¼¸å¡«å……å®½åº¦ */
	  gap: 10px;
	  height: auto; /* é«˜åº¦è‡ªé€‚åº”å†…å®¹ */
	}

	.battle-header input[type="text"] {
	  padding: 15px;
	  font-size: 1rem;
	}

	.battle-header button {
	  padding: 15px 30px;
	  font-size: 1rem;
	  cursor: pointer;
	}

	.battle-content {
	  height: 180px;
	  width: 100vw;
	  display: flex;
	  margin: 0px;
	}

	.battle-half {
	  width: 50vw;
	  height: 180px;
	  overflow: hidden;
	  position: relative;
	  background: #000; /* é è¨­é»‘å± */
	}

	.battle-half.left .battle-inner {
	  transform: scaleX(-1); /* å·¦é‚Šå…§å®¹æ°´å¹³ç¿»è½‰ */
	}

	.battle-inner {
	  width: 100%;
	  height: 100%;
	  position: relative;
	}

	/* æˆ°é¬¥æ—¥èªŒ */
	/* æ–°å¢ï¼šæˆ°é¬¥æ—¥èªŒæ¨™é¡Œ */
	.battle-log-title {
	  margin: 0;
	  padding: 5px 10px;
	  background: #444;
	  border-bottom: 1px solid #666;
	  font-family: 'Microsoft YaHei', sans-serif;
	  font-size: 1.1rem;
	}

	.battle-log {
	  position: fixed;
	  top: 300px;      /* æˆ°é¬¥æ—¥èªŒé ‚éƒ¨ç·Šè²¼ battle-container åº•éƒ¨ */
	  left: 0;
	  width: 100%;
	  height: calc(100vh - 220px);  /* å æ»¿å‰©é¤˜é«˜åº¦ */
	  background: #1f1f1f;         /* èˆ‡æ¢ç´¢æ—¥èªŒä¸€è‡´ */
	  color: #fff;
	  overflow-y: auto;
	  z-index: 2200;
	  padding: 5px 10px;
	  box-sizing: border-box;
	  border-top: 1px solid #4a4a4a;
	}
	.log-entry.battle-self-entry {
	  color: white;
	  font-weight: bold;
	  margin: 4px 0;
	}

	.log-entry.battle-enemy-entry {
	  color: #fca572;
	  font-weight: bold;
	  margin: 4px 0;
	}
	
	.log-entry.battle-system-entry {
	  color: #fae678;
	  font-weight: bold;
	  margin: 4px 0;
	}
	#battleSelfAnim .zombie-search, #battleEnemyAnim .enemy-zombie-search  {
	  top: 60%
	}
	#battleExitBtn {
	  background-color: #5e1c0d; /* åº•è‰²ç‚ºç´…è‰² */
	  color: white;          /* æ–‡å­—é¡è‰²ç‚ºç™½è‰² */
	  border: none;          /* ç„¡é‚Šæ¡†ï¼ˆå¯æ ¹æ“šéœ€è¦èª¿æ•´ï¼‰ */
	  font-size: 20px;       /* èª¿æ•´å­—é«”å¤§å° */
	  cursor: pointer;
	}
	.resource-header {
	  display: grid;
	  grid-template-columns: 20% 30% 50%; /* ç¬¬ä¸€æ¬„å›ºå®š30%ï¼Œç¬¬äºŒæ¬„40%ï¼Œç¬¬ä¸‰æ¬„30%ï¼Œç¸½å’Œç‚º100% */
	  align-items: center;
	  width: 100%;
	  padding: 10px 0;  /* æ ¹æ“šéœ€è¦èª¿æ•´å…§é‚Šè· */
	}

	.resource-icon {
	  grid-column: 1;
	  text-align: center;  /* é å³å°é½Šï¼Œè®“åœ–ç¤ºé è¿‘é‚Šç•Œ */
	}

	.resource-name {
	  grid-column: 2;
	  text-align: center;
	}

	.resource-count {
	  grid-column: 3;
	  text-align: right;
	  padding-right: 20px;
	}

	 #wardrobeModal {
      position: absolute;
      top: 30vh;
      left: 50%;
      transform: translateX(-50%);
      width: 90vw;
      max-width: 600px;
      background: #2d2d2d;
      border-radius: 12px;
      padding: 1rem;
      box-sizing: border-box;
    }

	#wardrobeHeader {
	  display: flex;
	  align-items: center;
	  font-weight: bold;
	}
	#wardrobeCloseBtn {
	  margin-left: auto;
	  background-color: #5e1c0d; /* åº•è‰²ç‚ºç´…è‰² */
	  color: white;          /* æ–‡å­—é¡è‰²ç‚ºç™½è‰² */
	  border: none;          /* ç„¡é‚Šæ¡†ï¼ˆå¯æ ¹æ“šéœ€è¦èª¿æ•´ï¼‰ */
	  font-size: 20px;       /* èª¿æ•´å­—é«”å¤§å° */
	  cursor: pointer;
	}
        /* åˆ†é éƒ¨åˆ† */
    #wardrobeTabs {
      display: flex;
      justify-content: space-around;
      margin-bottom: 1em;
      border-bottom: 1px solid #aaa;
    }
    #wardrobeTabs button {
      flex: 1;
      background: transparent;
      border: none;
      padding: 0.5em;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
    }
    #wardrobeTabs button.active {
      border-bottom: 2px solid limegreen;
    }
    /* å…§å®¹å€ï¼ˆå¡ç‰‡å€ï¼‰ï¼Œè¶…å‡ºé«˜åº¦å‰‡è‡ªå‹•å‡ºç¾æ»¾å‹•æ¢ */
    #wardrobeContent {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      max-height: 400px; /* å¯æ ¹æ“šéœ€è¦èª¿æ•´ */
      overflow-y: auto;
    }
    .wardrobe-card {
      width: 150px;
      height: 150px;
      background-size: cover;
      background-position: center;
      border: 2px solid transparent;
      cursor: pointer;
      transition: border 0.3s ease;
      position: relative;
    }
    .wardrobe-card.locked {
      filter: grayscale(100%);
    }
    .wardrobe-card.selected {
      border: 2px solid limegreen;
    }
    .wardrobe-card .label {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0, 128, 0, 0.7);
      color: white;
      text-align: center;
      font-size: 1em;
      display: none;
    }
    .wardrobe-card.selected .label {
      display: block;
    }
	/* å¯¹æˆ˜æ¨¡å¼å¯¼èˆªè¡Œæ ·å¼ */
	.battle-nav-row {
	  display: flex;
	  justify-content: center;
	  align-items: center;
	  gap: 10px; /* å…ƒç´ é—´è· */
	  width: 100%;
	}

	.battle-nav-row:first-child input[type="text"] {
	  flex: 1;
	  max-width: 40%; /* é™åˆ¶æœ€å¤§å®½åº¦ */
	  padding: 8px 12px;
	  font-size: 1rem;
	}

	.battle-nav-row:first-child button {
	  padding: 8px 15px;
	  margin-left: auto; /* æ¨åˆ°å³ä¾§ */
	}

	/* ç¬¬äºŒè¡Œæ ·å¼ - ä¸‰ä¸ªä¸‹æ‹‰èœå•å‡åŒ€åˆ†å¸ƒ */
	.battle-nav-row:last-child select {
	  flex: 1;
	  padding: 8px;
	  max-width: 30%; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œç¡®ä¿ä¸‰ä¸ªé€‰æ‹©å™¨å¤§å°ä¸€è‡´ */
	}

	.battle-nav-row:last-child button {
	  padding: 8px 20px;
	  min-width: 100px; /* ç»™å¼€å§‹æŒ‰é’®ä¸€ä¸ªæœ€å°å®½åº¦ */
	}

	/* è°ƒæ•´ä¸‹æ‹‰èœå•æ ·å¼ */
	#battleModeSelect, #bossList, #pveModeSelect {
	  padding: 8px;
	  border-radius: 4px;
	  border: 1px solid #444;
	  background: #222;
	  color: #fff;
	  height: 36px; /* å›ºå®šé«˜åº¦ç¡®ä¿ä¸€è‡´æ€§ */
	}


	
  </style>
</head>
<!-- Firebase App (æ ¸å¿ƒ) SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<!-- Firebase Realtime Database SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<!-- Firebase Authentication SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>


<body>
  <div class="main-grid-container">
   <!-- ä¸Šæ’ï¼šå·¦ - æœ«æ—¥æŒ‡æ®ä¸­å¿ƒï¼›å³ - å°¸ç¾¤æŒ‡æ®ç³»çµ± -->
   <div class="grid-item" id="resourceDashboard">
    <!-- å·¦å´è³‡æºé¢æ¿ -->
      <h2 class="section-title">
		ğŸšï¸ æœ«æ—¥æŒ‡æ®ä¸­å¿ƒ
		<button id="resetProgressBtn" class="modal-btn" style="margin-left: 10px;">é‡ç½®å­˜æª”</button>
	  </h2>
      <div class="resource-panel">
        <div class="resource-group">
          <div class="resource-header" onclick="toggleResource('food')">
            <span class="resource-icon">ğŸ–</span>
            <span class="resource-name">é£Ÿç‰©</span>
            <span class="resource-count" id="foodCount">0</span>
          </div>
          <div class="resource-details" id="foodDetails"></div>
        </div>
        <div class="resource-group">
          <div class="resource-header" onclick="toggleResource('materials')">
            <span class="resource-icon">ğŸ”©</span>
            <span class="resource-name">ææ–™</span>
            <span class="resource-count" id="materialsCount">0</span>
          </div>
          <div class="resource-details" id="materialsDetails"></div>
        </div>
        <div class="resource-group">
          <div class="resource-header" onclick="toggleResource('weapons')">
            <span class="resource-icon">ğŸ”«</span>
            <span class="resource-name">æ­¦å™¨</span>
            <span class="resource-count" id="weaponsCount">0</span>
          </div>
          <div class="resource-details" id="weaponsDetails"></div>
        </div>
        <div class="resource-group">
          <div class="resource-header" onclick="toggleResource('tech')">
            <span class="resource-icon">ğŸ’¾</span>
            <span class="resource-name">ç§‘æŠ€</span>
            <span class="resource-count" id="techCount">0</span>
          </div>
          <div class="resource-details" id="techDetails"></div>
        </div>
      </div>
	  
	  <div class="dashboard reset-cycle-card" id="resetCycleCard">
		<div class="reset-cycle-container">
			<span class="reset-cycle-label" style="font-weight: bold;">è³‡æºçˆ†ç ´</span>
			<span class="reset-cycle-count" id="resetCycleDisplay">å¾ªç’°æ¬¡æ•¸ï¼š0</span>
		  </div>
		</div>
	  <div class="dashboard achievement-card" id="achievementCard">
		  <div class="achievement-header">
			<span class="achievement-title">æˆå°±ç³»çµ±</span>
			<button id="titleLibraryBtn" class="modal-btn">ç¨±è™Ÿåº«</button>
		  </div>
		  <!-- 3*2 æ ¼å±€ï¼Œç”¨ä¸€å€‹ç¶²æ ¼é¡¯ç¤ºæœ€æ–°å…­å€‹æˆå°± -->
		  <div class="achievement-grid" id="achievementGrid">
			<!-- ç¨‹å¼æœƒåœ¨æ­¤å¡«å……æœ€æ–°çš„ 6 å€‹æˆå°± -->
		  </div>
		</div>
	  <!-- ç¨±è™Ÿåº«æ¨¡æ…‹è¦–çª— -->
		<div id="titlesModal" class="modal-overlay">
		  <div class="modal-content">
			<h3 id="titleLibraryTitle" style="text-align: center; font-weight: bold;">ç¨±è™Ÿåº«</h3>
			<div class="titles-content" id="titlesContent">
			  <!-- å…¨éƒ¨ç¨±è™Ÿï¼ŒæŒ‰ç¨€æœ‰åº¦æ’åºé¡¯ç¤º -->
			</div>
		  </div>
		</div>
	</div>	
	   <div class="grid-item" id="zombieCommand">
		<!-- å°¸ç¾¤æŒ‡æ®ç³»çµ±ï¼šæ“ä½œæ§åˆ¶å€åŸŸ -->
		<div class="operations-panel">
		  <h2 class="section-title">ğŸ§Ÿ å°¸ç¾¤æŒ‡æ®ç³»çµ±</h2>
		  <div class="production-grid">
			<div class="department-card" id="exploration">
			  <div class="dept-header">
				<h3>ğŸ” åµå¯Ÿè»åœ˜</h3>
				<div class="efficiency-badge" id="exploreEfficiency">æ•ˆç‡: 100%</div>
			  </div>
			  <div class="zombie-control">
				<button class="zombie-btn" onclick="adjustZombies('exploration', -1)">âˆ’</button>
				<span class="zombie-count" id="explorationCount">0</span>
				<button class="zombie-btn" onclick="adjustZombies('exploration', 1)">+</button>
			  </div>
			</div>
			  <div class="department-card" id="farming">
				<div class="dept-header">
				  <h3>ğŸŒ¾ ç¨®æ¤éƒ¨é–€</h3>
				  <div class="efficiency-badge" id="farmEfficiency">+0%</div>
				</div>
				<div class="zombie-control">
				  <button class="zombie-btn" onclick="adjustZombies('farming', -1)">âˆ’</button>
				  <span class="zombie-count" id="farmingCount">0</span>
				  <button class="zombie-btn" onclick="adjustZombies('farming', 1)">+</button>
				</div>
			  </div>
			  <div class="department-card" id="recycling">
				<div class="dept-header">
				  <h3>â™» å›æ”¶å·¥å» </h3>
				  <div class="efficiency-badge" id="recycleEfficiency">+0%</div>
				</div>
				<div class="zombie-control">
				  <button class="zombie-btn" onclick="adjustZombies('recycling', -1)">âˆ’</button>
				  <span class="zombie-count" id="recyclingCount">0</span>
				  <button class="zombie-btn" onclick="adjustZombies('recycling', 1)">+</button>
				</div>
			  </div>
			  <div class="department-card" id="research">
				<div class="dept-header">
				  <h3>ğŸ”¬ ç§‘ç ”ä¸­å¿ƒ</h3>
				  <div class="efficiency-badge" id="researchEfficiency">+0%</div>
				</div>
				<div class="zombie-control">
				  <button class="zombie-btn" onclick="adjustZombies('research', -1)">âˆ’</button>
				  <span class="zombie-count" id="researchCount">0</span>
				  <button class="zombie-btn" onclick="adjustZombies('research', 1)">+</button>
				</div>
			  </div>
			</div>
		 </div>
	  </div>
      <!-- ä¸‹æ’ï¼šå·¦ - è¡Œå‹•æ—¥èªŒï¼›å³ - ç”Ÿç”¢æ—¥èªŒ -->
	  <div class="grid-item" id="explorationLogContainer">
		<h3 class="log-title">
		  ğŸ“œ è¡Œå‹•æ—¥èªŒ
		 <!-- åœ¨æ¨™é¡Œå³å´åŠ å…¥æ”¶è—æŒ‰éˆ• -->
		 <button id="favoritesBtn">æ”¶è—</button>
		 <button id="encounterBattleBtn">é­é‡æˆ°</button>
		</h3>
		<div class="log-header">
          <span class="zombie-status">å¾…åˆ†é…åƒµå°¸: <span id="pendingZombies">0</span></span>
          <span class="total-zombies">ç¸½æ•¸: <span id="totalZombies">10</span></span>
        </div>
		<div class="log" id="explorationLog">
		  <div class="log-entry uncommon">âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆ</div>
		</div>
		<div id="explorationAnim" class="anim-window"></div>
	 </div>
	  <div class="grid-item" id="productionLogContainer">
	   <h3 class="log-title">ğŸ›  ç”Ÿç”¢æ—¥èªŒ
	   <button id="productionFavoritesBtn" class="modal-btn" onclick="showProductionCollection()">æ”¶è—</button>
	   </h3>
	   	<div id="timerContainer" class="timer-container">
          <span class="timer-label">ç”¨æ™‚</span>
          <span id="timerValue">00:00:00</span>
        </div>
	   <div class="log" id="productionLog">
		 <!-- ç”Ÿç”¢äº‹ä»¶å°‡åœ¨æ­¤é¡¯ç¤º -->
	   </div>
	     <div id="productionAnim" class="anim-window">
	    <div class="prod-col" id="prodAnimLeft"></div>
	    <div class="prod-col" id="prodAnimMid"></div>
	    <div class="prod-col" id="prodAnimRight"></div>
	  </div>
	 </div>
    <div class="grid-item building-system-container" id="buildingSystem">
        <h2 class="section-title">ğŸ—ï¸ åŸºåœ°å»ºè¨­
		<button id="wardrobeBtn">è¡£æ«ƒ</button>
		</h2>
        <div class="construction-grid" id="buildingGrid">
          <!-- å‹•æ…‹ç”Ÿæˆçš„å»ºç¯‰æ ¼å­ -->
        </div>
	  
	  <!-- è«‹å°‡ä¸‹é¢é€™å››å€‹å½ˆçª—çš„ HTML ç§»å…¥ id="buildingSystem" çš„å®¹å™¨å…§ -->
		<!-- çµæœæç¤ºå½ˆçª—ï¼šåŠ ä¸Š nested é¡ -->
		<div id="resultModal" class="modal-overlay nested">
		  <div class="modal-content">
			<p id="resultMessage"></p>
		  </div>
		</div>

		<!-- å‡ç´šå½ˆçª—ï¼šåŠ ä¸Š nested é¡ -->
		<div id="upgradeModal" class="modal-overlay nested">
		  <div class="modal-content">
			<h3 id="upgradeTitle"></h3>
			<div id="upgradeInfo" style="white-space: pre-wrap; margin-bottom: 1em;"></div>
			<div class="button-row" style="display: flex; justify-content: space-between;">
			  <button id="confirmUpgradeBtn" class="modal-btn large-btn" onclick="confirmUpgrade()" style="flex: 1; margin-right: 5px;">å‡ç´š</button>
			  <button id="demolishBtn" class="modal-btn large-btn" onclick="confirmBuildingRemoval(currentUpgradeIndex)" style="flex: 1; margin-left: 5px;">æ‹†é™¤</button>
			</div>
		  </div>
		</div>

		<!-- å»ºç¯‰äº’å‹•å½ˆçª—ï¼šåŠ ä¸Š nested é¡ -->
		<div id="interactionModal" class="modal-overlay nested">
		  <div class="modal-content">
			<h3 id="interactionTitle">å»ºç¯‰ç®¡ç†</h3>
			<div id="interactionContent"></div>
		  </div>
		</div>

	  
    </div>
  </div>

  <!-- æ”¶è—å½ˆçª— -->
   <div id="favoritesModal" class="modal-overlay">
	 <div class="modal-content">
	 <h3 style="display: flex; justify-content: space-between; align-items: center;">æ”¶è—è¨˜éŒ„
	 <!-- æ–°å¢æ”¶è—å®Œæˆåº¦ -->
       <div id="collectionCompletion" style="display: inline-block; margin-left: 10px; font-weight: bold;"></div>
	 </h3>
	 <div class="collection-content" id="collectionContent">
		  <!-- æ”¶è—å…§å®¹å°‡åœ¨æ­¤å¡«å…… -->
	 </div>
	</div>
   </div>
   <div id="productionCollectionModal" class="modal-overlay">
    <div class="modal-content">
		<h3>ç”Ÿç”¢è¨˜éŒ„</h3>
		<div id="productionCollectionContent"></div>
	  </div>
	</div>
	<div id="buildModal" class="modal-overlay">
	  <div class="modal-content">
		<div id="buildHeaderStatus" style="margin-bottom: 1rem; font-size: 1.1em; color: var(--text-color);">
		  <div style="display: flex; flex-wrap: wrap;">
			<div style="width: 50%; text-align: left;">
			  <span class="resource-label">ğŸ–é£Ÿç‰©: </span>
			  <span id="foodCountDisplay">0</span>
			</div>
			<div style="width: 50%; text-align: left;">
			  <span class="resource-label">ğŸ”©ææ–™: </span>
			  <span id="materialsCountDisplay">0</span>
			</div>
			<div style="width: 50%; text-align: left;">
			  <span class="resource-label">ğŸ”«æ­¦å™¨: </span>
			  <span id="weaponsCountDisplay">0</span>
			</div>
			<div style="width: 50%; text-align: left;">
			  <span class="resource-label">ğŸ’¾ç§‘æŠ€: </span>
			  <span id="techCountDisplay">0</span>
			</div>
		  </div>
		</div>
		<div class="build-options" id="buildOptions"></div>
	  </div>
	</div>
	
	<div id="battleOverlay" class="battle-overlay">
	  <div class="battle-container">
		<!-- å¯¼èˆªåŒºï¼šåˆ†ä¸¤è¡Œï¼Œç»“æ„æ¸…æ™° -->
		<div class="battle-header">
		  <!-- ç¬¬ä¸€è¡Œï¼šæš±ç¨±ã€PINå’Œé€€å‡º -->
		  <div class="battle-nav-row">
			<input type="text" id="battleNickname" placeholder="è¼¸å…¥æš±ç¨±">
			<input type="text" id="battlePin" placeholder="è¼¸å…¥PINç¢¼">
			<button id="battleExitBtn">X</button>
		  </div>
		  
		  <!-- ç¬¬äºŒè¡Œï¼šæ¨¡å¼ã€BOSSã€å•æŒ‘/åˆä½œé€‰æ‹© -->
		  <div class="battle-nav-row">
			<select id="battleModeSelect">
			  <option value="pvp">PVPæ¨¡å¼</option>
			  <option value="pve">PVEæ¨¡å¼</option>
			</select>
			<select id="bossList" style="display:none">
			  <option value="zombieKing">BTR-80Aã€Œå®ˆè­·è€…ã€</option>
			  
			</select>
			<select id="pveModeSelect" style="display:none">
			  <option value="solo">å–®æŒ‘æ¨¡å¼</option>
			  <option value="coop">åˆä½œæ¨¡å¼</option>
			</select>
			<button id="battleStartBtn">é–‹å§‹</button>
		  </div>
		</div>
		
		<!-- å‹•ç•«å€ -->
		<div class="battle-content">
		  <div class="battle-half left">
			<div class="battle-inner" id="battleSelfAnim">
			  <!-- å·±æ–¹å‹•ç•«å…§å®¹ï¼Œå…¶åƒµå°¸ç²¾éˆåœ–å°‡å–è‡ªå…¨å±€é…ç½® -->
			</div>
		  </div>
		  <div class="battle-half right">
			<div class="battle-inner" id="battleEnemyAnim">
			  <!-- æ•µæ–¹å‹•ç•«ä¿æŒåŸæœ‰é‚è¼¯ -->
			</div>
		  </div>
		</div>
	  </div>
	  <!-- æ—¥èªŒå€ -->
	  <div class="battle-log" id="battleLog">
		<h3 class="battle-log-title">æˆ°é¬¥æ—¥èªŒ</h3>
		<div class="log" id="battleLogContent"></div>
	  </div>
	</div>
	  <!-- ===== æ–°å¢ï¼š è¡£æ«ƒæ¨¡å¼ï¼ˆWardrobe Modeï¼‰å½ˆçª— ===== -->
	   <div id="wardrobeOverlay" class="modal-overlay">
		<div id="wardrobeModal">
		  <div id="wardrobeHeader">
			<span>è¡£æ«ƒ</span>
			<button id="wardrobeCloseBtn">X</button>
		  </div>
		  <div id="wardrobeTabs">
			<button id="tabZombie" class="active">åƒµå°¸</button>
			<button id="tabArmor">è£ç”²</button>
		  </div>
		  <div id="wardrobeContent">
			<!-- å¡ç‰‡å…§å®¹æœƒç”± JS å‹•æ…‹ç”Ÿæˆ -->
		  </div>
		</div>
	  </div>



  
  <script>
  
    // æ›¿æ›ä»¥ä¸‹é…ç½®ç‚ºä½ è‡ªå·±çš„ Firebase é…ç½®
	var firebaseConfig = {
	  apiKey: "AIzaSyDKXgDOWZnTF9cBTCCOc6kgMSnJLZplFiY",
	  authDomain: "san1tater-gz2.firebaseapp.com",
	  databaseURL: "https://san1tater-gz2-default-rtdb.asia-southeast1.firebasedatabase.app",
	  projectId: "san1tater-gz2",
	  storageBucket: "san1tater-gz2.firebasestorage.app",
	  messagingSenderId: "554205994483",
	  appId: "1:554205994483:web:1389f62227f078f00ac686"
	};

	// åˆå§‹åŒ– Firebase
	firebase.initializeApp(firebaseConfig);
	var currentUid = firebase.auth().currentUser ? firebase.auth().currentUser.uid : "userPlaceholder";	
	var enemyTotalZombies = 0;
    var enemyAllocations = { exploration: 0, farming: 0, recycling: 0, research: 0 };


	let achievements = [];  // å„²å­˜ç¨±è™Ÿå°è±¡ï¼Œæ¯å€‹ç¨±è™ŸåŒ…å« category, title, rarity, unlockedTime ç­‰å±¬æ€§
	// ã€æ–°å¢ã€‘åœ¨å…¨å±€ç¯„åœå®šç¾©ç¨€æœ‰åº¦æ˜ å°„ï¼Œç¢ºä¿æ‰€æœ‰å‡½æ•¸å‡å¯è¨ªå•
	var rarityMapping = {
	  junk: "[ç ´çˆ›çš„]",
	  old: "[é™³èˆŠçš„]",
	  damaged: "[ç ´æçš„]",
	  common: "[æ­£å¸¸çš„]",
	  decent: "[çœ‹èµ·ä¾†ä¸éŒ¯çš„]",
	  sealed: "[æœªé–‹å°çš„]",
	  selected: "[ç²¾æŒ‘ç´°é¸çš„]",
	  tested: "[æ­·ç¶“è€ƒé©—çš„]",
	  rare: "[ç¨€æœ‰çš„]",
	  epic: "[å²è©©çš„]",
	  legendary: "[å‚³å¥‡çš„]",
	  divine: "[ç¥è–çš„]"
	};

    let ITEM_DATA = {
	  food: {
		names: ['ç½é ­é£Ÿå“', 'å£“ç¸®é¤…ä¹¾', 'è»ç”¨å£ç³§', 'è„«æ°´è”¬èœ', 'è‚‰é¡ç½é ­', 'æ°´æœä¹¾', 'èƒ½é‡æ£’', 'å³é£Ÿéº¥ç‰‡', 'å¥¶ç²‰', 'é€Ÿé£Ÿæ¹¯åŒ…', 'çœŸç©ºåŒ…è£ç±³', 'ä¹¾ç‡¥è±†é¡', 'å …æœæ··åˆç‰©', 'å·§å…‹åŠ›å¡Š', 'èœ‚èœœ', 'æœé†¬', 'é­šç½é ­', 'é†ƒè£½è‚‰é¡', 'ä¹¾ç‡¥éºµæ¢', 'é€Ÿé£Ÿé¦¬éˆ´è–¯æ³¥', 'å³é£Ÿç²¥', 'å’–å•¡ç²‰', 'èŒ¶åŒ…', 'ç³–', 'é¹½', 'é£Ÿç”¨æ²¹', 'èŠ±ç”Ÿé†¬', 'ä¹¾é…ª', 'é¤…ä¹¾', 'æ³¡éºµ', 'ä¹¾ç‡¥è˜‘è‡', 'é¢¨ä¹¾è‚‰æ¢', 'ç©€ç‰©æ£’', 'ä¹¾ç‡¥æ¹¯å¡Š', 'ç‡•éº¥ç‰‡', 'ç‰ç±³ç½é ­', 'ç•ªèŒ„ç½é ­', 'ç‡‰ç…®è±†ç½é ­', 'å£“ç¸®ä¹¾ç³§', 'é»‘ç³–', 'è‘¡è„ä¹¾', 'æ¤°å­ç²‰', 'èŠéº»ç³Š', 'é€Ÿé£Ÿè›‹èŠ±æ¹¯', 'ä¹¾ç‡¥æµ·å¸¶', 'å‡ä¹¾æ°´æœ', 'ç‰›è‚‰ä¹¾', 'è±¬è‚‰é¬†', 'å³é£Ÿå¸ƒä¸', 'ä¹¾ç‡¥é¦¬éˆ´è–¯', 'é€Ÿé£Ÿå’–å“©', 'ç½è£ç…‰ä¹³', 'ä¹¾ç‡¥é¦™è…¸', 'é€Ÿé£Ÿå‘³å™Œæ¹¯', 'ç½è£ç‰ç±³æ¿ƒæ¹¯', 'ä¹¾ç‡¥å—ç“œ', 'é€Ÿé£Ÿç‡‰é£¯', 'ç½è£ç‡‰è‚‰', 'ä¹¾ç‡¥æ´‹è”¥', 'é€Ÿé£Ÿé¦¬éˆ´è–¯é¤…', 'ç½è£è”¬èœæ¹¯', 'ä¹¾ç‡¥èƒ¡è˜¿è””', 'é€Ÿé£Ÿç¾©å¤§åˆ©éºµ', 'ç½è£é®ªé­š', 'ä¹¾ç‡¥é«˜éº—èœ', 'é€Ÿé£Ÿæ¿ƒæ¹¯', 'ç½è£ç´…è±†', 'ä¹¾ç‡¥é’è±†', 'é€Ÿé£Ÿç‚’é£¯', 'ç½è£æ²™ä¸é­š', 'ä¹¾ç‡¥è èœ', 'é€Ÿé£Ÿç‰ç±³ç²¥', 'ç½è£å¥¶æ²¹è˜‘è‡æ¹¯', 'ä¹¾ç‡¥ç”œæ¤’', 'é€Ÿé£Ÿç‡‰è”¬èœ', 'ç½è£é›è‚‰', 'ä¹¾ç‡¥è˜‹æœ', 'é€Ÿé£Ÿå—ç“œæ¹¯', 'ç½è£ç‰›è‚‰é†¬', 'ä¹¾ç‡¥é¦™è•‰ç‰‡', 'é€Ÿé£Ÿé¦¬éˆ´è–¯æ²™æ‹‰', 'ç½è£ç¾Šè‚‰', 'ä¹¾ç‡¥é³³æ¢¨', 'é€Ÿé£Ÿè”¬èœæ³¥', 'ç½è£æµ·é®®æ¿ƒæ¹¯', 'ä¹¾ç‡¥è—è“', 'é€Ÿé£Ÿç‡‰ç‰›è‚‰', 'ç½è£ç«è…¿', 'ä¹¾ç‡¥èŠ’æœ', 'é€Ÿé£Ÿç‡‰è±†', 'ç½è£å¥¶æ²¹ç‰ç±³', 'ä¹¾ç‡¥è‰è“', 'é€Ÿé£Ÿç‡‰é›', 'ç½è£ç•ªèŒ„é†¬', 'ä¹¾ç‡¥å¥‡ç•°æœ', 'é€Ÿé£Ÿç‡‰é­š', 'ç½è£å¥¶æ²¹å—ç“œæ¹¯', 'ä¹¾ç‡¥è¦†ç›†å­', 'é€Ÿé£Ÿç‡‰é¦¬éˆ´è–¯'],
		modifiers: [
		   { name: 'å†·å‡ä¹¾ç‡¥çš„', effect: 1.3 },   // ä¿å­˜æŠ€è¡“
		   { name: 'è¼»å°„è®Šç•°çš„', effect: 0.8 },  // ç’°å¢ƒå½±éŸ¿
		   { name: 'è»ç”¨å¯†å°çš„', effect: 1.5 },  // åŒ…è£è¦æ ¼
		   { name: 'éƒ¨åˆ†éœ‰è®Šçš„', effect: 0.7 },  // ç‰©ç†ç‹€æ…‹
		   { name: 'ç‡Ÿé¤Šå¼·åŒ–çš„', effect: 1.4 },   // åŠŸèƒ½å±¬æ€§
		   { name: 'é‡æˆ°çƒ¹è£½çš„', effect: 1.1 },  // è£½ä½œæ–¹å¼
		   { name: 'é»ç¨ æ¶²åŒ–çš„', effect: 0.6 },  // è®Šè³ªç‹€æ…‹
		   { name: 'æŠ—è¼»å°„è™•ç†çš„', effect: 1.25 }, // ç‰¹æ®Šè™•ç†
		   { name: 'åˆæˆå†é€ çš„', effect: 1.15 }, // ç”Ÿç”¢æ–¹å¼
		   { name: 'çœŸç©ºè„«æ°´çš„', effect: 1.35 }  // åŠ å·¥æŠ€è¡“
		]
	  },
	  materials: {
		names: ['å»¢é‡‘å±¬', 'é›»å­å…ƒä»¶', 'èšåˆç‰©', 'éˆ¦åˆé‡‘', 'é‹æ', 'éŠ…ç·š', 'é‹¼æ¿', 'æ©¡è† ', 'ç»ç’ƒ', 'é™¶ç“·', 'æ··å‡åœŸ', 'æœ¨æ', 'å¡‘æ–™', 'çº–ç¶­å¸ƒ', 'çŸ³å¢¨', 'çŸ½è† ', 'é‚åˆé‡‘', 'é‰›å¡Š', 'é‹…æ¿', 'é³ç‰‡', 'éŒ«ç®”', 'ç¢³çº–ç¶­', 'ä¸é½é‹¼', 'å½ˆç°§', 'è»¸æ‰¿', 'é½’è¼ª', 'èºçµ²', 'èºæ¯', 'èºæ “', 'éµçµ²', 'é‹¼çºœ', 'é‹ç®”', 'éŠ…ç®¡', 'é‹¼ç®¡', 'PVCç®¡', 'é›»ç·š', 'çµ•ç·£è† å¸¶', 'ç„ŠéŒ«', 'æ½¤æ»‘æ²¹', 'ç ‚ç´™', 'ç£¨åˆ€çŸ³', 'ç ‚è¼ª', 'é‘½é ­', 'é‹¸ç‰‡', 'é‰—å­', 'æ‰³æ‰‹', 'éŒ˜é ­', 'èºçµ²åˆ€', 'éµé‡˜', 'é‰šé‡˜', 'éµéŠ', 'æ›é‰¤', 'æ»‘è¼ª', 'çš®å¸¶', 'å½ˆç°§é‹¼', 'é‹åˆé‡‘', 'é»ƒéŠ…', 'é’éŠ…', 'é‘„éµ', 'éé‹…é‹¼', 'é¢çµ²', 'é‰¬ç‰‡', 'éˆ·ç²‰', 'ç¨€åœŸç£éµ', 'é‹°é›»æ± ', 'å¤ªé™½èƒ½æ¿', 'é›»è·¯æ¿', 'é›»å®¹å™¨', 'é›»é˜»å™¨', 'äºŒæ¥µç®¡', 'æ™¶é«”ç®¡', 'é›†æˆé›»è·¯', 'é¦¬é”', 'ç™¼é›»æ©Ÿ', 'è®Šå£“å™¨', 'é›»ç£éµ', 'çµ•ç·£æ¼†', 'é˜²ç«æ£‰', 'éš”ç†±æ¿', 'é˜²æ°´å¸ƒ', 'é˜²å½ˆç»ç’ƒ', 'ç¢³åŒ–çŸ½', 'æ°§åŒ–é‹', 'æ°®åŒ–ç¡¼', 'çŸ³æ£‰', 'ç»ç’ƒçº–ç¶­', 'ç’°æ°§æ¨¹è„‚', 'èšæ°¨é…¯', 'å°¼é¾ç¹©', 'å‡±å¤«æ‹‰çº–ç¶­', 'èšä¹™çƒ¯', 'èšä¸™çƒ¯', 'èšç¢³é…¸é…¯', 'èšé…¯è–„è†œ', 'çŸ½é‹¼ç‰‡', 'ç£æ€§ææ–™', 'è¶…å°ææ–™', 'é™¶ç“·çº–ç¶­', 'è€ç«ç£š', 'æ°´æ³¥', 'çŸ³è†æ¿', 'ç€é’', 'ç ‚çŸ³', 'é»åœŸ', 'çŸ³ç°', 'ç£šå¡Š', 'å¤§ç†çŸ³', 'èŠ±å´—å²©', 'çŸ³è‹±ç ‚', 'çŸ½è—»åœŸ'],
		modifiers: [
		  { name: 'ä¿ºæ‹¾çš„', effect: 2.0 },
		  { name: 'é•·æœŸå»¢æ£„çš„', effect: 1.8 },
		  { name: 'é«˜æº«é›å£“çš„', effect: 1.9 },  // åŠ å·¥å·¥è—
		  { name: 'é½è•è„†åŒ–çš„', effect: 0.7 },  // åŠ£åŒ–ç‹€æ…‹
		  { name: 'é›»éå¼·åŒ–çš„', effect: 2.0 },  // è¡¨é¢è™•ç†
		  { name: 'å›æ”¶å†é€ çš„', effect: 1.5 },  // ä¾†æºé¡å‹
		  { name: 'è¼»å°„ç¡¬åŒ–çš„', effect: 1.8 },  // ç’°å¢ƒé©æ‡‰
		  { name: 'ç²¾å¯†é‘„é€ çš„', effect: 2.2 },  // è£½é€ ç²¾åº¦
		  { name: 'æ‡‰åŠ›æ–·è£‚çš„', effect: 0.5 },  // çµæ§‹ç¼ºé™·
		  { name: 'ç¢³çº–ç¶­è¤‡åˆçš„', effect: 2.3 },  // ææ–™é¡å‹
		  { name: 'æˆ°å‰åº«å­˜çš„', effect: 1.7 },  // æ™‚ä»£èƒŒæ™¯
		  { name: 'æ¶²å£“æˆå‹çš„', effect: 2.1 }   // æˆå‹æŠ€è¡“
		]
	  },
	  weapons: {
		names: ['é•·åŠ', 'çŸ­åŠ', 'å½åˆ€', 'æˆ°æ–§', 'é›™æ‰‹æ–§', 'åŒ•é¦–', 'é•·çŸ›', 'çŸ­çŸ›', 'æˆ°éŒ˜', 'é‡˜é ­éŒ˜', 'éˆæ·', 'é®åˆ€', 'é‰¤é®', 'æˆŸ', 'é•·æŸ„æ–§', 'æ­¦å£«åˆ€', 'å¤ªåˆ€', 'è‚‹å·®', 'è¥¿æ´‹åˆºåŠ', 'é—ŠåŠ', 'æ‰‹åŠåŠ', 'ç¾…é¦¬çŸ­åŠ', 'ç¶­äº¬æ–§', 'é£›æ–§', 'æŠ•çŸ›', 'é£›åˆ€', 'ç‹¼ç‰™æ£’', 'æµæ˜ŸéŒ˜', 'æˆ°é®', 'é›™æˆªæ£', 'ä¸‰ç¯€æ£', 'éµé­', 'éµå°º', 'å³¨çœ‰åˆº', 'é‰¤çˆª', 'è¢–ç®­', 'å¼©ç®­', 'è¤‡åˆå¼“', 'åæ›²å¼“', 'é•·å¼“', 'AK-74M', 'AK-105', 'AK-12', 'AK-101', 'AK-103', 'AKS-74U', 'RPK-16', 'SKS', 'VPO-136', 'VPO-209', 'ADAR 2-15', 'TX-15 DML', 'M4A1', 'HK416', 'SCAR-L', 'FN FAL', 'SR-25', 'M1A', 'RSASS', 'SV-98', 'Mosin Nagant', 'VSS Vintorez', 'AS VAL', 'SR-3M', '9A-91', 'VSK-94', 'MP5', 'MP7', 'P90', 'UMP45', 'Vector', 'PP-19-01 Vityaz', 'PP-91 Kedr', 'MPX', 'MP9', 'MP-155', 'Saiga-12', 'TOZ-106', 'Remington 870', 'Mossberg 590', 'Glock 17', 'Glock 18C', 'M9A3', 'P226', 'TT-33', 'APS', 'Five-seveN', 'Desert Eagle', 'RSh-12', 'SVD', 'DVL-10', 'T-5000', 'M700', 'MK18', 'HK G36', 'AUG A3', 'DT MDR', 'MCX', 'SA-58', 'RPD', 'PKM'],
		modifiers: [
		  { name: 'ç”Ÿé½çš„', effect: 0.9 },
		  { name: 'ç²¾å¯†æ ¡æº–çš„', effect: 1.6 },  // èª¿è©¦ç‹€æ…‹
		  { name: 'ç¶“å¸¸å¡æ®¼çš„', effect: 0.6 },  // æ•…éšœé¡å‹
		  { name: 'æˆ°è¡“æ¶ˆéŸ³çš„', effect: 1.4 },  // åŠŸèƒ½æ”¹è£
		  { name: 'é½è•é»é€£çš„', effect: 0.5 },  // æå£ç¨‹åº¦
		  { name: 'è¤‡åˆææ–™çš„', effect: 1.7 },  // æè³ªç‰¹æ€§
		  { name: 'å¼·åŒ–å°„é€Ÿçš„', effect: 1.8 },  // å°„æ“Šæ¨¡å¼
		  { name: 'é˜²åå…‰è™•ç†çš„', effect: 1.3 },  // è¡¨é¢è™•ç†
		  { name: 'é›™å½ˆåŒ£ç³»çµ±', effect: 1.5 },  // çµæ§‹è¨­è¨ˆ
		  { name: 'ç†±æˆåƒç„å…·', effect: 1.9 },  // é…ä»¶å‡ç´š
		  { name: 'å¹³è¡¡é…é‡çš„', effect: 1.2 }   // äººé«”å·¥å­¸
		]
	  },
	  tech: {
		names: ['é›»è·¯æ¿', 'åŠ å¯†èŠ¯ç‰‡', 'AIæ ¸å¿ƒ', 'é‡å­è™•ç†å™¨', 'å‚³æ„Ÿå™¨æ¨¡çµ„', 'ä¼ºæœé¦¬é”', 'å›ºæ…‹ç¡¬ç›¤', 'å…§å­˜æ¢', 'GPUèŠ¯ç‰‡', 'CPUæ•£ç†±å™¨', 'é›»æºæ¨¡å¡Š', 'è—ç‰™æ¨¡çµ„', 'WiFiå¤©ç·š', 'å°„é »èŠ¯ç‰‡', 'å…‰çº–æ”¶ç™¼å™¨', 'è§¸æ§é¢æ¿', 'æ¶²æ™¶å±å¹•', 'OLEDé¡¯ç¤ºå™¨', 'æ”åƒé ­æ¨¡çµ„', 'æŒ‡ç´‹è­˜åˆ¥å™¨', 'è²æ³¢é¦¬é”', 'å¾®å‹éº¥å…‹é¢¨', 'æšè²å™¨å–®å…ƒ', 'æŒ¯å‹•é›»æ©Ÿ', 'é™€èºå„€å‚³æ„Ÿå™¨', 'åŠ é€Ÿåº¦è¨ˆ', 'æ°£å£“å‚³æ„Ÿå™¨', 'æº«åº¦å‚³æ„Ÿå™¨', 'æ¿•åº¦å‚³æ„Ÿå™¨', 'ç´…å¤–ç·šç™¼å°„å™¨', 'æ¿€å…‰é›·é”', 'æ¯«ç±³æ³¢é›·é”', 'NFCèŠ¯ç‰‡', 'RFIDæ¨™ç±¤', 'ç”Ÿç‰©è­˜åˆ¥æ¨¡çµ„', 'èªéŸ³è­˜åˆ¥èŠ¯ç‰‡', 'ç¥ç¶“ç¶²çµ¡è™•ç†å™¨', 'é‚Šç·£è¨ˆç®—å–®å…ƒ', '5GåŸºå¸¶èŠ¯ç‰‡', 'è¡›æ˜Ÿé€šä¿¡æ¨¡å¡Š', 'ç„¡äººæ©Ÿé£›æ§', 'æ©Ÿæ¢°è‡‚æ§åˆ¶å™¨', 'å·¥æ¥­PLC', 'æ©Ÿå™¨è¦–è¦ºé¡é ­', '3Dæ‰“å°å™´é ­', 'CNCæ§åˆ¶æ¿', 'æ¿€å…‰åˆ‡å‰²é ­', 'é›»åŒ–å­¸å‚³æ„Ÿå™¨', 'å…‰ä¼é›»æ± æ¿', 'é‹°é›»æ± é›»èŠ¯', 'è¶…ç´šé›»å®¹å™¨', 'ç‡ƒæ–™é›»æ± å †', 'ç„¡ç·šå……é›»ç·šåœˆ', 'é€†è®Šå™¨æ¨¡å¡Š', 'è®Šå£“å™¨çµ„ä»¶', 'ç¹¼é›»å™¨é–‹é—œ', 'é›»ç£é–¥é–€', 'æ­¥é€²é›»æ©Ÿ', 'ä¼ºæœé©…å‹•å™¨', 'æ©Ÿå™¨äººé—œç¯€æ¨¡çµ„', 'è‡ªå‹•é§•é§›ECU', 'è»Šè¼‰é›·é”', 'è»è¦ç´šèŠ¯ç‰‡', 'èˆªç©ºé›»å­çµ„ä»¶', 'è¡›æ˜Ÿå§¿æ§ç³»çµ±', 'ç«ç®­å°èˆªèŠ¯ç‰‡', 'æ·±ç©ºé€šä¿¡çµ‚ç«¯', 'é‡å­åŠ å¯†æ©Ÿ', 'å€å¡Šéˆç¤¦æ©Ÿ', 'é›²æœå‹™å™¨ä¸»æ¿', 'æ•¸æ“šä¸­å¿ƒäº¤æ›æ©Ÿ', 'å…‰åˆ»æ©Ÿé¡é ­', 'åŠå°é«”è•åˆ»æ©Ÿ', 'ç´ç±³å£“å°è¨­å‚™', 'åˆ†å­ç¯©è†œ', 'ç¢³ç´ç±³ç®¡ææ–™', 'çŸ³å¢¨çƒ¯æ™¶ç‰‡', 'è¶…å°é«”ææ–™', 'æŸ”æ€§é›»å­è–„è†œ', 'æ™ºèƒ½çº–ç¶­ç¹”ç‰©', 'é›»å­çš®è†š', 'è…¦æ©Ÿæ¥å£æ¢é‡', 'é†«ç™‚å½±åƒæ¢é ­', 'åŸºå› æ¸¬åºå„€', 'ç´ç±³æ©Ÿå™¨äºº', 'å¾®æµæ§èŠ¯ç‰‡', 'ç”Ÿç‰©å‚³æ„Ÿå™¨', 'äººå·¥æ™¶ç‹€é«”', 'ä»¿ç”Ÿç¾©è‚¢', 'æ™ºèƒ½å‡è‚¢', 'å¤–éª¨éª¼é©…å‹•å™¨', 'ARé¡¯ç¤ºæ¨¡çµ„', 'VRå®šä½å‚³æ„Ÿå™¨', 'å…¨æ¯æŠ•å½±å„€', 'æ¿€å…‰æŠ•å½±é¡é ­', 'æ™ºèƒ½å®¶å±…ä¸­æ¨', 'ç‰©è¯ç¶²ç¶²é—œ', 'é‚Šç·£æœå‹™å™¨', 'AIè¨“ç·´é›†ç¾¤', 'è¶…ç´šè¨ˆç®—æ©Ÿç¯€é»', 'é‡å­è¨ˆç®—å–®å…ƒ'],
		modifiers: [
		  { name: 'å¯¦é©—æ€§çš„', effect: 1.5 },
		  { name: 'ç ´è§£æ¬Šé™çš„', effect: 1.8 },   // è»Ÿé«”ç‹€æ…‹
		  { name: 'è»ç”¨åŠ å¯†çš„', effect: 2.4 },   // å®‰å…¨ç­‰ç´š
		  { name: 'éè¼‰ç‡’æ¯€çš„', effect: 0.3 },   // æå£é¡å‹
		  { name: 'æ¨¡çµ„åŒ–è¨­è¨ˆçš„', effect: 1.7 },   // çµæ§‹ç‰¹æ€§
		  { name: 'é‡å­åŠ å¯†çš„', effect: 2.6 },   // æŠ€è¡“å±¤ç´š
		  { name: 'è¼»å°„å±è”½çš„', effect: 1.5 },   // é˜²è­·åŠŸèƒ½
		  { name: 'åŸå‹æ©Ÿç‰ˆæœ¬çš„', effect: 1.9 },   // é–‹ç™¼éšæ®µ
		  { name: 'ç”Ÿç‰©è­˜åˆ¥çš„', effect: 2.1 },   // é©—è­‰æ–¹å¼
		  { name: 'å¤ªé™½èƒ½ä¾›é›»çš„', effect: 1.4 },   // èƒ½æºé¡å‹
		  { name: 'å…¨æ¯æŠ•å½±çš„', effect: 2.0 }    // é¡¯ç¤ºæŠ€è¡“
		]
	  }
	};

	let LOCATIONS = ["å»¢æ£„è¶…å¸‚", "æ ¸é›»ç«™å»¢å¢Ÿ", "åœ°éµéš§é“", "è»äº‹åŸºåœ°", "é†«é™¢åœ°ä¸‹å®¤", "ç ”ç©¶æ‰€éºå€", "åŠ æ²¹ç«™", "è¾²å ´ç©€å€‰", "å»¢æ£„è³¼ç‰©ä¸­å¿ƒ", "æ ¸åæ‡‰çˆå†·å»æ± ", "åœ°éµç¶­ä¿®é€šé“", "é€€å½¹å°å½ˆç™¼å°„äº•", "ç²¾ç¥ç—…é™¢åœå°¸é–“", "åŒ–å·¥å¯¦é©—å®¤å»¢å¢Ÿ", "æ¼æ²¹åŠ æ²¹ç«™", "ç©€ç‰©é»´è®Šå€‰åº«", "éŠ¹è•è¼¸æ²¹ç®¡é“", "åå¡Œç¤¦å±±éš§é“", "å»¢æ£„å†·å‡é£Ÿå“å» ", "æ”¾å°„æ€§å»¢æ–™å‘", "åŸå¸‚é˜²ç©ºæ´ç¾¤", "è»ç”¨é›·é”ç«™éºå€", "ç„šåŒ–çˆè™•ç†è»Šé–“", "æ°´åº«æ§åˆ¶å¡”", "å ±å»¢ç«è»Šèª¿åº¦å ´", "æŠ—ç”Ÿç´ ç”Ÿç”¢ç·š", "é‹¼éµå» é«˜çˆå€", "æµ·åº•éš§é“æ»²æ°´æ®µ", "èˆªç©ºç‡ƒæ–™å„²ç½å€", "ç”Ÿç‰©è£½åŠ‘å¯¦é©—å®¤", "æ™¶åœ“å» ç„¡å¡µå®¤", "çºœè»Šä¸­è½‰æ©Ÿæˆ¿", "é€ ç´™å» æ±™æ°´æ± ", "åœ°ä¸‹éˆ¾ç¤¦è±äº•", "è·¨æµ·å¤§æ©‹æ©‹å¢©", "é›»å¼§çˆç…‰é‹¼è»Šé–“", "ç©€ç‰©å‡é™æ©Ÿç­’å€‰", "çŸ³åŒ–ç®¡ç·šåŠ å£“ç«™", "å ±å»¢èˆ¹èˆ¶æ‹†è§£å ´", "æ”¾å°„æ€§æ±™æ°´äº•", "å±±å€çºœè»Šå¡”æ¶", "æ··å‡åœŸé æ‹Œå·¥å» ", "åœ°ä¸‹é…é›»ç¸½ç«™", "æˆ°å‚™ç³§é£Ÿå„²è—åº«", "éµè·¯ä¿¡è™Ÿæ§åˆ¶å¡”", "è£½è—¥å» ç™¼é…µè»Šé–“", "å»¢æ£„ç´¡ç¹”å°æŸ“å» ", "å±±é«”æ»‘å¡æ©åŸ‹æ‘", "å†·æˆ°æ™‚æœŸè§€å¯Ÿå“¨", "åœ°ä¸‹ç¨®å­åŸºå› åº«", "æ¸¯å£è²¨æ«ƒåŠè£å€", "é‹é›»è§£è»Šé–“å»¢å¢Ÿ", "æ²³å·ç–æµšè¨­å‚™å ´", "ç«åŠ›ç™¼é›»ç…¤å€‰", "å»¢æ£„æ±½è»Šå£“ç¸®å» ", "æ·±å±¤åœ°è³ªé‘½æ¢äº•", "æˆ°æ™‚åœ°ä¸‹å°åˆ·æ‰€", "æ”¾å°„æ€§é†«ç™‚å™¨æ¢°åº«"];
	let currentUpgradeIndex;
    
	let productionCollection = {};
	
	// æ–°å®šç¾©æ± ï¼šå¢åŠ äº‹ä»¶æ™‚ï¼Œåƒµå°¸é‡åˆ°çš„å°è±¡
	const ZOMBIE_ENCOUNTER_POOL = [
	  "æµæµªçš„åƒµå°¸","å­¤ç¨çš„æ—…è¡Œè€…","å¤©çœŸçš„å€–å­˜è€…","è¿·é€”çš„è¡Œè€…","å—å‚·çš„é€€ä¼è»äºº","å¸¶è‘—æŸ“è¡€ç­†è¨˜çš„ç§‘å­¸å®¶","ç‹‚ç†±çš„æœ«æ—¥æ•™å¾’","æ”¹é€ æ©Ÿè»Šçš„æš´å¾’","å›¤è—¥è—¥åŠ‘å¸«","å¤±èªæˆ°åœ°è¨˜è€…","é»‘å¸‚åœ°åœ–å•†äºº","å›é€ƒç ”ç©¶å“¡","å…ç–«é«”æµæµªå…’","ç„¦æ…®ç›´å‡æ©Ÿå·¥ç¨‹å¸«", "ç˜‹ç™²å°¸é«”ç•«å®¶", "é …åœˆå¯¦é©—é«”", "æ¨‚å™¨ç›’ç‹™æ“Šæ‰‹", "è¨Šè™Ÿå¡”å»£æ’­å“¡", "æ€¥è¨ºå®¤ç„šå°¸é†«","è¢«æ„ŸæŸ“çš„è­·æ—å“¡", "è®Šç•°æµæµªçŠ¬", "è…çˆ›æ•‘è­·å“¡", "å¯„ç”Ÿè—¤å®¿ä¸»", "å˜¶å¼è·¯ç‡ˆåŠå°¸"  // å¯æ“´å……æ›´å¤šé¸é …
	];

	// æ–°å®šç¾©æ± ï¼šæ¸›å°‘äº‹ä»¶æ™‚ï¼Œåƒµå°¸é­é‡çš„ä¸åˆ©äº‹ä»¶
	const ZOMBIE_DISASTER_POOL = [
	  "æš´èµ°çš„è®Šç•°ç¸","å¤§è¦æ¨¡çš„åå¡Œ", "å¼·é›·é›¨å¤©æ°£","çªå¦‚å…¶ä¾†çš„é¢¶é¢¨","è¢«æ„ŸæŸ“çš„è­¦çŠ¬ç¾¤","å·¨å‹è…çˆ›çƒé´‰ç‹","å¯„ç”Ÿè—¤è”“åƒµå°¸æ¨¹","æˆç¾¤å°¸é¼ é·å¾™","é»èŒè¦†è“‹çš„è…åŒ–ç†Š","é£Ÿå°¸ç¦¿é·²ç¾¤è¥²æ“Š","è»æ–¹ç‡ƒç‡’å½ˆåœ°æ¯¯è½Ÿç‚¸","è‡ªå‹•å“¨æˆ’æ©Ÿæ§é™£åˆ—å•Ÿå‹•","åœ°ä¸‹ç“¦æ–¯ç®¡ç·šå¤§çˆ†ç‚¸","é«˜å£“é›»ç¶²æ„å¤–éè¼‰","è‡´å‘½æŠ—é«”ç©ºæ°£å‚³æ’­","æ™ºèƒ½ç„¡äººæ©Ÿç¾¤æƒè•©","ç”ŸåŒ–æº¶å°¸é…¸é›¨é›²åœ˜","ç²¾ç¥å¹²æ“¾æ³¢ç„¡å·®åˆ¥æ”»æ“Š","ååƒµå°¸çœŸèŒå¿«é€Ÿè”“å»¶","ç•°ç¨®æ•é£Ÿè€…é›†åœ˜ç‹©çµ" // å¯æ“´å……æ›´å¤šé¸é …
	];
	const effectMapping = {
	  food: "é£Ÿç‰©ç”Ÿç”¢",
	  materials: "ææ–™ç”Ÿç”¢",
	  weapons: "æ­¦å™¨ç”Ÿç”¢",
	  tech: "ç§‘æŠ€ç”Ÿç”¢",
	  resourceBonus: "è³‡æºåŠ æˆ",
	  explorationBoost: "æ¢ç´¢æå‡",
	  zombieEfficiency: "åƒµå°¸æ•ˆç‡",
	  production: "åƒµå°¸ç”Ÿç”¢",
	  zombieBoost: "åƒµå°¸åŠ æˆ",
	  zombieLossReduction: "æå¤±æ§åˆ¶",
	  productionBonus: "ç”Ÿç”¢åŠ æˆ",
	  resourceConsumptionRate: "å…¨è³‡æºæ¶ˆè€—",
	  weaponConsumptionRate: "æ­¦å™¨æ¶ˆè€—",
	  techConsumptionRate: "ç§‘æŠ€æ¶ˆè€—",
	  foodConsumption: "é£Ÿç‰©æ¶ˆè€—",
	  rareChanceBoost: "ç¨€æœ‰å¹¾ç‡",
	  accidentReduction: "æ„å¤–æ§åˆ¶",
	  btrChance: "BTRæ‡‰ç­”ç‡",
	  btrZombieEventChanceBonus: "BTRå”åŠ©",
	  btrZombieMaxBonus:"BTRæ”¶å®¹",
	  btrRareItemBonus: "BTRæ”¶é›†",
	  maxZombieCapBonus: "æ”¶å®¹ä¸Šé™"
	};

	const costMapping = {
	  food: "é£Ÿç‰©",
	  materials: "ææ–™",
	  weapons: "æ­¦å™¨",
	  tech: "ç§‘æŠ€"
	};
	const resourceMapping = {
	  food: "é£Ÿç‰©",
	  materials: "ææ–™",
	  weapons: "æ­¦å™¨",
	  tech: "ç§‘æŠ€"
	};

	
	/***** å…¨å±€è®Šé‡å®šç¾© *****/
	window.currentZombieSprite = localStorage.getItem("currentZombieSprite") || "images/zombie_search_sprite.png";
    window.currentBtrSprite = localStorage.getItem("currentBtrSprite") || "images/btr_sprite.png";
    window.currentT80Sprite = localStorage.getItem("currentT80Sprite") || "images/t-80_sprite.png";
	function getTotalRarityLevels() {
	  return RARITIES.length;
	}
	// æ›´æ–°é‡ç½®å¾ªç’°è¨˜éŒ„çš„é¡¯ç¤º
	function updateResetCycleDisplay() {
	  const totalRarityLevels = getTotalRarityLevels();  // å‹•æ…‹ç²å–ç¸½æ•¸
	  const cycleCount = Math.floor(gameState.resetCounter / totalRarityLevels);
	  const displayElem = document.getElementById("resetCycleDisplay");
	  if (displayElem) {
		displayElem.innerHTML = `å¾ªç’°æ¬¡æ•¸ï¼š${cycleCount}`;
	  }
	}
	function updateResourceCardsBorder() {
	  // å®šç¾©ç¨€æœ‰åº¦åˆ—è¡¨ï¼Œé †åºå¾ä½åˆ°é«˜
	  const rarityList = [
		"junk", "old", "damaged", "common",
		"decent", "sealed", "selected", "tested",
		"rare", "epic", "legendary", "divine"
	  ];
	  
	  // æ ¹æ“š gameState.resetCountsï¼Œåˆ†åˆ¥ç‚ºå„è³‡æºè¨ˆç®—é‡ç½®æ¬¡æ•¸å°æ‡‰çš„ç´¢å¼•
	  const foodRarity = rarityList[ gameState.resetCounts.food % rarityList.length ];
	  const materialsRarity = rarityList[ gameState.resetCounts.materials % rarityList.length ];
	  const weaponsRarity = rarityList[ gameState.resetCounts.weapons % rarityList.length ];
	  const techRarity = rarityList[ gameState.resetCounts.tech % rarityList.length ];
	  
	   // å–å¾—è³‡æºå¡çš„ DOM å…ƒç´ ï¼ˆå‡è¨­è³‡æºæ•¸å­—å…ƒç´ çš„çˆ¶å…ƒç´ ç‚ºé¸é …å¡å®¹å™¨ï¼‰
	  const foodCard = document.getElementById("foodCount")?.parentElement;
	  const materialsCard = document.getElementById("materialsCount")?.parentElement;
	  const weaponsCard = document.getElementById("weaponsCount")?.parentElement;
	  const techCard = document.getElementById("techCount")?.parentElement;
	  
	  // æ›´æ–°ç‚ºåªä¿®æ”¹ box-shadow é¡è‰²ï¼Œä¸¦ç¢ºä¿åœ“è§’å®Œæ•´é¡¯ç¤º
	  if (foodCard) {
		const colorVal = "var(--" + foodRarity + ")";
		foodCard.style.border = "1px solid " + colorVal;
		// ç¢ºä¿åœ“è§’ã€å…§é‚Šè·ç­‰è¨­å®šä¸å—å¹²æ“¾
		foodCard.style.borderRadius = "8px";
	  }
	  if (materialsCard) {
		const colorVal = "var(--" + materialsRarity + ")";
		materialsCard.style.border = "1px solid " + colorVal;
		materialsCard.style.borderRadius = "8px";
	  }
	  if (weaponsCard) {
		const colorVal = "var(--" + weaponsRarity + ")";
		weaponsCard.style.border = "1px solid " + colorVal;
		weaponsCard.style.borderRadius = "8px";
	  }
	  if (techCard) {
		const colorVal = "var(--" + techRarity + ")";
		techCard.style.border = "1px solid " + colorVal;
		techCard.style.borderRadius = "8px";
	  }
	}


	
	// å›ºå®šç¨€æœ‰åº¦æ•¸çµ„ï¼ˆå…± 12 å€‹ç­‰ç´šï¼‰
	const RARITIES = [
	  "junk", "old", "damaged", "common", "decent",
	  "sealed", "selected", "tested", "rare", "epic",
	  "legendary", "divine"
	];

	function calculateTotalCombinations() {
	  let total = 0;
	  // éæ­· ITEM_DATA ä¸­æ‰€æœ‰è³‡æºé¡å‹
	  for (let res in ITEM_DATA) {
		if (ITEM_DATA.hasOwnProperty(res)) {
		  const data = ITEM_DATA[res];
		  // ç‰©å“åç¨±æ•¸é‡
		  const namesCount = Array.isArray(data.names) ? data.names.length : 0;
		  // è©ç¶´æ•¸é‡ï¼Œå¦‚æœ modifiers ä¸å­˜åœ¨å‰‡é»˜èªç‚º 0
		  const modifiersCount = Array.isArray(data.modifiers) ? data.modifiers.length : 0;
		  const rarityCount = RARITIES.length; // å›ºå®šç‚º12

		  // è¨ˆç®—ï¼šç‰©å“å+ç¨€æœ‰åº¦ èˆ‡ ç‰©å“å+è©ç¶´+ç¨€æœ‰åº¦
		  const countNameRarity = namesCount * rarityCount;
		  const countNameModifierRarity = namesCount * modifiersCount * rarityCount;
		  const resourceTotal = countNameModifierRarity;
		  total += resourceTotal;
		}
	  }
	  return total;
	}

	// å¾ ITEM_DATA ä¸­å‹•æ…‹è¨ˆç®—æ‰€æœ‰å¯èƒ½çš„æ”¶è—çµ„åˆæ•¸
	let ALL_COMBINATIONS = calculateTotalCombinations();

	// æ›´æ–°æ”¶è—è¨˜éŒ„å®Œæˆåº¦çš„å‡½æ•¸
	function updateCollectionCompletion() {
	  // å·²æ”¶è—é …ç›®æ•¸é‡ï¼šä»¥ collectedItems çš„éµæ•¸é‡ä½œç‚ºè¨ˆæ•¸
	  const obtained = Object.keys(collectedItems).length;
	  // è¨ˆç®—æ”¶è—å®Œæˆç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰ï¼Œé¿å…é™¤æ•¸ç‚º 0 çš„æƒ…æ³
	  const total = ALL_COMBINATIONS || 1;
	  const percentage = (obtained / total) * 100;

	  const completionElem = document.getElementById("collectionCompletion");
	  if (completionElem) {
		// å³ä½¿æ•¸å€¼ç‚º 0ï¼Œä¹Ÿé¡¯ç¤º0/ç¸½æ•¸: 0.0%
		completionElem.textContent = `${obtained}/${total}(${percentage.toFixed(3)}%)`;
	  }
	}

	
	function showTempMessage(message) {
	  // æ‰¾åˆ°åŸºåœ°å»ºè¨­å®¹å™¨ï¼ˆå¿…é ˆç¢ºä¿è©²å®¹å™¨è¨­ç½® position: relativeï¼‰
	  let buildingContainer = document.getElementById("buildingSystem");
	  if (!buildingContainer) {
		// è‹¥ä¸å­˜åœ¨å‰‡é€€å› body
		buildingContainer = document.body;
	  }

	  // å‰µå»ºæç¤ºå…ƒç´ 
	  let tempDiv = document.createElement("div");
	  tempDiv.style.position = "absolute";  // çµ•å°å®šä½ç›¸å°æ–¼çˆ¶å®¹å™¨
	  tempDiv.style.top = "0";                // ä¸Šç·£è²¼é½Šçˆ¶å®¹å™¨é ‚éƒ¨
	  tempDiv.style.left = "50%";             // æ°´å¹³å±…ä¸­
	  tempDiv.style.transform = "translateX(-50%)";
	  tempDiv.style.background = "#333";
	  tempDiv.style.color = "#FFF";
	  tempDiv.style.padding = "1em 2em";
	  tempDiv.style.borderRadius = "12px";
	  tempDiv.style.zIndex = "1100";          // ç¢ºä¿æç¤ºå±¤ç´šé«˜æ–¼å…¶å®ƒå…§å®¹
	  tempDiv.style.boxShadow = "0 4px 12px rgba(0,0,0,0.3)";
	  tempDiv.textContent = message;

	  // å°‡æç¤ºæ·»åŠ åˆ°åŸºåœ°å»ºè¨­å®¹å™¨ä¸­
	  buildingContainer.appendChild(tempDiv);

	  // 300 æ¯«ç§’å¾Œè‡ªå‹•ç§»é™¤æç¤º
	  setTimeout(function() {
		if (tempDiv.parentNode) {
		  tempDiv.parentNode.removeChild(tempDiv);
		}
	  }, 300);
	}



	
	//ç”Ÿç”¢æ”¶è—å½ˆçª—
	function showProductionCollection() {
	  // å°‡ productionCollection è½‰æ›ç‚ºé™£åˆ—å¾Œæ’åºï¼ˆå¦‚ä¾ç²å–æ¬¡æ•¸å¾é«˜åˆ°ä½æ’åºï¼‰
	  let prodItems = Object.keys(productionCollection).map(key => ({
		name: key,
		count: productionCollection[key]
	  }));
	  
	  prodItems.sort((a, b) => b.count - a.count);
	  prodItems = prodItems.slice(0, 100); // åªå–å‰100æ¢
	  
	  let html = `<table class="collection-table">
		<thead>
		  <tr>
			<th>ç‰©å“åç¨±</th>
			<th>ç²å¾—æ¬¡æ•¸</th>
		  </tr>
		</thead>
		<tbody>`;

	  
	  prodItems.forEach(item => {
		html += `<tr>
		  <td style="border:1px solid var(--border-color); padding:5px; text-align: center;">${item.name}</td>
		  <td style="border:1px solid var(--border-color); padding:5px; text-align: center;">${item.count}</td>
		</tr>`;

	  });
	  html += `</tbody></table>`;
	  
	  // å°‡ç”Ÿæˆçš„ HTML å¡«å…¥ç”Ÿç”¢æ”¶è—é é¢çš„å…§å®¹å€åŸŸä¸­
	  document.getElementById("productionCollectionContent").innerHTML = html;
	  
	  // é¡¯ç¤ºç”Ÿç”¢æ”¶è—å½ˆçª—
	  showModal("productionCollectionModal");
	}

	


	const RESOURCE_CAP = 900000000000;  // æ‰€æœ‰è³‡æºé”åˆ°æ­¤å€¼å³èªç‚ºâ€œé”åˆ°ä¸Šé™â€
	const RESET_VALUE = 100000;     // é‡ç½®å¾Œæ¯é …è³‡æºé‡
	let collectedItems = {};
	let gameState = {
	  resources: { food: 100, materials: 100, weapons: 50, tech: 20 },
	  // æ–°å¢ï¼šé‡ç½®æ¬¡æ•¸è¨˜éŒ„ï¼Œåˆå§‹å€¼ç‚º 0
	  resetCounts: { food: 0, materials: 0, weapons: 0, tech: 0 },
	  // æ–°å¢çµ±ä¸€çš„è³‡æºé‡ç½®å¾ªç’°è¨˜æ•¸å™¨
	  resetCounter: 0,
	  totalZombies: 10,
	  allocations: { exploration: 4, farming: 4, recycling: 1, research: 1 },
	  buildings: new Array(9).fill(null).map((_, i) =>
		i === 4 ? { type: 'center', level: 1, upgradable: true } : null
	  ),
	  explorationMilestone: 10,
	  efficiency: { food: 1, materials: 1, weapons: 1, tech: 1, exploration: 1 }
	};

	let BUILDINGS = {
	  center: {
		name: 'ä¸­å¿ƒåŸºåœ°',
		buildable: false,
		baseCost: { materials: 200, tech: 50 },
		costMultiplier: 1.5,      // æ¯å‡ç´šä¸€æ¬¡ï¼Œæˆæœ¬ä¹˜ä»¥1.5
		baseEffect: { resourceBonus: 0.02, explorationBoost: 0.05 },
		effectMultiplier: 1.2,    // æ¯å‡ç´šä¸€æ¬¡ï¼Œæ•ˆæœä¹˜ä»¥1.2
		getUpgradeInfo: function(currentLevel) {
		  // currentLevel ä»£è¡¨ç›®æ¨™å‡ç´šå¾Œçš„ç­‰ç´š
		  return {
			cost: {
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
			  tech: Math.floor(this.baseCost.tech * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  resourceBonus: this.baseEffect.resourceBonus * Math.pow(this.effectMultiplier, currentLevel - 1),
			  explorationBoost: this.baseEffect.explorationBoost * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },

	  barracks: {
		name: 'åƒµå°¸å…µç‡Ÿ',
		baseCost: { food: 300, materials: 200 },
		costMultiplier: 1.5,
		baseEffect: { production: 2 },
		// æ–°å¢ï¼š1çº§æ—¶æ¯ç§’æ¶ˆè€—æ­¦å™¨èµ„æºæ¯”ä¾‹ (ä¾‹å¦‚ 0.05)
		baseWeaponConsumptionRate: 0.01,
		effectMultiplier: 1.2,
		getUpgradeInfo: function(currentLevel) {
		  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  // å¦‚æœç›®æ¨™ç­‰ç´šè¶…éä¸­å¿ƒåŸºåœ°ç­‰ç´šå‰‡è¿”å› null è¡¨ç¤ºç„¡æ³•å‡ç´š
		  if (currentLevel > centerLevel) return null;
		  return {
			cost: {
			  food: Math.floor(this.baseCost.food * Math.pow(this.costMultiplier, currentLevel - 1)),
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  production: this.baseEffect.production * Math.pow(this.effectMultiplier, currentLevel - 1),
			  // è¨ˆç®—ç­‰ç´šèª¿æ•´å¾Œçš„æ­¦å™¨è³‡æºæ¶ˆè€—ç‡ï¼ˆä¾‹å¦‚ 1 çº§æ—¶ä¸º baseWeaponConsumptionRate, åç»­ä»¥ effectMultiplier æŒ‡æ•¸å¢é•·ï¼‰
			  weaponConsumptionRate: this.baseWeaponConsumptionRate * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },


	  greenhouse: {
		name: 'æº«å®¤å¤§æ£š',
		baseCost: { materials: 100, tech: 50 },
		costMultiplier: 1.5,
		baseEffect: { food: 0.1 },
		effectMultiplier: 1.2,
		getUpgradeInfo: function(currentLevel) {
		  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  if (currentLevel > centerLevel) return null;
		  return {
			cost: {
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
			  tech: Math.floor(this.baseCost.tech * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  food: this.baseEffect.food * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },
	  recyclingFactory: {
	    name: 'å›æ”¶å·¥å» ',
	    baseCost: { materials: 150, tech: 50 }, // èˆ‡æº«å®¤å¤§æ£šç›¸ä¼¼çš„æˆæœ¬
	    costMultiplier: 1.5,                   // æ¯æ¬¡å‡ç´šæˆæœ¬ä¹˜ä»¥1.5
	    baseEffect: { materials: 0.1 },         // åˆå§‹æ•ˆæœï¼šç‚ºææ–™ç”¢é‡åŠ æˆ10%
	    effectMultiplier: 1.2,                 // æ¯å‡ç´šä¸€æ¬¡æ•ˆæœä¹˜ä»¥1.2
	    getUpgradeInfo: function(currentLevel) {
		  // å–å¾—ä¸­å¿ƒåŸºåœ°çš„ç­‰ç´šï¼Œä½œç‚ºå…¶ä»–å»ºç¯‰å‡ç´šä¸Šé™çš„åƒè€ƒ
		  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  // å¦‚æœç›®æ¨™ç­‰ç´šè¶…éä¸­å¿ƒåŸºåœ°ç­‰ç´šï¼Œå‰‡è¿”å› null è¡¨ç¤ºç„¡æ³•å‡ç´š
		  if (currentLevel > centerLevel) return null;
		  return {
		    cost: {
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
			  tech: Math.floor(this.baseCost.tech * Math.pow(this.costMultiplier, currentLevel - 1))
	        },
		    effect: {
			  // æ•ˆæœè½‰ç‚ºå½±éŸ¿ææ–™ç”¢é‡åŠ æˆ
			  materials: this.baseEffect.materials * Math.pow(this.effectMultiplier, currentLevel - 1)
		    }
		  };
	    }
	  },

	  armory: {
		name: 'è»æ¢°å·¥åŠ',
		baseCost: { materials: 100, weapons: 150 },
		costMultiplier: 1.5,
		baseEffect: { weapons: 0.3 },
		effectMultiplier: 1.2,
		getUpgradeInfo: function(currentLevel) {
		  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  if (currentLevel > centerLevel) return null;
		  return {
			cost: {
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
			  weapons: Math.floor(this.baseCost.weapons * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  weapons: this.baseEffect.weapons * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },

	  laboratory: {
		name: 'ç§‘ç ”å¯¦é©—å®¤',
		baseCost: { materials: 200, tech: 100 },
		costMultiplier: 1.5,
		baseEffect: { tech: 0.2 },
		effectMultiplier: 1.2,
		getUpgradeInfo: function(currentLevel) {
		  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  if (currentLevel > centerLevel) return null;
		  return {
			cost: {
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
			  tech: Math.floor(this.baseCost.tech * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  tech: this.baseEffect.tech * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },

	  // æ–°å¢ï¼šè³‡æºå¢å¹…ç«™ï¼Œå¢åŠ æ‰€æœ‰è³‡æºçš„ç”¢é‡åŠ æˆ
	  resourceAmplifier: {
		name: 'è³‡æºå¢å¹…ç«™',
		baseCost: { materials: 250, tech: 75, weapons: 250 },
		costMultiplier: 1.6,
		baseEffect: { resourceBonus: 0.05 },  // åˆå§‹ +5%
		effectMultiplier: 1.2,
		getUpgradeInfo: function(currentLevel) {
		  // å°æ–¼é€™é¡å»ºç¯‰ï¼Œå¯ä»¥ä¸å—ä¸­å¿ƒåŸºåœ°ç­‰ç´šçš„é™åˆ¶ï¼ˆæˆ–å¦å¤–è¨­å®šé™åˆ¶ï¼‰
		  return {
			cost: {
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
			  tech: Math.floor(this.baseCost.tech * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  resourceBonus: this.baseEffect.resourceBonus * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },

	  // æ–°å¢ï¼šåƒµå°¸æŒ‡æ®ä¸­å¿ƒï¼Œæé«˜ç²å¾—åƒµå°¸çš„æ©Ÿç‡èˆ‡æ•¸é‡ï¼ŒåŒæ™‚æ¸›å°‘æå¤±
	  // ä¸¦å¢åŠ æ­¦å™¨è³‡æºæ¶ˆè€—ï¼š1ç´šæ™‚æ¯ç§’æ¶ˆè€—0.5%ï¼Œéš¨ç­‰ç´šæå‡ï¼Œæ¶ˆè€—ç‡æŒ‰ effectMultiplier å¢é•·
	  zombieCommandCenter: {
	    name: 'åƒµå°¸æŒ‡æ®ä¸­å¿ƒ',
	    baseCost: { materials: 250, weapons: 250, tech: 100 },
	    costMultiplier: 1.5,
	    baseEffect: { 
	      zombieBoost: 0.05, 
		  zombieLossReduction: 0.1,
		  maxZombieCapBonus: 525
	    },
	    // æ–°å¢ï¼š1ç´šæ™‚æ¯ç§’æ¶ˆè€—æ­¦å™¨è³‡æº 0.5%ï¼ˆå³ 0.005ï¼‰
	    baseWeaponConsumptionRate: 0.02,
	    effectMultiplier: 1.015,
	    getUpgradeInfo: function(currentLevel) {
	  	  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  if (currentLevel > centerLevel) return null;
		  return {
		    cost: {
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
			  weapons: Math.floor(this.baseCost.weapons * Math.pow(this.costMultiplier, currentLevel - 1))
		    },
		    effect: {
			  zombieBoost: this.baseEffect.zombieBoost * Math.pow(this.effectMultiplier, currentLevel - 1),
			  zombieLossReduction: this.baseEffect.zombieLossReduction * Math.pow(this.effectMultiplier, currentLevel - 1),
			  // å‹•æ…‹è¨ˆç®—æ­¦å™¨è³‡æºæ¶ˆè€—ç‡ï¼š1ç´šç‚º baseWeaponConsumptionRateï¼Œä¹‹å¾ŒæŒ‰ effectMultiplier æŒ‡æ•¸å¢é•·
			  weaponConsumptionRate: this.baseWeaponConsumptionRate * Math.pow(this.effectMultiplier, currentLevel - 1),
			  maxZombieCapBonus: this.baseEffect.maxZombieCapBonus * currentLevel  
		    }
		  };
	    }
	  },


	  // æ–°å¢ï¼šçç¨€åº«ï¼Œæé«˜é«˜ç¨€æœ‰åº¦ç‰©å“ç²å¾—ç‡
	  rareVault: {
		name: 'çç¨€åº«',
		baseCost: { tech: 500, materials: 150, weapons: 150 },
		costMultiplier: 1.55,
		baseEffect: { rareChanceBoost: 0.05, techConsumptionRate: 0.05},  // åˆå§‹ +5%
		effectMultiplier: 1.2,
		getUpgradeInfo: function(currentLevel) {
		  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  if (currentLevel > centerLevel) return null;
		  return {
			cost: {
			  tech: Math.floor(this.baseCost.tech * Math.pow(this.costMultiplier, currentLevel - 1)),
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  rareChanceBoost: this.baseEffect.rareChanceBoost * Math.pow(this.effectMultiplier, currentLevel - 1),
			  techConsumptionRate: this.baseEffect.techConsumptionRate * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },

	  // æ–°å¢ï¼šè­¦è¡›å®¤ï¼Œçµ¦äºˆå¼·åŠ›ç”Ÿç”¢åŠ æˆï¼Œä½†æŒçºŒæ¶ˆè€—æ­¦å™¨è³‡æº
	  guardFacility: {
		name: 'è­¦è¡›å®¤',
		baseCost: { weapons: 350, materials: 150, tech: 150 },
		costMultiplier: 1.7,
		baseEffect: { productionBonus: 0.1, weaponConsumptionRate: 0.02 },
		effectMultiplier: 1.2,
		getUpgradeInfo: function(currentLevel) {
		  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  if (currentLevel > centerLevel) return null;
		  return {
			cost: {
			  weapons: Math.floor(this.baseCost.weapons * Math.pow(this.costMultiplier, currentLevel - 1)),
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  productionBonus: this.baseEffect.productionBonus * Math.pow(this.effectMultiplier, currentLevel - 1),
			  weaponConsumptionRate: this.baseEffect.weaponConsumptionRate * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },
	  safetyCenter: {
		  name: 'å®‰å…¨ä¸­å¿ƒ',
		  // å¯æ ¹æ“šéœ€æ±‚è‡ªè¨‚æˆæœ¬ï¼Œé€™è£¡åƒ…æä¾›ä¸€å€‹ç¤ºä¾‹
		  baseCost: { materials: 400, tech: 150, weapons: 500 },
		  costMultiplier: 1.6,
		  baseEffect: {
			accidentReduction: 0.05,        // 1ç´šæ™‚é™ä½5%
			resourceConsumptionRate: 0.05     // 1ç´šæ™‚ï¼Œæ¯ç§’æ¶ˆè€—0.05Ã—ç¸½åƒµå°¸æ•¸çš„è³‡æº
		  },
		  effectMultiplier: 1.025,  // å‡ç´šæ™‚æ•ˆæœä¹˜å­ï¼Œä¾‹å¦‚æ¯å‡ç´šä¸€æ¬¡æ•ˆæœä¹˜ä»¥1.1
		  getUpgradeInfo: function(currentLevel) {
			const accidentReduction = Math.min(this.baseEffect.accidentReduction * Math.pow(this.effectMultiplier, currentLevel - 1), 0.50);
			const resourceConsumptionRate = Math.min(this.baseEffect.resourceConsumptionRate * Math.pow(this.effectMultiplier, currentLevel - 1), 0.4);
			return {
			  cost: {
				materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
				tech: Math.floor(this.baseCost.tech * Math.pow(this.costMultiplier, currentLevel - 1)),
				weapons: Math.floor(this.baseCost.weapons * Math.pow(this.costMultiplier, currentLevel - 1))
			  },
			  effect: {
				accidentReduction: accidentReduction,
				resourceConsumptionRate: resourceConsumptionRate
			  }
			};
		  }
		},
		armoredGarage: {
		  name: 'æ‹–æ‹‰æ©Ÿå» ',
		  baseCost: { weapons: 400, materials: 300, tech: 200 },
		  costMultiplier: 1.6,
		  baseEffect: { 
			foodConsumption: 1000,               // æ¯ä¸€è¼ªï¼ˆæˆ–æ¯æ¬¡ gameLoopï¼‰æ¶ˆè€—çš„é£Ÿç‰©é‡
			btrChance: 0.50,                   // æ¯ 30 ç§’ 50% è§¸ç™¼ BTR äº‹ä»¶
			btrZombieEventChanceBonus: 0.20,   // åœ¨ BTR æ•ˆæœæœŸé–“ï¼Œå¢åŠ  20% åƒµå°¸äº‹ä»¶è§¸ç™¼æ©Ÿç‡
			btrZombieMaxBonus: 0.10,           // åŒæ™‚æé«˜æœ€å¤§åƒµå°¸ç²å¾—æ¯”ä¾‹ 10%
			btrRareItemBonus: 0.20             // å¢åŠ é«˜ç¨€æœ‰åº¦ç‰©å“æ©Ÿç‡ 20%
		  },
		  effectMultiplier: 1.05,
		  getUpgradeInfo: function(currentLevel) {
			return {
			  cost: {
				weapons: Math.floor(this.baseCost.weapons * Math.pow(this.costMultiplier, currentLevel - 1)),
				materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
				tech: Math.floor(this.baseCost.tech * Math.pow(this.costMultiplier, currentLevel - 1))
			  },
			  effect: {
				foodConsumption: this.baseEffect.foodConsumption * Math.pow(this.effectMultiplier, currentLevel - 1),
				btrChance: this.baseEffect.btrChance * Math.pow(this.effectMultiplier, currentLevel - 1),
				btrZombieEventChanceBonus: this.baseEffect.btrZombieEventChanceBonus * Math.pow(this.effectMultiplier, currentLevel - 1),
				btrZombieMaxBonus: this.baseEffect.btrZombieMaxBonus * Math.pow(this.effectMultiplier, currentLevel - 1),
				btrRareItemBonus: this.baseEffect.btrRareItemBonus * Math.pow(this.effectMultiplier, currentLevel - 1)
			  }
			};
		  }
		},	  
	};
	

	/***** æ¢ç´¢éšŠåŠåƒµå°¸äº‹ä»¶è™•ç† *****/
	function addEventLog(message, rarity, eventType = "exploration", applyZombieStyle = false) {
	  if (eventType === "production") {
		message = message.replace(/\n/g, " ");
	  }
	  let logContainerId = (eventType === "production") ? "productionLog" : "explorationLog";
	  const logElem = document.getElementById(logContainerId);
	  if (logElem) {
		const previousScrollTop = logElem.scrollTop;
		const isAtBottom = (logElem.scrollTop + logElem.clientHeight >= logElem.scrollHeight - 5);
		const maxLogs = 20;
		let removedHeight = 0;
		while (logElem.childElementCount >= maxLogs) {
		  const first = logElem.firstElementChild;
		  removedHeight += first.offsetHeight;
		  logElem.removeChild(first);
		}
		// å®šç¾©ç¨€æœ‰åº¦æ˜ å°„å°è±¡
		// å‰µå»ºæ–°çš„æ—¥èªŒå…ƒç´ 
		const div = document.createElement("div");
		div.className = `log-entry ${rarity}`;
		// ç•¶äº‹ä»¶é¡å‹ç‚º "zombie" æˆ–è¦æ±‚ä½¿ç”¨ zombie æ¨£å¼æ™‚æ·»åŠ å°æ‡‰class
		if (eventType === "zombie" || applyZombieStyle) {
		  div.className += " zombie-event";
		}
		// æ ¹æ“šäº‹ä»¶é¡å‹æ±ºå®šä½¿ç”¨ innerHTML é‚„æ˜¯ textContent
		div.innerHTML = message;
		
		// æ·»åŠ åˆ°æ—¥èªŒå®¹å™¨ä¸­
		logElem.appendChild(div);
		
		// æ›´æ–°æ»¾å‹•ï¼šå¦‚æœç”¨æˆ¶åœ¨åº•éƒ¨ï¼Œå‰‡æ»¾å‹•åˆ°åº•éƒ¨ï¼›å¦‚æœä¸åœ¨åº•éƒ¨ï¼Œå‰‡èª¿æ•´ scrollTopï¼Œä»¥è®“åŸæœ‰æ•¸æ“šä¸Šç§»è¢«åˆªé™¤è¨Šæ¯çš„é«˜åº¦
		if (isAtBottom) {
		  logElem.scrollTop = logElem.scrollHeight;
		} else {
		  logElem.scrollTop = previousScrollTop - removedHeight;
		}

	  }
	}

	function logResource(resource, itemName, amount, eventType = "production") {
	  // ä½¿ç”¨æ˜ å°„è¡¨å°‡è‹±æ–‡è³‡æºåè½‰ç‚ºä¸­æ–‡
	  const resourceCn = resourceMapping[resource] || resource;
	  
	  if (eventType === "production") {
		const fullMessage = `<span style="white-space: normal; display: inline;">ç”Ÿç”¢: ${itemName} +${amount} ${resourceCn}</span>`;
		addEventLog(fullMessage, 'common', eventType);
	  } else {
		addEventLog(`ç”Ÿç”¢: ${itemName} +${amount} ${resourceCn}`, 'common', eventType);
	  }
	  
	  if (!productionCollection[itemName]) {
		productionCollection[itemName] = 0;
	  }
	  productionCollection[itemName] += 1;
	  
	  // æ›´æ–°æ”¶è—è¨˜éŒ„ï¼ˆé€™è£¡å¦‚æœéœ€è¦ä¸­æ–‡åŒ–ï¼Œä¹Ÿå¯åŒæ­¥ç”¨ä¸­æ–‡é¡¯ç¤ºï¼‰
	  if (!collectedItems[itemName]) {
		collectedItems[itemName] = { count: 1, rarity: 'common' };
	  } else {
		collectedItems[itemName].count += 1;
	  }
	}


    function checkUpgradable(type, level) {
	  const centerBuilding = gameState.buildings.find(b => b && b.type.toLowerCase() === "center");
	  const centerLevel = centerBuilding ? centerBuilding.level : 1;

	  if (type === "center") {
		return true; // è®“ä¸­å¿ƒåŸºåœ°ç„¡é™åˆ¶å‡ç´š
	  } else {
		return level < centerLevel; // å…¶ä»–å»ºç¯‰ç­‰ç´šä¸èƒ½è¶…éä¸­å¿ƒåŸºåœ°
	  }
	}

	// æ ¹æ“šç¨€æœ‰åº¦æ¬Šé‡éš¨æ©Ÿé¸å–ä¸€å€‹ç¨€æœ‰åº¦
	function weightedRandomRarity(teamSize) {
	  const weights = {
		junk: 25,
		old: 20,
		damaged: 15,
		common: 15,
		decent: 10,
		sealed: 5,
		selected: 4,
		tested: 3,
		rare: 2,
		epic: 0.5,
		legendary: 0.3,
		divine: 0.2
	  };
	   // ä¾‹å¦‚ï¼šç•¶ teamSize é 10 æ™‚ï¼Œçµ¦é«˜ç¨€æœ‰åº¦åŠ ä¸Šé¡å¤–çå‹µ
	  // ä¸‹é¢é€™å€‹ bonus ä½¿ç”¨å°æ•¸å‡½æ•¸ç”¢ç”Ÿä¸€å€‹éš¨è‘— teamSize å¢é•·ä½†é‚Šéš›æ•ˆç›Šéæ¸›çš„åŠ æˆ
	  let bonus = 0;
	  if (teamSize > 10) {
		bonus = 0.2 * Math.log(teamSize); // ä½ å¯ä»¥æ ¹æ“šéœ€æ±‚å¾®èª¿é€™è£¡çš„ä¿‚æ•¸
	  }
	  
	  // å°‡ bonus åŠ åˆ°é«˜ç¨€æœ‰åº¦é …ç›®ä¸Šï¼ˆä¹Ÿå¯ä»¥é‡å°ä¸åŒç¨€æœ‰åº¦è¨­ç½®ä¸åŒå¢å¹…ï¼‰
	  weights.rare += bonus;
	  weights.epic += bonus * 0.8;
	  weights.legendary += bonus * 0.5;
	  weights.divine += bonus * 0.3;
	  
	  if (isBTRActive) {
		weights.rare *= 1.5;
		weights.epic *= 1.5;
		weights.legendary *= 1.5;
		weights.divine *= 1.5;
	  }
	  let total = Object.values(weights).reduce((a, b) => a + b, 0);
	  let rand = Math.random() * total;
	  return Object.keys(weights).find(key => (rand -= weights[key]) < 0);
	}

	// æ ¹æ“šç¨€æœ‰åº¦å€ç‡è¨ˆç®—æœ€çµ‚æ•¸å€¼
	function applyRarityMultiplier(base, rarity) {
	  const multipliers = {
		junk: 1,
		old: 1.5,
		damaged: 2,
		common: 2.5,
		decent: 3,
		sealed: 3.5,
		selected: 4,
		tested: 5,
		rare: 6,
		epic: 8,
		legendary: 10,
		divine: 12
	  };
	  return base * multipliers[rarity];
	}

	function generateZombieChange(teamSize) {
	  // å¦‚æœå­˜åœ¨ armoredGarageï¼Œå‰‡é–±è®€å®ƒçš„åŠ æˆæ•ˆæœ
	  let bonusPositive = 0;      // æ­£å‘äº‹ä»¶æ¦‚ç‡åŠ æˆ
	  let gainBonus = 0; // æ–°å¢ï¼šä¸“é—¨å¤„ç†å¢ç›Šçš„å˜é‡
	  let lossReduction = 0;      // è² å‘äº‹ä»¶æå¤±æŠ˜æ‰£ï¼ˆä¾‹å¦‚ 0.25 è¡¨ç¤ºæå¤±é™ä½ 25%ï¼‰
	  if (isBTRActive) {
		const garages = gameState.buildings.filter(b =>
		  b && 
		  b.type && 
		  typeof b.type === 'string' && 
		  b.type.toLowerCase() === "armoredgarage");
		  
		if (garages.length > 0) {
		  const garageInfo = BUILDINGS.armoredGarage.getUpgradeInfo(garages[0].level);
		  bonusPositive = garageInfo.effect.btrZombieEventChanceBonus || 0;
		  gainBonus = garageInfo.effect.btrZombieGainBonus || 0; // ä½¿ç”¨æ–°å­—æ®µ
		  lossReduction = garageInfo.effect.btrZombieMaxBonus || 0;
		}
	  }
	  // è‹¥ç¸½åƒµå°¸æ•¸ç‚º 0ï¼Œç›´æ¥è¿”å› 0
	  if (gameState.totalZombies <= 0) return 0;
	  
	  let baseZombieChange = 0;
	  // æ­£å‘äº‹ä»¶æ©Ÿç‡ï¼šåŸæœ¬ 40%ï¼ŒåŠ ä¸Š armoredGarage çš„ bonusPositive
	  if (Math.random() < (0.4 + bonusPositive)) {
		// å¢åŠ åƒµå°¸ï¼šæ­£å‘äº‹ä»¶
		baseZombieChange = Math.floor(teamSize * (0.001 + Math.random() * 1.9));
	  } else {
		// è² å‘äº‹ä»¶ï¼šæå¤±åƒµå°¸
		// é™ä½è² å‘äº‹ä»¶çš„æå¤±é‡ï¼šä¹˜ä»¥ (1 - lossReduction)
		baseZombieChange = -Math.floor(teamSize * (0.001 + Math.random() * 0.7) * (1 - lossReduction));
	  }

	  // åˆ©ç”¨æ¢ç´¢éƒ¨é–€èˆ‡ç¸½åƒµå°¸æ•¸è¨ˆç®—ç•¶å‰æ¯”ä¾‹
	  let explorationRatio = (gameState.totalZombies > 0) ? (teamSize / gameState.totalZombies) : 0;
	  const targetRatio = 0.4; // ç›®æ¨™æ¯”ä¾‹ 40%

	  // ä¾æ¯”ä¾‹è¨ˆç®—ä¸€å€‹åç§»é‡
	  let offset = 0;
	  if (explorationRatio < targetRatio) {
		offset = 0.05 * gameState.totalZombies * (targetRatio - explorationRatio);
	  } else if (explorationRatio > targetRatio) {
		offset = -0.1 * gameState.totalZombies * (explorationRatio - targetRatio);
	  }
	  
	  const finalZombieChange = Math.round(baseZombieChange + offset);
	  // å®šç¾©åŸºæœ¬ä¸Šé™
	  let baseCap = 80000;

	  // ç´¯è¨ˆæ‰€æœ‰åƒµå°¸æŒ‡æ®ä¸­å¿ƒçš„é¡å¤–æ”¶å®¹å€¼ï¼ˆæ³¨æ„ï¼šé€™è£¡ä¸æ··æ·†å…¶ä»–å»ºç¯‰ï¼Œåƒ…é‡å°type === "zombiecommandcenter"ï¼‰
	  const zccBuildings = gameState.buildings.filter(b =>
	  b && b.type.toLowerCase() === "zombiecommandcenter"
	  );
	  let bonusTotal = 0;
	  zccBuildings.forEach(b => {
	    const info = BUILDINGS.zombieCommandCenter.getUpgradeInfo(b.level);
	    if (info && typeof info.effect.maxZombieCapBonus === 'number') {
		  bonusTotal += info.effect.maxZombieCapBonus;
	    }
	  });
	  // åˆæ­¥ä¸Šé™ï¼åŸºæœ¬ä¸Šé™åŠ ä¸Šæ‰€æœ‰åŠ æˆ
	  let effectiveCap = baseCap + bonusTotal;

	  // å¦‚æœ BTR äº‹ä»¶è™•æ–¼æ¿€æ´»ç‹€æ…‹ï¼Œå‰‡æ ¹æ“šæ‹–æ‹‰æ©Ÿå» çš„ btrZombieMaxBonus æ¯”ä¾‹é€²ä¸€æ­¥æå‡ä¸Šé™
	  if (isBTRActive) {
	    const garages = gameState.buildings.filter(b =>
		  b && b.type.toLowerCase() === "armoredgarage"
	    );
	    garages.forEach(b => {
		  const info = BUILDINGS.armoredGarage.getUpgradeInfo(b.level);
		  if (info && typeof info.effect.btrZombieMaxBonus === 'number') {
		    // æ­¤è™•æˆ‘å€‘æŒ‰æ¯”ä¾‹å¢åŠ ä¸Šé™ï¼Œä¾‹å¦‚ bonus 0.10 å°±å¢åŠ  10%ï¼š
		    effectiveCap += Math.floor(effectiveCap * info.effect.btrZombieMaxBonus);
		  }
	    });
	  }
	  // æœ€å¾Œï¼Œè‹¥æœ€çµ‚è¨ˆç®—çš„åƒµå°¸å¢åŠ æ•¸é‡è¶…é effectiveCapï¼Œå‰‡è¿”å›ä¸Šé™å€¼
	  if (finalZombieChange > effectiveCap) {
	    return effectiveCap;
	  }
	  return finalZombieChange;
	}



	// å®šç¾©è³‡æºåç¨±çš„ä¸­æ–‡æ˜ å°„å°è±¡

	function generateExplorationResult(teamSize) {
	  // åŸæœ‰éš¨æ©Ÿç”Ÿæˆéƒ¨åˆ†
	  const location = LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)];
	  const resourceTypes = ['food', 'materials', 'weapons', 'tech'];
	  const resource = resourceTypes[Math.floor(Math.random() * resourceTypes.length)];
	  const rarity = weightedRandomRarity(teamSize);
	  const baseAmount = Math.floor(Math.random() * 5) + 5;
	  
	  const randFactor = 0.95 + Math.random() * 0.1;
	  // åŸä¾†ä½¿ç”¨å°æ•¸å¢é•·ï¼š
	  // const multiplier = 1 + 0.3 * Math.log(teamSize + 1);
	  // const computed = applyRarityMultiplier(baseAmount, rarity) * multiplier;
	  // const amount = convertProduction(computed);
	  const computed = applyRarityMultiplier(baseAmount, rarity);
	  const amount = convertProduction(computed);
	  const itemName = getRandomItemName(resource);
	  const modifier = getRandomModifier(resource);
	  
	  // èª¿ç”¨ generateZombieChange å®šç¾©ï¼Œè¨ˆç®—æ¢ç´¢å¯èƒ½å°è‡´çš„åƒµå°¸å¢åŠ æˆ–æå¤±
	  const adjustedZombieChange = generateZombieChange(teamSize);
	  
	  // è¿”å›çµæœæ™‚ï¼Œåˆ©ç”¨ resourceMapping å°‡è‹±æ–‡è³‡æºåç¨±è½‰ç‚ºä¸­æ–‡é¡¯ç¤ºï¼Œä½†å…§éƒ¨ä»ä¿æŒ resource ç‚ºè‹±æ–‡
	  return {
		resource,
		amount,
		rarity,
		zombieChange: adjustedZombieChange,
		item: `${modifier.name} ${itemName}`,
		log: {
		  text: `æ¢ç´¢ ${location} ç²å¾— ${rarityMapping[rarity]} ${modifier.name} ${itemName} +${amount} ${resourceMapping[resource] || resource}`,
		  zombieText: adjustedZombieChange > 0
			? `âš¡ ç²å¾— ${adjustedZombieChange} åƒµå°¸`
			: adjustedZombieChange < 0
			  ? `â˜ ï¸ æå¤± ${Math.abs(adjustedZombieChange)} åƒµå°¸`
			  : null,
		  rarity
		}
	  };
	}




	
	/**
	 * æ ¹æ“šé¡å‹å’Œæ•¸é‡ç”Ÿæˆæ¢ç´¢äº‹ä»¶ä¸­çš„åƒµå°¸è®ŠåŒ–æè¿°
	 * @param {string} type - "increase" æˆ– "decrease"
	 * @param {number} quantity - è®ŠåŒ–çš„åƒµå°¸æ•¸é‡ï¼ˆæ­£æ•¸ï¼Œè‹¥æ¸›å°‘å‰‡å‚³å…¥çµ•å°å€¼ï¼‰
	 * @returns {string} - æ ¼å¼åŒ–çš„æè¿°å­—ç¬¦ä¸²
	 */
	function generateZombieEventDescription(type, quantity) {
	  // éš¨æ©Ÿé¸ç”¨ä¸€å€‹åœ°é»
	  const location = LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)];
	  
	  if (type === "increase") {
		const encounter = ZOMBIE_ENCOUNTER_POOL[Math.floor(Math.random() * ZOMBIE_ENCOUNTER_POOL.length)];
		return `ä½ æ´¾å‡ºçš„åƒµå°¸åœ¨ ${location} é‡åˆ° ${encounter}ï¼Œâš¡ç²å¾— ${quantity} åƒµå°¸ã€‚`;
	  } else if (type === "decrease") {
		const disaster = ZOMBIE_DISASTER_POOL[Math.floor(Math.random() * ZOMBIE_DISASTER_POOL.length)];
		return `ä½ æ´¾å‡ºçš„åƒµå°¸åœ¨ ${location} é­é‡ ${disaster}ï¼Œâ˜ ï¸æå¤± ${quantity} åƒµå°¸ã€‚`;
	  } else {
		return "";
	  }
	}


    /***** è¼”åŠ©å‡½æ•¸ *****/
    function convertProduction(val) {
      return (val > 0 && val < 1) ? 1 : Math.floor(val);
    }
    function formatNumber(num) {
	  if (num === null || num === undefined || isNaN(num)) return "0";
	  if (num < 10000) {
		return num.toFixed(0); // å°æ–¼ 1 è¬æ™‚ä¿ç•™ 2 ä½å°æ•¸
	  } else if (num < 1e8) {  // 1e8 ç´„ç­‰æ–¼ 1 å„„
		return (num / 1e4).toFixed(2) + "è¬";
	  } else if (num < 1e12) {
		return (num / 1e8).toFixed(2) + "å„„";
	  } else {
		return num.toExponential(2); // è¶…å¤§æ•¸å‰‡ç”¨ç§‘å­¸è¨˜æ•¸æ³•ï¼ˆä¸€å€‹ç°¡åŒ–ç‰ˆï¼‰
	  }
	}

    function canAfford(cost) {
      return Object.entries(cost).every(([res, val]) => gameState.resources[res] >= val);
    }
    function payCost(cost) {
      Object.entries(cost).forEach(([res, val]) => {
        gameState.resources[res] -= val;
      });
    }
    function getRandomItemName(resource) {
      return ITEM_DATA[resource].names[Math.floor(Math.random() * ITEM_DATA[resource].names.length)];
    }
    function getRandomModifier(resource) {
      const modifiers = ITEM_DATA[resource].modifiers;
      return modifiers[Math.floor(Math.random() * modifiers.length)];
    }

    /***** æ¢ç´¢éšŠè‡ªå‹•é‡åˆ†é…äº‹ä»¶ *****/
    
  
    /***** å…µç‡Ÿç”¢ç”Ÿåƒµå°¸ *****/
    function produceZombies() {
      const production = gameState.buildings.reduce((sum, b) => {
        if (b && b.type === 'barracks') {
           const info = BUILDINGS.barracks.getUpgradeInfo(b.level);
		  // å¦‚æœ info å­˜åœ¨ï¼Œä½¿ç”¨å…¶ effect.productionï¼›å¦å‰‡è¦–ç‚º 0
		  const prod = info && info.effect && info.effect.production ? info.effect.production : 0;
		  return sum + prod;
		}
		return sum;
	  }, 0);
	  const newZombies = Math.floor(production);
      if (newZombies > 0) {
        let gained = newZombies;
        let toExploration = Math.round(gained * 0.7);
        let toFarming = Math.round(gained * 0.1);
        let toRecycling = Math.round(gained * 0.1);
        let toResearch = Math.round(gained * 0.1);
        let sum = toExploration + toFarming + toRecycling + toResearch;
        if(sum < gained) {
          toExploration += (gained - sum);
        } else if(sum > gained) {
          toExploration -= (sum - gained);
        }
        gameState.totalZombies += gained;
        gameState.allocations.exploration += toExploration;
        gameState.allocations.farming += toFarming;
        gameState.allocations.recycling += toRecycling;
        gameState.allocations.research += toResearch;
        addEventLog(`å…µç‡Ÿç”Ÿç”¢ï¼šæ–°å¢âš¡ ${gained} åƒµå°¸ï¼Œæ¢ç´¢+ ${toExploration}, ç¨®æ¤+${toFarming}, å›æ”¶+${toRecycling}, ç§‘ç ”+${toResearch}`, 'uncommon', 'zombie');
      }
      updateResourceDisplays();
    }
  
	   // å†›æ¢°å·¥åŠç”Ÿäº§æ­¦å™¨
	function produceWeaponsFromArmories() {
	  // å–å¾—æ‰€æœ‰è»æ¢°å·¥åŠ
	  const armories = gameState.buildings.filter(b => b && b.type === 'armory');
	  if (armories.length === 0) return;

	  // è¨ˆç®—ç§‘ç ”å’Œå›æ”¶éƒ¨é–€çš„äººæ•¸å¹³å‡å€¼
	  let researchCount = gameState.allocations.research || 0;
	  let recyclingCount = gameState.allocations.recycling || 0;
	  let avg = (researchCount + recyclingCount) / 2;

	  // æ ¹æ“šåŠ æˆå…¬å¼è¨ˆç®—å€ç‡
	  let baseMultiplier = Math.pow(avg, 0.85);
	  let bonusMultiplier = Math.pow(1.0005, avg);
	  let productionBonus = baseMultiplier * bonusMultiplier;

	  // éæ­·æ¯å€‹è»æ¢°å·¥åŠç´¯è¨ˆç”Ÿç”¢
	  let totalProduction = 0;
	  armories.forEach(b => {
		const config = BUILDINGS.armory;
		const upgradeInfo = config.getUpgradeInfo(b.level);
		if (upgradeInfo && upgradeInfo.effect && upgradeInfo.effect.weapons) {
		  totalProduction += upgradeInfo.effect.weapons * productionBonus;
		}
	  });

	  const roundedProduction = Math.round(totalProduction);
	  // è¨­å®šå–®æ¬¡ç”Ÿç”¢ä¸Šé™ï¼šåŸºç¤ç”¢é‡ä¸Šé™ç‚º 99000000
	  const productionCap = 99000000;
	  const limitedProduction = Math.min(roundedProduction, productionCap);

	  if (limitedProduction > 0) {
		// 5% æ©Ÿç‡è§¸ç™¼ç‰¹æ®Šï¼ˆè©æ¢ï¼‰ç”Ÿç”¢
		if (Math.random() < 0.05) {
		  const modifier = getRandomModifier('weapons');
		  // ä»¥æœ‰é™åˆ¶çš„åŸºç¤ç”Ÿç”¢å€¼ä½œç‚ºåŸºæ•¸ï¼Œå†ä¹˜ä»¥è©æ¢æ•ˆæœï¼š
		  const modProduction = Math.round(limitedProduction * modifier.effect);
		  // ä½¿ç”¨é¡è‰²æ ¹æ“šè©æ¢æ•ˆæœåˆ†é¡
		  const modColor = (modifier.effect < 1) ? "var(--junk)" : "var(--sealed)";
		  const styledItemName = `<span style="color: ${modColor}; font-weight: bold;">${modifier.name} ${getRandomItemName('weapons')}</span>`;
		  
		  logResource('weapons', styledItemName, modProduction, "production");
		  gameState.resources.weapons += modProduction;
		} else {
		  logResource('weapons', getRandomItemName('weapons'), limitedProduction, "production");
		  gameState.resources.weapons += limitedProduction;
		}
	  }
	  
	  updateResourceDisplays();
	}




    function handleExploration() {
	  const teamSize = gameState.allocations.exploration;
	  if (teamSize < 1) return;
	  const baseMultiplier = Math.pow(teamSize, 0.85);
	  const bonusMultiplier = Math.pow(1.0005, teamSize);
	  const effectiveMultiplier = baseMultiplier * bonusMultiplier;

	  const result = generateExplorationResult(teamSize);
	  let amountAfterMultiplier = Math.floor(result.amount * effectiveMultiplier);
  
	  // è¨­å®šå–®æ¬¡è³‡æºç²å¾—ä¸Šé™ï¼ˆä¾‹å¦‚ productionCap ç‚º 990000ï¼‰
	  const normalMultiplier = 2.5;
	  const baseCapFactor = 99000000 / normalMultiplier; // 3960000
	  const rarityMultipliers = {
		  junk: 1,
		  old: 1.5,
		  damaged: 2,
		  common: 2.5,
		  decent: 3,
		  sealed: 3.5,
		  selected: 4,
		  tested: 5,
		  rare: 6,
		  epic: 8,
		  legendary: 10,
		  divine: 12
	  };
	  const rarityCap = baseCapFactor * (rarityMultipliers[result.rarity] || normalMultiplier);
      amountAfterMultiplier = Math.min(amountAfterMultiplier, rarityCap);
	  
	  result.amount = amountAfterMultiplier;
	  result.log.text = result.log.text.replace(/\+\d+/, "+" + result.amount);
	  
	  // å°‡ç²å¾—æ•¸é‡ç´¯åŠ åˆ°å°æ‡‰è³‡æºä¸Š;
	  gameState.resources[result.resource] += result.amount;
	  addEventLog(result.log.text, result.rarity, "exploration");
	  
	  // æ›´æ–°æ”¶è—è¨˜éŒ„
	  if (result.item) {
		const key = `${result.item}_${result.rarity}`;
	    if (collectedItems[key]) {
		  collectedItems[key].count += 1;
	    } else {
	      collectedItems[key] = { count: 1, rarity: result.rarity, name: result.item };
	    }
      }
	  
	  // è™•ç†åƒµå°¸è®ŠåŒ–æè¿°ï¼ˆå³ä½¿çµæœå¯èƒ½ç‚º0ä¹Ÿæœƒç”Ÿæˆ logï¼‰
	  if (result.zombieChange !== 0) {
		let desc = "";
		if (result.zombieChange > 0) {
		  triggerZombieEntry();
		  const gain = result.zombieChange;
		  const toExploration = Math.round(gain * 0.5);
		  const toFarming = Math.round(gain * 0.3);
		  const toRecycling = Math.round(gain * 0.1);
		  const toResearch = gain - toExploration - toFarming - toRecycling;
		  gameState.totalZombies += gain;
		  gameState.allocations.exploration += toExploration;
		  gameState.allocations.farming += toFarming;
		  gameState.allocations.recycling += toRecycling;
		  gameState.allocations.research += toResearch;
		  const encounterMessage = generateZombieEventDescription("increase", gain);
		  const distributionMessage = `æ¢ç´¢ +${toExploration}ï¼Œç¨®æ¤ +${toFarming}ï¼Œå›æ”¶ +${toRecycling}ï¼Œç§‘ç ” +${toResearch}`;
		  desc = encounterMessage + distributionMessage;
		} else {
		  triggerZombieLying();
		  const loss = Math.abs(result.zombieChange);
		  desc = generateZombieEventDescription("decrease", loss);
		  gameState.totalZombies = Math.max(0, gameState.totalZombies - loss);
		  gameState.allocations.exploration = Math.max(0, gameState.allocations.exploration - loss);
		}
		addEventLog(desc, "uncommon", "zombie");
	  }
	  
	  updateAllDisplays();
	}

  
    /***** è³‡æºç”Ÿç”¢ *****/
    function produceResources(dept, resource, baseRate) {
      const count = gameState.allocations[dept];
      if (count <= 0) return;
      const baseMultiplier = Math.pow(count, 0.85);
	  const bonusMultiplier = Math.pow(1.0005, count);
	  const effectiveMultiplier = baseMultiplier * bonusMultiplier;
      const computed = baseRate * effectiveMultiplier * gameState.efficiency[resource];
      const amount = convertProduction(computed);
	  
	  // è¨­ç½®å–®æ¬¡ç”Ÿç”¢ä¸Šé™
	  const productionCap = 99000000;
	  // é™åˆ¶åŸå§‹ç”Ÿç”¢é‡
	  const limitedAmount = Math.min(amount, productionCap);
	  
      if (Math.random() < 0.05) {
        const modifier = getRandomModifier(resource);
        const modAmount = convertProduction(limitedAmount * modifier.effect);
		const modColor = (modifier.effect < 1) ? "var(--junk)" : "var(--sealed)";
		const styledItemName = `<span style="color: ${modColor}; font-weight: bold;">${modifier.name} ${getRandomItemName(resource)}</span>`;
        logResource(resource, styledItemName, modAmount, "production");
		} else {
		  logResource(resource, getRandomItemName(resource), limitedAmount, "production");
		}
      gameState.resources[resource] += limitedAmount;
	  
	  // æ–°å¢éš¨æ©Ÿäº‹ä»¶ï¼šåƒµå°¸æå¤±ï¼ˆåƒ…å°ç¨®æ¤ã€å›æ”¶ã€ç§‘ç ”éƒ¨é–€ï¼‰
	  if (dept === "farming" || dept === "recycling" || dept === "research") {
	  const baseEventProbability = 0.005; // åŸºç¤äº‹æ•…è§¸ç™¼æ©Ÿç‡
	  // æ ¹æ®éƒ¨é–€åƒµå°¸æ•¸é‡ï¼Œåœ¨åŸºç¤æ¦‚ç‡ä¸ŠåŠ æˆï¼Œå‡è¨­æ¯éš»åƒµå°¸å¢åŠ  0.01 çš„æ¦‚ç‡
	  const deptZombies = gameState.allocations[dept] || 0;
	  let eventProbability = baseEventProbability + (deptZombies * 0.001);
	  // é˜²æ­¢æ©Ÿç‡è¶…é 100%
	  eventProbability = Math.min(eventProbability, 0.8);

	  let lossMultiplier = 1;
	  
	  // å¦‚å®‰å…¨ä¸­å¿ƒå­˜åœ¨ï¼Œå‰‡æŒ‰å…¶æ•ˆæœé™ä½äº‹æ•…è§¸ç™¼æ©Ÿç‡
	  const safety = gameState.buildings.find(b => b && b.type.toLowerCase() === "safetycenter");
	  if (safety) {
		const safetyInfo = BUILDINGS.safetyCenter.getUpgradeInfo(safety.level);
		const reduction = safetyInfo.effect.accidentReduction; // å¦‚é™å¹… 0.05 è¡¨ç¤ºäº‹æ•…æ©Ÿç‡ä¹˜ä»¥ 0.95
		eventProbability *= (1 - reduction);
		lossMultiplier = (1 - reduction);
	  }
	  
	  if (Math.random() < eventProbability) {
		// éš¨æ©Ÿæå¤±æ¯”ä¾‹ä»‹æ–¼ 5% åˆ° 80%
		const lossPercentage = 0.01 + Math.random() * 0.8;
		// æ ¹æ“šè©²éƒ¨é–€åƒµå°¸æ•¸è¨ˆç®—æå¤±é‡ï¼ˆlossMultiplier å¯åœ¨æœªä¾†ç”¨æ–¼é€²ä¸€æ­¥èª¿æ•´æå¤±é‡ï¼‰
		let lost = Math.floor(gameState.allocations[dept] * lossPercentage * lossMultiplier);
		// è‹¥è¨ˆç®—å¾Œçš„æå¤±ç‚º 0ï¼Œä½†éƒ¨é–€ä¸­ä»æœ‰åƒµå°¸ï¼Œæœ€ä½å¯ä»¥è€ƒæ…®æå¤± 0ï¼ˆæˆ–ä¿æŒ 0 è¦–å…·é«”éœ€æ±‚è€Œå®šï¼‰
		if (lost < 1 && gameState.allocations[dept] > 0) {
		  lost = 0;
		}
		gameState.allocations[dept] -= lost;
		gameState.totalZombies -= lost;
		
		let eventMsg = "";
		if (dept === "farming") {
		  eventMsg = `é›†é«”é£Ÿç‰©ä¸­æ¯’ï¼šç¨®æ¤éƒ¨é–€â˜ ï¸æå¤± ${lost} åƒµå°¸ (${(lossPercentage * 100).toFixed(1)}%)`;
		} else if (dept === "recycling") {
		  eventMsg = `åƒµå°¸æ“ä½œä¸ç•¶ï¼šå›æ”¶éƒ¨é–€â˜ ï¸æå¤± ${lost} åƒµå°¸ (${(lossPercentage * 100).toFixed(1)}%)`;
		} else if (dept === "research") {
		  eventMsg = `è©¦åŠ‘é€£ç’°çˆ†ç‚¸ï¼šç§‘ç ”éƒ¨é–€â˜ ï¸æå¤± ${lost} åƒµå°¸ (${(lossPercentage * 100).toFixed(1)}%)`;
		}
		addEventLog(eventMsg, "warning", "production", true);
		triggerProductionAccident(dept);
	  }
	}	  
      updateResourceDisplays();
    }
	
	function updateTechConsumptionFromRareVault() {
	  let totalTechRate = 0;
	  // é¸å–æ‰€æœ‰çç¨€åº«
	  const rareVaultBuildings = gameState.buildings.filter(b => b && b.type.toLowerCase() === "rarevault");
	  rareVaultBuildings.forEach(b => {
		const info = BUILDINGS.rarevault.getUpgradeInfo(b.level);
		if (info && typeof info.effect.techConsumptionRate !== "undefined") {
		  totalTechRate += info.effect.techConsumptionRate;
		}
	  });
	  
	  // æ¶ˆè€—é‡ = ç´¯è¨ˆçš„techæ¶ˆè€—ç‡ * éŠæˆ²ä¸­ç¸½åƒµå°¸æ•¸
	  const consumption = totalTechRate * gameState.totalZombies;
	  
	  // å¾ç§‘æŠ€è³‡æºä¸­æ‰£é™¤ï¼Œä¸¦ä¿æŒä¸å°æ–¼0
	  gameState.resources.tech = Math.max(0, gameState.resources.tech - consumption);
	  
	  updateResourceDisplays();
	}


	function updateSafetyCenterConsumption() {
	  // æª¢æŸ¥å®‰å…¨ä¸­å¿ƒæ˜¯å¦å­˜åœ¨
	  const safety = gameState.buildings.find(b => b && b.type.toLowerCase() === "safetycenter");
	  if (!safety) return;
	  
	  const safetyInfo = BUILDINGS.safetyCenter.getUpgradeInfo(safety.level);
	  const consumptionRate = safetyInfo.effect.resourceConsumptionRate; // æ¯ç§’æ¶ˆè€—ç™¾åˆ†æ¯”ï¼Œå¦‚åŸºç¤ 0.05ï¼Œæœ€é«˜ 0.4
	  
	  // æ ¹æ“šåƒµå°¸ç¸½æ•¸ï¼Œå°å››ç¨®è³‡æºè¨ˆç®—æ¶ˆè€—é‡
	  const resourceList = ["food", "materials", "weapons", "tech"];
	  resourceList.forEach(res => {
		// æ¶ˆè€—é‡ = consumptionRate * totalZombies
		const toConsume = consumptionRate * gameState.totalZombies;
		gameState.resources[res] = Math.max(0, gameState.resources[res] - toConsume);
	  });
	  
	  updateResourceDisplays();
	}
	function updateBarracksWeaponConsumption() {
	  // ç¯©é¸å‡ºæ‰€æœ‰â€œbarracksâ€å»ºç¯‰
	  const barracksBuildings = gameState.buildings.filter(b => b && b.type.toLowerCase() === "barracks");
	  if (barracksBuildings.length === 0) return;
	  
	  let totalConsumption = 0;
	  
	  // å°æ¯æ£Ÿåƒµå°¸å…µç‡Ÿä¾æ“šå…¶ç­‰ç´šè¨ˆç®—æ¶ˆè€—ç‡ï¼ˆå– getUpgradeInfo è¨ˆç®—çš„æ¶ˆè€—ç‡ï¼‰
	  barracksBuildings.forEach(b => {
		// è‹¥åƒµå°¸å…µç‡Ÿçš„å‡ç´šè³‡è¨Šå¯æ±‚å¾—ï¼Œå‰‡è®€å–è©²æ£Ÿå»ºç¯‰çš„æ­¦å™¨è³‡æºæ¶ˆè€—ç‡
		const upgradeInfo = (typeof BUILDINGS[b.type].getUpgradeInfo === "function") 
							 ? BUILDINGS[b.type].getUpgradeInfo(b.level)
							 : null;
		if (upgradeInfo && upgradeInfo.effect.weaponConsumptionRate) {
		  totalConsumption += upgradeInfo.effect.weaponConsumptionRate;
		}
	  });
	  
	  // ä»¥ç¸½åƒµå°¸æ•¸ç‚ºåŸºç¤ï¼Œè¨ˆç®—ç´¯è¨ˆçš„æ­¦å™¨è³‡æºæ¶ˆè€—é‡
	  // ä¾‹å¦‚ï¼šç¸½æ¶ˆè€— = totalConsumption * gameState.totalZombies
	  const consumption = totalConsumption * gameState.totalZombies;
	  
	  // å¾ç©å®¶çš„æ­¦å™¨è³‡æºä¸­æ‰£é™¤
	  gameState.resources.weapons = Math.max(0, gameState.resources.weapons - consumption);
	  
	  // æ›´æ–°è³‡æºé¡¯ç¤º
	  updateResourceDisplays();
	}


    function checkResourceCap() {
	// æª¢æŸ¥æ‰€æœ‰è³‡æºæ˜¯å¦å‡é”åˆ° RESOURCE_CAP
	  if (
		gameState.resources.food >= RESOURCE_CAP &&
		gameState.resources.materials >= RESOURCE_CAP &&
		gameState.resources.weapons >= RESOURCE_CAP &&
		gameState.resources.tech >= RESOURCE_CAP
	  ) {
		// é‡ç½®æ‰€æœ‰è³‡æºç‚º RESET_VALUE
		gameState.resources.food = RESET_VALUE;
		gameState.resources.materials = RESET_VALUE;
		gameState.resources.weapons = RESET_VALUE;
		gameState.resources.tech = RESET_VALUE;
		
		// ç´¯åŠ æ¯ä¸€é …è³‡æºçš„é‡ç½®æ¬¡æ•¸
		gameState.resetCounts.food++;
		gameState.resetCounts.materials++;
		gameState.resetCounts.weapons++;
		gameState.resetCounts.tech++;
		
		gameState.resetCounter++; // å¢åŠ ä¸€æ¬¡é‡ç½®è¨ˆæ•¸

		// æ›´æ–°è³‡æºå¡çš„é‚Šæ¡†æ¨£å¼
		updateResourceCardsBorder();
		updateResetCycleDisplay()
	  }
	}

    /***** é£Ÿç‰©æ¶ˆè€—èˆ‡åƒµå°¸æå¤± *****/
    function updateFoodConsumption() {
      let foodNeeded = Math.floor(gameState.totalZombies * 3);
      if (foodNeeded > 0 && gameState.resources.food >= foodNeeded) {
        gameState.resources.food -= foodNeeded;
        addEventLog(`æ¶ˆè€—é£Ÿç‰©ï¼š${foodNeeded}`, 'common');
      } else if (gameState.resources.food <= 0) {
        let removeNum = Math.ceil(gameState.totalZombies * 1);
        if (removeNum < 1) removeNum = 1;
        let priorities = ['exploration', 'research', 'recycling', 'farming'];
        for (let dept of priorities) {
          let available = gameState.allocations[dept] || 0;
          if (available >= removeNum) {
            gameState.allocations[dept] -= removeNum;
            gameState.totalZombies -= removeNum;
            addEventLog(`é£Ÿç‰©è€—ç›¡ï¼Œ${dept}å¤±å» ${removeNum} åƒµå°¸`, 'epic');
            removeNum = 0;
            break;
          } else {
            gameState.totalZombies -= available;
            addEventLog(`é£Ÿç‰©è€—ç›¡ï¼Œ${dept}å¤±å» ${available} åƒµå°¸`, 'epic');
            removeNum -= available;
            gameState.allocations[dept] = 0;
          }
        }
		gameState.totalZombies = Math.max(0, gameState.totalZombies);
        if (gameState.totalZombies <= 0) {
          addEventLog("æ‰€æœ‰åƒµå°¸å‡å·²æ­»äº¡ï¼ŒéŠæˆ²çµæŸï¼", "epic");
          clearInterval(gameLoopInterval);
        }
      }
      updateResourceDisplays();
    }
  
    /***** æ›´æ–°é¡¯ç¤º *****/
    function updateResourceDisplays() {
	  gameState.totalZombies = Math.max(0, gameState.totalZombies);
      document.getElementById("foodCount").textContent = formatNumber(gameState.resources.food);
      document.getElementById("materialsCount").textContent = formatNumber(gameState.resources.materials);
      document.getElementById("weaponsCount").textContent = formatNumber(gameState.resources.weapons);
      document.getElementById("techCount").textContent = formatNumber(gameState.resources.tech);
      document.getElementById("totalZombies").textContent = formatNumber(gameState.totalZombies);
      const totalAllocated = gameState.allocations.exploration +
                             gameState.allocations.farming +
                             gameState.allocations.recycling +
                             gameState.allocations.research;
      document.getElementById("pendingZombies").textContent = formatNumber(gameState.totalZombies - totalAllocated);
    
	// æª¢æŸ¥ä¸¦ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰é‡ç½®è³‡æº
	checkResourceCap();
	}
  
    function updateEfficiencyDisplays() {
      document.getElementById("exploreEfficiency").textContent = "æ•ˆç‡: " + Math.floor(gameState.efficiency.exploration * 100) + "%";
      document.getElementById("farmEfficiency").textContent = "+" + Math.floor((gameState.efficiency.food - 1) * 100) + "%";
      document.getElementById("recycleEfficiency").textContent = "+" + Math.floor((gameState.efficiency.materials - 1) * 100) + "%";
      document.getElementById("researchEfficiency").textContent = "+" + Math.floor((gameState.efficiency.tech - 1) * 100) + "%";
    }
  
    function updateAllDisplays() {
      updateResourceDisplays();
      document.getElementById("explorationCount").textContent = gameState.allocations.exploration;
      document.getElementById("farmingCount").textContent = gameState.allocations.farming;
      document.getElementById("recyclingCount").textContent = gameState.allocations.recycling;
      document.getElementById("researchCount").textContent = gameState.allocations.research;
      updateEfficiencyDisplays();
      initBuildingGrid();
	  updateZombieSearchSprite();
	  checkBuildingAchievements();
    
    }
	/***** æˆå°±ç³»çµ± *****/
	const achievementRules = {
	  collectionCompleteness: [
		{ threshold: 0.001, title: "é€™æ˜¯å•¥ï¼Ÿ", level: 1 },
		{ threshold: 0.1, title: "å¥½åƒèƒ½ç”¨", level: 2 },
		{ threshold: 0.5, title: "æ‹¾è’è€…", level: 3 },
		{ threshold: 1, title: "æ‹¾è’é«˜æ‰‹", level: 4 },
		{ threshold: 5, title: "æœ«æ—¥æ¡è³¼å“¡", level: 5 },
		{ threshold: 10, title: "æ¸…ç©ºè²¨æ¶ï¼", level: 6 },
		{ threshold: 30, title: "ç‰©è³‡æ”¶é›†è€…", level: 7 },
		{ threshold: 50, title: "æœ«æ—¥æ”¶è—å®¶", level: 8 },
		{ threshold: 70, title: "æœ«æ—¥æ”¶é›†ç‹‚", level: 9 },
		{ threshold: 85, title: "å„ªç§€ç‡", level: 10 },
		{ threshold: 90, title: "å¼·è¿«ç—‡", level: 11 },
		{ threshold: 100, title: "é ‚ç´šæœåˆ®è€…", level: 12 }
	  ],
	  divineItems: [
		{ threshold: 1, title: "ç‹—å±é‹", level: 1 },
		{ threshold: 5, title: "äº®é–ƒé–ƒ", level: 2 },
		{ threshold: 10, title: "é‡‘å…‰é–ƒé–ƒ", level: 3 },
		{ threshold: 50, title: "é‡‘ç¢§è¼ç…Œ", level: 4 },
		{ threshold: 100, title: "å¤©é¸ä¹‹å­", level: 5 },
		{ threshold: 300, title: "é‘’å¯¶å°ˆå®¶", level: 6 },
		{ threshold: 500, title: "è¢«çœ·é¡§è€…", level: 7 },
		{ threshold: 666, title: "æƒ¡é­”çš„ç¥ç¦", level: 8 },
		{ threshold: 750, title: "ç§‘å­¸ç„¡æ³•è§£é‡‹", level: 9 },
		{ threshold: 900, title: "å‘½é‹çš„å®‰æ’", level: 10 },
		{ threshold: 999, title: "å€’ç«‹æƒ¡é­”çš„ç¥ç¦", level: 11 },
		{ threshold: 1200, title: "é€™æœ‰å•¥ç¨€å¥‡çš„ï¼Ÿ", level: 12 }
	  ],
	  totalZombies: [
		{ threshold: 100, title: "åƒµå°¸æ”¶å®¹è€…", level: 1 },
		{ threshold: 200, title: "åƒµå°¸å°éšŠ", level: 2 },
		{ threshold: 300, title: "åƒµå°¸ä¸­éšŠ", level: 3 },
		{ threshold: 400, title: "åˆå…·è¦æ¨¡", level: 4 },
		{ threshold: 500, title: "åŠ å¼·ç‡Ÿ", level: 5 },
		{ threshold: 1000, title: "ç©å°‘æˆå¤š", level: 6 },
		{ threshold: 1500, title: "èšè½é ˜ä¸»", level: 7 },
		{ threshold: 3000, title: "æ‰€å‘æŠ«é¡", level: 8 },
		{ threshold: 5000, title: "åˆæˆæ—…", level: 9 },
		{ threshold: 8000, title: "äººå¤šå°¸çœ¾", level: 10 },
		{ threshold: 10000, title: "ä¸€æ–¹è±ªå¼·", level: 11 },
		{ threshold: 100000, title: "å€åŸŸéœ¸ä¸»", level: 12 }
	  ],
	  btrTriggers: [
		{ threshold: 1, title: "è£ç”²ä¿è­·", level: 1 },
		{ threshold: 5, title: "ç«åŠ›æ”¯æ´", level: 2 },
		{ threshold: 50, title: "è£ç”²å…ˆé‹’", level: 3 },
		{ threshold: 100, title: "æ©Ÿæ¢°åŒ–åƒµå°¸", level: 4 },
		{ threshold: 500, title: "å°¸å¦å”åŒ", level: 5 },
		{ threshold: 1000, title: "æ©Ÿç‚®ä»™äºº", level: 6 },
		{ threshold: 5000, title: "è£ç”²çŒ›è™", level: 7 },
		{ threshold: 10000, title: "éŠ…å¢»éµå£", level: 8 },
		{ threshold: 20000, title: "å …ä¸å¯æ‘§", level: 9 },
		{ threshold: 50000, title: "è£ç”²å¤§è»", level: 10 },
		{ threshold: 100000, title: "é‹¼éµå°¸æµ", level: 11 },
		{ threshold: 200000, title: "é‡‘å±¬åœ°ç„", level: 12 }
	  ]
	};

	// ç¨€æœ‰åº¦æ˜ å°„ï¼šæ ¹æ“šå‡ç´šç­‰ç´šè¿”å›ç¨€æœ‰åº¦
	function getRarityForAchievement(level) {
	  if (level <= 2) return "common";
	  else if (level <= 4) return "uncommon";
	  else if (level <= 6) return "rare";
	  else if (level <= 8) return "epic";
	  else if (level <= 10) return "legendary";
	  else return "divine";
	}

	// å…¨å±€é™£åˆ—ä¿å­˜å·²ç²å¾—æˆå°±
	let unlockedAchievements = []; // æ¯é …å½¢å¦‚ { category, level, title, rarity, unlockedTime }

	function getAchievementDetails(category, rule) {
	  switch (category) {
		case "collectionCompleteness":
		  return `é”åˆ° ${rule.threshold}%æ”¶è—ç‡`;
		case "divineItems":
		  return `ç²å¾— ${rule.threshold}ä»¶ç¥è–ç‰©å“`;
		case "totalZombies":
		  return `é”åˆ° ${rule.threshold}éš»åƒµå°¸`;
		case "btrTriggers":
		  return `å‘¼å«BTR ${rule.threshold}æ¬¡`;
		default:
		  return "";
	  }
	}
	// æª¢æŸ¥å»ºç¯‰æˆå°±æ˜¯å¦å·²è§£é–ï¼ˆæ ¹æ“š category "building" èˆ‡æˆå°± title ä¾†åˆ¤æ–·ï¼‰
	function isBuildingAchievementUnlocked(title) {
	  return unlockedAchievements.some(a => a.category === "building" && a.title === title);
	}

	// è§£é–å»ºç¯‰é¡æˆå°±ã€‚åƒæ•¸ï¼štitleï¼ˆæˆå°±åç¨±ï¼‰ã€detailsï¼ˆæˆå°±èªªæ˜ï¼‰ã€rarityï¼ˆæˆå°±ç¨€æœ‰åº¦æ¨™è¨˜ï¼Œä¾‹å¦‚ "uncommon"ã€"rare"ã€"legendary"ï¼‰
	function awardBuildingAchievement(title, details, level) {
	  if (isBuildingAchievementUnlocked(title)) return;
	  const rarity = getRarityForAchievement(level);
	  const achievement = {
		category: "building",
		level: level,
		title: title,
		details: details,
		rarity: rarity,
		unlockedTime: Date.now()
	  };
	  unlockedAchievements.push(achievement);
	  if (!gameState.unlockedAchievements) {
		gameState.unlockedAchievements = [];
	  }
	  gameState.unlockedAchievements.push(achievement);
	  addEventLog(`æˆå°±è§£é–ï¼š[${title}] (${details})`, rarity, "achievement");
	  updateAchievementsUI();
	}
	// æª¢æŸ¥æ˜¯å¦å·²è§£é–éæŸé …å»ºç¯‰æˆå°±
	function isBuildingAchievementUnlocked(title) {
	  return unlockedAchievements.some(a => a.category === "building" && a.title === title);
	}
	// æª¢æŸ¥å»ºç¯‰æˆå°±ï¼šå¦‚æœæ‰€æœ‰ç›®æ¨™æˆå°±å‡å·²è§£é–ï¼Œå‰‡æå‰è¿”å›
	function checkBuildingAchievements() {
	  // è‹¥æ‰€æœ‰å»ºç¯‰æˆå°±å·²è§£é–ï¼Œå°±ä¸å†æª¢æŸ¥
	  if (
		isBuildingAchievementUnlocked("å ±è©±æ©Ÿ") &&
		isBuildingAchievementUnlocked("ĞĞ»Ñ‚Ñ‹Ğ½") &&
		isBuildingAchievementUnlocked("æ­¦è£é€šä¿¡å…µ") &&
		isBuildingAchievementUnlocked("å…¨å‰¯æ­¦è£")
	  ) {
		return;
	  }
	  
	  // æª¢æŸ¥æ˜¯å¦å­˜åœ¨ã€æ‹–æ‹‰æ©Ÿå» ã€‘ï¼ˆå°æ‡‰ armoredgarageï¼‰
	  const hasTractor = gameState.buildings.some(
		b => b && b.type.toLowerCase() === "armoredgarage"
	  );
	  // æª¢æŸ¥æ˜¯å¦å­˜åœ¨ã€è»æ¢°å·¥å» ã€‘ï¼ˆarmoryï¼‰
	  const hasArmory = gameState.buildings.some(
		b => b && b.type.toLowerCase() === "armory"
	  );
	  // æª¢æŸ¥æ˜¯å¦å­˜åœ¨ã€åƒµå°¸æŒ‡æ®ä¸­å¿ƒã€‘ï¼ˆzombiecommandcenterï¼‰
	  const hasZombieCommand = gameState.buildings.some(
		b => b && b.type.toLowerCase() === "zombiecommandcenter"
	  );
	  
	  // æˆå°±ã€Œå ±è©±æ©Ÿã€ï¼šç•¶æ‹–æ‹‰æ©Ÿå» å­˜åœ¨æ™‚
	  if (hasTractor && !isBuildingAchievementUnlocked("å ±è©±æ©Ÿ")) {
		awardBuildingAchievement("å ±è©±æ©Ÿ", "å»ºé€ æ‹–æ‹‰æ©Ÿå» ", "6");
	  }
	  
	  // æˆå°±ã€ŒĞĞ»Ñ‚Ñ‹Ğ½ã€ï¼šç•¶å­˜åœ¨è»æ¢°å·¥å» æˆ–åƒµå°¸æŒ‡æ®ä¸­å¿ƒæ™‚
	  if ((hasArmory || hasZombieCommand) && !isBuildingAchievementUnlocked("ĞĞ»Ñ‚Ñ‹Ğ½")) {
		awardBuildingAchievement("ĞĞ»Ñ‚Ñ‹Ğ½", "å»ºé€ è»æ¢°å·¥å» æˆ–åƒµå°¸æŒ‡æ®ä¸­å¿ƒ", "6");
	  }
	  if (hasTractor &&(hasArmory || hasZombieCommand) && !isBuildingAchievementUnlocked("æ­¦è£é€šä¿¡å…µ")) {
		awardBuildingAchievement("æ­¦è£é€šä¿¡å…µ", "åŒæ™‚æ“æœ‰æ‹–æ‹‰æ©Ÿå» ä»¥åŠè»æ¢°å·¥å» æˆ–åƒµå°¸æŒ‡æ®ä¸­å¿ƒ", "8");
	  }
	  
	  // æˆå°±ã€Œå…¨å‰¯æ­¦è£ã€ï¼šåªæœ‰ç•¶æ‹–æ‹‰æ©Ÿå» ã€è»æ¢°å·¥å» èˆ‡åƒµå°¸æŒ‡æ®ä¸­å¿ƒä¸‰è€…åŒæ™‚å­˜åœ¨æ™‚
	  if (hasTractor && hasArmory && hasZombieCommand && !isBuildingAchievementUnlocked("å…¨å‰¯æ­¦è£")) {
		awardBuildingAchievement("å…¨å‰¯æ­¦è£", "åŒæ™‚æ“æœ‰æ‹–æ‹‰æ©Ÿå» ã€è»æ¢°å·¥å» èˆ‡åƒµå°¸æŒ‡æ®ä¸­å¿ƒ", "10");
	  }
	}

	
	function isAchievementUnlocked(category, level) {
	  return unlockedAchievements.some(a => a.category === category && a.level === level);
	}

	function awardAchievement(category, rule) {
	  if (isAchievementUnlocked(category, rule.level)) {
		return;
	  }
	  let rarity = getRarityForAchievement(rule.level);
	  let details = getAchievementDetails(category, rule);
	  let achievement = {
		category,
		level: rule.level,
		title: rule.title,
		rarity,
		details,
		unlockedTime: Date.now()
	  };
	  // æ°¸ä¹…ä¿å­˜åˆ° gameState
	  if (!gameState.unlockedAchievements) {
		gameState.unlockedAchievements = [];
	  }
	  gameState.unlockedAchievements.push(achievement);
	  unlockedAchievements.push(achievement);
	  addEventLog(`æˆå°±è§£é–ï¼š[${rule.title}] (${category})`, rarity, "achievement");
	  updateAchievementsUI();
	}
	
	/***** (2) ä¿®æ­£ç¥è–ç‰©å“æˆå°±çµ±è¨ˆ *****/
	// æ¯æ¬¡æª¢æŸ¥æˆå°±å‰èª¿ç”¨ï¼Œçµ±è¨ˆ collectedItems ä¸­ç¥è–ç‰©å“çš„ç¸½æ•¸
	function updateDivineItemsCount() {
	  let count = 0;
	  for (let key in collectedItems) {
		if (collectedItems[key].rarity === "divine") {
		  count += collectedItems[key].count;
		}
	  }
	  gameState.divineItemsCount = count;
	}

	function checkAchievements() {
	  updateDivineItemsCount();  // èª¿æ•´ç¥è–ç‰©å“æ•¸é‡
	  let collValue = getCollectionCompletion();
	  achievementRules.collectionCompleteness.forEach(rule => {
		if (collValue >= rule.threshold && !isAchievementUnlocked("collectionCompleteness", rule.level)) {
		  awardAchievement("collectionCompleteness", rule);
		}
	  });
	  let divineCount = gameState.divineItemsCount || 0;
	  achievementRules.divineItems.forEach(rule => {
		if (divineCount >= rule.threshold && !isAchievementUnlocked("divineItems", rule.level)) {
		  awardAchievement("divineItems", rule);
		}
	  });
	  let totalZombies = gameState.totalZombies || 0;
	  achievementRules.totalZombies.forEach(rule => {
		if (totalZombies >= rule.threshold && !isAchievementUnlocked("totalZombies", rule.level)) {
		  awardAchievement("totalZombies", rule);
		}
	  });
	  let btrCount = gameState.btrTriggerCount || 0;
	  achievementRules.btrTriggers.forEach(rule => {
		if (btrCount >= rule.threshold && !isAchievementUnlocked("btrTriggers", rule.level)) {
		  awardAchievement("btrTriggers", rule);
		}
	  });
	  updateAchievementsUI();
	}


	function updateAchievementsUI() {
	  const grid = document.getElementById("achievementGrid");
	  if (!grid) return;
	  // ä»¥è§£é–æ™‚é–“å€’åºæ’åºï¼Œå–æœ€æ–°6å€‹
	  let sorted = unlockedAchievements.slice().sort((a, b) => b.unlockedTime - a.unlockedTime);
	  let latest6 = sorted.slice(0, 6);
	  grid.innerHTML = "";
	  latest6.forEach(ach => {
		const cell = document.createElement("div");
		cell.className = "achievement-cell " + ach.rarity;
		cell.textContent = ach.title;
		grid.appendChild(cell);
	  });
	}

	function showTitlesLibrary() {
	  const container = document.getElementById("titlesContent");
	  if (!container) return;
	  
	  let sorted = unlockedAchievements.slice().sort((a, b) => b.level - a.level);

	  
	  let html = `<table class="collection-table">
		<thead>
		  <tr>
			<th>ç¨±è™Ÿ</th>
			<th>è©³æƒ…</th>
		  </tr>
		</thead>
		<tbody>`;
	  sorted.forEach(ach => {
		html += `<tr class="${ach.rarity}">
		  <td>${ach.title}</td>
		  <td>${ach.details}</td>
		</tr>`;
	  });
	  html += '</tbody></table>';
	  container.innerHTML = html;
	  showModal('titlesModal');
	}

	// æ¨¡æ“¬å®šç¾© getCollectionCompletion()ï¼Œè«‹æ ¹æ“šå¯¦éš›æ•¸æ“šä¿®æ”¹
	function getCollectionCompletion() {
	  // ä¾‹å¦‚ä½¿ç”¨ collectedItems å’Œ ALL_COMBINATIONS
	  const obtained = Object.keys(collectedItems || {}).length;
	  const total = ALL_COMBINATIONS || 1;
	  return (obtained / total) * 100;
	}

	function removeDuplicateAchievements() {
	  // ä½¿ç”¨ä¸€å€‹ Map ä»¥ "category_title" ç‚ºéµï¼Œä¿è­‰æ¯å€‹ç¨±è™Ÿåªä¿ç•™ä¸€ç­†
	  const dedupMap = new Map();
	  // éæ­· unlockedAchievementsï¼Œè‹¥é‡è¤‡å‰‡åªä¿ç•™ç¬¬ä¸€ç­†
	  unlockedAchievements = unlockedAchievements.filter(achievement => {
		// å®šç¾©éµå€¼ï¼ˆä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ category+level ä½œç‚ºå€åˆ†ä¾æ“šï¼‰
		const key = achievement.category + "_" + achievement.title;
		if (dedupMap.has(key)) {
		  // å·²å­˜åœ¨å‰‡è·³é
		  return false;
		} else {
		  dedupMap.set(key, true);
		  return true;
		}
	  });
	  // åŒæ­¥å­˜å…¥ gameState ä¸­ï¼ˆå¦‚æœä½ éœ€è¦çµ±ä¸€å­˜æ”¾ï¼‰
	  gameState.unlockedAchievements = unlockedAchievements.slice();
	  // æ›´æ–°æˆå°±ç•Œé¢
	  updateAchievementsUI();
	}
	 
	
  
    /***** å»ºç¯‰ç®¡ç†ç³»çµ± *****/
	function initBuildingGrid() {
	  const grid = document.getElementById('buildingGrid');
	  grid.innerHTML = '';
	  gameState.buildings.forEach((building, index) => {
		const tile = document.createElement('div');
		let tileClass = "tile";
		if (building && building.upgradable) {
		  tileClass += " upgradable";
		}
		tile.className = tileClass;
		tile.setAttribute('data-index', index);
		tile.onclick = () => {
		  handleBuildingClick(index);
		};

		if (building) {
		  const config = BUILDINGS[building.type];
		  // åˆ¤æ–·æ˜¯å¦å¯ä»¥å‡ç´šï¼šå¦‚æœå»ºç¯‰æ¨™è¨˜å¯å‡ç´šä¸”è³‡æºè¶³å¤ é€²è¡Œä¸‹ä¸€ç´šå‡ç´š
		  let canUpgrade = false;
		  if (building.upgradable) {
			const upgradeInfo = config.getUpgradeInfo(building.level + 1);
			if (upgradeInfo && canAfford(upgradeInfo.cost)) {
			  canUpgrade = true;
			}
		  }
		  
		  // çµ„åˆå»ºç¯‰è³‡è¨Šçš„ HTMLï¼Œå¦‚æœå¯å‡ç´šå‰‡å¢åŠ ä¸€å€‹ç®­é ­å…ƒç´ ï¼Œä¸¦ä¸”å¦‚æœå¯å‡ç´šå‰‡é™„åŠ  "upgrade-available" class
		  tile.innerHTML = `
			<div class="building-icon">${getBuildingIcon(building.type)}</div>
			<div class="building-info">
			  <div>${config.name}</div>
			  <div class="building-level">Lv.${building.level}</div>
			</div>
			${building.upgradable 
				? `<div class="upgrade-indicator ${canUpgrade ? "upgrade-available" : ""}">â†‘</div>` 
				: '' }
		  `;
		  // å¦‚æœå¯ä»¥å‡ç´šï¼Œå°‡æ•´å€‹ tile é‚Šæ¡†è¨­ç‚ºç¶ è‰²
		  if (canUpgrade) {
			tile.style.borderColor = "green";
		  }
		} else {
		  // é‡å°ç©ºåœ°
		  tile.innerHTML = `
			<div class="empty-plot">ğŸŸ¦</div>
			<div class="plot-label">ç©ºåœ°</div>
		  `;
		}
		
		grid.appendChild(tile);
	  });
	}

  
    function handleBuildingClick(index) {
	  const building = gameState.buildings[index];
	  if (!building) {
		return showBuildMenu(index);
	  }
	  // ç›´æ¥ä½¿ç”¨å‡ç´šå½ˆçª—é¡¯ç¤ºè³‡è¨Šå’Œæ“ä½œï¼ˆæ‹†é™¤æŒ‰éˆ•ä¹Ÿæ•´åˆé€²ä¾†ï¼‰
	  showUpgradeMenu(index);
	}

	let currentBuildIndex = null;
	function showBuildMenu(index) {
	  currentBuildIndex = index;
	  updateBuildMenuContent(index);
	  showModal("buildModal");

	  const modalContent = document.querySelector('#buildModal .modal-content');
	  const baseTitleElem = document.querySelector('.building-system h2.section-title');
	  const centerTile = document.querySelector('[data-index="4"]'); // ä¸­å¿ƒåŸºåœ°

	  if (modalContent && baseTitleElem && centerTile) {
		const titleRect = baseTitleElem.getBoundingClientRect();
		const centerRect = centerTile.getBoundingClientRect();
		
		// å¦‚æœæ˜¯æ¡Œé¢ï¼š
		if (window.innerWidth >= 768) {
		  modalContent.style.position = "fixed";
		  // å°‡ top è¨­åœ¨åŸºåœ°å»ºè¨­æ¨™é¡Œçš„ä¸‹é‚Šç·£ï¼š
		  modalContent.style.top = titleRect.bottom + "px";
		  // å·¦å´æ ¹æ“šä¸­å¿ƒåŸºåœ°å¡ç‰‡æ°´å¹³å±…ä¸­
		  const modalWidth = modalContent.offsetWidth;
		  modalContent.style.left = (centerRect.left + centerRect.width / 2 - modalWidth / 2) + "px";
		} else {
		  // å¦‚æœæ˜¯ç§»å‹•ç«¯ï¼Œå‰‡ç”¨è¼ƒåˆç†çš„è¨­ç½®ï¼Œé€™è£¡æˆ‘å€‘è®“å½ˆçª—å¯¬åº¦ç”±ä¸Šé¢çš„ CSS æ§åˆ¶ï¼Œ
		  // åªéœ€è¦èª¿æ•´ top ç‚ºåŸºåœ°å»ºè¨­æ¨™é¡Œä¸‹æ–¹ä¸€å®šè·é›¢ï¼ˆæ¯”å¦‚20pxï¼‰
		  modalContent.style.position = "absolute";
		  modalContent.style.top = (titleRect.bottom + 20) + "px";
		  modalContent.style.left = "50%";
		  modalContent.style.transform = "translateX(-50%)";
		}
	  }
	}


	function updateBuildMenuContent(index) {
	  const available = Object.entries(BUILDINGS)
		.filter(([key, cfg]) => cfg.baseCost && key.toLowerCase() !== "center");

	  let modalContent = available.map(([key, cfg]) => {
		let bonusInfo = "";
		if (typeof cfg.getUpgradeInfo === "function") {
		  const info = cfg.getUpgradeInfo(1);
		  if (info && info.effect) {
			bonusInfo = Object.entries(info.effect)
			  .map(([attr, value]) => {
				const cnAttr = effectMapping[attr] || attr;  // åˆ©ç”¨ effectMapping å°‡è‹±æ–‡éµæ˜ å°„ç‚ºä¸­æ–‡
				return `${cnAttr}: +${parseFloat(value).toFixed(2)}`;
			  })
			  .join("<br>");
		  }
		}
		let costHtml = Object.entries(cfg.baseCost)
		  .map(([res, val]) => `<span class="cost-item" style="margin-right: 8px;">${costMapping[res] || res}: ${parseInt(val)}</span>`)
		  .join(' ');
		let unmet = "";
		if (!canAfford(cfg.baseCost)) {
		  unmet = " ï¼ˆâŒï¼‰";
		}
		return `
		  <div class="build-box" onclick="startBuilding('${key}', ${index})">
			<div class="build-top-container">
			  <div class="build-row">
				<div class="build-left">
				  <span class="build-icon">${getBuildingIcon(key)}</span>
				  <span class="build-name" style="margin-left:5px; font-weight:bold;">${cfg.name}</span>
				</div>
				<div class="build-right">
				  ${bonusInfo}
				</div>
			  </div>
			</div>
			<div class="build-resources">
			  ${costHtml}${unmet}
			</div>
		  </div>
		`;
	  }).join('');
	  
	  document.getElementById('buildOptions').innerHTML = modalContent;
	}


	function closeBuildModal() {
	  closeNestedModal("buildModal");
	  // æ¸…é™¤æ›´æ–°è¨ˆæ™‚å™¨
	  if(buildMenuUpdateTimer) {
		clearInterval(buildMenuUpdateTimer);
		buildMenuUpdateTimer = null;
	  }
	}


	// æ¯ 5 ç§’æª¢æŸ¥ä¸€æ¬¡ï¼Œå¦‚æœå»ºé€ æˆ–å‡ç´šå½ˆçª—æ‰“é–‹ï¼Œå‰‡åˆ·æ–°å…¶å…§å®¹
	setInterval(function() {
	  // æª¢æŸ¥å»ºé€ å½ˆçª—ï¼ˆbuildModalï¼‰çš„ç‹€æ…‹
	  var buildModal = document.getElementById("buildModal");
	  if (buildModal && buildModal.style.display !== "none" && typeof currentBuildIndex !== "undefined") {
		updateBuildMenuContent(currentBuildIndex);
	  }
	  
	  // æª¢æŸ¥å‡ç´šå½ˆçª—ï¼ˆupgradeModalï¼‰çš„ç‹€æ…‹
	  var upgradeModal = document.getElementById("upgradeModal");
	  if (upgradeModal && upgradeModal.style.display !== "none" && typeof currentUpgradeIndex !== "undefined") {
		updateUpgradeMenuContent(currentUpgradeIndex);
	  }
	  
	  const prodModal = document.getElementById("productionCollectionModal");
	  if (prodModal && window.getComputedStyle(prodModal).display !== "none") {
		showProductionCollection();
	  }

	  const favModal = document.getElementById("favoritesModal");
	  if (favModal && window.getComputedStyle(favModal).display !== "none") {
		showCollection();
	  }
	}, 5000);

	




	function getBuildItems() {
	  // å¾ BUILDINGS éæ¿¾å‡ºå…·å»ºé€ æˆæœ¬ä¸”éä¸­å¿ƒåŸºåœ°çš„é …ç›®
	  return Object.entries(BUILDINGS)
		.filter(([key, cfg]) => cfg.baseCost && key.toLowerCase() !== "center");
	}
	function calculateTotalPages() {
	  const itemsPerPage = 2;  // æ¯é 2å€‹é …ç›®ï¼ˆæ ¹æ“šä½ çš„ updateBuildMenuContent() è¨­å®šï¼‰
	  const totalItems = getBuildItems().length;
	  return Math.ceil(totalItems / itemsPerPage);
	}
	


	// æ¯ 5 ç§’æª¢æŸ¥ä¸€æ¬¡ï¼Œå¦‚æœå»ºé€ æˆ–å‡ç´šå½ˆçª—æ‰“é–‹ï¼Œå‰‡åˆ·æ–°å…¶å…§å®¹
	setInterval(function() {
	  updateBuildMenuContent(currentBuildIndex);
	  updateBuildHeaderNumbers();
	  // æª¢æŸ¥å»ºé€ å½ˆçª—ï¼ˆbuildModalï¼‰çš„ç‹€æ…‹
	  var buildModal = document.getElementById("buildModal");
	  if (buildModal && buildModal.style.display !== "none" && typeof currentBuildIndex !== "undefined") {
		updateBuildMenuContent(currentBuildIndex);
	  }
	  
	  // æª¢æŸ¥å‡ç´šå½ˆçª—ï¼ˆupgradeModalï¼‰çš„ç‹€æ…‹
	  var upgradeModal = document.getElementById("upgradeModal");
	  if (upgradeModal && upgradeModal.style.display !== "none" && typeof currentUpgradeIndex !== "undefined") {
		updateUpgradeMenuContent(currentUpgradeIndex);
	  }
	  
	  const prodModal = document.getElementById("productionCollectionModal");
	  if (prodModal && window.getComputedStyle(prodModal).display !== "none") {
		showProductionCollection();
	  }

	  const favModal = document.getElementById("favoritesModal");
	  if (favModal && window.getComputedStyle(favModal).display !== "none") {
		showCollection();
	  }
	}, 5000);
	

	function updateBuildHeaderNumbers() {
	  document.getElementById("foodCountDisplay").textContent = formatNumber(gameState.resources.food);
	  document.getElementById("materialsCountDisplay").textContent = formatNumber(gameState.resources.materials);
	  document.getElementById("weaponsCountDisplay").textContent = formatNumber(gameState.resources.weapons);
	  document.getElementById("techCountDisplay").textContent = formatNumber(gameState.resources.tech);
	}




  
    function updateEfficiencies() {
	  // å¦‚æœ gameState.efficiency å°šæœªå®šç¾©ï¼Œå‰‡åˆå§‹åŒ–å…¶ä¸»è¦éµ
	  if (!gameState.efficiency) {
		gameState.efficiency = {
		  exploration: 1,
		  food: 1,
		  materials: 1,
		  weapons: 1,
		  tech: 1
		};
	  } else {
		// é‡ç½®æ‰€æœ‰é å®šç¾©çš„æ•ˆç‡éµ
		gameState.efficiency.exploration = 1;
		gameState.efficiency.food = 1;
		gameState.efficiency.materials = 1;
		gameState.efficiency.weapons = 1;
		gameState.efficiency.tech = 1;
	  }

	  // å–å¾—ä¸­å¿ƒåŸºåœ°ï¼ˆcenterï¼‰çš„ç­‰ç´šï¼Œç”¨æ–¼ä½œç‚ºå…¶å®ƒå»ºç¯‰ç­‰ç´šçš„ä¸Šé™åƒè€ƒ
	  const centerBuilding = gameState.buildings.find(b => b && b.type === "center");
	  const centerLevel = centerBuilding ? centerBuilding.level : 1;

	  // åˆå§‹åŒ–ç´¯è¨ˆè®Šæ•¸
	  let totalExplorationBoost = 0; // æ¢ç´¢æå‡ï¼Œåªç”±ä¸­å¿ƒåŸºåœ°æä¾›
	  let totalProductionBonus = 0;  // ç”Ÿç”¢åŠ æˆï¼Œå…¨å±€æ‡‰ç”¨æ–¼ foodã€materialsã€weaponsã€tech
	  let totalResearchBoost = 0;    // ç§‘ç ”æå‡
	  let totalZombieEfficiency = 0; // åƒµå°¸å°ˆå±¬æ•ˆæœ
	  let totalZombieBoost = 0;      // æ¢ç´¢åŠ æˆï¼ˆzombieBoostï¼‰ï¼Œç”±åƒµå°¸æŒ‡æ®ä¸­å¿ƒæä¾›

	  // éæ­·æ‰€æœ‰å»ºç¯‰ï¼Œç´¯è¨ˆæ•ˆæœ
	  gameState.buildings.forEach(b => {
		if (!b) return; // è·³éç©ºåœ°

		const upgradeInfo = (typeof BUILDINGS[b.type].getUpgradeInfo === "function")
		  ? BUILDINGS[b.type].getUpgradeInfo(b.level)
		  : null;
		const effects = upgradeInfo ? upgradeInfo.effect : {};

		// å°‡éç‰¹æ®Šéµï¼ˆé explorationBoost, researchBoost, zombieEfficiency, productionBonus, zombieBoostï¼‰
		// çš„æ•ˆæœç›´æ¥ç´¯åŠ åˆ° gameState.efficiencyï¼ˆä¾‹å¦‚æŸäº›å»ºç¯‰å¯èƒ½ç›´æ¥çµ¦ foodã€materials ç­‰åŠ æˆï¼‰
		Object.entries(effects).forEach(([key, value]) => {
		  if (['explorationBoost', 'researchBoost', 'zombieEfficiency', 'productionBonus', 'zombieBoost'].includes(key)) {
			return;
		  }
		  if (gameState.efficiency.hasOwnProperty(key)) {
			gameState.efficiency[key] += value;
		  } else {
			gameState.efficiency[key] = 1 + value;
		  }
		});

		// ç´¯è¨ˆç‰¹æ®Šæ•ˆæœï¼š
		if (b.type === "center") {
		  // ä¸­å¿ƒåŸºåœ°æä¾›æ¢ç´¢æå‡ï¼ˆexplorationBoostï¼‰ç­‰
		  totalExplorationBoost += effects.explorationBoost || 0;
		  totalResearchBoost += effects.researchBoost || 0;
		  totalZombieEfficiency += effects.zombieEfficiency || 0;
		  totalProductionBonus += effects.productionBonus || 0;
		} else {
		  // å…¶ä»–å»ºç¯‰å¦‚æœæœ‰ç”Ÿç”¢åŠ æˆï¼Œä¹Ÿç´¯è¨ˆ
		  if (effects.productionBonus) {
			totalProductionBonus += effects.productionBonus;
		  }
		}
	  });

	  // å°‡æœ€çµ‚æ¢ç´¢æ•ˆç‡åªä½¿ç”¨ä¸­å¿ƒåŸºåœ°æä¾›çš„æ¢ç´¢æå‡ä¾†è¨ˆç®—
	  gameState.efficiency.exploration = 1 + totalExplorationBoost;
	  // æ³¨æ„ï¼šé€™è£¡ä¸æŠŠ zombieBoost åŠ å…¥ exploration æ•ˆç‡ï¼Œä»¥ç¬¦åˆä½ å®šç¾©çš„å€åˆ†

	  // å°‡ç”Ÿç”¢åŠ æˆå…¨å±€æ‡‰ç”¨åˆ°æ‰€æœ‰ä¸»è¦è³‡æºä¸Š
	  ['food', 'materials', 'weapons', 'tech'].forEach(res => {
		gameState.efficiency[res] = (gameState.efficiency[res] || 1) + totalProductionBonus;
	  });

	  // æ›´æ–°å…¶å®ƒå°ˆç”¨è®Šæ•¸ï¼Œæ–¹ä¾¿å¾ŒçºŒä½¿ç”¨æˆ–é¡¯ç¤º
	  gameState.explorationEfficiency = gameState.efficiency.exploration;
	  gameState.researchEfficiency = 1 + totalResearchBoost;
	  gameState.zombieEfficiency = 1 + totalZombieEfficiency;
	  // å¦‚æœ‰éœ€è¦ï¼Œç¨ç«‹å­˜å„²æ¢ç´¢åŠ æˆï¼ˆzombieBoostï¼‰ä»¥ä¾›å…¶å®ƒç”¨é€”ï¼Œä½†ä¸ç´å…¥æ¢ç´¢æ•ˆç‡ï¼š
	  gameState.zombieBoost = 1 + totalZombieBoost;
	  gameState.productionEfficiency = 1 + totalProductionBonus;

	  // é™åˆ¶éä¸­å¿ƒåŸºåœ°çš„å»ºç¯‰ç­‰ç´šä¸å¾—è¶…éä¸­å¿ƒåŸºåœ°ç­‰ç´š
	  gameState.buildings.forEach(b => {
		if (b && b.type !== "center" && b.level > centerLevel) {
		  b.level = centerLevel;
		}
	  });
	}



  
    function getBuildingIcon(type) {
	  const icons = {
		center: "ğŸ°",
		barracks: "ğŸ«",
		greenhouse: "ğŸŒ¿",
		armory: "ğŸ”§",
		laboratory: "ğŸ”¬",
		resourceamplifier: "ğŸ“ˆ",       // æ›¿æ›ç‚ºæ›´å¸¸è¦‹çš„ç¬¦è™Ÿ
		zombiecommandcenter: "ğŸ§Ÿ",
		rarevault: "ğŸ’",
		guardfacility: "âš”ï¸", // æ”¹ç‚ºäº¤å‰åŠ
		safetycenter: "ğŸ›¡ï¸",
		recyclingfactory: "â™»ï¸",
		armoredgarage: "ğŸšœ",
	  };
	  return icons[type.toLowerCase()] || "ğŸŸ¦";
	}


	
	// æ›´æ–°æ‰€æœ‰å»ºç¯‰çš„å‡ç´šç‹€æ…‹ï¼Œæ ¹æ“šä¸»åŸºåœ°ç•¶å‰ç­‰ç´šä¾†æ±ºå®š
	function updateBuildingsAfterMainBaseUpgrade() {
	  // æ‰¾å‡ºä¸»åŸºåœ°ä¸¦ç²å–ç•¶å‰ç­‰ç´šï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
	  const centerBuilding = gameState.buildings.find(b => b && b.type.toLowerCase() === "center");
	  const centerLevel = centerBuilding ? centerBuilding.level : 1;

	  // éæ­·æ‰€æœ‰å»ºç¯‰ï¼Œéä¸»åŸºåœ°çš„ upgradable ç‹€æ…‹ç”±è‡ªèº«ç­‰ç´šèˆ‡ä¸»åŸºåœ°ç­‰ç´šæ±ºå®š
	  gameState.buildings.forEach(b => {
		if (b && b.type.toLowerCase() !== "center") {
		  b.upgradable = (b.level < centerLevel);
		};
		if (b && b.type.toLowerCase() === "armoredgarage") {
			const garageInfo = BUILDINGS.armoredGarage.getUpgradeInfo(b.level);
			gameState.resources.food = Math.max(0, gameState.resources.food - garageInfo.effect.foodConsumption);
		  }
	  });
	}
	let isBTRActive = false;
	let t80IdleInterval = null;
	let t80CannonOnCooldown = false;


	function startT80IdleAnimation(sprite) {
	  // ç¢ºä¿idleå®šæ™‚å™¨ä¸å­˜åœ¨
	  if (t80IdleInterval) clearInterval(t80IdleInterval);
	  t80IdleToggle = false;
	  // åˆå§‹è¨­ç‚ºç¬¬1 å¹€
	  sprite.style.backgroundPosition = "0px 0";
	  t80IdleInterval = setInterval(() => {
		// ä½¿ç”¨ toggle è®Šæ•¸é€²è¡Œäº¤æ›¿
		t80IdleToggle = !t80IdleToggle;
		// ç¬¬1 å¹€ï¼š "0px 0"ï¼›ç¬¬4 å¹€ï¼š -1440px 0 ï¼ˆå› ç‚º 3*480 = 1440ï¼‰
		sprite.style.backgroundPosition = t80IdleToggle ? "-1440px 0" : "0px 0";
	  }, 250);
	}

	// ä¸»å…¥å£å‡½æ•¸ï¼šç”Ÿæˆå‹•ç•«
	function triggerBTRAnimation() {
	  const container = document.getElementById("explorationAnim");
	  if (!container) {
		return;
	  }
	  const containerWidth = container.clientWidth;
	  const offset = 50;
	  const rootStyles = getComputedStyle(document.documentElement);

	  // 40%æ©Ÿç‡ä½¿ç”¨ Tâ€‘80ï¼Œå¦å‰‡BTR
	  const useT80 = (Math.random() < 0.4);

	  let frameWidth;
	  if (useT80) {
		// Tâ€‘80çš„å–®å¹€å¯¬åº¦å›ºå®šç‚º480px
		frameWidth = 480;
	  } else {
		frameWidth = parseFloat(rootStyles.getPropertyValue('--btr-frame-width')) || 240;
	  }

	  // è¨ˆç®—æ°´å¹³ä½ç½®ï¼šèµ·å§‹ä½ç½®ã€åœæ­¢ä½ç½®ï¼Œä¾æ“š frameWidth è¨ˆç®—
	  const centerStart = containerWidth + offset + 0.5 * frameWidth;
	  const centerStop = 0.5 * containerWidth;
	  const startLeft = centerStart - 0.5 * frameWidth;
	  const stopLeft  = centerStop - 0.5 * frameWidth;

	  // ç”Ÿæˆæ°´å¹³ç§»å‹• keyframesï¼ˆæ§åˆ¶ wrapperï¼‰
	  const keyframesText = `
		@keyframes btrMoveDynamic {
		  0%   { left: ${startLeft}px; }
		  20%  { left: ${stopLeft}px; }
		  60%  { left: ${stopLeft}px; }
		  100% { left: ${startLeft}px; }
		}
	  `;
	  let styleElem = document.getElementById("btrKeyframes");
	  if (!styleElem) {
		styleElem = document.createElement("style");
		styleElem.id = "btrKeyframes";
		document.head.appendChild(styleElem);
	  }
	  styleElem.textContent = keyframesText;
	  
	  const wrapper = document.createElement("div");
	  wrapper.className = "btr-wrapper";
	  wrapper.style.position = "absolute";
	  wrapper.style.left = startLeft + "px";
	  wrapper.style.animation = "btrMoveDynamic 10s ease-in-out forwards";

	  let spriteElem;
	  if (useT80) {
		// Tâ€‘80 åˆ†æ”¯ï¼šå»ºç«‹è£åˆ‡å®¹å™¨
		const frameContainer = document.createElement("div");
		frameContainer.className = "frameContainer";
		frameContainer.style.width = frameWidth + "px";
		frameContainer.style.height = rootStyles.getPropertyValue('--btr-frame-height') || "120px";
		frameContainer.style.overflow = "hidden";

		spriteElem = document.createElement("div");
		spriteElem.className = "t80-animation";
		// åˆå§‹ idleï¼šè¨­ç½® backgroundPosition ç‚ºç¬¬1 å¹€
		spriteElem.style.backgroundPosition = "0px 0";

		frameContainer.appendChild(spriteElem);
		wrapper.appendChild(frameContainer);
	  } else {
		// BTR åˆ†æ”¯ï¼šç›´æ¥ä½¿ç”¨åŸä¾†çš„ btr-animation
		spriteElem = document.createElement("div");
		spriteElem.className = "btr-animation";
		wrapper.appendChild(spriteElem);
	  }

	  container.appendChild(wrapper);

	  gameState.btrTriggerCount = (gameState.btrTriggerCount || 0) + 1;
	  if (useT80) {
		addEventLog('[T-80]å…¥å ´ï¼Œç²å¾—åƒµå°¸äº‹ä»¶çå‹µæå‡ï¼', 'btr-active', 'exploration');
	  } else {
		addEventLog('[BTR-80]å…¥å ´ï¼Œç²å¾—åƒµå°¸äº‹ä»¶çå‹µæå‡ï¼', 'btr-active', 'exploration');
	  }
	  isBTRActive = true;
	  setTimeout(() => { isBTRActive = false; }, 10000);
	  setTimeout(() => {
		if (container.contains(wrapper)) {
		  container.removeChild(wrapper);
		}
		// å¦‚æœ Tâ€‘80ï¼Œæ¸…é™¤ idle å®šæ™‚å™¨
		if (useT80 && t80IdleInterval) {
		  clearInterval(t80IdleInterval);
		  t80IdleInterval = null;
		}
	  }, 10000);

	  // å¦‚æœæ˜¯ Tâ€‘80 åˆ†æ”¯ï¼Œå•Ÿå‹• idle å‹•ä½œ
	  if (useT80) {
		startT80IdleAnimation(spriteElem);
		setTimeout(() => {
		  triggerT80Cannon();
		}, 1000);
	  }
	}

function triggerT80Cannon() {
	  if (t80CannonOnCooldown) return;
	  const sprite = document.querySelector(".t80-animation");
	  if (!sprite) {
		return;
	  }
	  t80CannonOnCooldown = true;
	  
	  // åœæ­¢ idle å®šæ™‚å™¨
	  if (t80IdleInterval) {
		clearInterval(t80IdleInterval);
		t80IdleInterval = null;
	  }
	  // ä½¿ç”¨ setTimeout æ¨¡æ“¬å®Œæ•´ 4 å¹€æ’­æ”¾ï¼šæ¯å¸§ 250msï¼ˆç¸½è€—æ™‚ç´„1ç§’ï¼‰
	  sprite.style.backgroundPosition = "0px 0"; // frame1
	  setTimeout(() => { sprite.style.backgroundPosition = "-480px 0"; }, 250); // frame2
	  setTimeout(() => { sprite.style.backgroundPosition = "-960px 0"; }, 500); // frame3
	  setTimeout(() => { sprite.style.backgroundPosition = "-1440px 0"; }, 750); // frame4
	  
	  // 1ç§’å¾Œæ¢å¾© idle æ¨¡å¼
	  setTimeout(() => {
		sprite.style.backgroundPosition = "0px 0"; // å¾©åŸåˆ° frame1
		// é‡æ–°å•Ÿå‹• idle å‹•ç•«
		startT80IdleAnimation(sprite);
	  }, 1000);
	  
	  // å†·å»å¾Œå…è¨±å†æ¬¡é–‹ç‚®
	  setTimeout(() => {
		t80CannonOnCooldown = false;
		if (isBTRActive) {
			triggerT80Cannon();
		  }
	  }, 4250);
	}




 
	function checkBTREvent() {
	  const garages = gameState.buildings.filter(b => b && b.type.toLowerCase() === "armoredgarage");
	  if (garages.length > 0) {
		const garageInfo = BUILDINGS.armoredGarage.getUpgradeInfo(garages[0].level);
		if (Math.random() < garageInfo.effect.btrChance) {
		  triggerBTRAnimation();
		}
	   }
	 }
	setInterval(checkBTREvent, 30000); // æ¯ 30 ç§’æª¢æŸ¥ä¸€æ¬¡

	
	function confirmUpgrade() {
	  if (typeof currentUpgradeIndex === "undefined") return;
	  
	  const index = currentUpgradeIndex;
	  const building = gameState.buildings[index];
	  const config = BUILDINGS[building.type];
	  const nextUpgrade = (typeof config.getUpgradeInfo === "function")
							? config.getUpgradeInfo(building.level + 1)
							: null;
							
	  if (!nextUpgrade || !nextUpgrade.cost) {
		// ç„¡æ³•å‡ç´šï¼ˆå¯èƒ½å·²é”é ‚ç´šï¼‰
		showTempMessage("å‡ç´šå¤±æ•—");
		return;
	  }
	  
	  if (!canAfford(nextUpgrade.cost)) {
		showTempMessage("å‡ç´šå¤±æ•—");
		return;
	  }
	  
	  payCost(nextUpgrade.cost);
	  building.level++;
	  building.upgradable = checkUpgradable(building.type, building.level);
	  if (building.type.toLowerCase() === "center") {
		updateBuildingsAfterMainBaseUpgrade();
	  }
	  updateEfficiencies();
	  updateAllDisplays();
	  
	  // **æ›´æ–°å‡ç´šå½ˆçª—å…§å®¹**
      showUpgradeMenu(index);
	  
	  showTempMessage("å‡ç´šæˆåŠŸ");
	  // æ³¨æ„ï¼šæ­¤è™•ä¸è‡ªå‹•é—œé–‰å‡ç´šå½ˆçª—ï¼Œä¾¿æ–¼é€£çºŒå‡ç´š
	}


	// æ–°å¢ï¼šçµæœæç¤ºå½ˆçª—å‡½æ•¸
	function showResultModal(message) {
	  document.getElementById("resultMessage").textContent = message;
	  showNestedModal("resultModal");
	}
	

	function closeResultModal() {
	  closeNestedModal("resultModal");
	}

	// åŸæœ‰çš„å‡ç´šèœå–®å‡½æ•¸ï¼ˆä¿®æ”¹å¾Œä½¿ç”¨å‹•æ…‹å‡ç´šè³‡è¨Šï¼‰
	function updateUpgradeMenuContent(index) {
	  const building = gameState.buildings[index];
	  if (!building) return;
	  const config = BUILDINGS[building.type];
	  
	  let currentInfo = "";
	  if (typeof config.getUpgradeInfo === "function") {
	    const currentUpgrade = config.getUpgradeInfo(building.level);
	    if (currentUpgrade && currentUpgrade.effect) {
		  currentInfo = Object.entries(currentUpgrade.effect)
		    .map(([attr, value]) => {
		      const cnAttr = effectMapping[attr] || attr;  // è‹¥æ‰¾ä¸åˆ°æ˜ å°„å‰‡ç›´æ¥ç”¨ attr
		  	  return `${cnAttr}: +${parseFloat(value).toFixed(2)}`;
		    })
		    .join("ï¼Œ");
	    }
	  }
	  
	  let nextInfo = "";
	  const nextUpgrade = (typeof config.getUpgradeInfo === "function")
						  ? config.getUpgradeInfo(building.level + 1)
						  : null;
	  if (nextUpgrade && nextUpgrade.cost) {
		nextInfo = " ";
		for (let [res, val] of Object.entries(nextUpgrade.cost)) {
		  const cnRes = costMapping[res] || res;
		  nextInfo += ` ${cnRes}: ${parseInt(val)}`;
		}
		if (!canAfford(nextUpgrade.cost)) {
		  nextInfo += " ï¼ˆâŒï¼‰";
		}
	  } else {
		nextInfo = "å·²é”æœ€é«˜ç´š";
	  }
	  
	  const upperContent = `ç•¶å‰åŠ æˆ: ${currentInfo}\nå‡ç´šæ‰€éœ€: ${nextInfo}`;
	  document.getElementById("upgradeTitle").textContent = config.name;
	  document.getElementById("upgradeInfo").textContent = upperContent;
	  
	  document.getElementById("confirmUpgradeBtn").style.display = "inline-block";
	  if (building.type.toLowerCase() === "center") {
		document.getElementById("demolishBtn").style.display = "none";
	  } else {
		document.getElementById("demolishBtn").style.display = "inline-block";
	  }
	}



	function showUpgradeMenu(index) {
	  currentUpgradeIndex = index;
	  const building = gameState.buildings[index];
	  if (!building) return;
	  // åˆæ¬¡æ›´æ–°å‡ç´šå½ˆçª—å…§å®¹
	  updateUpgradeMenuContent(index);
	  
	  // é¡¯ç¤ºå‡ç´šå½ˆçª—
	  showNestedModal("upgradeModal");
	  // æ­¤è™•ä¸å†å•Ÿå‹•ç¨ç«‹å®šæ™‚å™¨
	  const modalContent = document.querySelector('#upgradeModal .modal-content');
	  const baseTitleElem = document.querySelector('.building-system h2.section-title');
	  const centerTile = document.querySelector('[data-index="4"]'); // å‡è¨­ä¸­å¿ƒåŸºåœ°æ‰€åœ¨æ ¼å­ç´¢å¼•ç‚º 4
	  
	  if (modalContent && baseTitleElem && centerTile) {
		// å–å¾—åŸºåœ°å»ºè¨­æ¨™é¡Œå€åŸŸçš„çŸ©å½¢ä¿¡æ¯
		const titleRect = baseTitleElem.getBoundingClientRect();
		// å–å¾—ä¸­å¿ƒåŸºåœ° tile çš„çŸ©å½¢ä¿¡æ¯
		const centerRect = centerTile.getBoundingClientRect();
		
		// å›ºå®šå®šä½ï¼ˆå¿…é ˆè¨­å®šç‚º fixed æˆ– absoluteï¼‰
		modalContent.style.position = "fixed";
		// å°‡å‡ç´šå½ˆçª—é ‚éƒ¨è¨­ç½®åˆ°åŸºåœ°å»ºè¨­æ¨™é¡Œçš„ä¸Šé‚Šç·£ï¼ˆèˆ‡å»ºé€ å½ˆçª—ä¿æŒä¸€è‡´ï¼‰
		modalContent.style.top = titleRect.top + "px";
		
		// è¨ˆç®— modal-content å¯¬åº¦ä¸¦ä½¿å…¶æ°´å¹³å±…ä¸­æ–¼ä¸­å¿ƒåŸºåœ°
		const modalWidth = modalContent.offsetWidth;
		modalContent.style.left = (centerRect.left + centerRect.width / 2) + "px";
	  }
	}



	function closeUpgradeModal() {
	  closeNestedModal("upgradeModal");
	}

	function startBuilding(type, index) {
	  const config = BUILDINGS[type];
	  if (!canAfford(config.baseCost)) {
		addEventLog(`âŒ è³‡æºä¸è¶³ï¼Œç„¡æ³•å»ºé€  ${config.name}`, 'epic');
		showTempMessage(`å»ºé€ å¤±æ•— ${config.name}`);
		return;
	  }
	  payCost(config.baseCost);
	  gameState.buildings[index] = {
		type,
		level: 1,
		upgradable: checkUpgradable(type, 1)
	  };
	  updateEfficiencies();
	  addEventLog(`ğŸ—ï¸ æˆåŠŸå»ºé€  ${config.name}`, 'uncommon');
	  closeModal("buildModal");  // æ”¹ç”¨ closeModal ä¾†é—œé–‰å»ºé€ å½ˆçª—
	  updateAllDisplays();
	  showTempMessage(`æˆåŠŸå»ºé€  ${config.name}`);
	}


	// å»ºç¯‰äº’å‹•ï¼ˆåŒ…æ‹¬æ‹†é™¤ã€æŸ¥çœ‹è³‡è¨Šç­‰ï¼‰èˆ‡æ‹†é™¤å»ºç¯‰çš„é‚è¼¯

	function showBuildingInteractionMenu(index) {
	  const building = gameState.buildings[index];
	  if (!building) return;
	  const config = BUILDINGS[building.type];

	  // ç”Ÿæˆé¡¯ç¤ºåŸºæœ¬è³‡è¨Šçš„å­—ä¸²
	  const infoStr = `<div class="building-info-popup">
							<p><strong>${config.name}</strong></p>
							<p>ç›®å‰ç­‰ç´šï¼šLv.${building.level}</p>
						</div>`;

	  // å¦‚æœå»ºç¯‰å¯å‡ç´šï¼Œå‰‡æ·»åŠ å‡ç´šæŒ‰éˆ•
	  let buttonContent = "";
	  if (building.upgradable) {
		buttonContent += `<button class="modal-btn" onclick="showUpgradeMenu(${index})">å‡ç´šå»ºç¯‰</button>`;
	  }
	  // åƒ…ç•¶è©²å»ºç¯‰ä¸æ˜¯ä¸­å¿ƒåŸºåœ°æ™‚æ‰é¡¯ç¤ºæ‹†é™¤æŒ‰éˆ•
	  if (building.type.toLowerCase() !== "center") {
		buttonContent += `<button class="modal-btn danger" onclick="confirmBuildingRemoval(${index})">æ‹†é™¤å»ºç¯‰</button>`;
	  }

	  // æ‹¼æ¥æœ€çµ‚çš„äº’å‹•å…§å®¹
	  const interactionContent = infoStr + buttonContent;

	  document.getElementById("interactionContent").innerHTML = interactionContent;
	  document.getElementById("interactionTitle").textContent = config.name;
	  showModal("interactionModal");
	}


	function confirmBuildingRemoval(index) {
	  const building = gameState.buildings[index];
	  if (!building) return;
	  closeNestedModal("upgradeModal");
	  let confirmRemoval = confirm(`ç¢ºå®šè¦æ‹†é™¤ ${BUILDINGS[building.type].name}ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`);
	  if (!confirmRemoval) return;
	  
	  gameState.buildings[index] = null;
	  addEventLog(`ğŸ—ï¸ ${BUILDINGS[building.type].name} å·²è¢«æ‹†é™¤`, "warning");
	  updateEfficiencies();
	  updateAllDisplays();
	  showResultModal(`å·²æ‹†é™¤ ${BUILDINGS[building.type].name}`);
	}

	function showBuildingInfo(index) {
	  const building = gameState.buildings[index];
	  if (building) {
		const config = BUILDINGS[building.type];
		addEventLog(`${config.name} ç­‰ç´š ${building.level}`, "common");
		showResultModal(`${config.name} çš„ç›®å‰ç­‰ç´šï¼š${building.level}`);
	  }
	}


  
    function toggleResource(resource) {
      const detailsElem = document.getElementById(resource + "Details");
      if (detailsElem.style.maxHeight && detailsElem.style.maxHeight !== "0px") {
        detailsElem.style.maxHeight = "0";
      } else {
        detailsElem.style.maxHeight = "100px";
      }
    }
  
    	/***** (3) èª¿æ•´å„éƒ¨é–€åƒµå°¸åˆ†é…çš„åŠ æ¸›æ­¥å¹…ç‚ºç•¶å‰æ•¸é‡çš„ 5%ï¼ˆä¸‹é™ 1ï¼‰ *****/
	function adjustZombies(dept, amount) {
	  let current = gameState.allocations[dept] || 0;
	  let step = 0;

	  if (amount > 0) {
		// è‹¥ç•¶å‰éƒ¨é–€ç‚º 0ï¼Œå‰‡åŠ  1ï¼›å¦å‰‡ä»¥ç•¶å‰éƒ¨é–€åƒµå°¸æ•¸çš„ 5%ï¼ˆå‘ä¸Šå–æ•´ï¼Œæœ€å° 1ï¼‰
		step = current > 0 ? Math.max(Math.ceil(current * 0.05), 1) : 1;
	  } else {
		// æ¸›å°‘åˆ†é…æ™‚æ¡ç”¨ç›¸åŒæ–¹å¼ï¼ˆä¸å¾—ä½æ–¼ 0ï¼‰
		step = current > 0 ? -Math.max(Math.ceil(current * 0.05), 1) : 0;
	  }

	  if (amount > 0) {
		// è¨ˆç®—å…¶å®ƒéƒ¨é–€å·²åˆ†é…åƒµå°¸æ•¸
		const totalAllocatedOther = Object.keys(gameState.allocations).reduce((sum, key) => {
		  return key === dept ? sum : sum + gameState.allocations[key];
		}, 0);
		// è¨ˆç®—ç•¶å‰éƒ¨é–€å·²åˆ†é…å¾Œï¼Œç¸½å…±åˆ†é…å‡ºå»çš„æ•¸å­—ï¼šcurrent + totalAllocatedOther
		// å‰©é¤˜åƒµå°¸æ•¸æ‡‰ç‚ºç¸½åƒµå°¸æ•¸æ¸›å»å·²åˆ†é…çš„ç¸½æ•¸
		const remainingForDept = gameState.totalZombies - (totalAllocatedOther + current);

		// å¦‚æœå‰©é¤˜ä¸è¶³æœ¬éƒ¨é–€æŒ‰ç…§ 5% è¨ˆç®—æ‡‰å¢åŠ çš„æ•¸é‡ï¼Œ
		// å‰‡ç›´æ¥å°‡å…¨éƒ¨å‰©é¤˜æ•¸åˆ†é…é€²è©²éƒ¨é–€
		if (remainingForDept < step && remainingForDept > 0) {
		  gameState.allocations[dept] = current + remainingForDept;
		} else {
		  // æª¢æŸ¥å¢åŠ å¾Œæ˜¯å¦è¶…å‡ºç¸½åƒµå°¸æ•¸
		  if (totalAllocatedOther + (current + step) > gameState.totalZombies) {
			addEventLog("æ²’æœ‰è¶³å¤ çš„åƒµå°¸åˆ†é…", "warning");
			return;
		  }
		  gameState.allocations[dept] = current + step;
		}
	  } else {
		// æ¸›å°‘åˆ†é…æƒ…æ³ç›´æ¥æ›´æ–°
		gameState.allocations[dept] = Math.max(current + step, 0);
	  }

	  updateAllDisplays();
	}





  
  // ç•¶è§¸æ‘¸é–‹å§‹æ™‚ï¼Œå¦‚æœç›®æ¨™ä½æ–¼æˆ‘å€‘é—œæ³¨çš„å€åŸŸå…§ï¼ˆ.modal-content æˆ– .logï¼‰ï¼Œå‰‡ä¿å­˜è©²å®¹å™¨èˆ‡åˆå§‹ä½ç½®ã€‚
	const scrollManager = (() => {
	  let startX = 0, startY = 0;
	  let currentContainer = null;
	  // ç”¨ä¾†æ¨™è¨˜é€™æ¬¡è§¸æ‘¸æ“ä½œæ˜¯å¦æ˜¯å‚ç›´æ‰‹å‹¢ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡ touchmove æ™‚ç¢ºå®šï¼‰
	  let isVerticalGesture = null; 
	  // å‚ç›´è§’åº¦é–¾å€¼ï¼ˆå–®ä½ï¼šåº¦ï¼‰
	  const verticalThreshold = 60; 

	  // æª¢æŸ¥å…ƒç´ æ˜¯å¦å…·æœ‰å‚ç›´æ»¾å‹•åŠŸèƒ½
	  function isScrollable(el) {
		return el && el.scrollHeight > el.clientHeight;
	  }
	  
	  function handleTouchStart(e) {
		if (e.touches.length > 1) {
		  currentContainer = null;
		  isVerticalGesture = null;
		  return;
		}
		
		// å„ªå…ˆåˆ¤æ–·æ˜¯å¦é»æ“Šåˆ° buildModal å…§éƒ¨çš„æ»¾å‹•å€ï¼ˆ.build-optionsï¼‰
		let buildOptions = e.target.closest('#buildModal .build-options');
		if (buildOptions && isScrollable(buildOptions)) {
		  currentContainer = buildOptions;
		} else if (e.target.closest('#explorationLog, #productionLog')) {
		  let logContainer = e.target.closest('#explorationLog, #productionLog');
		  currentContainer = isScrollable(logContainer) ? logContainer : null;
		} else if (e.target.closest('#favoritesModal .modal-content')) {
		  currentContainer = document.querySelector('#favoritesModal .modal-content');
		} else if (e.target.closest('#productionCollectionModal.modal-content')) {
		  currentContainer = document.querySelector('#productionCollectionModal .modal-content');
		} else {
		  const container = e.target.closest('.modal-content, .log');
		  currentContainer = container && isScrollable(container) ? container : null;
		}
		
		if (currentContainer) {
		  startX = e.touches[0].clientX;
		  startY = e.touches[0].clientY;
		  isVerticalGesture = null;
		}
	  }

	  function handleTouchMove(e) {
		// å¦‚æœå¤šé»è§¸æ§æˆ–æœªé¸å®šå®¹å™¨å‰‡ç›´æ¥è¿”å›
		if (e.touches.length > 1 || !currentContainer) return;
		
		const currentX = e.touches[0].clientX;
		const currentY = e.touches[0].clientY;
		const deltaX = currentX - startX;
		const deltaY = currentY - startY;
		
		if (isVerticalGesture === null) {
		  const angle = Math.atan2(Math.abs(deltaX), Math.abs(deltaY)) * (180 / Math.PI);
		  isVerticalGesture = angle < verticalThreshold;
		}
		
		if (isVerticalGesture) {
		  e.preventDefault();
		  e.stopPropagation();
		  currentContainer.scrollTop -= deltaY;
		}
		
		startX = currentX;
		startY = currentY;
	  }

	  function handleTouchEnd(e) {
		currentContainer = null;
		isVerticalGesture = null;
	  }

	  return {
		init() {
		  document.addEventListener('touchstart', handleTouchStart, { passive: false });
		  document.addEventListener('touchmove', handleTouchMove, { passive: false });
		  document.addEventListener('touchend', handleTouchEnd);
		}
	  };
	})();
	scrollManager.init();

	document.addEventListener("touchmove", function(e) {
	  const openModal = document.querySelector('.modal-overlay[style*="display: flex"]');
	  if (openModal && !e.target.closest('.modal-content')) {
		// å¦‚æœè§¸æ§ä¾†æºä¸¦é modal å…§å®¹å…§ï¼Œä¹Ÿä¸æ˜¯æŸå€‹å…è¨±æ»¾å‹•çš„ç‰¹å®šå€åŸŸï¼ˆä¾‹å¦‚ï¼Œ#buildModal .build-options å¯æ»¾å‹•ï¼‰
		if (!e.target.closest('#buildModal .build-options')) {
		  // å…è¨±æ‰‹å‹¢ï¼ˆä¾‹å¦‚ç¸®æ”¾ï¼‰ç…§å¸¸åŸ·è¡Œ
		  return;
		}
	  }
	}, { passive: false });

	function globalTouchMoveHandler(e) {
	  // å¦‚æœå½ˆçª—é®ç½©å·²ç¶“æ‰“é–‹ï¼Œä¸¦ä¸”è§¸æ§ä¸¦éç™¼ç”Ÿåœ¨å…è¨±æ»¾å‹•çš„å€åŸŸå…§
	  if (document.body.classList.contains('modal-open') &&
		  !e.target.closest('#buildModal .build-options')) {
		e.preventDefault();
	  }
	}
	// ç¶å®šäº‹ä»¶
	document.addEventListener("touchmove", globalTouchMoveHandler, { passive: false });



	// å¼¹çª—æ§åˆ¶å‡½æ•°
	function showNestedModal(modalId) {
	  var modal = document.getElementById(modalId);
	  if (!modal) return;
	  modal.style.display = "flex";
	  modal.offsetHeight;
	  if (modalId === "buildModal") {
		let logIds = ["explorationLog", "productionLog"];
		logIds.forEach(id => {
		  let logElem = document.getElementById(id);
		  if (logElem) {
			logElem.scrollTop = logElem.scrollHeight;
		  }
		});
	  }
	}
	function closeNestedModal(modalId) {
	  var modal = document.getElementById(modalId);
	  if (modal) {
		modal.style.display = "none";
		// æ¢å¾© overflow
		document.documentElement.style.overflow = '';
		document.body.style.overflow = '';
		}
	}


	function updateModalPosition() {
	  // åªé‡å°åŠ ä¸Šè‡ªå®šç¾©å®šä½æ¨™è¨˜çš„å½ˆçª—é€²è¡Œèª¿æ•´
	  const modals = document.querySelectorAll('.modal-overlay .modal-content[data-custom-pos="true"]');
	  if (!modals.length) return;

	  const baseTitleElem = document.querySelector('.building-system h2.section-title');
	  const centerTile = document.querySelector('[data-index="4"]');
	  if (baseTitleElem && centerTile) {
		const titleRect = baseTitleElem.getBoundingClientRect();
		const centerRect = centerTile.getBoundingClientRect();
		modals.forEach(content => {
		  content.style.position = "fixed";
		  content.style.top = `${titleRect.top}px`;
		  content.style.left = `${centerRect.left + centerRect.width / 2}px`;
		  content.style.transform = "translateX(-50%)";
		});
	  }
	}


	function closeModal(modalId) {
	  var modal = document.getElementById(modalId);
	  if (!modal) return;
	  modal.style.display = 'none';
	  document.documentElement.style.overflow = '';
	  document.body.style.overflow = '';
	}

	// è§†è§‰è§†å£ç›‘å¬å™¨
	let currentScale = 1;
	const viewportHandler = () => {
	  currentScale = window.visualViewport.scale;	  
	};

	// å¼¹çª—æ§åˆ¶å¢å¼º
	const modalController = {
	  init() { },
	  
	  show(modalId) {
		const modal = document.getElementById(modalId);
		currentScale = window.visualViewport.scale;
		
		// åˆå§‹åŒ–å¼¹çª—ä½ç½®
		modal.style.display = 'flex';
		modal.querySelector('.modal-content').style.transform = `
		  translateX(-50%) 
		  scale(${1/currentScale})
		`;
		
		// æ·»åŠ åŒæŒ‡æ‰‹åŠ¿ç›‘å¬
		modal.addEventListener('gesturestart', e => e.preventDefault());
		modal.addEventListener('gesturechange', this.handleZoom);
	  },

	  handleZoom(e) {
		const modalContent = e.target.closest('.modal-content');
		if(!modalContent) return;
		
		// é™åˆ¶ç¼©æ”¾èŒƒå›´
		const newScale = Math.min(Math.max(e.scale, 0.8), 2);
		modalContent.style.setProperty('--zoom-factor', newScale);
		
		// é˜»æ­¢é¡µé¢çº§ç¼©æ”¾
		e.preventDefault();
	  },
	  
	  close(modalId) {
		window.visualViewport.removeEventListener('scroll', viewportHandler);
		window.visualViewport.removeEventListener('resize', viewportHandler);
		document.getElementById(modalId).style.display = 'none';
	  }
	};

	// åˆå§‹åŒ–
	modalController.init();

	  

    /***** è¼”åŠ©å‡½æ•¸ çµæŸ *****/
  
    // éŠæˆ²åˆå§‹åŒ–èˆ‡æ ¸å¿ƒå¾ªç’°
    function initGame() {
      updateAllDisplays();
      initBuildingGrid();
    
    }
	
	
    function loadSave() {
      // å¦‚æœ‰éœ€è¦ï¼Œå¯åœ¨æ­¤è®€å–å­˜æª”ï¼Œæœ¬ä¾‹ä¸­ç›´æ¥è¨­å®šåˆå§‹éƒ¨é–€åˆ†é…
      gameState.allocations.exploration = 4;
      gameState.allocations.farming = 4;
      gameState.allocations.recycling = 1;
      gameState.allocations.research = 1;
    }
  
    /*******************
	 * å­˜æ¡£ç›¸å…³ä»£ç 
	 *******************/

	// ä¿å­˜æ¸¸æˆè¿›åº¦çš„å‡½æ•°
	function saveGameState() {
	  try {
		// è®¡ç®—å·²ç»æµé€çš„æ—¶é—´
		const elapsedTime = Date.now() - window.startTime;
		const saveData = {
		  gameState: gameState,
		  collectedItems: collectedItems,
		  productionCollection: productionCollection,
		  unlockedAchievements: unlockedAchievements, // ä¿å­˜æˆå°±è¨˜éŒ„
		  elapsedTime: elapsedTime
		};
		localStorage.setItem("gameSave", JSON.stringify(saveData));
	  } catch (err) {}
	}

	// åŠ è½½å­˜æ¡£çš„å‡½æ•°
	function loadGameState() {
	  const saved = localStorage.getItem("gameSave");
	  if (saved) {
		try {
		  const saveData = JSON.parse(saved);
		  if (saveData.gameState) {
			gameState = saveData.gameState;
		  }
		  if (saveData.collectedItems) {
			collectedItems = saveData.collectedItems;
		  }
		  if (saveData.productionCollection) {  // <-- æ–°å¢
			productionCollection = saveData.productionCollection;
		  }
		  if (saveData.unlockedAchievements) {
			unlockedAchievements = saveData.unlockedAchievements;
			gameState.unlockedAchievements = unlockedAchievements;
		  }
		 if (saveData.elapsedTime) {
			window.startTime = Date.now() - saveData.elapsedTime;
		  } else {
			window.startTime = Date.now();
		  }
		} catch (err) {
		  window.startTime = Date.now();
		}
	  } else {
		window.startTime = Date.now();
	  }
	}

	/***** (1) é‡ç½®å­˜æª”æ™‚é‡ç½®æ‰€æœ‰å…§å®¹ *****/
	function confirmResetProgress() {
	  if (confirm("ç¡®å®šè¦é‡ç½®å­˜æ¡£å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) {
		localStorage.removeItem("gameSave");
		// é‡ç½® gameStateã€collectedItems ä¸¦æ–°å¢é‡ç½® productionCollection èˆ‡ unlockedAchievements
		gameState = {
		  resources: { food: 100, materials: 100, weapons: 50, tech: 20 },
		  resetCounts: { food: 0, materials: 0, weapons: 0, tech: 0 },
		  resetCounter: 0,
		  totalZombies: 10,
		  allocations: { exploration: 4, farming: 4, recycling: 1, research: 1 },
		  buildings: new Array(9).fill(null).map((_, i) =>
			i === 4 ? { type: 'center', level: 1, upgradable: true } : null),
		  explorationMilestone: 10,
		  efficiency: { food: 1, materials: 1, weapons: 1, tech: 1, exploration: 1 }
		};
		collectedItems = {};
		productionCollection = {};    // æ–°å¢ï¼šé‡ç½®ç”Ÿç”¢æ—¥èªŒå…§å®¹
		unlockedAchievements = [];    // æ–°å¢ï¼šé‡ç½®ç¨±è™Ÿï¼ˆæˆå°±ï¼‰è¨˜éŒ„
		gameState.unlockedAchievements = [];
		// åŒæ™‚æ¸…ç©ºæ¢ç´¢ã€ç”Ÿäº§æ—¥èªŒå€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
		const prodLog = document.getElementById("productionLog");
		if (prodLog) prodLog.innerHTML = "";
		const explorationLog = document.getElementById("explorationLog");
		if (explorationLog) explorationLog.innerHTML = "";
		// æ¸…ç©ºæˆå°±é é¢
		const achievementGrid = document.getElementById("achievementGrid");
		if (achievementGrid) achievementGrid.innerHTML = "";
		window.startTime = Date.now();
		updateAllDisplays();
		showTempMessage("è¿›åº¦å·²é‡ç½®");
	  }
	}


	
	 
	function showCollection() {
	  // å®šç¾©ä¾ç¨€æœ‰åº¦æ’åºçš„é †åº
	  const rarityOrder = { 
		  divine: 12,      // ç¥è–çš„
		  legendary: 11,   // å‚³å¥‡çš„
		  epic: 10,        // å²è©©çš„
		  rare: 9,         // ç¨€æœ‰çš„
		  tested: 8,       // æ­·ç¶“è€ƒé©—çš„
		  selected: 7,     // ç²¾æŒ‘ç´°é¸çš„
		  sealed: 6,       // æœªé–‹å°çš„
		  decent: 5,       // çœ‹èµ·ä¾†ä¸éŒ¯çš„
		  common: 4,       // æ­£å¸¸çš„
		  damaged: 3,      // ç ´æçš„
		  old: 2,          // é™³èˆŠçš„
		  junk: 1     
	  };
	  // å°‡ collectedItems è½‰æ›æˆé™£åˆ—ï¼Œæ¯å€‹é …ç›®åŒ…å«ï¼šåç¨±ã€ç²å¾—æ¬¡æ•¸èˆ‡ç¨€æœ‰åº¦
	  let items = Object.keys(collectedItems).map(key => {
		  let itemName = collectedItems[key].name;
		  if (itemName === undefined) {
			itemName = key.split("_")[0];
		  }
		  return {
			name: itemName,
			count: collectedItems[key].count,
			rarity: collectedItems[key].rarity
		  };
	  });
	  // æŒ‰ç…§ç¨€æœ‰åº¦ç”±é«˜åˆ°ä½æ’åº
	  items.sort((a, b) => (rarityOrder[b.rarity] || 0) - (rarityOrder[a.rarity] || 0));
	  items = items.slice(0, 100); // åªå–å‰100æ¢

	  // å»ºè­°ï¼šæ”¹ç”¨ CSS é¡ï¼Œé¿å…æ¯å€‹ cell éƒ½åœ¨å…§è¯ä¸­è¨­ç½®æ¨£å¼
	  let html = `<table class="collection-table">
		<thead>
		  <tr>
			<th>ç‰©å“åç¨±</th>
			<th>ç²å¾—æ¬¡æ•¸</th>
		  </tr>
		</thead>
		<tbody>`;
	  items.forEach(item => {
		  html += `<tr class="${item.rarity}">
			<td>${item.name}</td>
			<td>${item.count}</td>
		  </tr>`;
	  });
	  html += `</tbody></table>`;
	  
	  document.getElementById("collectionContent").innerHTML = html;
	  updateCollectionCompletion();
	  showModal('favoritesModal');
	}
	function showModal(modalId) {
	  const modal = document.getElementById(modalId);
	  if (!modal) return;
	  modal.style.display = 'flex';
	}
		
	function updateTimer() {
	  const now = Date.now();
	  const elapsed = now - window.startTime; // window.startTime åº”è¯¥å·²åˆå§‹åŒ–
	  const seconds = Math.floor((elapsed / 1000) % 60);
	  const minutes = Math.floor((elapsed / 60000) % 60);
	  const hours = Math.floor(elapsed / 3600000);
	  const formattedTime = 
		String(hours).padStart(2, '0') + ":" +
		String(minutes).padStart(2, '0') + ":" +
		String(seconds).padStart(2, '0');
	  const timerElem = document.getElementById("timerValue");
	  if (timerElem) {
		timerElem.textContent = formattedTime;
	  }
	}

	function initExplorationAnimation() {
	  const container = document.getElementById("explorationAnim");
	  if (container) {
		// å¦‚æœå·²ç»å­˜åœ¨åˆ™ä¸é‡å¤æ·»åŠ 
		if (!container.querySelector('.zombie-search')) {
		  const zombie = document.createElement("div");
		  zombie.className = "zombie-search";
		  container.appendChild(zombie);
		}
	  }
	}

	// è§¦å‘å…¥åœºåŠ¨ç”»ï¼ˆåƒµå°¸å¢åŠ æ—¶è°ƒç”¨ï¼‰
	function triggerZombieEntry() {
	  const container = document.getElementById("explorationAnim");
	  if (!container) { return; }
	  
	  // åˆ›å»ºå…¥åœºåŠ¨ç”»å…ƒç´ 
	  const entryElem = document.createElement("div");
	  entryElem.className = "zombie-entry";
	  container.appendChild(entryElem);
	  
	  // åŠ¨ç”»ç»“æŸåæ¸…ç†
	  setTimeout(() => {
		if (container.contains(entryElem)) {
		  container.removeChild(entryElem);
		}
	  }, 4000); // åŒ¹é…åŠ¨ç”»æ—¶é•¿
	}

	// è§¦å‘å€’åœ°åŠ¨ç”»ï¼ˆåƒµå°¸å‡å°‘æ—¶è°ƒç”¨ï¼‰
	function triggerZombieLying() {
	  const container = document.getElementById("explorationAnim");
	  if (!container) return;
	  
	  // åˆ›å»ºå€’åœ°åŠ¨ç”»å…ƒç´ ï¼ˆåœ¨ä¸‹å±‚ï¼‰
	  const lyingElem = document.createElement("div");
	  lyingElem.className = "zombie-lying";
	  container.appendChild(lyingElem);
	  
	  // åŠ¨ç”»ç»“æŸåæ¸…ç†
	  setTimeout(() => {
		if (container.contains(lyingElem)) {
		  container.removeChild(lyingElem);
		}
	  }, 20000); // åŒ¹é…å‹•ç•«æ™‚é•·
	}
	function updateZombieSearchSprite() {
      const zombieElem = document.querySelector(".zombie-search");
      if (!zombieElem) return;
      zombieElem.style.backgroundImage = "url('" + window.currentZombieSprite + "')";
    }

	// åˆå§‹åŒ–ç”Ÿäº§åŠ¨ç”»ï¼šä¸ºç”Ÿäº§åŠ¨ç”»å„æ æ·»åŠ å‰æ™¯åƒµå°¸åŠ¨ç”»ï¼ˆå¸¸é©»å¾ªç¯æ’­æ”¾ï¼‰
	function initProductionAnimation() {
	  const leftCol = document.getElementById("prodAnimLeft");
	  if (leftCol && !leftCol.querySelector('.prod-zombie-plow')) {
		const zombiePlow = document.createElement("div");
		zombiePlow.className = "prod-zombie-plow";
		leftCol.appendChild(zombiePlow);
	  }
	  const midCol = document.getElementById("prodAnimMid");
	  if (midCol && !midCol.querySelector('.prod-zombie-weld')) {
		const zombieWeld = document.createElement("div");
		zombieWeld.className = "prod-zombie-weld";
		midCol.appendChild(zombieWeld);
	  }
	  const rightCol = document.getElementById("prodAnimRight");
	  if (rightCol && !rightCol.querySelector('.prod-zombie-lab')) {
		const zombieLab = document.createElement("div");
		zombieLab.className = "prod-zombie-lab";
		rightCol.appendChild(zombieLab);
	  }
	}

	function triggerProductionAccident(dept) {
		  let targetElem = null;
		  if (dept === "farming") targetElem = document.getElementById("prodAnimLeft");
		  else if (dept === "recycling") targetElem = document.getElementById("prodAnimMid");
		  else if (dept === "research") targetElem = document.getElementById("prodAnimRight");
		  
		  if (!targetElem) {
			return;
		  }
		  
		  // å‰µå»ºäº‹æ•…å‹•ç•«è¦†è“‹å±¤
		  const accidentOverlay = document.createElement("div");
		  accidentOverlay.className = "accident-overlay";
		  accidentOverlay.style.backgroundImage = "url('images/accident.png')";
		  
		  targetElem.appendChild(accidentOverlay);
		  
		  // 3ç§’å¾Œæ¸…é™¤å‹•ç•«è¦†è“‹å±¤
		  setTimeout(() => {
			if (targetElem.contains(accidentOverlay)) {
			  targetElem.removeChild(accidentOverlay);
			}
		  }, 3000);
		}
	
	// ç•¶æ–‡ä»¶å…§å®¹å®Œå…¨åŠ è¼‰å¾Œå•Ÿå‹•éŠæˆ²
	document.addEventListener("DOMContentLoaded", function() {
		initProductionAnimation();
		initExplorationAnimation();
		updateProductionBackground(); // åˆå§‹åŒ–ç”Ÿäº§èƒŒæ™¯
		setInterval(updateProductionBackground, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
		const titleLibraryBtn = document.getElementById("titleLibraryBtn");
	    if (titleLibraryBtn) {
		  titleLibraryBtn.addEventListener("click", showTitlesLibrary);
	    }
		
		// æ¢ç´¢å‹•ç•«ç›¸é—œè®Šæ•¸
		let explorationBackgroundsDay = [
		  "images/location_day_1.png",
		  "images/location_day_2.png",
		  "images/location_day_3.png"
		];
		let explorationBackgroundsNight = [
		  "images/location_night_1.png",
		  "images/location_night_2.png",
		  "images/location_night_3.png"
		];
		let currentExplorationBg = "";
		let explorationAnimElem = document.getElementById("explorationAnim");

		// æ¯åˆ†é˜éš¨æ©Ÿæ›´æ›èƒŒæ™¯
		function updateExplorationBackground() {
		  let now = new Date();
		  // åˆ¤æ–·ç•¶å‰æ™‚æ®µï¼ˆ08:00-20:00æ—¥é–“ï¼Œå¦å‰‡å¤œé–“ï¼‰
		  let isDay = now.getHours() >= 8 && now.getHours() < 20;
		  let bgArray = isDay ? explorationBackgroundsDay : explorationBackgroundsNight;
		  // éš¨æ©Ÿé¸ä¸€å€‹èƒŒæ™¯
		  let newBg = bgArray[Math.floor(Math.random() * bgArray.length)];
		  
		  const transitionElem = document.createElement("div");
		  transitionElem.className = "transition-overlay";
		  transitionElem.style.backgroundImage = "url('images/transition.png')";
		  explorationAnimElem.appendChild(transitionElem);
		  
		  setTimeout(() => {
			explorationAnimElem.removeChild(transitionElem);
			explorationAnimElem.style.backgroundImage = `url('${newBg}')`;
		    }, 500);
		}
		// è¨­ç½®æ¯åˆ†é˜æ›´æ–°èƒŒæ™¯
		setInterval(updateExplorationBackground, 60000);
		updateExplorationBackground(); // åˆå§‹åŒ–æ™‚å…ˆåŸ·è¡Œä¸€æ¬¡
		
		function updateProductionBackground() {
		  const now = new Date();
		  const isDay = now.getHours() >= 8 && now.getHours() < 20;
		  
		  const bgPrefix = isDay ? "day" : "night";
		  
		  const leftCol = document.getElementById("prodAnimLeft");
		  const midCol = document.getElementById("prodAnimMid");
		  const rightCol = document.getElementById("prodAnimRight");
		  
		  if (leftCol) leftCol.style.backgroundImage = `url('images/prod_${bgPrefix}_left.png')`;
		  if (midCol) midCol.style.backgroundImage = `url('images/prod_${bgPrefix}_mid.png')`;
		  if (rightCol) rightCol.style.backgroundImage = `url('images/prod_${bgPrefix}_right.png')`;
		}

	
		// ç»‘å®šé‡ç½®å­˜æ¡£æŒ‰é’®ï¼ˆå‡å®šè¯¥æŒ‰é’®å·²åœ¨ HTML ä¸­æ”¾åœ¨æœ«æ—¥æŒ‡æŒ¥ä¸­å¿ƒæ ‡é¢˜æ—è¾¹ï¼Œid="resetProgressBtn"ï¼‰
		const resetBtn = document.getElementById("resetProgressBtn");
		if (resetBtn) {
		 resetBtn.addEventListener("click", confirmResetProgress);
		}
		  
		// å°è¯•åŠ è½½å­˜æ¡£
		loadGameState();
		removeDuplicateAchievements();
		  
		// åˆå§‹åŒ–æ¸¸æˆï¼ˆä½¿ç”¨å­˜æ¡£æˆ–åˆå§‹çŠ¶æ€ï¼‰
		initGame();
		  
		// åˆå§‹åŒ–è®¡æ—¶å™¨ï¼šupdateTimer æ¯ç§’æ›´æ–°ï¼Œè®¡æ—¶å™¨ä¾æ® window.startTime è®¡ç®—å·²æµé€æ—¶é—´
		setInterval(updateTimer, 1000);
		  
		// åœ¨æµè§ˆå™¨åˆ·æ–°/ç¦»å¼€å‰è‡ªåŠ¨ä¿å­˜
		window.addEventListener("beforeunload", saveGameState);
		  
		// å®šæ—¶ä¿å­˜ï¼ˆä¾‹å¦‚æ¯10ç§’ä¿å­˜ä¸€æ¬¡ï¼‰
		setInterval(saveGameState, 10000);
		  
		// å‡è¨­æ‚¨çš„æ”¶è—æŒ‰éˆ• ID ç‚º favoritesBtn
	    const favBtn = document.getElementById("favoritesBtn");
		if (favBtn) {
		  favBtn.addEventListener("click", showCollection);
		}

		// æ¯ç§’æ›´æ–°ä¸€æ¬¡
		setInterval(updateTimer, 1000);
		
		function gameLoop() {
		  checkAchievements();  // æ¯æ¬¡å¾ªç’°æª¢æŸ¥æˆå°±æ¢ä»¶
		  // è³‡æºç”Ÿç”¢ã€åƒµå°¸ç”Ÿç”¢ã€é£Ÿç‰©æ¶ˆè€—ã€æ¢ç´¢ç­‰æ“ä½œé›†ä¸­åŸ·è¡Œ
		  produceResources('farming', 'food', 1.7 * 5);
		  produceResources('recycling', 'materials', 0.5 * 5);
		  produceResources('research', 'tech', 0.2 * 5);
		  produceWeaponsFromArmories() 
		  produceZombies();
		  updateFoodConsumption();
		  updateSafetyCenterConsumption();
		  updateBarracksWeaponConsumption();
		  // æ¢ç´¢äº‹ä»¶ä¹Ÿå¯ä»¥æ”¾åœ¨åŒä¸€å¾ªç’°å…§ï¼Œæˆ–å†é–‹ä¸€å€‹è¼ƒä½é »ç‡çš„å¾ªç’°
		  if (gameState.allocations.exploration > 0) {
			handleExploration();
		  }

		  // çµ±ä¸€æ›´æ–°æ‰€æœ‰é¡¯ç¤ºï¼ˆè‹¥åŠ ä¸Šå‰é¢æåˆ°çš„ dirty flag æ›´æ–°ï¼Œå°±ä¸æœƒæ¯æ¬¡éƒ½æ›´æ–°ï¼‰
		  updateAllDisplays();
		  const upgradeModal = document.getElementById("upgradeModal");
		  if (upgradeModal && upgradeModal.style.display === "flex" && typeof currentUpgradeIndex !== "undefined") {
			updateUpgradeMenuContent(currentUpgradeIndex);
		  }
		  // --- æ–°å¢å»ºé€ å½ˆçª—è‡ªå‹•æ›´æ–° ---
		  const buildModal = document.getElementById("buildModal");
		  if (buildModal && buildModal.style.display === "flex" && currentBuildIndex !== null) {
			updateBuildMenuContent(currentBuildIndex);
		  }
		}

		// ç”¨å–®ä¸€å®šæ™‚å™¨å•Ÿå‹•ä¸»å¾ªç’°ï¼Œä¾‹å¦‚æ¯ 5 ç§’åŸ·è¡Œä¸€æ¬¡
		setInterval(gameLoop, 5000);

		
		
		// ç‚ºæ‰€æœ‰ modal-overlay æ·»åŠ äº‹ä»¶ç›£è½å™¨
		document.querySelectorAll('.modal-overlay').forEach(overlay => {
		  overlay.addEventListener('click', function(event) {
			// ç²¾ç¡®åˆ¤æ–­ç‚¹å‡»åŒºåŸŸæ˜¯å¦ä¸ºé®ç½©å±‚æœ¬èº«
			if (event.target === overlay) { 
			  closeModal(overlay.id);
			}
			if (!event.target.closest('.modal-content')) {
			  closeNestedModal(overlay.id);
			}
		  });
		});
	});
	


 (function(){
	let battleModeActive = false;
	let battleMatched = false;
	let battleInterval = null;
	let battleSpecialTimer = null; 
	let battleSpecialLogTimer = null;
	let btrSpecialActive = false;
	let totalEnemyDamage = 0;
	let totalSelfDamage = 0;
	let resultCalculated = false;
	let resultData = null;
	let battleEnded = false;
	let processedCommands = {};
	const battleDuration = 60; // æˆ°é¬¥æ™‚é•· 180 ç§’ï¼ˆ3 åˆ†é˜ï¼‰
	
	const attackPhrases = {
	  normal: [
		"åƒµå°¸è‡ªä¿¡åœ°æ‰“å‡ºä¸€å€‹é•·é»å°„",
		"åƒµå°¸ä½¿ç”¨å–®ç™¼é»å°„ï¼Œé€²è¡Œç²¾ç¢ºå°„æ“Š",
		"åƒµå°¸å…‹åˆ¶åœ°æ‰“å‡ºå…©å€‹çŸ­é»å°„",
		"åƒµå°¸æŠŠæ§èˆ‰éé ­é ‚ï¼Œäº‚å°„ä¸€é€š",
		"åƒµå°¸èª¿åˆ°å…¨è‡ªå‹•ï¼Œé€²è¡Œå£“åˆ¶å°„æ“Š"
	  ],
	  btr: [
		"BTR-80ä½¿ç”¨30mmé«˜çˆ†å½ˆéˆ[HE]ï¼Œå‰å‡ºå¯¦æ–½ç«åŠ›æ”¯æ´",
		"BTR-80ä½¿ç”¨30mmæ··åˆå½ˆéˆ[AP+HE+API]ï¼Œå°ç›®æ¨™å±•é–‹ç«åŠ›è¦†è“‹",
		"BTR-80ä½¿ç”¨30mmå°ç©ºå½ˆéˆ[API+HE+AP-T]ï¼Œå°ç›®æ¨™å±•é–‹ç²¾æº–å°„æ“Š",
		"BTR-80ä½¿ç”¨30mmç©¿ç”²å½ˆéˆ[AP]ï¼Œå°æ•µæ–¹æ©é«”å±•é–‹é›†ä¸­å°„æ“Š",
		"BTR-80ä½¿ç”¨30mmæ›³å…‰å½ˆéˆ[AP-T+API+HE-T]ï¼Œå°æ•µæ–¹é›†ç¾¤é€²è¡Œå¨æ‡¾å°„æ“Š",
		"BTR-80ä½¿ç”¨30mmç©¿ç‡ƒå½ˆéˆ[API]ï¼Œå°è¼•è£ç”²ç›®æ¨™å±•é–‹å£“åˆ¶å°„æ“Š"
	  ],
	  t80: [
	    "T-80ä½¿ç”¨12.7mmé«˜å°„æ©Ÿæ§[7n34]ï¼Œå°ç›®æ¨™å±•é–‹ç²¾ç¢ºé»å°„",
		"T-80ä½¿ç”¨125mmé«˜çˆ†å½ˆ[3OF26]ï¼Œå°é–‹é—Šåœ°ç›®æ¨™å¯¦æ–½å°„æ“Š",
		"T-80ä½¿ç”¨125mmé«˜çˆ†å½ˆ[3OF26]ï¼Œå°æ©é«”å…§ç›®æ¨™å¯¦æ–½å°„æ“Š",
		"T-80ä½¿ç”¨125mmç©¿ç”²å½ˆ[3BM42]ï¼Œå°æ··å‡åœŸå»ºç¯‰å¯¦æ–½è²«ç©¿å°„æ“Š",
		"T-80æ¡ç”¨125mmç©¿ç”²å½ˆ[3BM60]ï¼Œå°æ•µæ–¹é‡è£ç”²ç›®æ¨™å¯¦æ–½è²«ç©¿å°„æ“Š",
		"T-80ä½¿ç”¨125mmç ´ç”²å½ˆ[3BK18M]ï¼Œå°æ··å‡åœŸå»ºç¯‰å¯¦æ–½ç ´å£å°„æ“Š",
		"T-80ä½¿ç”¨125mmç ´ç”²å½ˆ[3BK18M]ï¼Œå°æ•µæ–¹è¼•è£ç”²ç›®æ¨™å¯¦æ–½ç ´å£å°„æ“Š"
	  ]
	};
	function getRandomPhrase(type) {
	  let phrases = attackPhrases[type];
	  if (!phrases || phrases.length === 0) {
		// æ²’æœ‰ç‰¹å®šé¡å‹ï¼Œè¿”å›ä¸€èˆ¬æ”»æ“Šçš„æè¿°
		phrases = attackPhrases.normal;
	  }
	  const index = Math.floor(Math.random() * phrases.length);
	  return phrases[index];
	}

	// ä¿®æ”¹å¾Œï¼šé€²å…¥å°æˆ°æ¨¡å¼åªåˆå§‹åŒ–ç¨ç«‹å°æˆ°å‹•ç•«
	function enterBattleMode() {
        if (battleModeActive) return;
        battleModeActive = true;
        battleMatched = false;
        document.getElementById("battleOverlay").style.display = "block";
        document.body.style.overflow = "hidden";
        // åˆå§‹åŒ–å°æˆ°å‹•ç•«ï¼Œå·±æ–¹ä½¿ç”¨ window.currentZombieSprite
        initBattleAnimation(false);
        // ç‚º battleOverlay ç¶å®šé›™æ“Šé€€å‡ºäº‹ä»¶
        document.getElementById("battleOverlay").addEventListener("dblclick", exitBattleMode);
      }
	  
      function exitBattleMode() {
        if (!battleModeActive) return;
        battleModeActive = false;
        battleMatched = false;
        document.getElementById("battleOverlay").style.display = "none";
        document.body.style.overflow = "";
		
		// æ¸…ç†è®¡æ—¶å™¨
		if (battleInterval) {
		clearInterval(battleInterval);
		battleInterval = null;
	  }
	  if (battleSpecialTimer) {
		clearInterval(battleSpecialTimer);
		battleSpecialTimer = null;
	  }
	  if (battleSpecialLogTimer) {
		clearInterval(battleSpecialLogTimer);
		battleSpecialLogTimer = null;
	  }
	  if (statusCheckInterval) {
		clearInterval(statusCheckInterval);
		statusCheckInterval = null;
	  }
	  if (battleBTREventTimer) {
		clearInterval(battleBTREventTimer);
		battleBTREventTimer = null;
	  }
	  if (battleBTRInterval) {
		clearInterval(battleBTRInterval);
		battleBTRInterval = null;
	  }
		
		// æ¸…ç† Firebase ç›‘å¬
		if (window.currentBattleRoom) {
		  const roomRef = firebase.database().ref("battles").child(window.currentBattleRoom);
		  
		  // ç§»é™¤ç”¨æˆ·
		  if (window.myRole === "userA") {
			roomRef.child("userA").remove();
		  } else if (window.myRole === "userB") {
			roomRef.child("userB").remove();
		  }
		  
		  // æ£€æŸ¥æˆ¿é—´æ˜¯å¦ä¸ºç©º
		  roomRef.once("value").then(snapshot => {
			const data = snapshot.val();
			if ((!data.userA || !data.userA.uid) && (!data.userB || !data.userB.uid)) {
			  // æˆ¿é—´ä¸ºç©ºï¼Œåˆ é™¤æ•´ä¸ªæˆ¿é—´
			  roomRef.remove();
			}
		  });
		  
		  // ç§»é™¤ç»“æœç›‘å¬
		  roomRef.child("result").off();
		}
		
		// é‡ç½®å˜é‡
		window.currentBattleRoom = null;
		window.myRole = null;
		resultData = null;
		resultCalculated = false;
		totalSelfDamage = 0;
		totalEnemyDamage = 0;
		window.location.reload();
	  }

	 function updateBattleZombieSearchSprite() {
      const battleZombieElem = document.querySelector("#battleSelfAnim .zombie-search");
      if (!battleZombieElem) return;
      battleZombieElem.style.backgroundImage = "url('" + window.currentZombieSprite + "')";
	  battleZombieElem.style.backgroundImage = "url('" + window.currentT80Sprite + "')";
	  battleZombieElem.style.backgroundImage = "url('" + window.currentBtrSprite + "')";
    }
	

	 function initBattleAnimation(match) {
        const selfAnim = document.getElementById("battleSelfAnim");
        const enemyAnim = document.getElementById("battleEnemyAnim");
        selfAnim.innerHTML = "";
        enemyAnim.innerHTML = "";
        selfAnim.style.backgroundImage = "url('images/location_day_1.png')";
        selfAnim.style.backgroundRepeat = "repeat-x";
        selfAnim.style.backgroundSize = "auto 100%";
        selfAnim.style.backgroundPosition = "center top";
        selfAnim.style.animation = "scrollBgRight 30s linear infinite";
        if (match) {
          enemyAnim.style.backgroundImage = selfAnim.style.backgroundImage;
          enemyAnim.style.backgroundRepeat = "repeat-x";
          enemyAnim.style.backgroundSize = "auto 100%";
          enemyAnim.style.backgroundPosition = "center top";
          enemyAnim.style.animation = "scrollBgRight 30s linear infinite";
        } else {
          enemyAnim.style.backgroundColor = "#000";
          enemyAnim.style.animation = "";
        }
        // å‰µå»ºå·±æ–¹åƒµå°¸æœå°‹å‹•ç•«å…ƒç´ ï¼Œä½¿ç”¨ window.currentZombieSprite
        let zombieSearch = document.createElement("div");
        zombieSearch.className = "zombie-search";
        zombieSearch.style.backgroundImage = "url('" + window.currentZombieSprite + "')";
        selfAnim.appendChild(zombieSearch);
      }
	  
	function handleIncomingDamage(damage) {
	  totalSelfDamage += damage;
	}

	// ä¿®æ”¹ appendBattleLogEntry å‡½æ•°
	function appendBattleLogEntry(messageObj) {
	  // ç¡®ä¿ messageObj æ˜¯å¯¹è±¡
	  if (typeof messageObj !== 'object' || messageObj === null) {
		return;
	  }
	  
	  // å¤„ç†ç³»ç»Ÿæ¶ˆæ¯
	  if (messageObj.senderRole === "system") {
		const entry = document.createElement("div");
		entry.className = "log-entry battle-system-entry";
		entry.textContent = messageObj.message || "ç³»ç»Ÿæ¶ˆæ¯";
		
		const logContainer = document.getElementById("battleLogContent");
		if (logContainer) {
		  logContainer.appendChild(entry);
		  logContainer.scrollTop = logContainer.scrollHeight;
		}
		return;
	  }
	  
	  // å¤„ç†æ™®é€šæ¶ˆæ¯
	  const sender = messageObj.sender || "æœªçŸ¥";
	  const msg = messageObj.message || "æœªçŸ¥"; // ç¡®ä¿ msg è¢«å®šä¹‰
	  
	  // ç»„åˆæ˜¾ç¤ºæ–‡æœ¬
	  const displayText = `${sender}æ´¾é£çš„${msg}`;
	  
	  const entry = document.createElement("div");
	  
	  // æ ¹æ® senderRole ä¸æœ¬åœ°è§’è‰²åŒºåˆ†æ ·å¼
	  if (messageObj.senderRole === window.myRole) {
		entry.className = "log-entry battle-self-entry";
	  } else if (messageObj.senderRole) {
		entry.className = "log-entry battle-enemy-entry";
	  } else {
		entry.className = "log-entry battle-system-entry";
	  }
	  
	  entry.textContent = displayText;
	  
	  const logContainer = document.getElementById("battleLogContent");
	  if (logContainer) {
		logContainer.appendChild(entry);
		logContainer.scrollTop = logContainer.scrollHeight;
	  }
	  
	  // è§£æä¼¤å®³ä¿¡æ¯ - ç°åœ¨ msg å·²ç»è¢«å®šä¹‰
	  if (messageObj.senderRole && messageObj.senderRole !== window.myRole) {
		const damageMatch = msg.match(/å°æ–¹åƒµå°¸-(\d+)/);
		if (damageMatch) {
		  const damage = parseInt(damageMatch[1]);
		  handleIncomingDamage(damage);
		}
	  }
	}

	// æ·»åŠ æ•Œæ–¹ä¼¤å®³å¤„ç†å‡½æ•°
	function handleIncomingDamage(damage) {
	  totalSelfDamage += damage;
	}



	
	// ç•¶é é¢åŠ è¼‰å®Œæˆå¾Œï¼Œåˆå§‹åŒ–ä½¿ç”¨è€… UIDï¼ˆç›´æ¥ä½¿ç”¨æš±ç¨±ï¼‰
	function initializeUser() {
	  let nickname = document.getElementById("battleNickname").value.trim();
	  if (!nickname) {
		return false;
	  }
	  window.myUid = nickname; // å°‡æš±ç¨±ä½œç‚ºå”¯ä¸€æ¨™è­˜
	  return true;
	}

	function startBattleModeFirebase() {
	  let pin = document.getElementById("battlePin").value.trim();
	  if (pin === "") {
		return;
	  }
	  
	  // ä½¿ç”¨æš±ç¨±ä½œç‚º uid
	  let currentUid = document.getElementById("battleNickname").value.trim();
	  if (!currentUid) {
		return;
	  }
	  
	  firebase.database().ref('pveBattles').child(pin).once('value').then((snapshot) => {
		const pveRoomData = snapshot.val();
		if (pveRoomData) {
		  // é€™æ˜¯ä¸€å€‹PVEæˆ¿é–“
		  if (pveRoomData.locked || pveRoomData.mode === 'solo') {
			return;
		  }
		  
		  if (pveRoomData.mode === 'coop' && !pveRoomData.userB) {
			return;
		  }
		  
		  // å…¶ä»–æƒ…æ³ï¼šæˆ¿é–“å·²æ»¿æˆ–ç‹€æ…‹ç•°å¸¸
		  return;
		}
    
		// ä¸æ˜¯PVEæˆ¿é–“ï¼Œç¹¼çºŒåŸæœ‰çš„PVPåŒ¹é…é‚è¼¯
		let battleRoomRef = firebase.database().ref("battles").child(pin);
		// ä½¿ç”¨ once("value") æª¢æŸ¥æˆ¿é–“æ˜¯å¦å­˜åœ¨
		battleRoomRef.once("value").then(function(snapshot) {
		  let battleData = snapshot.val();
		  if (battleData === null) {
			// æˆ¿é–“ä¸å­˜åœ¨ â†’ è¨­ç½® userA
			battleRoomRef.set({
			  userA: { uid: currentUid },
			  log: {}
			}).then(function() {
			  joinBattleRoom(pin, "userA");
			});
		  } else if (battleData.userA && battleData.userA.uid === currentUid) {
			// ç•¶å‰è¨­å‚™å·²ç¶“æ˜¯ userA
			joinBattleRoom(pin, "userA");
		  } else if (!battleData.userB) {
			// æˆ¿é–“å­˜åœ¨ä½†æ²’æœ‰ userB â†’ åŠ å…¥æˆç‚º userB
			battleRoomRef.child("userB").set({ uid: currentUid }).then(function() {
			  joinBattleRoom(pin, "userB");
			});
		  } else if (battleData.userB && battleData.userB.uid === currentUid) {
			// ç•¶å‰è¨­å‚™å·²ç¶“æ˜¯ userB
			joinBattleRoom(pin, "userB");
		  } else {
			alert("æ­¤æˆ°å±€å·²æ»¿ï¼");
		  }
		});
	  }).catch((error) => {
		let battleRoomRef = firebase.database().ref("battles").child(pin);
	  });
	}

	// æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯æ¨é€å‡½æ•°
	function pushSystemMessage(message) {
	  if (!window.currentBattleRoom) return;
	  
	  const data = {
		sender: "ç³»çµ±",
		senderRole: "system",
		message: message
	  };
	  
	  const logRef = firebase.database().ref("battles")
							.child(window.currentBattleRoom)
							.child("log");
	  logRef.push(data);
	}
	function joinBattleRoom(battleId, roleFromServer) {
	  window.currentBattleRoom = battleId;
	  window.myRole = roleFromServer; 
	  window.myUid = document.getElementById("battleNickname").value.trim();
	   // æ¸…ç†æ—§ç»“æœ
	  resultData = null;
	  resultCalculated = false;
	  
	  // å»ºç«‹æˆ¿é–“åƒè€ƒ
	  let roomRef = firebase.database().ref("battles").child(battleId);
	  
	  // æ¸…é™¤ä¸¦æŒçºŒç›£è½æˆ¿é–“ç‹€æ…‹
	  roomRef.off("value");
	  roomRef.on("value", function(snapshot) {
		let data = snapshot.val();
		if (data && data.userA && data.userB) {
		  if (!battleMatched) {
			battleMatched = true;
			initBattleAnimation(true);
			pushBattleLog("é›™æ–¹é€£ç·šæˆåŠŸï¼Œå°æˆ°é–‹å§‹ï¼");
			startBattleTimerFirebase();
			if (battleSpecialTimer) clearInterval(battleSpecialTimer);
		  }
		} else {
		  if (battleMatched) {
			battleMatched = false;
			pushBattleLog("ç­‰å¾…å°æˆ°å°æ‰‹åŠ å…¥...");
		  }
		}
	  });
	  
	  let logRef = roomRef.child("log");
	  logRef.off("child_added");
	  logRef.on("child_added", function(snapshot) {
	    if (battleEnded) return;
		let data = snapshot.val();
		try {  
		  // ç¡®ä¿æ•°æ®æ˜¯å¯¹è±¡
		  if (data && typeof data === 'object') {
			appendBattleLogEntry(data);
		  } else {
			// å¤„ç†æ—§æ ¼å¼æˆ–æ— æ•ˆæ•°æ®
			appendBattleLogEntry({
			  sender: "ç³»çµ±",
			  senderRole: "system",
			  message: data || "æœªçŸ¥æ¶ˆæ¯"
			});
		  }
		} catch (e) {}
	  });
	  listenForZombieStatus();
	  requestZombieStatus();
	  listenForAdjustmentCommand();
	  
	  // æ·»åŠ ç»“æœç›‘å¬
	  const resultRef = roomRef.child("result");
	  resultRef.off("value");
	  resultRef.on("value", snapshot => {
		const result = snapshot.val();
		if (result && !resultData) {
		  resultData = result;
		  displayBattleResult(result);
		}
	  });
	  startStatusCheck();
	  initBattleBTRSystem();
	  listenForEnemyBTR();
	  listenForEnemyBTRAttacks();

	}



	function pushBattleLog(message) {
	  if (battleEnded) return;
	  if (!window.myRole) {
		return;
	  }
	  
	  const data = {
		sender: window.myUid || "æœªçŸ¥", // ä½¿ç”¨æ˜µç§°
		senderRole: window.myRole,      // "userA" æˆ– "userB"
		message: message                // æ”»å‡»æ¶ˆæ¯
	  };
	  if (window.currentBattleRoom) {
		  try {
			const logRef = firebase.database()
			  .ref("battles")
			  .child(window.currentBattleRoom)
			  .child("log");
			logRef.push(data)
			  .catch(() => {
			  });
		  } catch (e) {
		  }
		}
	}


	// ä¿®æ”¹â€œé–‹å§‹å°æˆ°â€æŒ‰éˆ•äº‹ä»¶ï¼Œä»¤å…¶èª¿ç”¨ Firebase å°æˆ°æµç¨‹
	document.getElementById("battleStartBtn").addEventListener("click", function(){
	  initializeUser();
	  startBattleModeFirebase();
	});
	document.getElementById("battleExitBtn").addEventListener("click", function() {
	  exitBattleMode();
	});

	// ä½¿ç”¨ Firebase åŒæ­¥å°æˆ°æ—¥èªŒä¿¡æ¯çš„å°æˆ°äº‹ä»¶
	function triggerBattleEventFirebase() {
	  if (battleEnded || !battleModeActive) {
		return;
	  }
	  const centerBuilding = gameState.buildings.find(b => 
		b && b.type.toLowerCase() === "center"
	  );
	  const centerLevel = centerBuilding ? centerBuilding.level : 1;
	  const hitChance = Math.min(40 + centerLevel * 0.5, 85);
	  
	  // æ¨¡æ‹Ÿæˆ‘æ–¹æ”»å‡»
	  const ourHit = (Math.random() * 100 < hitChance);
	  const baseOurDamage = ourHit ? (Math.floor(Math.random() * 10) + 1): 0;
	   // å¾ gameState ä¸­æŸ¥æ‰¾åƒµå°¸æŒ‡æ®ä¸­å¿ƒçš„ç­‰ç´š
	  let commandCenterLevel = 0;
	  if (window.gameState && window.gameState.buildings) {
		  const commandCenter = window.gameState.buildings.find(b => 
			  b && b.type.toLowerCase() === "zombiecommandcenter"
		  );
		  if (commandCenter) {
			  commandCenterLevel = commandCenter.level;
		  }
	  }

	  // æ¯ç´š1%çš„åŠ æˆï¼šå€ç‡ = 1 + (åƒµå°¸æŒ‡æ®ä¸­å¿ƒç­‰ç´š Ã— 0.01)
	  const multiplierZ = 1 + commandCenterLevel * 0.01;

	  // æœ€çµ‚å‚·å®³
	  const ourDamage = Math.round(baseOurDamage * multiplierZ);
	  const phrase = getRandomPhrase("normal");
	  if (ourHit) {
	    pushBattleLog( phrase + "ï¼ˆå‘½ä¸­ï¼‰ï¼Œå°æ–¹åƒµå°¸-" + ourDamage);
		totalEnemyDamage += ourDamage;
	  } else {
		pushBattleLog( phrase + "ï¼ˆæœªå‘½ä¸­ï¼‰");
	  }
	}


	function startBattleTimerFirebase() {
	   let remaining = battleDuration;
		battleInterval = setInterval(function() {
		  if (remaining <= 0) {
			endBattle(); // ç›´æ¥èª¿ç”¨æˆ‘å€‘çš„æ–°å‡½æ•¸ï¼Œç«‹å³çµ‚æ­¢æ‰€æœ‰äº‹ä»¶ç”Ÿæˆ
			} else {
			  // åƒ…åœ¨ battleEnded ç‚º false æ™‚è§¸ç™¼äº‹ä»¶ç”Ÿæˆ
			  if (!battleEnded) {
				triggerBattleEventFirebase();
			  }
			  remaining -= 5;
			}
		}, 5000);
	}
	function endBattle() {
	  // ç«‹å³æ¸…é™¤æ‰€æœ‰å®šæ™‚å™¨
	  if (battleInterval) {
		clearInterval(battleInterval);
		battleInterval = null;
	  }
	  if (battleSpecialTimer) {
		clearInterval(battleSpecialTimer);
		battleSpecialTimer = null;
	  }
	  if (battleBTREventTimer) {
		clearInterval(battleBTREventTimer);
		battleBTREventTimer = null;
	  }

	  // ç«‹å³å¸è¼‰ Firebase ä¸Šå° log èˆ‡ btrAttacks çš„ç›£è½å™¨
	  const roomRef = firebase.database().ref("battles").child(window.currentBattleRoom);
	  roomRef.child("log").off();
	  roomRef.child("btrAttacks").off();

	  // è¨­å®š battleEnded ç‚º trueï¼Œé˜»æ­¢æœªä¾†æ‰€æœ‰äº‹ä»¶ç”Ÿæˆå…¥å£
	  battleEnded = true;

	  // å¦‚æœæœ¬ç«¯æ˜¯ userA ä¸”çµæœå°šæœªè¨ˆç®—ï¼Œå‰‡è¨ˆç®—ä¸¦ä¸Šå‚³æˆ°é¬¥çµæœ
	  if (window.myRole === "userA" && !resultCalculated) {
		calculateAndBroadcastBattleResult();
	  }
	  
	  // ç›£è½çµæœï¼ˆè®“æ‰€æœ‰ç”¨æˆ¶éƒ½çœ‹åˆ°æœ€çµ‚çµæœï¼‰
	  listenForBattleResult();

	  // ç™¼é€æˆ°é¬¥çµæŸç³»çµ±æç¤º
	  pushSystemMessage("æˆ°é¬¥çµæŸï¼æˆ°é¬¥ç¸½çµç”Ÿæˆä¸­");
	}
	function clearPendingEvents() {
	  // æ¸…é™¤æ‰€æœ‰è®¡åˆ’ä¸­çš„äº‹ä»¶
	  if (window.pendingEvents) {
		window.pendingEvents.forEach(timeoutId => {
		  clearTimeout(timeoutId);
		});
		window.pendingEvents = [];
	  }
	}

	function calculateAndBroadcastBattleResult() {
	  // ç¡®ä¿åªè®¡ç®—ä¸€æ¬¡
	  if (resultCalculated) return;
	  resultCalculated = true;
	  
	  // è·å–æˆ¿é—´æ•°æ®
	  const roomRef = firebase.database().ref("battles").child(window.currentBattleRoom);
	  
	  roomRef.once("value").then(snapshot => {
		const roomData = snapshot.val();
		if (!roomData || !roomData.userA || !roomData.userB) return;
		
		// è·å–åŒæ–¹UID
		const userAUid = roomData.userA.uid;
		const userBUid = roomData.userB.uid;
		
		// è·å–åŒæ–¹ä¼¤å®³æ•°æ®
		const logEntries = Object.values(roomData.log || {});
		
		// è®¡ç®—åŒæ–¹ä¼¤å®³
		let damageA = 0;
		let damageB = 0;
		
		logEntries.forEach(entry => {
		  if (entry.senderRole === "userA") {
			const damageMatch = entry.message.match(/å°æ–¹åƒµå°¸-(\d+)/);
			if (damageMatch) damageB += parseInt(damageMatch[1]);
		  } else if (entry.senderRole === "userB") {
			const damageMatch = entry.message.match(/å°æ–¹åƒµå°¸-(\d+)/);
			if (damageMatch) damageA += parseInt(damageMatch[1]);
		  }
		});
		
		// åˆ¤å®šèƒœè´Ÿ
		let winnerUid = null;
		let loserUid = null;
		let isDraw = false;
		
		if (damageA < damageB) {
		  winnerUid = userAUid;
		  loserUid = userBUid;
		} else if (damageA > damageB) {
		  winnerUid = userBUid;
		  loserUid = userAUid;
		} else {
		  isDraw = true; // å¹³å±€
		}
		
		// åˆ›å»ºç»“æœå¯¹è±¡
		const result = {
		  userA: userAUid,
		  userB: userBUid,
		  damageA: damageA,
		  damageB: damageB,
		  isDraw: isDraw, // æ·»åŠ å¹³å±€æ ‡å¿—
		  timestamp: Date.now()
		};
		// åªåœ¨æœ‰èƒœè´Ÿæ—¶è®¾ç½®èƒœè´¥æ–¹
		if (!isDraw) {
		  result.winner = winnerUid;
		  result.loser = loserUid;
		}
		
		// ä¿å­˜ç»“æœåˆ°Firebase
		roomRef.child("result").set(result);
		
		// è¯·æ±‚åŒæ–¹ä¸Šä¼ åƒµå°¸çŠ¶æ€
		const myStatus = {
		  uid: window.myUid,
		  totalZombies: gameState.totalZombies,
		  allocations: {...gameState.allocations}
		};
		
		roomRef.child("status").child(window.myRole).set(myStatus);
		
		// é€šçŸ¥å¯¹æ–¹ä¹Ÿä¸Šä¼ çŠ¶æ€
		pushSystemMessage("æˆ°é¬¥çµæŸï¼Œè‡ªå‹•ä¸Šå‚³åƒµå°¸ç‹€æ…‹...");
	  });
	}
	// æ·»åŠ åƒµå°¸çŠ¶æ€è¯·æ±‚å‡½æ•°
	function requestZombieStatus() {
	  if (!window.currentBattleRoom) return;
	  
	  // ä¸Šä¼ è‡ªå·±çš„åƒµå°¸çŠ¶æ€
	  
  
	  const myStatus = {
		uid: window.myUid,
		totalZombies: gameState.totalZombies,
		allocations: { ...gameState.allocations },

		currentZombieSprite: window.currentZombieSprite,

		currentT80Sprite: window.currentT80Sprite,
		currentBtrSprite: window.currentBtrSprite,

		resources: {
		  food: gameState.resources.food,
		  materials: gameState.resources.materials,
		  weapons: gameState.resources.weapons,
		  tech: gameState.resources.tech
		}
	  };
	  
	  const statusRef = firebase.database().ref("battles")
		.child(window.currentBattleRoom)
		.child("status")
		.child(window.myRole);
	  
	  statusRef.transaction(current => {
		return myStatus; // ç›´æ¥æ›¿æ¢ä¸ºæ–°æ•°æ®
	  }, (error, committed) => {
	  }, false); 
	}

	// æ·»åŠ åƒµå°¸çŠ¶æ€ç›‘å¬
	function listenForZombieStatus() {
	  if (!window.currentBattleRoom) return; 
	  const statusRef = firebase.database().ref("battles")
		.child(window.currentBattleRoom)
		.child("status");
	  
	  // æ¸…é™¤æ—§ç›‘å¬
	  statusRef.off("value");
	  
	  statusRef.on("value", snapshot => {
		const statusData = snapshot.val();		
		// +++ æ›´å¥å£®çš„çŠ¶æ€æ£€æŸ¥ +++
		const userAReady = statusData && statusData.userA && statusData.userA.uid;
		const userBReady = statusData && statusData.userB && statusData.userB.uid;
		
		if (userAReady && userBReady) {
		  const enemyRole = window.myRole === "userA" ? "userB" : "userA";
		   window.opponentZombieSprite = statusData[enemyRole].currentZombieSprite;
		   window.opponentT80Sprite = statusData[enemyRole].currentT80Sprite;
		   window.opponentBtrSprite = statusData[enemyRole].currentBtrSprite;
		  
		  initEnemyZombieSearchAnimation(window.opponentZombieSprite);
		  pushSystemMessage("é›™æ–¹ç‹€æ…‹å·²æ¥æ”¶ï¼Œé–‹å§‹è¨ˆç®—è³‡æºèª¿æ•´");
		  
		  // åªæœ‰ userA è®¡ç®—èµ„æºè°ƒæ•´
		  if (window.myRole === "userA") {
			calculateResourceAdjustment(statusData);
		  }
		} else {
		  // å¦‚æœæ˜¯userBæ²¡å‡†å¤‡å¥½ä¸”æˆ‘æ˜¯userAï¼Œå°è¯•é‡æ–°è¯·æ±‚
		  if (!userBReady && window.myRole === "userA") {
			pushSystemMessage("è«‹æ±‚userBé‡æ–°ä¸Šå‚³ç‹€æ…‹...");
			const logRef = firebase.database().ref("battles")
			  .child(window.currentBattleRoom)
			  .child("log");
			  
			logRef.push({
			  sender: "ç³»ç»Ÿ",
			  senderRole: "system",
			  message: "userBè¯·é‡æ–°ä¸Šä¼ åƒµå°¸çŠ¶æ€"
			});
		  }
		}
	  });
	}
	function startStatusCheck() {
	  if (statusCheckInterval) clearInterval(statusCheckInterval);
	  
	  statusCheckInterval = setInterval(() => {
		if (!window.currentBattleRoom) return;
		
		const statusRef = firebase.database().ref("battles")
		  .child(window.currentBattleRoom)
		  .child("status");
		
		statusRef.once("value").then(snapshot => {
		  const statusData = snapshot.val();
		  
		  // å¦‚æœuserBçŠ¶æ€ä¸å­˜åœ¨ï¼Œä¸”æˆ‘æ˜¯userBï¼Œç«‹å³ä¸Šä¼ 
		  if (window.myRole === "userB" && 
			  (!statusData || !statusData.userB || !statusData.userB.uid)) {
			requestZombieStatus();
		  }
		});
	  }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
	}

	// æ·»åŠ èµ„æºè°ƒæ•´è®¡ç®—å‡½æ•°
	function calculateResourceAdjustment(statusData) {
	  // ç¡®ä¿æ˜¯userAæ‰§è¡Œè®¡ç®—
	  if (window.myRole !== "userA") return;
	  
	  // è·å–ç»“æœæ•°æ®
	  const resultRef = firebase.database().ref("battles")
		.child(window.currentBattleRoom)
		.child("result");
	  
	  resultRef.once("value").then(snapshot => {
		const result = snapshot.val();
		if (!result || !result.winner) return;
		
		// è·å–åŒæ–¹çŠ¶æ€
		const winnerStatus = result.winner === statusData.userA.uid ? statusData.userA : statusData.userB;
		const loserStatus = result.loser === statusData.userA.uid ? statusData.userA : statusData.userB;
		
		if (!result.winner) {
			pushSystemMessage("å¹³å±€ï¼Œé›™æ–¹è³‡æºä¿æŒä¸è®Š");
			return;
		  }
		// è®¡ç®—è°ƒæ•´æ¯”ä¾‹ï¼ˆ10%-20%ï¼‰
		const adjustmentFraction = 0.1 + Math.random() * 0.1;
		const adjustmentAmount = Math.floor(loserStatus.totalZombies * adjustmentFraction);
		
		// è®¡ç®—èµ¢å®¶åˆ†é…æ¯”ä¾‹ï¼ˆæ¢ç´¢:å†œä¸š:å›æ”¶:ç ”ç©¶ = 4:4:1:1ï¼‰
		const winRatios = { exploration: 4, farming: 4, recycling: 1, research: 1 };
		const winTotalRatio = 10;
		
		// è®¡ç®—èµ¢å®¶å„éƒ¨é—¨å¢åŠ é‡
		const winnerAdjustment = {};
		for (const department in winRatios) {
		  const ratio = winRatios[department];
		  winnerAdjustment[department] = Math.floor(adjustmentAmount * (ratio / winTotalRatio));
		}
		
		// è®¡ç®—è¾“å®¶å„éƒ¨é—¨æ‰£é™¤é‡ï¼ˆå¹³å‡æ‰£é™¤ï¼‰
		const departments = Object.keys(loserStatus.allocations);
		const deductionPerDept = Math.floor(adjustmentAmount / departments.length);
		const loserAdjustment = {};
		
		for (const department of departments) {
		  loserAdjustment[department] = deductionPerDept;
		}
		// +++ æ–°å¢èµ„æºè½¬ç§»è®¡ç®— +++
	    const resourceTypes = ['food', 'materials', 'weapons', 'tech'];
	    const selectedResource = resourceTypes[Math.floor(Math.random() * resourceTypes.length)];
	  
	    // è·å–å¤±è´¥æ–¹è¯¥èµ„æºæ•°é‡
	    const loserResource = loserStatus.resources[selectedResource] || 0;
	  
	    // è®¡ç®—è½¬ç§»é‡ï¼ˆ20%ï¼‰
	    const resourceAdjustment = Math.floor(loserResource * 0.2);
		// åˆ›å»ºè°ƒæ•´æŒ‡ä»¤
		const adjustmentCommand = {
		  winner: result.winner,
		  loser: result.loser,
		  adjustmentAmount: adjustmentAmount,
		  winnerAdjustment: winnerAdjustment,
		  loserAdjustment: loserAdjustment,
		  // +++ æ–°å¢èµ„æºè½¬ç§»å­—æ®µ +++
		  resourceType: selectedResource, // éšæœºé€‰æ‹©çš„èµ„æºç±»å‹
		  resourceAmount: resourceAdjustment // è½¬ç§»æ•°é‡
		};
		
		// å¹¿æ’­è°ƒæ•´æŒ‡ä»¤
		const commandRef = firebase.database().ref("battles")
		  .child(window.currentBattleRoom)
		  .child("command");
		
		commandRef.set(adjustmentCommand);
	  });
	}
	// æ·»åŠ è°ƒæ•´æŒ‡ä»¤ç›‘å¬
	function listenForAdjustmentCommand() {
	  if (!window.currentBattleRoom) return;
	  
	  const commandRef = firebase.database().ref("battles")
		.child(window.currentBattleRoom)
		.child("command");
	  
	  commandRef.off("value");
	  commandRef.on("value", snapshot => {
		const command = snapshot.val();
		if (!command) return;
    
		// +++ æ·»åŠ æŒ‡ä»¤å”¯ä¸€æ€§æ£€æŸ¥ +++
		const commandId = command.timestamp; // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
		
		// å¦‚æœå·²ç»å¤„ç†è¿‡è¿™ä¸ªæŒ‡ä»¤ï¼Œåˆ™è·³è¿‡
		if (processedCommands[commandId]) {
		  return;
		}
		
		// æ ‡è®°æŒ‡ä»¤å·²å¤„ç†
		processedCommands[commandId] = true;
		applyResourceAdjustment(command);
	  });
	}
	function endBattleFirebase() {
	  if (window.currentBattleRoom) {
		firebase.database().ref("battles")
		  .child(window.currentBattleRoom)
		  .child("log")
		  .off();
	  }
	}

	function listenForBattleResult() {
	  if (!window.currentBattleRoom) return;
	  
	  const resultRef = firebase.database().ref("battles")
		.child(window.currentBattleRoom)
		.child("result");
	  resultRef.off("value");
	  
	  resultRef.on("value", snapshot => {
		const result = snapshot.val();
		if (result && !resultData) {
		  resultData = result;
		
		  displayBattleResult(result);
		  
		 // +++ ç¡®ä¿æ‰€æœ‰ç©å®¶éƒ½ä¸Šä¼ çŠ¶æ€ +++
		  const myStatus = {
			uid: window.myUid,
			totalZombies: gameState.totalZombies,
			allocations: {...gameState.allocations},
			// +++ æ–°å¢èµ„æºæ•°æ® +++
			resources: {
			  food: gameState.resources.food,
			  materials: gameState.resources.materials,
			  weapons: gameState.resources.weapons,
			  tech: gameState.resources.tech
			}
		  };
		  
		  // +++ ä½¿ç”¨ç»Ÿä¸€è·¯å¾„æ ¼å¼ +++
		  const statusRef = firebase.database().ref("battles")
			.child(window.currentBattleRoom)
			.child("status")
			.child(window.myRole); // ç›´æ¥å­˜å‚¨åœ¨ userA/userB ä¸‹
		  
		  statusRef.set(myStatus)
			.then(() => {
			  pushSystemMessage(`ç‹€æ…‹å·²ä¸Šå‚³: ${gameState.totalZombies} åƒµå°¸`);
			})
			.catch(error => {
			  pushSystemMessage("ç‹€æ…‹ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥");
			  setTimeout(() => statusRef.set(myStatus), 2000);
			});
		}
	  });
	}

	// æ·»åŠ ç»“æœæ˜¾ç¤ºå‡½æ•°
	function displayBattleResult(result) {
	  if (!result) return;
	  
	  // æ˜¾ç¤ºä¼¤å®³ç»Ÿè®¡
	  const damageMessage = `æˆ°é¬¥å ±å‘Šï¼š
		${result.userA} æ“Šæ–ƒ: ${result.damageB} ååƒµå°¸
		${result.userB} æ“Šæ–ƒ: ${result.damageA} ååƒµå°¸`;
	  
	  pushSystemMessage(damageMessage);
	  
	  // +++ å¤„ç†å¹³å±€æƒ…å†µ +++
	  if (result.isDraw) {
		pushSystemMessage("æœ€çµ‚çµæœï¼šå¹³æ‰‹");
	  } else if (result.winner) {
		const winnerName = result.winner === result.userA ? result.userA : result.userB;
		const loserName = result.winner === result.userA ? result.userB : result.userA;
		
		const resultMessage = `æœ€çµ‚çµæœï¼š
		  ${result.winner} å‹åˆ©
		  ${result.loser} å¤±æ•—`;
		
		pushSystemMessage(resultMessage);
	  }
	}
	function applyResourceAdjustment(command) {
	  // ç¡®å®šå½“å‰ç©å®¶èº«ä»½
	  const isWinner = window.myUid === command.winner;
	  const isLoser = window.myUid === command.loser;
	  
	  if (!command.winner) {
		pushSystemMessage("å¹³å±€ï¼Œæ— èµ„æºè°ƒæ•´");
		return;
	  }
	  
	  // åº”ç”¨è°ƒæ•´
	  if (isWinner) {
		// èµ¢å®¶ï¼šæŒ‰æ¯”ä¾‹å¢åŠ å„éƒ¨é—¨åƒµå°¸
		for (const department in command.winnerAdjustment) {
		  const amount = command.winnerAdjustment[department];
		  gameState.allocations[department] += amount;
		  gameState.totalZombies += amount;
		}
		
		// æ˜¾ç¤ºè°ƒæ•´ä¿¡æ¯
		const adjustmentMessage = `å‹æ–¹ï¼ˆ${window.myUid}ï¼‰æ å¥ªé‡ï¼š
		  æ¢ç´¢éƒ¨é–€ +${command.winnerAdjustment.exploration || 0}
		  è¾²æ¥­éƒ¨é–€ +${command.winnerAdjustment.farming || 0}
		  å›æ”¶éƒ¨é–€ +${command.winnerAdjustment.recycling || 0}
		  ç ”ç©¶éƒ¨é–€ +${command.winnerAdjustment.research || 0}
		  ç¸½è¨ˆ +${command.adjustmentAmount}éš»åƒµå°¸`;
		
		pushSystemMessage(adjustmentMessage);
	  } 
	  else if (isLoser) {
		// è¾“å®¶ï¼šå¹³å‡æ‰£é™¤å„éƒ¨é—¨åƒµå°¸
		for (const department in command.loserAdjustment) {
		  const amount = command.loserAdjustment[department];
		  // ç¡®ä¿ä¸è¶…è¿‡å½“å‰æ•°é‡
		  const deduction = Math.min(amount, gameState.allocations[department] || 0);
		  gameState.allocations[department] -= deduction;
		  gameState.totalZombies -= deduction;
		}
		
		// æ˜¾ç¤ºè°ƒæ•´ä¿¡æ¯
		const adjustmentMessage = `æ•—æ–¹ï¼ˆ${window.myUid}ï¼‰æå¤±é‡ï¼š
		  æ¢ç´¢éƒ¨é–€ -${command.loserAdjustment.exploration || 0}
		  è¾²æ¥­éƒ¨é–€ -${command.loserAdjustment.farming || 0}
		  å›æ”¶éƒ¨é–€ -${command.loserAdjustment.recycling || 0}
		  ç ”ç©¶éƒ¨é–€ -${command.loserAdjustment.research || 0}
		  ç¸½è¨ˆ -${command.adjustmentAmount}éš»åƒµå°¸`;
		
		pushSystemMessage(adjustmentMessage);
	  }
	  // +++ æ–°å¢èµ„æºè½¬ç§»å¤„ç† +++
	  if (command.resourceType && command.resourceAmount) {
		const resourceName = resourceMapping[command.resourceType];
		
		if (isWinner) {
		  // èƒœæ–¹å¢åŠ èµ„æº
		  gameState.resources[command.resourceType] += command.resourceAmount;
		  
		  // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
		  const gainMessage = `å‹æ–¹ï¼ˆ${window.myUid}ï¼‰ç²å¾—${resourceName}è³‡æº: +${command.resourceAmount}`;
		  pushSystemMessage(gainMessage);
		  
		  // æ›´æ–°UIæ˜¾ç¤º
		  updateResourceDisplays(command.resourceType);
		} 
		else if (isLoser) {
		  // è´¥æ–¹æ‰£é™¤èµ„æºï¼ˆç¡®ä¿ä¸ä½äº0ï¼‰
		  const currentAmount = gameState.resources[command.resourceType] || 0;
		  const deduction = Math.min(command.resourceAmount, currentAmount);
		  
		  gameState.resources[command.resourceType] -= deduction;
		  
		  // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
		  const lossMessage = `æ•—æ–¹ï¼ˆ${window.myUid}ï¼‰æå¤±${resourceName}è³‡æº: -${deduction}`;
		  pushSystemMessage(lossMessage);
		  
		  // æ›´æ–°UIæ˜¾ç¤º
		  updateResourceDisplays(command.resourceType);
		}
	  }
	  
	  // ä¿å­˜æ¸¸æˆçŠ¶æ€
	  saveGameState();
	  
	  // æ›´æ–°UI
	  updateResourceDisplays();
	}
	

	function triggerBattleEvent() {
	  if (!battleMatched) return;
	  
	  const centerBuilding = gameState.buildings.find(b => b && b.type.toLowerCase() === "center");
	  const centerLevel = centerBuilding ? centerBuilding.level : 1;
	  const hitChance = Math.min(40 + centerLevel * 0.5, 85);

	  const ourHit = (Math.random() * 100 < hitChance);
	  const baseOurDamage = ourHit ? (Math.floor(Math.random() * 10) + 1): 0;
	   // å¾ gameState ä¸­æŸ¥æ‰¾åƒµå°¸æŒ‡æ®ä¸­å¿ƒçš„ç­‰ç´š
	  let commandCenterLevel = 0;
	  if (window.gameState && window.gameState.buildings) {
		  const commandCenter = window.gameState.buildings.find(b => 
			  b && b.type.toLowerCase() === "zombiecommandcenter"
		  );
		  if (commandCenter) {
			  commandCenterLevel = commandCenter.level;
		  }
	  }

	  // æ¯ç´š1%çš„åŠ æˆï¼šå€ç‡ = 1 + (åƒµå°¸æŒ‡æ®ä¸­å¿ƒç­‰ç´š Ã— 0.01)
	  const multiplierZ = 1 + commandCenterLevel * 0.01;

	  // æœ€çµ‚å‚·å®³
	  const ourDamage = Math.round(baseOurDamage * multiplierZ);
	  const phrase = getRandomPhrase("normal");
	  if (ourHit) {
		pushBattleLog( phrase + "ï¼ˆå‘½ä¸­ï¼‰ï¼Œå°æ–¹åƒµå°¸-" + ourDamage);
		totalEnemyDamage += ourDamage;
	  } else {
		pushBattleLog( phrase + "ï¼ˆæœªå‘½ä¸­ï¼‰");
	  }

	}


	
	function initEnemyZombieSearchAnimation(sprite) {
	  const enemyAnim = document.getElementById("battleEnemyAnim");
	  if (!enemyAnim) return;
	  
	  // æ¸…é™¤èˆŠå‹•ç•«ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
	  const oldZombie = enemyAnim.querySelector(".enemy-zombie-search");
	  if (oldZombie) {
		enemyAnim.removeChild(oldZombie);
	  }
	  
	  // å‰µå»ºåƒµå°¸æœç´¢å…ƒç´ ï¼Œç›´æ¥ä½¿ç”¨å‚³å…¥çš„ sprite
	  const zombieSearch = document.createElement("div");
	  zombieSearch.className = "zombie-search enemy-zombie-search";
	  zombieSearch.style.backgroundImage = `url('${sprite}')`;
	  
	  // æ·»åŠ åˆ°æ•µæ–¹å‹•ç•«çª—å£
	  enemyAnim.appendChild(zombieSearch);
	}

	
	/***** å¯¹æˆ˜æ¨¡å¼BTR/T-80äº‹ä»¶ç³»ç»Ÿ *****/
	let battleBTREventTimer = null;
	let battleBTRActive = false;
	let battleBTRType = null;
	let battleBTRInterval = null;
	let battleBTRWrapper = null;
	let statusCheckInterval = null;

	// 1. åˆå§‹åŒ–å¯¹æˆ˜æ¨¡å¼BTRäº‹ä»¶ç³»ç»Ÿ
	function initBattleBTRSystem() {
	  if (battleBTREventTimer) clearInterval(battleBTREventTimer);
	  
	  // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡BTRäº‹ä»¶
	  battleBTREventTimer = setInterval(() => {
		if (!battleModeActive || battleEnded || !battleMatched) return;
		
		const garages = gameState.buildings.filter(b => 
		  b && b.type.toLowerCase() === "armoredgarage"
		);
		
		if (garages.length > 0) {
		  const garageInfo = BUILDINGS.armoredGarage.getUpgradeInfo(garages[0].level);
		  if (Math.random() < garageInfo.effect.btrChance) {
			triggerBattleBTRAnimation();
		  }
		}
	  }, 30000);
	}

	// 2. è§¦å‘å¯¹æˆ˜æ¨¡å¼BTRåŠ¨ç”»
	function triggerBattleBTRAnimation() {
	  const container = document.getElementById("battleSelfAnim");
	  if (!container) {
		return;
	  }
	  
	  const containerWidth = container.clientWidth;
	  const offset = 50;
	  const rootStyles = getComputedStyle(document.documentElement);
	  
	  // 40%å‡ ç‡ä½¿ç”¨T-80ï¼Œå¦åˆ™BTR
	  const useT80 = (Math.random() < 0.4);
	  battleBTRType = useT80 ? "t80" : "btr";
	  
	  let frameWidth;
	  if (useT80) {
		frameWidth = 480;
	  } else {
		frameWidth = parseFloat(rootStyles.getPropertyValue('--btr-frame-width')) || 240;
	  }
	  
	  const centerStart = containerWidth + offset + 0.5 * frameWidth;
	  const centerStop = 0.5 * containerWidth;
	  const startLeft = centerStart - 0.5 * frameWidth;
	  const stopLeft  = centerStop - 0.5 * frameWidth;
	  
	  const keyframesText = `
		@keyframes btrMoveDynamicBattle {
		  0%   { left: ${startLeft}px; }
		  20%  { left: ${stopLeft}px; }
		  60%  { left: ${stopLeft}px; }
		  100% { left: ${startLeft}px; }
		}
	  `;
	  
	  let styleElem = document.getElementById("btrKeyframesBattle");
	  if (!styleElem) {
		styleElem = document.createElement("style");
		styleElem.id = "btrKeyframesBattle";
		document.head.appendChild(styleElem);
	  }
	  styleElem.textContent = keyframesText;
	  
	  // åˆ›å»ºåŠ¨ç”»å®¹å™¨
	  battleBTRWrapper = document.createElement("div");
	  battleBTRWrapper.className = "btr-wrapper";
	  battleBTRWrapper.style.position = "absolute";
	  battleBTRWrapper.style.top = "25%";
	  battleBTRWrapper.style.left = startLeft + "px";
	  battleBTRWrapper.style.animation = "btrMoveDynamicBattle 10s ease-in-out forwards";
	  
	  let spriteElem;
	  if (useT80) {
		const frameContainer = document.createElement("div");
		frameContainer.className = "frameContainer";
		frameContainer.style.width = frameWidth + "px";
		frameContainer.style.height = rootStyles.getPropertyValue('--btr-frame-height') || "120px";
		frameContainer.style.overflow = "hidden";
		
		spriteElem = document.createElement("div");
		spriteElem.className = "t80-animation";
		spriteElem.style.backgroundPosition = "0px 0";
		
		frameContainer.appendChild(spriteElem);
		battleBTRWrapper.appendChild(frameContainer);
		
		// å¯åŠ¨T-80ç©ºé—²åŠ¨ç”»
		startT80IdleAnimation(spriteElem);
	  } else {
		// BTRåŠ¨ç”»ä¿æŒä¸å˜
		spriteElem = document.createElement("div");
		spriteElem.className = "btr-animation";
		battleBTRWrapper.appendChild(spriteElem);
	  }
  
		container.appendChild(battleBTRWrapper);
	  
	  // ä¸Šä¼ äº‹ä»¶åˆ°Firebase
	  uploadBattleBTREvent(battleBTRType);
	  
	  // å¯åŠ¨ç‰¹æ®Šæ”»å‡»
	  startBattleBTRSpecialAttack();
	  
	  battleBTRActive = true;
	  if (useT80) {
		setTimeout(() => {
		// ä¿®å¤ï¼šä¼ é€’spriteElemå‚æ•°
		triggerBattleT80Cannon(spriteElem);
		}, 1000);
	  }
	  
	  // 10ç§’åæ¸…ç†
	  setTimeout(() => {
		if (container.contains(battleBTRWrapper)) {
		  container.removeChild(battleBTRWrapper);
		  battleBTRWrapper = null;
		}
		
		if (useT80 && t80IdleInterval) {
		  clearInterval(t80IdleInterval);
		  t80IdleInterval = null;
		}
		
		if (battleBTRInterval) {
		  clearInterval(battleBTRInterval);
		  battleBTRInterval = null;
		}
		
		battleBTRActive = false;
	  }, 10000);
	}

	// 3. ä¸Šä¼ BTRäº‹ä»¶åˆ°Firebase
	function uploadBattleBTREvent(type) {
	  if (!window.currentBattleRoom) return;
	  
	  const eventData = {
		type: type,
		senderRole: window.myRole,
		timestamp: Date.now()
	  };
	  
	  const eventRef = firebase.database().ref("battles")
		.child(window.currentBattleRoom)
		.child("btrEvents");
	  
	  eventRef.push(eventData);
	}

	// 4. ç›‘å¬æ•Œæ–¹BTRäº‹ä»¶
	function listenForEnemyBTR() {
	  if (!window.currentBattleRoom) return;
	  
	  const eventRef = firebase.database().ref("battles")
		.child(window.currentBattleRoom)
		.child("btrEvents");
	  
	  eventRef.off("child_added");
	  eventRef.on("child_added", snapshot => {
		const event = snapshot.val();
		
		// å¿½ç•¥è‡ªå·±å‘é€çš„äº‹ä»¶
		if (event.senderRole === window.myRole) return;
		
		// åœ¨æ•Œæ–¹åŒºåŸŸæ˜¾ç¤ºåŠ¨ç”»
		showEnemyVehicleAnimation(event);
	  });
	}

	// 5. åœ¨æ•Œæ–¹åŒºåŸŸæ˜¾ç¤ºè½¦è¾†åŠ¨ç”»
	function showEnemyVehicleAnimation(event) {
	  const enemyAnim = document.getElementById("battleEnemyAnim");
	  if (!enemyAnim) return;
	  
	  const containerWidth = enemyAnim.clientWidth;
	  const offset = 50;
	  const rootStyles = getComputedStyle(document.documentElement);
	  
	  let frameWidth;
	  if (event.type === "t80") {
		frameWidth = 480;
	  } else {
		frameWidth = parseFloat(rootStyles.getPropertyValue('--btr-frame-width')) || 240;
	  }
	  
	  // ä¿®å¤ï¼šæ•Œæ–¹åŠ¨ç”»ä»å³å‘å·¦ç§»åŠ¨
	  const startRight = containerWidth + offset + 0.5 * frameWidth;
	  const stopRight = 0.5 * containerWidth - 0.5 * frameWidth;
	  
	  const keyframesText = `
		@keyframes btrMoveDynamicBattleEnemy {
		  0%   { left: ${startRight}px; }
		  20%  { left: ${stopRight}px; }
		  60%  { left: ${stopRight}px; }
		  100% { left: ${containerWidth + offset}px; }
		}
	  `;
	  
	  let styleElem = document.getElementById("btrKeyframesBattleEnemy");
	  if (!styleElem) {
		styleElem = document.createElement("style");
		styleElem.id = "btrKeyframesBattleEnemy";
		document.head.appendChild(styleElem);
	  }
	  styleElem.textContent = keyframesText;
	  
	  // åˆ›å»ºåŠ¨ç”»å®¹å™¨
	  const enemyWrapper = document.createElement("div");
	  enemyWrapper.className = "btr-wrapper enemy";
	  enemyWrapper.style.position = "absolute";
	  enemyWrapper.style.top = "25%";
	  enemyWrapper.style.left = startRight + "px";
	  enemyWrapper.style.animation = "btrMoveDynamicBattleEnemy 10s ease-in-out forwards";
	  
	  let spriteElem;
	  if (event.type === "t80") {
		// T-80åŠ¨ç”»
		const frameContainer = document.createElement("div");
		frameContainer.className = "frameContainer";
		frameContainer.style.width = frameWidth + "px";
		frameContainer.style.height = rootStyles.getPropertyValue('--btr-frame-height') || "120px";
		frameContainer.style.overflow = "hidden";
		
		spriteElem = document.createElement("div");
		spriteElem.className = "t80-animation";
		const t80URL = window.opponentT80Sprite ? window.opponentT80Sprite : "default_t80.png";
		spriteElem.style.backgroundImage = "url('" + t80URL + "')";
		spriteElem.style.backgroundPosition = "0px 0";
		
		frameContainer.appendChild(spriteElem);
		enemyWrapper.appendChild(frameContainer);
		
		// å¯åŠ¨ç©ºé—²åŠ¨ç”»
		startT80IdleAnimation(spriteElem);
		
		// ===== ä¿®å¤1ï¼šå£°æ˜å¹¶åˆå§‹åŒ–å†·å´çŠ¶æ€å˜é‡ =====
		let enemyT80CannonOnCooldown = false;
		
		// ===== ä¿®å¤2ï¼šç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ç©ºé—²åŠ¨ç”»å‡½æ•° =====
		const startLocalIdleAnimation = (sprite) => {
		  // ç¡®ä¿idleå®šæ™‚å™¨ä¸å­˜åœ¨
		  if (window.enemyT80IdleInterval) clearInterval(window.enemyT80IdleInterval);
		  window.enemyT80IdleToggle = false;
		  // åˆå§‹è¨­ç‚ºç¬¬1å¹€
		  sprite.style.backgroundPosition = "0px 0";
		  window.enemyT80IdleInterval = setInterval(() => {
			// ä½¿ç”¨ toggle è®Šæ•¸é€²è¡Œäº¤æ›¿
			window.enemyT80IdleToggle = !window.enemyT80IdleToggle;
			// ç¬¬1å¹€ï¼š "0px 0"ï¼›ç¬¬4å¹€ï¼š -1440px 0ï¼ˆå› ç‚º 3*480 = 1440ï¼‰
			sprite.style.backgroundPosition = window.enemyT80IdleToggle ? "-1440px 0" : "0px 0";
		  }, 250);
		};
		
		const triggerEnemyT80Cannon = () => {
		  if (enemyT80CannonOnCooldown) return;
		  enemyT80CannonOnCooldown = true;
		  
		  // åœæ­¢ç©ºé—²åŠ¨ç”»
		  if (window.enemyT80IdleInterval) {
			clearInterval(window.enemyT80IdleInterval);
			window.enemyT80IdleInterval = null;
		  }
		  
		  // æ’­æ”¾å¼€ç‚®åŠ¨ç”»åºåˆ—
		  spriteElem.style.backgroundPosition = "0px 0"; // frame1
		  setTimeout(() => { spriteElem.style.backgroundPosition = "-480px 0"; }, 250); // frame2
		  setTimeout(() => { spriteElem.style.backgroundPosition = "-960px 0"; }, 500); // frame3
		  setTimeout(() => { spriteElem.style.backgroundPosition = "-1440px 0"; }, 750); // frame4
		  
		  // 1ç§’åæ¢å¤ç©ºé—²å¸§
		  setTimeout(() => {
			if (spriteElem && spriteElem.parentNode) {
			  spriteElem.style.backgroundPosition = "0px 0";
			  startLocalIdleAnimation(spriteElem); // ä½¿ç”¨ä¿®å¤åçš„ç©ºé—²åŠ¨ç”»å‡½æ•°
			}
			enemyT80CannonOnCooldown = false;
		  }, 1000);
		};
		
		// ===== ä¿®å¤3ï¼šç¡®ä¿æ­£ç¡®å¯åŠ¨å¼€ç‚®å¾ªç¯ =====
		// å¯åŠ¨å¼€ç‚®å¾ªç¯
		setTimeout(() => {
		  triggerEnemyT80Cannon(); // é¦–æ¬¡å¼€ç‚®
		  
		  // æ¯4.25ç§’å¼€ç‚®ä¸€æ¬¡
		  const cannonInterval = setInterval(() => {
			if (enemyAnim.contains(enemyWrapper)) {
			  triggerEnemyT80Cannon();
			} else {
			  clearInterval(cannonInterval); // åŠ¨ç”»å…ƒç´ å·²ç§»é™¤æ—¶åœæ­¢
			}
		  }, 4250);
		}, 1000); // å»¶è¿Ÿ1ç§’å¼€å§‹
		
	  } else {
		// BTRåŠ¨ç”»
		spriteElem = document.createElement("div");
		spriteElem.className = "btr-animation";
		const btrURL = window.opponentBtrSprite ? window.opponentBtrSprite : "default_btr.png";
	    spriteElem.style.backgroundImage = "url('" + btrURL + "')";
		enemyWrapper.appendChild(spriteElem);
	  }
	  
	  enemyAnim.appendChild(enemyWrapper);
	  
	  // 10ç§’åæ¸…ç†
	  setTimeout(() => {
		if (enemyAnim.contains(enemyWrapper)) {
		  enemyAnim.removeChild(enemyWrapper);
		}
		// æ¸…ç†ç©ºé—²åŠ¨ç”»å®šæ—¶å™¨
		if (window.enemyT80IdleInterval) {
		  clearInterval(window.enemyT80IdleInterval);
		  window.enemyT80IdleInterval = null;
		}
	  }, 10000);
	}

	// 6. å¯åŠ¨ç‰¹æ®Šæ”»å‡»
	function startBattleBTRSpecialAttack() {
	  if (!battleModeActive || battleEnded || !battleMatched) return;
	  if (battleBTRInterval) clearInterval(battleBTRInterval);
	  
	  // ç«‹å³æ‰§è¡Œç¬¬ä¸€æ¬¡æ”»å‡»
	  triggerBattleBTRSpecialAttack();
	  
	  // ä¹‹åæ¯5ç§’æ‰§è¡Œä¸€æ¬¡
	  battleBTRInterval = setInterval(() => {
		triggerBattleBTRSpecialAttack();
	  }, 5000);
	}

	// 7. æ‰§è¡Œç‰¹æ®Šæ”»å‡»
	function triggerBattleBTRSpecialAttack() {
	  if (battleEnded) return;
	  if (!battleBTRActive) return;
	    
	  const centerBuilding = gameState.buildings.find(b => 
		b && b.type.toLowerCase() === "center"
	  );
	  const centerLevel = centerBuilding ? centerBuilding.level : 1;
	  const baseHitChance = 40;
	  const hitChanceVal = Math.min(baseHitChance + centerLevel * 0.5, 85);
	  
	  const hitRoll = Math.random() * 100;
	  const baseDamage = battleBTRType === "t80" ? 
		  Math.floor(Math.random() * 20) + 15 :  // T-80ä¼¤å®³15-35
		  Math.floor(Math.random() * 15) + 10;     // BTRä¼¤å®³10-25

	  // å¾å…¨å±€ gameState.buildings ä¸­æŸ¥æ‰¾æ‹–æ‹‰æ©Ÿå» ï¼ˆarmoredgarageï¼‰çš„ç­‰ç´š
	  let tractorLevel = 0;
	  if (window.gameState && window.gameState.buildings) {
		  const tractor = window.gameState.buildings.find(b => 
			  b && b.type.toLowerCase() === "armoredgarage"
		  );
		  if (tractor) {
		     tractorLevel = tractor.level;
		  }
	  }

	  // æ¯ç´š0.5%çš„åŠ æˆï¼šå€ç‡ = 1 + (æ‹–æ‹‰æ©Ÿå» ç­‰ç´š Ã— 0.005)
	  const multiplier = 1 + tractorLevel * 0.005;

	  // æ ¹æ“šå€ç‡èª¿æ•´æœ€çµ‚å‚·å®³ï¼Œä¸¦å–æ•´ï¼ˆå››æ¨äº”å…¥ï¼‰
	  const damage = Math.round(baseDamage * multiplier);
	  
	  const hitSuccess = hitRoll < hitChanceVal;
	  
	  if (hitSuccess) {
	    totalEnemyDamage += damage;
		
	    let type = battleBTRType === "t80" ? "t80" : "btr";
		  // å¾å°æ‡‰è©åº«ä¸­ç²å–ä¸€å€‹éš¨æ©ŸçŸ­èª
		  let phrase = getRandomPhrase(type);
		  
		  // ä¸Šå‚³æ”»æ“Šæ—¥å¿—ï¼Œä½¿ç”¨éš¨æ©ŸçŸ­èªä¾†æè¿°äº‹ä»¶
		  const attackMessage = `${phrase}ï¼ˆå‘½ä¸­ï¼‰ï¼Œå°æ–¹åƒµå°¸-${damage}`;
		  pushBattleLog(attackMessage);

		  // å¦‚æœæ˜¯ T-80 äº‹ä»¶ï¼Œè§¸ç™¼é–‹ç‚®å‹•ç•«
		  if (battleBTRType === "t80") {
			triggerBattleT80Cannon();
		  }
		} else {
		  // æœªå‘½ä¸­æ™‚ä¹ŸåŒæ¨£éš¨æ©Ÿæ¡ç”¨å°æ‡‰è©åº«ä¸­çš„æè¿°
		  let type = battleBTRType === "t80" ? "t80" : "btr";
		  let phrase = getRandomPhrase(type);
		  const missMessage = `${phrase}ï¼ˆæœªå‘½ä¸­ï¼‰`;
		  pushBattleLog(missMessage);
		}
	  
	  // ä¸Šä¼ æ”»å‡»ç»“æœåˆ°Firebase
	  uploadBattleBTRAttack({
		type: battleBTRType,
		hit: hitSuccess,
		damage: hitSuccess ? damage : 0,
		timestamp: Date.now(),
		senderRole: window.myRole
	  });
	}

	// 8. ä¸Šä¼ æ”»å‡»ç»“æœ
	function uploadBattleBTRAttack(attackData) {
	  if (!window.currentBattleRoom) return;
	  
	  const attackRef = firebase.database().ref("battles")
		.child(window.currentBattleRoom)
		.child("btrAttacks");
	  
	  attackRef.push(attackData);
	}

	// 9. ç›‘å¬æ•Œæ–¹æ”»å‡»
	function listenForEnemyBTRAttacks() {
	  if (!window.currentBattleRoom) return;
	  
	  const attackRef = firebase.database().ref("battles")
						.child(window.currentBattleRoom)
						.child("btrAttacks");
	  
	  attackRef.off("child_added");
	  attackRef.on("child_added", function(snapshot) {
	    if (battleEnded) return;
		const attack = snapshot.val();
		
		// å¿½ç•¥è‡ªå·±å‘é€çš„æ”»å‡»
		if (attack.senderRole === window.myRole) return;
		
		if (attack.hit) {
		  totalSelfDamage += attack.damage;
		}
	  });
	}

	// 10. T-80å¼€ç‚®åŠ¨ç”»ï¼ˆå¯¹æˆ˜æ¨¡å¼ç®€åŒ–ç‰ˆï¼‰
	function triggerBattleT80Cannon(sprite) {
	  if (!sprite) return;
	  
	  // ä¿®å¤ï¼šä½¿ç”¨ä¸»æ–‡ä»¶ä¸­çš„å¼€ç‚®é€»è¾‘
	  if (window.t80CannonOnCooldown) return;
	  window.t80CannonOnCooldown = true;
	  
	  // åœæ­¢idleå®šæ—¶å™¨
	  if (window.t80IdleInterval) {
		clearInterval(window.t80IdleInterval);
		window.t80IdleInterval = null;
	  }
	  
	  // æ’­æ”¾å®Œæ•´å¼€ç‚®åŠ¨ç”»åºåˆ—ï¼ˆä¸»æ–‡ä»¶é€»è¾‘ï¼‰
	  sprite.style.backgroundPosition = "0px 0"; // frame1
	  setTimeout(() => { sprite.style.backgroundPosition = "-480px 0"; }, 250); // frame2
	  setTimeout(() => { sprite.style.backgroundPosition = "-960px 0"; }, 500); // frame3
	  setTimeout(() => { sprite.style.backgroundPosition = "-1440px 0"; }, 750); // frame4
	  
	  // 1ç§’åæ¢å¤ç©ºé—²å¸§
	  setTimeout(() => {
		sprite.style.backgroundPosition = "0px 0"; 
		// é‡æ–°å¯åŠ¨idleåŠ¨ç”»
		startT80IdleAnimation(sprite);
	  }, 1000);
	  
	  // å†·å´åå…è®¸å†æ¬¡å¼€ç‚®
	  setTimeout(() => {
		window.t80CannonOnCooldown = false;
		if (battleBTRActive) {
		  triggerBattleT80Cannon(sprite);
		}
	  }, 4250);
	}

	function handleBattleEvent(eventData) {
	  // å¿½ç•¥è‡ªå·±å‘é€çš„äº‹ä»¶
	  if (eventData.senderRole === window.myRole) return;
	  
	  // æ ¹æ®äº‹ä»¶ç±»å‹å¤„ç†
	  switch (eventData.type) {
		case "btr":
		case "t80":
		  // åœ¨å³ä¾§æ˜¾ç¤ºæ•Œæ–¹åŠ¨ç”»
		  showEnemyVehicleAnimation(eventData);
		  break;
	  }
	}

	function startBattleTimer() {
	  let remaining = battleDuration;
	  battleInterval = setInterval(function(){
		if (remaining <= 0) {
		  clearInterval(battleInterval);
		  battleInterval = null;
		} else {
		  triggerBattleEvent();
		  remaining -= 5;
		}
	  }, 5000);
	}


	// æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯æ¨é€å‡½æ•°ï¼ˆç¡®ä¿ä½¿ç”¨æ­£ç¡®ï¼‰
	function pushSystemMessage(message) {
	  const data = {
		sender: "ç³»çµ±",
		senderRole: "system",
		message: message
	  };
	  
	  appendBattleLogEntry(data);
	  
	  // å¦‚æœéœ€è¦åŒæ­¥åˆ°å¯¹æ–¹ï¼Œä¸Šä¼ åˆ°Firebase
	  if (window.currentBattleRoom) {
		const logRef = firebase.database().ref("battles")
							  .child(window.currentBattleRoom)
							  .child("log");
		logRef.push(data);
	  }
	}

	window.battleMode = {
        enter: enterBattleMode,
        exit: exitBattleMode
    };
	document.getElementById("battleStartBtn").addEventListener("click", function(){
        if(initializeUser()){
          startBattleModeFirebase();
        }
      });
	document.getElementById("explorationAnim").addEventListener("dblclick", function(e) {
	  battleMode.enter();
	});
	document.getElementById("encounterBattleBtn").addEventListener("click", function() {
	  battleMode.enter();
	});

    })();

	// ç”¨æœ¬åœ° unlockedAchievements ç”Ÿæˆä¸€ä¸ªç§°å·é›†åˆ
	function syncAchievements() {
	  const set = new Set();
	  // æˆ‘å€‘éæ­· unlockedAchievements é€™å€‹å…¨å±€è®Šé‡
	  unlockedAchievements.forEach(a => {
		if (a.title) {
		  // é€²è¡Œ Unicode æ­£è¦åŒ–ã€è½‰å°å¯«ä¸¦ä¿®å‰ªç©ºæ ¼
		  set.add(a.title.normalize("NFC").toLowerCase().trim());
		}
	  });
	  return set;
	}

  (function(){
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // æ¨¡å¡Šå…§å®šç¾©ç²¾éˆåœ–æ•¸æ“šï¼šåŸæœ‰çš„åƒµå°¸ç²¾éˆåœ–èˆ‡æ–°å¢çš„è£ç”²ç³»åˆ—
    const zombieSpriteOptions = [
      { src: "images/zombie_search_sprite.png", unlock: true },
      { src: "images/zombie_search_sprite_helmet.png", unlock: "ĞĞ»Ñ‚Ñ‹Ğ½" },
      { src: "images/zombie_search_sprite_btr.png", unlock: "å ±è©±æ©Ÿ" },
      { src: "images/zombie_search_sprite_equipped.png", unlock: "æ­¦è£é€šä¿¡å…µ" },
      { src: "images/zombie_search_sprite_svd.png", unlock: "æ‹¾è’é«˜æ‰‹" },
      { src: "images/zombie_search_sprite_svd_b.png", unlock: "æ¸…ç©ºè²¨æ¶ï¼" },
	  { src: "images/zombie_search_sprite_svd_h.png", unlock: "ç‰©è³‡æ”¶é›†è€…" },
      { src: "images/zombie_search_sprite_elite.png", unlock: "å…¨å‰¯æ­¦è£" },
      { src: "images/zombie_search_sprite_pkm_e.png", unlock: "è£ç”²çŒ›è™" },
      { src: "images/zombie_search_sprite_pkm_m.png", unlock: "éŠ…å¢»éµå£" },
	  { src: "images/zombie_search_sprite_pkm_ms.png", unlock: "å …ä¸å¯æ‘§" },
    ];
    const btrSpriteOptions = [
      { src: "images/btr_sprite_80.png", unlock: true },
	  { src: "images/btr_sprite_80_a.png", unlock: "å°¸å¦å”åŒ" },
      { src: "images/btr_sprite_80_mg.png", unlock: "æ©Ÿç‚®ä»™äºº" },
    ];
    const t80SpriteOptions = [
      { src: "images/t-80_sprite.png", unlock: true },
      { src: "images/t-80_sprite_u.png", unlock: "è£ç”²çŒ›è™" },
	  { src: "images/t-80_sprite_um.png", unlock: "è£ç”²å¤§è»" },
    ];
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // å…¨å±€ç²¾éˆåœ–è®Šé‡åˆå§‹åŒ–ï¼Œå¾ localStorage è®€å–ï¼›å¦‚ç„¡å‰‡æ¡ç”¨é»˜èªå€¼
    window.currentZombieSprite = localStorage.getItem("currentZombieSprite") || "images/zombie_search_sprite.png";
    window.currentBtrSprite = localStorage.getItem("currentBtrSprite") || "images/btr_sprite.png";
    window.currentT80Sprite = localStorage.getItem("currentT80Sprite") || "images/t-80_sprite.png";
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // è¦†è“‹CSSè¦å‰‡å‡½æ•¸ï¼šç•¶ç”¨æˆ¶é¸å®š Tâ€‘80 è£ç”²ç²¾éˆåœ–å¾Œï¼Œæ›´æ–° head ä¸­çš„è¦å‰‡
   function overrideT80SpriteCSS() {
	  const spritePath = localStorage.getItem("currentT80Sprite") || "images/t-80_sprite.png";
	  let styleEl = document.getElementById("t80OverrideStyle");
	  
	  if (!styleEl) {
		styleEl = document.createElement("style");
		styleEl.id = "t80OverrideStyle";
		document.head.appendChild(styleEl);
	  }

	  // æ’é™¤æ•Œæ–¹çª—å£çš„è¦†ç›–
	  styleEl.innerHTML = `
		.t80-animation:not(#battleEnemyAnim *) {
		  background-image: url('${spritePath}') !important;
		}
	  `;

	  let styleEl2 = document.getElementById("btrOverrideStyle");
	  if (!styleEl2) {
		styleEl2 = document.createElement("style");
		styleEl2.id = "btrOverrideStyle";
		document.head.appendChild(styleEl2);
	  }

	  const btrPath = localStorage.getItem("currentBtrSprite") || "images/btr_sprite.png";
	  
	  // æ’é™¤æ•Œæ–¹çª—å£çš„è¦†ç›–
	  styleEl2.innerHTML = `
		.btr-animation:not(#battleEnemyAnim *) {
		  background-image: url('${btrPath}') !important;
		}
	  `;
	}
    
    // æ¯æ¬¡æ›´æ–°ç”¨æˆ¶é¸æ“‡å¾Œèª¿ç”¨è¦†è“‹å‡½æ•¸ä»¥ä¿è­‰ css è¦†è“‹ç”Ÿæ•ˆ
    overrideT80SpriteCSS();
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     function isSpriteUnlocked(option) {
		// å¦‚æœ unlock ç‚º trueï¼Œè¡¨ç¤ºå§‹çµ‚å¯ç”¨
		if(option.unlock === true) return true;
		
		// å…ˆå° item.unlock é€²è¡Œæ­£è¦åŒ–è™•ç†ï¼š
		let need = "";
		if (typeof option.unlock === "string") {
		  need = option.unlock.normalize("NFC").toLowerCase().trim();
		}
		// é€šå¸¸ä½ ä¹Ÿå¯èƒ½å®šç¾© "default" ç‚ºå¯ç”¨
		if (need === "default") return true;

		// ç²å–åŒæ­¥å¾Œçš„ç¨±è™Ÿåº«
		const unlockedSet = syncAchievements();
		return unlockedSet.has(need);
	  }
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // æ›´æ–°å‹•ç•«çª—å£ä¸­åƒµå°¸ç²¾éˆåœ–çš„å‡½æ•¸ï¼ˆåƒµå°¸ç³»åˆ—ï¼‰
    function updateZombieSearchSprite(){
      const zombieElem = document.querySelector(".zombie-search");
      if (!zombieElem) return;
      zombieElem.style.backgroundImage = "url('" + window.currentZombieSprite + "')";
    }
    // æ›´æ–°å°æˆ°æ¨¡å¼ä¸­å·±æ–¹å‹•ç•«çª—å£ã€‚é€™è£¡ä¸é€²è¡Œåˆ¤æ–·ï¼Œåƒ…ä¾›åƒè€ƒï¼šå¦‚æœå°æˆ°æ¨¡å¼çš„Tâ€‘80å‹•ç•«å…ƒç´ ç”Ÿæˆæ™‚
    // å·²ç¶“æ¡ç”¨ CSS è¦†è“‹è¦å‰‡ï¼Œé‚£éº¼é€™è£¡å°±ä¸å¿…å¦å¤–è¨­ç½®ã€‚
    function updateBattleZombieSearchSprite(){
      const battleZombieElem = document.querySelector("#battleSelfAnim .zombie-search");
      if (!battleZombieElem) return;
      // ç”±æ–¼Tâ€‘80å‹•ç•«å°‡ä¾é  CSS è¦†è“‹ï¼Œæ‰€ä»¥é€™è£¡å¯ä»¥ä¸åšä¿®æ”¹ï¼Œæˆ–è€…å¼·åˆ¶æ›¸å¯«ï¼š
      battleZombieElem.style.backgroundImage = "url('" + window.currentT80Sprite + "')";
    }
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // æ¸²æŸ“åŸæœ‰çš„åƒµå°¸è¡£æ«¥åˆ†é ï¼šä½¿ç”¨ zombieSpriteOptions
    function renderWardrobeTab(){
      const container = document.getElementById("wardrobeContent");
      container.innerHTML = "";
      zombieSpriteOptions.forEach(function(option){
        const card = document.createElement("div");
        card.className = "wardrobe-card";
        const thumb = option.src.replace(/(\.\w+)$/, "_card$1");
        card.style.backgroundImage = "url('" + thumb + "')";
        if (!isSpriteUnlocked(option)){
          card.classList.add("locked");
        }
        if (option.src === window.currentZombieSprite){
          card.classList.add("selected");
          const label = document.createElement("div");
          label.className = "label";
          label.textContent = "ä½¿ç”¨ä¸­";
          card.appendChild(label);
        }
        card.addEventListener("click", function(){
          if (!isSpriteUnlocked(option)) return;
          document.querySelectorAll(".wardrobe-card.selected").forEach(function(el){
            el.classList.remove("selected");
            const lab = el.querySelector(".label");
            if (lab) lab.remove();
          });
          card.classList.add("selected");
          const label = document.createElement("div");
          label.className = "label";
          label.textContent = "ä½¿ç”¨ä¸­";
          card.appendChild(label);
          window.currentZombieSprite = option.src;
          localStorage.setItem("currentZombieSprite", window.currentZombieSprite);
          updateZombieSearchSprite();
          updateBattleZombieSearchSprite();
        });
        container.appendChild(card);
      });
    }
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // æ¸²æŸ“è£ç”²ç³»åˆ—è¡£æ«¥ï¼šæ ¹æ“š mode ("btr" æˆ– "t80") æ’­æ”¾å°æ‡‰å¡ç‰‡
    function renderArmorSprites(mode){
      const container = document.getElementById("armorSprites");
      container.innerHTML = "";
      let optionsArray = (mode === "btr") ? btrSpriteOptions : t80SpriteOptions;
      optionsArray.forEach(function(option){
        const card = document.createElement("div");
        card.className = "wardrobe-card";
        const thumb = option.src.replace(/(\.\w+)$/, "_card$1");
        card.style.backgroundImage = "url('" + thumb + "')";
        if (!isSpriteUnlocked(option)){
          card.classList.add("locked");
        }
        if (mode === "btr" && option.src === window.currentBtrSprite){
          card.classList.add("selected");
          const label = document.createElement("div");
          label.className = "label";
          label.textContent = "ä½¿ç”¨ä¸­";
          card.appendChild(label);
        }
        if (mode === "t80" && option.src === window.currentT80Sprite){
          card.classList.add("selected");
          const label = document.createElement("div");
          label.className = "label";
          label.textContent = "ä½¿ç”¨ä¸­";
          card.appendChild(label);
        }
        card.addEventListener("click", function(){
          if (!isSpriteUnlocked(option)) return;
          document.querySelectorAll("#armorSprites .wardrobe-card.selected").forEach(function(el){
            el.classList.remove("selected");
            const lab = el.querySelector(".label");
            if (lab) lab.remove();
          });
          card.classList.add("selected");
          const label = document.createElement("div");
          label.className = "label";
          label.textContent = "ä½¿ç”¨ä¸­";
          card.appendChild(label);
          if (mode === "btr"){
            window.currentBtrSprite = option.src;
            localStorage.setItem("currentBtrSprite", window.currentBtrSprite);
          } else if (mode === "t80"){
            window.currentT80Sprite = option.src;
            localStorage.setItem("currentT80Sprite", window.currentT80Sprite);
          }
          // è¦†è“‹ CSS è¦å‰‡ï¼Œä»¥ä¾¿å°æˆ°å‹•ç•«ä½¿ç”¨æœ€æ–°ç²¾éˆåœ–
          overrideT80SpriteCSS();
          updateZombieSearchSprite();
          updateBattleZombieSearchSprite();
        });
        container.appendChild(card);
      });
    }
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // è¡£æ«ƒæ¨¡å¼æ¨¡å¡Šï¼šåˆ†é åˆ‡æ›åŠé¡¯ç¤ºé‚è¼¯
    (function(){
      const wardrobeOverlay = document.getElementById("wardrobeOverlay");
      const wardrobeModal = document.getElementById("wardrobeModal");
      const wardrobeContent = document.getElementById("wardrobeContent");
      const tabZombie = document.getElementById("tabZombie");
      const tabArmor = document.getElementById("tabArmor");
      
      tabZombie.addEventListener("click", function(){
        tabZombie.classList.add("active");
        tabArmor.classList.remove("active");
        wardrobeContent.innerHTML = "";
        renderWardrobeTab();
      });
      
      tabArmor.addEventListener("click", function(){
        tabArmor.classList.add("active");
        tabZombie.classList.remove("active");
        wardrobeContent.innerHTML = `
          <div id="armorTabs" style="display: flex; justify-content: center; margin-bottom: 1em;">
            <button id="armorTabBTR" class="active" style="flex: 1;">BTR</button>
            <button id="armorTabT80" style="flex: 1;">Tâ€‘80</button>
          </div>
          <div id="armorSprites" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;"></div>
        `;
        document.getElementById("armorTabBTR").addEventListener("click", function(){
          this.classList.add("active");
          document.getElementById("armorTabT80").classList.remove("active");
          renderArmorSprites("btr");
        });
        document.getElementById("armorTabT80").addEventListener("click", function(){
          this.classList.add("active");
          document.getElementById("armorTabBTR").classList.remove("active");
          renderArmorSprites("t80");
        });
        // åˆå§‹é»˜èªæ¸²æŸ“ BTR ç³»åˆ—
        renderArmorSprites("btr");
      });
      
      window.showWardrobeMode = function(){
        wardrobeOverlay.style.display = "block";
        tabZombie.classList.add("active");
        tabArmor.classList.remove("active");
        renderWardrobeTab();
      };
      window.hideWardrobeMode = function(){
        wardrobeOverlay.style.display = "none";
      };
      
      const wardrobeBtn = document.getElementById("wardrobeBtn");
      if (wardrobeBtn) {
        wardrobeBtn.addEventListener("click", function(){
          window.showWardrobeMode();
        });
      }
      const closeBtn = document.getElementById("wardrobeCloseBtn");
      if (closeBtn) {
        closeBtn.addEventListener("click", function(){
          window.hideWardrobeMode();
        });
      }
      wardrobeOverlay.addEventListener("click", function(e){
          if (e.target === wardrobeOverlay) {
            window.hideWardrobeMode();
          }
      });
      wardrobeModal.addEventListener("click", function(e){
        e.stopPropagation();
      });
    })();
    
  })();


/* PVEæ¨¡å¼ - æœ«æ—¥æ§åˆ¶ä¸­å¿ƒæ“´å±•æ¨¡å¡Š - San1tater - 2025-06-24 17:57:16 */
(function(){
  function updatePlayerSpriteToDead(role) {
    const deadSprite = 'images/zombie_dead_sprite.png';
    const el = document.getElementById(`zombie-${role}`);
    if (el) {
      el.style.backgroundImage = `url('${deadSprite}')`;
    }
  }
  // ç¢ºä¿ Firebase å·²åˆå§‹åŒ–
  if (!window.firebase || !window.firebase.database) {
    return;
  }


  // ======== 1. å…¨å±€è®Šé‡å®šç¾© ========
  let pveActive = false;
  let pveMatched = false;
  let pveInterval = null;
  let bossAttackInterval = null;
  let bossHp = 0;
  let bossMaxHp = 0;
  let playerHp = 0;
  let playerMaxHp = 0;
  let playerIsDown = false;
  let totalPlayerDamage = 0;
  let pveEnded = false;
  let selectedBoss = "zombieKing"; 
  let pveMode = "solo"; 
  let battleBTRType = "";
  let battleBTRActive = false;      // BTR/T80æ˜¯å¦åœ¨å ´æ¨™å¿—
  let battleBTREventTimer = null;   // BTRäº‹ä»¶è§¸ç™¼è¨ˆæ™‚å™¨
  let battleBTRInterval = null;     // BTRæ”»æ“Šé–“éš”è¨ˆæ™‚å™¨
  let t80IdleInterval = null;       // T80é–’ç½®å‹•ç•«è¨ˆæ™‚å™¨
  let t80CannonTimeout = null;      // T80é–‹ç‚®å‹•ç•«è¨ˆæ™‚å™¨
  let t80CannonOnCooldown = false;  // T80é–‹ç‚®å†·å»æ¨™å¿—
  let currentBattleRoomRef = null;  // Firebase æˆ¿é–“åƒè€ƒ
  let processedMessages = {};       // ç”¨æ–¼é˜²æ­¢è¨Šæ¯é‡è¤‡é¡¯ç¤º
  let latestRoomData = null;
  
  // BOSSé…ç½®
  const bossConfigs = {
    "zombieKing": {
      name: "BTR-80A ã€Œå®ˆè­·è€…ã€",
      hp: 1000,
      damageRange: {min: 25, max: 75},
      attackInterval: 7000, 
      singleAttackRate: 0.7,
	  hitChance: 75,
      sprite: "images/boss_zombie_king_sprite.png", 
      frames: 4,  // ç²¾éˆåœ–å¹€æ•¸
      frameWidth: 200, // æ¯å¹€å¯¬åº¦
      rewards: {
        food: 1000000,
        materials: 3000000,
        weapons: 5000000,
        tech: 3000000
      },
      attackPhrases: {
        single: [
          "ä½¿ç”¨30mmæ··åˆå½ˆéˆ[AP+HE+API]ï¼Œç‹‚æš´å°„æ“Š",
          "ä½¿ç”¨30mmæ›³å…‰å½ˆéˆ[AP-T+API+HE-T]ï¼Œå˜—è©¦é–å®š",
          "ä½¿ç”¨30mmç©¿ç‡ƒå½ˆéˆ[API]ï¼Œè©¦åœ–å¼•ç‡ƒ",
		  "ä½¿ç”¨30mmç©¿ç”²å½ˆéˆ[AP]ï¼Œå°ˆæ³¨ç ´å£"
        ],
        aoe: [
          "ä½¿ç”¨30mmé«˜çˆ†å½ˆéˆ[HE]ï¼Œè¦†è“‹å°„æ“Š",
          "é‡‹æ”¾å¼•æ“ç…™éœ§ï¼Œç± ç½©æˆ°å ´",
          "å°‡å¼•æ“èª¿åˆ°æœ€å¤§åŠŸç‡ï¼Œæ©«è¡ç›´æ’"
        ]
      }
    },
  };
  
  // æ”»æ“Šè©åº«
  const pveAttackPhrases = {
    normal: [
      "åƒµå°¸è‡ªä¿¡åœ°æ‰“å‡ºä¸€å€‹é•·é»å°„",
      "åƒµå°¸ä½¿ç”¨å–®ç™¼é»å°„ï¼Œé€²è¡Œç²¾ç¢ºå°„æ“Š",
      "åƒµå°¸å…‹åˆ¶åœ°æ‰“å‡ºå…©å€‹çŸ­é»å°„",
      "åƒµå°¸æŠŠæ§èˆ‰éé ­é ‚ï¼Œäº‚å°„ä¸€é€š",
      "åƒµå°¸èª¿åˆ°å…¨è‡ªå‹•ï¼Œé€²è¡Œå£“åˆ¶å°„æ“Š"
    ],
    btr: [
      "BTR-80ä½¿ç”¨30mmé«˜çˆ†å½ˆéˆ[HE]ï¼Œå¯¦æ–½ç«åŠ›æ”¯æ´",
      "BTR-80ä½¿ç”¨30mmæ··åˆå½ˆéˆ[AP+HE+API]ï¼Œå±•é–‹ç«åŠ›è¦†è“‹",
      "BTR-80ä½¿ç”¨30mmå°ç©ºå½ˆéˆ[API+HE+AP-T]ï¼Œå±•é–‹ç²¾æº–å°„æ“Š",
      "BTR-80ä½¿ç”¨30mmç©¿ç”²å½ˆéˆ[AP]ï¼Œå±•é–‹é›†ä¸­å°„æ“Š",
      "BTR-80ä½¿ç”¨30mmæ›³å…‰å½ˆéˆ[AP-T+API+HE-T]ï¼Œé€²è¡Œå¨æ‡¾å°„æ“Š",
      "BTR-80ä½¿ç”¨30mmç©¿ç‡ƒå½ˆéˆ[API]ï¼Œå±•é–‹å£“åˆ¶å°„æ“Š"
    ],
    t80: [
      "T-80ä½¿ç”¨12.7mmé«˜å°„æ©Ÿæ§[7n34]ï¼Œå±•é–‹ç²¾ç¢ºé»å°„",
      "T-80ä½¿ç”¨125mmé«˜çˆ†å½ˆ[3OF26]ï¼Œå¯¦æ–½è¦†è“‹å°„æ“Š",
      "T-80ä½¿ç”¨125mmé«˜çˆ†å½ˆ[3OF26]ï¼Œå¯¦æ–½å¼±é»ç ´å£",
      "T-80ä½¿ç”¨125mmç©¿ç”²å½ˆ[3BM42]ï¼Œå¯¦æ–½ä¸€èˆ¬è²«ç©¿å°„æ“Š",
      "T-80æ¡ç”¨125mmç©¿ç”²å½ˆ[3BM60]ï¼Œå¯¦æ–½å¼·å‹¢è²«ç©¿å°„æ“Š",
      "T-80ä½¿ç”¨125mmç ´ç”²å½ˆ[3BK18M]ï¼Œå¯¦æ–½ç ´å£å°„æ“Š",
      "T-80ä½¿ç”¨125mmç ´ç”²å½ˆ[3BK18M]ï¼Œå¯¦æ–½å‰Šå¼±å°„æ“Š"
    ]
  };

  // ======== 2. äº‹ä»¶ç¶å®š ========
  document.addEventListener('DOMContentLoaded', function() {
    // æ¨¡å¼é¸æ“‡
    const modeSelect = document.getElementById('battleModeSelect');
    if (modeSelect) {
      modeSelect.addEventListener('change', handleModeChange);
    }
    
    // BOSSé¸æ“‡
    const bossList = document.getElementById('bossList');
    if (bossList) {
      bossList.addEventListener('change', function() {
        selectedBoss = this.value;
      });
    }
    
    // PVEæ¨¡å¼é¸æ“‡
    const pveModeSelect = document.getElementById('pveModeSelect');
    if (pveModeSelect) {
      pveModeSelect.addEventListener('change', function() {
        pveMode = this.value;
      });
    }
    
    // é–‹å§‹æŒ‰éˆ•
    const startBtn = document.getElementById('battleStartBtn');
    if (startBtn) {
      startBtn.addEventListener('click', function(e) {
        const modeSelect = document.getElementById('battleModeSelect');
        if (modeSelect && modeSelect.value === 'pve') {
          startPveBattle();
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      });
    }
    
    // é€€å‡ºæŒ‰éˆ•
    const exitBtn = document.getElementById('battleExitBtn');
    if (exitBtn) {
      exitBtn.addEventListener('click', function(e) {
        if (pveActive) {
          exitPveBattle();
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      });
    }
  });
  
  function handleModeChange() {
    const bossList = document.getElementById('bossList');
    const pveModeSelect = document.getElementById('pveModeSelect');
    
    if (this.value === 'pve') {
      bossList.style.display = 'inline-block';
      pveModeSelect.style.display = 'inline-block';
    } else {
      bossList.style.display = 'none';
      pveModeSelect.style.display = 'none';
    }
  }
  
  // ======== 3. æ ¸å¿ƒåŠŸèƒ½ ========
  
  // æ·»åŠ å¿…è¦çš„CSSæ¨£å¼
  function addPveStyles() {
    if (document.getElementById('pve-styles')) return;
    
    const styleSheet = document.createElement('style');
    styleSheet.id = 'pve-styles';
    styleSheet.textContent = `
      .health-bar {
        width: 100%;
        height: 20px;
        background: #333;
        border-radius: 5px;
        margin-bottom: 0px;
        overflow: hidden;
        position: relative;
      }
      
      .health-fill {
        height: 100%;
        background: var(--health-color, green);
        width: 100%;
        transition: width 0.5s;
      }
      
      .boss-health-fill {
        background: var(--boss-health-color, red);
      }
      
      .health-text {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        text-align: center;
        line-height: 20px;
        font-size: 12px;
        font-weight: bold;
        color: white;
        text-shadow: 0 0 2px black;
      }
      
      .boss-animation {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: var(--boss-frame-width);
        height: var(--boss-frame-height);
        background-image: url(var(--boss-sprite-url));
        background-size: var(--boss-sprite-total-width) var(--boss-frame-height);
        background-repeat: no-repeat;
        animation: bossSearchAnim 1.5s steps(4) infinite;
      }
      
      @keyframes bossSearchAnim {
        from { background-position: 0 0; }
        to { background-position: calc(-1 * var(--boss-sprite-total-width)) 0; }
      }
      
      @keyframes bossPulse {
        0% { transform: translateX(-50%) scale(1); }
        50% { transform: translateX(-50%) scale(1.05); }
        100% { transform: translateX(-50%) scale(1); }
      }
      
      .boss-animation.attack {
        animation: bossPulse 0.5s ease-in-out;
      }
      
      .pve-background {
        background-image: url('images/location_day_1.png');
        background-repeat: repeat-x;
        background-size: auto 100%;
        background-position: center top;
        animation: pveBgScroll 30s linear infinite;
      }
      
      @keyframes pveBgScroll {
        0% { background-position: 0 top; }
        100% { background-position: -1000px top; }
      }
      
      /* ä¿®æ”¹å®¹å™¨ä½ˆå±€ï¼Œå°‡å¥åº·æ¢æ”¾åœ¨åº•éƒ¨ */
      .battle-half {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      
      .battle-inner {
        flex: 1;
        position: relative;
        overflow: hidden;
      }
      
      .health-bars-container {
        padding: 5px;
        background: rgba(0,0,0,0.5);
      }
      
      /* åˆä½œæ¨¡å¼è¡€æ¡æ ·å¼ */
      .coop-health-container {
        display: flex;
        justify-content: space-between;
        gap: 8px;
      }
      
      .coop-health-bar {
        width: calc(50% - 4px); /* å‡å»é—´éš”çš„ä¸€åŠ */
        margin-bottom: 0;
      }
      
      .player-down .health-fill {
        background: #888 !important; /* ç°è‰²è¡¨ç¤ºå€’åœ° */
      }
      
      .player-down .health-text {
        color: #ff6666;
        font-weight: bold;
      }
      
      /* åˆä½œæ¨¡å¼ç©å®¶Bä½ç½®è°ƒæ•´ */
		#zombie-userA, #zombie-userB {
		  position: absolute !important;
		  bottom: 20% !important;
		  top: auto !important;
		  margin-bottom: 0 !important;
		  transform: none !important; /* ç§»é™¤æ‰€æœ‰ç¿»è½¬ */
		}
		
		/* userAä½ç½® */
		#zombie-userA {
		  left: 50% !important;
		  transform: translateX(-50%) !important; /* å±…ä¸­ */
		}
		
		/* userBä½ç½® */
		#zombie-userB {
		  left: 60% !important;
		  right: auto !important;
		}
		
		/* æ ‡ç­¾æ ·å¼ç»Ÿä¸€ */
		.player-name-tag {
		  position: absolute !important;
		  top: -20px !important;
		  bottom: auto !important;
		  width: 100% !important;
		  text-align: center !important;
		  color: #fff !important;
		  font-size: 12px !important;
		  text-shadow: 0 0 2px #000 !important;
		  transform: scaleX(-1) !important;
		}
    `;
    
    document.head.appendChild(styleSheet);
  }
  
  // åˆå§‹åŒ–PVEæˆ°é¬¥
  function initPveBattle() {
    if (!pveActive) return;
    
    addPveStyles();
    
    const bossConfig = bossConfigs[selectedBoss];
    if (!bossConfig) return;
    
    // è¨­ç½®èƒŒæ™¯å’Œå‹•ç•«
    setupBattleAnimation();
    
    // ä¿®æ”¹ï¼šå…ˆè¨­ç½®å¥åº·æ¢å®¹å™¨ï¼Œå†æ·»åŠ ç”Ÿå‘½æ¢å’ŒBOSS
    addHealthBarsContainers();
    addHealthBarsAndBoss();
    
    // é–‹å§‹æˆ°é¬¥å¾ªç’°
    startCombatLoop();
    
    // æ¸…é™¤å·²è™•ç†æ¶ˆæ¯è¨˜éŒ„
    processedMessages = {};
    
    // æ¨é€æˆ°é¬¥é–‹å§‹æ¶ˆæ¯
    appendBattleLogEntry({
      sender: "ç³»çµ±",
      senderRole: "system",
      message: `æˆ°é¬¥é–‹å§‹ï¼æŒ‘æˆ° ${bossConfig.name}ï¼`,
      battleMode: "pve"
    });
  }
  
  // æ·»åŠ å¥åº·æ¢å®¹å™¨
  function addHealthBarsContainers() {
    const selfContainer = document.querySelector('.battle-half.left');
    const enemyContainer = document.querySelector('.battle-half.right');
    
    if (!selfContainer || !enemyContainer) return;
    
    // åˆ›å»ºå¥åº·æ¡å®¹å™¨ - æ¸…é™¤å¯èƒ½å·²å­˜åœ¨çš„
    const existingPlayerContainer = document.getElementById('player-health-container');
    if (existingPlayerContainer) {
      existingPlayerContainer.remove();
    }
    
    const existingBossContainer = document.getElementById('boss-health-container');
    if (existingBossContainer) {
      existingBossContainer.remove();
    }
    
    // æ–°å»ºå®¹å™¨
    const playerHealthContainer = document.createElement('div');
    playerHealthContainer.id = 'player-health-container';
    playerHealthContainer.className = 'health-bars-container';
    
    // åˆä½œæ¨¡å¼æ—¶æ·»åŠ ç‰¹æ®Šæ ·å¼
    if (pveMode === 'coop') {
      playerHealthContainer.classList.add('coop-health-container');
    }
    
    selfContainer.appendChild(playerHealthContainer);
    
    const bossHealthContainer = document.createElement('div');
    bossHealthContainer.id = 'boss-health-container';
    bossHealthContainer.className = 'health-bars-container';
    enemyContainer.appendChild(bossHealthContainer);
  }
  
  function setupBattleAnimation() {
  const selfAnim = document.getElementById('battleSelfAnim');
  const enemyAnim = document.getElementById('battleEnemyAnim');
  
  if (!selfAnim || !enemyAnim) return;
  
  // æ¸…ç©ºç°æœ‰å†…å®¹
  selfAnim.innerHTML = "";
  enemyAnim.innerHTML = "";
  
  // åº”ç”¨èƒŒæ™¯ - ä¸PVPæ¨¡å¼ä¸€è‡´
  selfAnim.style.backgroundImage = "url('images/location_day_1.png')";
  selfAnim.style.backgroundRepeat = "repeat-x";
  selfAnim.style.backgroundSize = "auto 100%";
  selfAnim.style.backgroundPosition = "center top";
  selfAnim.style.animation = "scrollBgRight 30s linear infinite";
  
  enemyAnim.style.backgroundImage = "url('images/location_day_1.png')";
  enemyAnim.style.backgroundRepeat = "repeat-x";
  enemyAnim.style.backgroundSize = "auto 100%";
  enemyAnim.style.backgroundPosition = "center top";
  enemyAnim.style.animation = "scrollBgRight 30s linear infinite";
  
  // ç¡®ä¿å®¹å™¨å¯è§
  selfAnim.style.display = "block";
  enemyAnim.style.display = "block";
  
  // æ ¹æ®è§’è‰²æ·»åŠ å¯¹åº”è§’è‰²çš„åŠ¨ç”»
  addUserCharacters(selfAnim);
}

// ä¿®æ”¹addUserCharacterså‡½æ•°ï¼Œç¡®ä¿ä¸é‡å¤åˆ›å»ºè§’è‰²
function addUserCharacters(container) {
  if (!container) return;
  
  // æ¸…é™¤æ‰€æœ‰ç°æœ‰åƒµå°¸åŠ¨ç”»
  const existingZombies = container.querySelectorAll('.zombie-search');
  existingZombies.forEach(zombie => zombie.remove());
  
  // æ·»åŠ userAçš„åƒµå°¸åŠ¨ç”»
  const zombieA = document.createElement("div");
  zombieA.className = "zombie-search";
  zombieA.id = "zombie-userA";
  zombieA.style.backgroundImage = "url('" + window.currentZombieSprite + "')";
  
  // æ·»åŠ userAçš„åç§°æ ‡ç­¾
  const nameTagA = document.createElement("div");
  nameTagA.className = "player-name-tag";
  nameTagA.textContent = pveMode === 'coop' ? (window.myRole === "userA" ? window.myUid : "ç­‰å¾…ç©å®¶A...") : window.myUid;
  zombieA.appendChild(nameTagA);
  
  container.appendChild(zombieA);
  
  // å¦‚æœæ˜¯åˆä½œæ¨¡å¼ï¼ŒåŒæ—¶æ·»åŠ userBçš„åƒµå°¸åŠ¨ç”»
  if (pveMode === 'coop') {
    const zombieB = document.createElement("div");
    zombieB.className = "zombie-search";
    zombieB.id = "zombie-userB";
    // åˆå§‹çŠ¶æ€ - ç¨åä¼šç”±updatePartnerInfoæ›´æ–°
    zombieB.style.backgroundImage = "url('" + window.currentZombieSprite + "')";
    
    // æ·»åŠ userBçš„åç§°æ ‡ç­¾
    const nameTagB = document.createElement("div");
    nameTagB.className = "player-name-tag";
    nameTagB.textContent = window.myRole === "userB" ? window.myUid : "ç­‰å¾…ç©å®¶B...";
    zombieB.appendChild(nameTagB);
    
    container.appendChild(zombieB);
    
    // ç«‹å³å°è¯•æ›´æ–°ä¼™ä¼´ä¿¡æ¯
    setTimeout(() => updatePartnerInfo(), 500); // ç»™Firebaseæœ‰æ—¶é—´åŒæ­¥æ•°æ®
  }
}

// æ”¹è¿›updatePartnerInfoå‡½æ•°
function updatePartnerInfo() {
  if (!currentBattleRoomRef || pveMode !== 'coop') return;
  
  const partnerRole = window.myRole === "userA" ? "userB" : "userA";
  
  currentBattleRoomRef.child(partnerRole).once('value').then((snapshot) => {
    const partnerData = snapshot.val();
    if (!partnerData || !partnerData.uid) return;
    // æ›´æ–°å¯¹åº”ç©å®¶çš„åç§°æ ‡ç­¾
    const partnerZombieId = `zombie-${partnerRole}`;
    const partnerZombie = document.getElementById(partnerZombieId);
    if (partnerZombie) {
      // æ›´æ–°ä¼™ä¼´çš„ç²¾çµå›¾
      if (partnerData.spriteUrl) {
        partnerZombie.style.backgroundImage = `url('${partnerData.spriteUrl}')`;
      }
	  if (partnerData.btrSpriteUrl) {
        window.partnerBtrSprite = partnerData.btrSpriteUrl;
      }
      if (partnerData.t80SpriteUrl) {
        window.partnerT80Sprite = partnerData.t80SpriteUrl;
      }
      
      const nameTag = partnerZombie.querySelector('.player-name-tag');
      if (nameTag && partnerData.uid) {
        nameTag.textContent = partnerData.uid;
      }
    }
  });
}
  

  
  // æ·»åŠ ç”Ÿå‘½æ¢å’ŒBOSS
  function addHealthBarsAndBoss() {
    const playerHealthContainer = document.getElementById('player-health-container');
    const bossHealthContainer = document.getElementById('boss-health-container');
    
    if (!playerHealthContainer || !bossHealthContainer) return;
    
    // å¦‚æœæ˜¯åˆä½œæ¨¡å¼ï¼Œæ·»åŠ ä¸¤ä¸ªç©å®¶ç”Ÿå‘½æ¡
    if (pveMode === 'coop') {
      // UserBçš„ç”Ÿå‘½æ¡ - å·¦ä¾§
      const userBBar = document.createElement('div');
      userBBar.id = 'userB-health-bar';
      userBBar.className = 'health-bar coop-health-bar';
      userBBar.innerHTML = `
        <div class="health-fill" style="background:green"></div>
        <div class="health-text">ç­‰å¾…ç©å®¶B...</div>
      `;
      playerHealthContainer.appendChild(userBBar);
      
      // UserAçš„ç”Ÿå‘½æ¡ - å³ä¾§
      const userABar = document.createElement('div');
      userABar.id = 'userA-health-bar';
      userABar.className = 'health-bar coop-health-bar';
      userABar.innerHTML = `
        <div class="health-fill" style="background:green"></div>
        <div class="health-text">ç­‰å¾…ç©å®¶A...</div>
      `;
      playerHealthContainer.appendChild(userABar);
      
      // ç«‹å³å°è¯•æ›´æ–°ç”Ÿå‘½å€¼
      updateCoopHealthDisplay();
    } else {
      // å•äººæ¨¡å¼ - åªæ˜¾ç¤ºè‡ªå·±çš„è¡€æ¡
      const playerBar = document.createElement('div');
      playerBar.id = 'player-health-bar';
      playerBar.className = 'health-bar';
      playerBar.innerHTML = `
        <div class="health-fill" style="background:green"></div>
        <div class="health-text">${window.myUid}: ${playerHp}/${playerMaxHp}</div>
      `;
      playerHealthContainer.appendChild(playerBar);
    }
    
    // BOSSç”Ÿå‘½æ¢
    const bossBar = document.createElement('div');
    bossBar.id = 'boss-health-bar';
    bossBar.className = 'health-bar';
    bossBar.innerHTML = `
      <div class="health-fill boss-health-fill" style="background:red"></div>
      <div class="health-text">${bossConfigs[selectedBoss].name}: 100%</div>
    `;
    bossHealthContainer.appendChild(bossBar);
    
	// æ·»åŠ BOSSç²¾çµå›¾
	const enemyAnim = document.getElementById('battleEnemyAnim');
	if (enemyAnim && !document.getElementById('boss-animation')) {
	  const bossAnim = document.createElement('div');
	  bossAnim.id = 'boss-animation';
	  
	  // ä½¿ç”¨åŸå§‹CSSå˜é‡
	  const rootStyles = getComputedStyle(document.documentElement);
	  const frameHeight = parseFloat(rootStyles.getPropertyValue('--btr-frame-height')) || 120;
	  const frameWidth = parseFloat(rootStyles.getPropertyValue('--btr-frame-width')) || 480;
	  
	  // ç²¾çµå›¾æ€»å®½åº¦ (4å¸§)
	  const framesTotal = 4;
	  const totalWidth = frameWidth * framesTotal;
	  
	  // è®¾ç½®æ ·å¼
	  bossAnim.style.position = 'absolute';
	  bossAnim.style.left = '70%';
	  bossAnim.style.top = '50%';
	  bossAnim.style.marginLeft = `-${frameWidth / 2}px`;
	  bossAnim.style.marginTop = `-${frameHeight / 2}px`;
	  bossAnim.style.width = `${frameWidth}px`;
	  bossAnim.style.height = `${frameHeight}px`;
	  bossAnim.style.backgroundImage = `url(${bossConfigs[selectedBoss].sprite})`;
	  bossAnim.style.backgroundSize = `${totalWidth}px ${frameHeight}px`;
	  bossAnim.style.backgroundRepeat = 'no-repeat';
	  bossAnim.style.zIndex = '10';
	  
	  // åˆ›å»ºåŠ¨ç”»
	  const keyframesText = `
		@keyframes bossFrameAnim {
		  from { background-position: 0 0; }
		  to { background-position: -${totalWidth}px 0; }
		}
	  `;
	  
	  let styleElem = document.getElementById('boss-animation-keyframes');
	  if (!styleElem) {
		styleElem = document.createElement('style');
		styleElem.id = 'boss-animation-keyframes';
		document.head.appendChild(styleElem);
	  }
	  styleElem.textContent = keyframesText;
	  
	  // åº”ç”¨åŠ¨ç”»
	  bossAnim.style.animation = 'bossFrameAnim 0.5s steps(4) infinite';
	  
	  enemyAnim.appendChild(bossAnim);
	}
    
    // æ›´æ–°ç”Ÿå‘½å€¼é¡¯ç¤º
    updateHealthDisplay();
  }
  
  // æ›´æ–°ç”Ÿå‘½å€¼é¡¯ç¤º
  function updateHealthDisplay() {
    if (pveMode === 'coop') {
      // åˆä½œæ¨¡å¼ä¸‹æ›´æ–°åŒæ–¹è¡€æ¡
      updateCoopHealthDisplay();
    } else {
      // å•äººæ¨¡å¼åªæ›´æ–°è‡ªå·±
      const playerBar = document.getElementById('player-health-bar');
      if (playerBar) {
        const percentage = Math.round((playerHp / playerMaxHp) * 100);
        playerBar.querySelector('.health-fill').style.width = `${percentage}%`;
        playerBar.querySelector('.health-text').textContent = `${window.myUid}: ${playerHp}/${playerMaxHp}`;
      }
    }
    
    if (pveMode === 'coop' && window.myRole === 'userB') {
    // userBéœ€è¦ä»Firebaseè¯»å–æœ€æ–°å€¼
    if (currentBattleRoomRef) {
      currentBattleRoomRef.child('bossHealth').once('value')
        .then(snapshot => {
          if (snapshot.exists()) {
            const remoteBossHp = snapshot.val();
            updateBossHealthBar(remoteBossHp);
          } else {
            updateBossHealthBar(bossHp); // å›é€€åˆ°æœ¬åœ°å€¼
          }
        })
        .catch(() => {
          updateBossHealthBar(bossHp); // å‡ºé”™æ—¶ä½¿ç”¨æœ¬åœ°å€¼
        });
    }
  } else {
    // userAæˆ–å•äººæ¨¡å¼ç›´æ¥ä½¿ç”¨æœ¬åœ°å€¼
    updateBossHealthBar(bossHp);
  }
}
	function updateBossHealthBar(currentBossHp) {
	  const bossBar = document.getElementById('boss-health-bar');
	  if (bossBar) {
		const percentage = Math.round((currentBossHp / bossMaxHp) * 100);
		bossBar.querySelector('.health-fill').style.width = `${percentage}%`;
		bossBar.querySelector('.health-text').textContent = `${bossConfigs[selectedBoss].name}: ${percentage}%`;
	  }
	}
  
  // åˆä½œæ¨¡å¼ä¸‹æ›´æ–°åŒæ–¹è¡€æ¡
  function updateCoopHealthDisplay() {
    if (!currentBattleRoomRef) return;
  
  currentBattleRoomRef.once('value').then((snapshot) => {
    updateAllPlayerHealth(snapshot.val());
  });
}
  
  // é–‹å§‹PVEæˆ°é¬¥
  function startPveBattle() {
    // æª¢æŸ¥æš±ç¨±
    let nickname = document.getElementById('battleNickname').value.trim();
    if (!nickname) {
      return;
    }
    window.myUid = nickname;
    
    // æª¢æŸ¥PINç¢¼
    let pin = document.getElementById('battlePin').value.trim();
    if (!pin) {
      return;
    }
    
    // ç²å–é¸æ“‡
    selectedBoss = document.getElementById('bossList').value;
    pveMode = document.getElementById('pveModeSelect').value;
    
    // åˆå§‹åŒ–ç”Ÿå‘½å€¼ - æ­£ç¢ºè®€å–ä¸­å¿ƒå»ºç¯‰ç­‰ç´š
    initializePlayerHealth();
    
    // æ¨™è¨˜PVEæ¨¡å¼æ´»èº
    pveActive = true;
    
    // ç„¡è«–å–®äººé‚„æ˜¯åˆä½œæ¨¡å¼ï¼Œéƒ½å‰µå»ºFirebaseæˆ¿é–“
    createPveRoom(pin);
  }
  
  // åˆå§‹åŒ–ç©å®¶ç”Ÿå‘½å€¼ - ç¢ºä¿æ­£ç¢ºè®€å–ä¸­å¿ƒå»ºç¯‰ç­‰ç´š
  function initializePlayerHealth() {
    let centerLevel = 1;
    
    try {
      // ç›´æ¥å¾å…¨å±€gameStateç²å–ä¸­å¿ƒå»ºç¯‰ç­‰ç´š
      const centerBuilding = gameState.buildings.find(b => 
        b && b.type.toLowerCase() === "center"
      );
      if (centerBuilding) {
        centerLevel = centerBuilding.level || 1;
      }
    } catch (error) {
      centerLevel = 1; // å‡ºéŒ¯æ™‚ä½¿ç”¨é»˜èªå€¼
    }
    
    // åŸºç¤ç”Ÿå‘½å€¼100ï¼Œæ¯ç´šæå‡5%
    const baseHealth = 100;
    const healthMultiplier = Math.pow(1.05, centerLevel - 1);
    playerMaxHp = playerHp = Math.round(baseHealth * healthMultiplier);
    
    // åˆå§‹åŒ–BOSSç”Ÿå‘½å€¼
    const bossConfig = bossConfigs[selectedBoss];
    bossMaxHp = bossHp = bossConfig.hp;
  }
  
  // å‰µå»ºPVEæˆ¿é–“
  function createPveRoom(pin) {
    // ç¢ºä¿Firebaseå·²åˆå§‹åŒ–
    if (!firebase.database) {
      alert("Firebase æ•¸æ“šåº«æœªåˆå§‹åŒ–");
      return;
    }
    
    // å‰µå»ºæˆ¿é–“åƒè€ƒ
    currentBattleRoomRef = firebase.database().ref('pveBattles').child(pin);
	const playerData = {
		uid: window.myUid,
		health: playerHp,
		maxHp: playerMaxHp,
		isDown: false,
		spriteUrl: window.currentZombieSprite, // åƒµå°¸ç²¾çµå›¾
		btrSpriteUrl: window.currentBtrSprite, // BTRç²¾çµå›¾
		t80SpriteUrl: window.currentT80Sprite  // T80ç²¾çµå›¾
	  };
    
    if (pveMode === 'solo') {
      // å–®äººæ¨¡å¼ - ç›´æ¥å‰µå»ºä¸¦é–‹å§‹
      currentBattleRoomRef.set({
        bossId: selectedBoss,
        mode: pveMode,
        type: 'pve',         // æ ‡è®°æˆ¿é—´ç±»å‹ä¸ºPVE
        locked: true,        // é”å®šæˆ¿é—´ï¼Œä¸å…è®¸å…¶ä»–ç©å®¶åŠ å…¥
        userA: playerData,
        bossHealth: bossHp,
        status: 'active',
        startTime: firebase.database.ServerValue.TIMESTAMP
      }).then(() => {
	    currentBattleRoomRef.onDisconnect().remove();
        window.myRole = "userA";
        pveMatched = true; // å–®äººæ¨¡å¼ç›´æ¥æ¨™è¨˜ç‚ºå·²åŒ¹é…
		currentBattleRoomRef.child('userA').onDisconnect().remove();
        // ä¿å­˜æˆ¿é–“IDä»¥ä¾¿å¾ŒçºŒä½¿ç”¨
        window.currentBattleRoom = pin;
        // åˆå§‹åŒ–æˆ°é¬¥
        initPveBattle();
        // è¨­ç½®ç›£è½
        setupFirebaseListeners();
      }).catch(error => {
        alert('å‰µå»ºPVEæˆ¿é–“å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      });
    } else {
      // åˆä½œæ¨¡å¼ - æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æˆ¿é–“
      currentBattleRoomRef.once('value').then((snapshot) => {
        const roomData = snapshot.val();
		if (roomData && roomData.locked) {
		  return;
		}
        if (!roomData) {
          // å‰µå»ºæ–°æˆ¿é–“
          currentBattleRoomRef.set({
            bossId: selectedBoss,
            mode: pveMode,
            type: 'pve',     // æ ‡è®°æˆ¿é—´ç±»å‹ä¸ºPVE
            userA: playerData,
            bossHealth: bossHp,
            status: 'waiting',
            startTime: firebase.database.ServerValue.TIMESTAMP
          }).then(() => {
		    currentBattleRoomRef.onDisconnect().remove();
            window.myRole = "userA";
			currentBattleRoomRef.child('userA').onDisconnect().remove();
            window.currentBattleRoom = pin;
            // ç­‰å¾…å¦ä¸€ä½ç©å®¶åŠ å…¥
            appendBattleLogEntry({
              sender: "ç³»çµ±",
              senderRole: "system",
              message: "ç­‰å¾…å¦ä¸€åç©å®¶åŠ å…¥...",
              battleMode: "pve"
            });
            // è¨­ç½®ç›£è½
            setupFirebaseListeners();
          }).catch(err => {
            alert("å‰µå»ºåˆä½œæ¨¡å¼æˆ¿é–“å¤±æ•—");
          });
        } else if (!roomData.userB) {
          // åŠ å…¥ç‚ºç©å®¶B
          currentBattleRoomRef.child('userB').set(playerData).then(() => {
		    currentBattleRoomRef.onDisconnect().remove();
            window.myRole = "userB";
			currentBattleRoomRef.child('userB').onDisconnect().remove();
            window.currentBattleRoom = pin;
            // æ›´æ–°æˆ¿é–“ç‹€æ…‹
            currentBattleRoomRef.update({ status: 'active' });
            // è¨­ç½®ç›£è½
            setupFirebaseListeners();
            // ç²å–BOSSä¿¡æ¯
            selectedBoss = roomData.bossId;
            bossHp = bossMaxHp = roomData.bossHealth;
            // åˆå§‹åŒ–æˆ°é¬¥
            pveMatched = true;
            initPveBattle();
          }).catch(() => {});
        } else {}
      }).catch(() => {});
    }
  }
  
function setupFirebaseListeners() {
  if (!currentBattleRoomRef) return;
  
  // ç§»é™¤ç¾æœ‰ç›£è½å™¨
  currentBattleRoomRef.off();
  currentBattleRoomRef.child('log').off();
  currentBattleRoomRef.child('events').off();
  
  // 1. ç›‘å¬æˆ¿é—´çŠ¶æ€å˜åŒ– - é‡è¦ï¼šæ­»äº¡åä»éœ€ç»§ç»­ç›‘å¬
  currentBattleRoomRef.on('value', (snapshot) => {
    const roomData = snapshot.val();
    if (!roomData) return;
	latestRoomData = roomData;
	updateAllPlayerHealth(roomData);
	if (pveMode === 'coop') {
		if (roomData.userA?.isDown && !processedMessages['bossLoop_taken']) {
          processedMessages['bossLoop_taken'] = true;
          enableBossLoop();
        }
        if (roomData.userA?.isDown && !processedMessages['userA_death']) {
          processedMessages['userA_death'] = true;
          updatePlayerSpriteToDead('userA');
        }
        if (roomData.userB?.isDown && !processedMessages['userB_death']) {
          processedMessages['userB_death'] = true;
          updatePlayerSpriteToDead('userB');
        }
      }
    currentBattleRoomRef.on('child_removed', snapshot => {
    const role = snapshot.key;  // 'userA' æˆ– 'userB'
    if (role !== 'userA' && role !== 'userB') return;
    // é¿å…é‡å¤æ‰§è¡Œ
    const flag = `${role}_exit_death`;
    if (processedMessages[flag]) return;
    processedMessages[flag] = true;

    // 1) åˆ‡æ­»äº¡ç²¾çµ
    updatePlayerSpriteToDead(role);

    // 2) æ›´æ–°è¡€æ¡ï¼šè¯¥ç©å®¶è¡€é‡å½’é›¶
    const rem = snapshot.val() || {};
    const fakeData = {
      userA: role==='userA'
        ? { uid: rem.uid || 'ç©å®¶A', health: 0, maxHp: rem.maxHp || playerMaxHp, isDown: true }
        : latestRoomData.userA,
      userB: role==='userB'
        ? { uid: rem.uid || 'ç©å®¶B', health: 0, maxHp: rem.maxHp || playerMaxHp, isDown: true }
        : latestRoomData.userB
    };
    updateAllPlayerHealth(fakeData);
  });
    
	    
    // æ£€æŸ¥æ¸¸æˆç»“æŸ
    if (roomData.status === 'ended') {
      if (!pveEnded) {
        pveEnded = true;
        setTimeout(() => endPveBattle(roomData.result === 'victory'), 1000);
      }
      return;
    }
    
    // å…³é”®æ”¹è¿›ï¼šæ— è®ºä»»ä½•çŠ¶æ€ï¼Œå§‹ç»ˆæ›´æ–°æ‰€æœ‰è¡€é‡æ˜¾ç¤º
    updateAllPlayerHealth(roomData);
      
      // æª¢æŸ¥æ˜¯å¦å·²æœ‰å…©åç©å®¶
      if (roomData.status === 'active' && roomData.userA && roomData.userB) {
        if (!pveMatched) {
          pveMatched = true;
          appendBattleLogEntry({
            sender: "ç³»çµ±",
            senderRole: "system",
            message: "é›™æ–¹é€£ç·šæˆåŠŸï¼Œæº–å‚™é–‹å§‹å°æˆ°ï¼",
            battleMode: "pve"
          });
          
          // å¦‚æœæ˜¯ç©å®¶Aï¼Œåˆå§‹åŒ–æˆ°é¬¥
          if (window.myRole === "userA") {
            initPveBattle();
          }
          
          // æ·»åŠ ä¼™ä¼´è§’è‰²
          const selfAnim = document.getElementById('battleSelfAnim');
          if (selfAnim) {
            addUserCharacters(selfAnim);
          }
          
          // æ›´æ–°åŒæ–¹è¡€æ¡
          updateCoopHealthDisplay();
        }
      }
      
      // åŒæ­¥BOSSç”Ÿå‘½å€¼
      if (window.myRole === "userB" && roomData.bossHealth !== undefined) {
        bossHp = roomData.bossHealth;
        updateHealthDisplay();
      }
      
      // ===== ç©å®¶å€’åœ°æ£€æµ‹ä¸å¤„ç† =====
      if (window.myRole === "userA") {
      // æ£€æŸ¥userAæ˜¯å¦åˆšåˆšæ­»äº¡
      if (roomData.userA && roomData.userA.isDown) {
        const userADownKey = `userA_${roomData.userA.uid}_down`;
        if (!processedMessages[userADownKey]) {
          processedMessages[userADownKey] = true;
          
          appendBattleLogEntry({
            sender: "ç³»çµ±",
            senderRole: "system",
            message: `${roomData.userA.uid} å—åˆ°è‡´å‘½ä¸€æ“Šï¼Œé‡å‚·å€’åœ°ã€‚`,
            battleMode: "pve"
          });
		   currentBattleRoomRef.child('_processedMessages').update({
            [userADownKey]: true
          });
        }
      }
      
      // æ£€æŸ¥userBæ˜¯å¦åˆšåˆšæ­»äº¡
      if (roomData.userB && roomData.userB.isDown) {
        const userBDownKey = `userB_${roomData.userB.uid}_down`;
        if (!processedMessages[userBDownKey]) {
          processedMessages[userBDownKey] = true;
          
          appendBattleLogEntry({
            sender: "ç³»çµ±",
            senderRole: "system",
            message: `${roomData.userB.uid} å—åˆ°è‡´å‘½ä¸€æ“Šï¼Œé‡å‚·å€’åœ°ã€‚`,
            battleMode: "pve"
          });
        }
      }
      
      // æ£€æŸ¥æ˜¯å¦åŒæ–¹éƒ½æ­»äº¡ - æˆ˜æ–—å¤±è´¥
      if (roomData.userA && roomData.userA.isDown && 
          roomData.userB && roomData.userB.isDown && !pveEnded) {
        setTimeout(() => endPveBattle(false), 1000);
      }
    }
  });
  
  // 2. ç›£è½äº‹ä»¶ - ç”¨äºåŒæ­¥BTR/T80æ”¯æ´
  if (pveMode === 'coop') {
    currentBattleRoomRef.child('events').on('child_added', (snapshot) => {
      const event = snapshot.val();
      if (event && event.type === 'btrSupport' && event.sender !== window.myRole) {
        // æ˜¾ç¤ºä¼™ä¼´çš„BTR/T80æ”¯æ´
        battleBTRType = event.btrType;
        showPartnerBtrSupport();
      }
    });
  }
  
  // 3. ç›£è½æ—¥èªŒ - ä¿®å¾©ï¼šä½¿ç”¨å”¯ä¸€IDé˜²æ­¢é‡è¤‡
  currentBattleRoomRef.child('log').on('child_added', (snapshot) => {
    if (pveEnded) return;
    
    const logEntry = snapshot.val();
    if (!logEntry) return;
    
    const entryId = snapshot.key;
    
    // æª¢æŸ¥æ˜¯å¦å·²è™•ç†éè©²æ¶ˆæ¯
    if (processedMessages[entryId]) {
      return; // è·³éå·²è™•ç†çš„æ¶ˆæ¯
    }
    
    // æ¨™è¨˜æ¶ˆæ¯ç‚ºå·²è™•ç†
    processedMessages[entryId] = true;
    
    // ç¢ºä¿æ¶ˆæ¯ä¾†è‡ªPVEæˆ°é¬¥
    if (logEntry.battleMode !== 'pve' && logEntry.battleMode !== undefined) {
      return; // è·³è¿‡éPVEæ¶ˆæ¯
    }
    
    // é¿å…é¡¯ç¤ºè‡ªå·±æœ¬åœ°å·²é¡¯ç¤ºéçš„æ¶ˆæ¯ï¼ˆåƒ…æª¢æŸ¥ç™¼é€è€…å’Œè§’è‰²ï¼‰
    if (logEntry.sender === window.myUid && logEntry.senderRole === window.myRole) {
      return;
    }
    
    // é¡¯ç¤ºæ—¥èªŒ
    displayBattleLogEntry(logEntry);
  });
}

function updateAllPlayerHealth(roomData) {
  if (!roomData) return;

  // ç©å®¶ A çš„è¡€æ¡
  const userA = roomData.userA || {};
  const barA  = document.getElementById('userA-health-bar');
  if (barA) {
    // å¦‚æœ roomData ä¸­å­˜äº† maxHp å°±ç”¨å®ƒï¼Œå¦åˆ™å›é€€åˆ°æœ¬åœ° playerMaxHp
    const maxHpA = userA.maxHp != null ? userA.maxHp : playerMaxHp;
    const hpA    = userA.health != null ? userA.health : 0;
    const pctA   = maxHpA > 0 ? Math.round((hpA / maxHpA) * 100) : 0;

    barA.querySelector('.health-fill').style.width       = pctA + '%';
    barA.querySelector('.health-text').textContent       =
      `${userA.uid || 'ç©å®¶A'}: ${hpA}/${maxHpA}`;
    barA.classList.toggle('player-down', !!userA.isDown);
  }

  // ç©å®¶ B çš„è¡€æ¡ï¼ˆCoop æ¨¡å¼ä¸‹æ‰ä¼šæœ‰ï¼‰
  const userB = roomData.userB || {};
  const barB  = document.getElementById('userB-health-bar');
  if (barB) {
    const maxHpB = userB.maxHp != null ? userB.maxHp : playerMaxHp;
    const hpB    = userB.health != null ? userB.health : 0;
    const pctB   = maxHpB > 0 ? Math.round((hpB / maxHpB) * 100) : 0;

    barB.querySelector('.health-fill').style.width       = pctB + '%';
    barB.querySelector('.health-text').textContent       =
      `${userB.uid || 'ç©å®¶B'}: ${hpB}/${maxHpB}`;
    barB.classList.toggle('player-down', !!userB.isDown);
  }
}


// æ˜¾ç¤ºä¼™ä¼´çš„BTR/T80æ”¯æ´
function showPartnerBtrSupport() {
  if (!window.currentBattleRoom) return;
  const selfAnim = document.getElementById("battleSelfAnim");
  if (!selfAnim) return;
  const useT80 = (battleBTRType === "t80");
  const partnerRole = window.myRole === "userA" ? "userB" : "userA";
  currentBattleRoomRef.child(partnerRole).once("value").then(snap => {
    const pd = snap.val();
    if (!pd) return;
    // 1) å–å¯¹æ–¹ä¸Šä¼ çš„ç²¾çµå›¾ URL
    const spriteUrl = (battleBTRType === "t80")
      ? (pd.t80SpriteUrl || window.currentT80Sprite)
      : (pd.btrSpriteUrl  || window.currentBtrSprite);
  
   // åŠ¨æ€è®¡ç®—ä½ç½®
  const containerWidth = selfAnim.clientWidth;
  const offset = 50;
  const rootStyles = getComputedStyle(document.documentElement);
  
  let frameWidth;
  if (useT80) {
    frameWidth = 480;
  } else {
    frameWidth = parseFloat(rootStyles.getPropertyValue('--btr-frame-width')) || 240;
  }
  
  // è®¡ç®—ä½ç½® - åœ¨ä¼™ä¼´åƒµå°¸é™„è¿‘
  const centerStart = containerWidth + offset + 0.5 * frameWidth;
  const centerStop = window.myRole === "userB" ? containerWidth * 0.4 : containerWidth * 0.6; 
  const startLeft = centerStart - 0.5 * frameWidth;
  const stopLeft  = centerStop - 0.5 * frameWidth;
  
  // åˆ›å»ºå…³é”®å¸§åŠ¨ç”»
  const keyframesText = `
    @keyframes btrMovePartnerBattle {
      0%   { left: ${startLeft}px; }
      20%  { left: ${stopLeft}px; }
      60%  { left: ${stopLeft}px; }
      100% { left: ${startLeft}px; }
    }
  `;
  
  let styleElem = document.getElementById("btrKeyframesPartnerBattle");
  if (!styleElem) {
    styleElem = document.createElement("style");
    styleElem.id = "btrKeyframesPartnerBattle";
    document.head.appendChild(styleElem);
  }
  styleElem.textContent = keyframesText;
  
  // åˆ›å»ºåŠ¨ç”»å®¹å™¨
  const btrWrapper = document.createElement("div");
  btrWrapper.className = "btr-wrapper partner-btr";
  btrWrapper.style.position = "absolute";
  btrWrapper.style.top = "25%";
  btrWrapper.style.left = startLeft + "px";
  btrWrapper.style.animation = "btrMovePartnerBattle 10s ease-in-out forwards";
  btrWrapper.style.zIndex = "5";
  
  let spriteElem;
  if (useT80) {
    // T80åŠ¨ç”»
    const frameContainer = document.createElement("div");
    frameContainer.className = "frameContainer";
    frameContainer.style.width = frameWidth + "px";
    frameContainer.style.height = rootStyles.getPropertyValue('--btr-frame-height') || "120px";
    frameContainer.style.overflow = "hidden";
    
    spriteElem = document.createElement("div");
    spriteElem.className = "t80-animation partner-t80";
    spriteElem.style.backgroundImage = `url("${spriteUrl}")`;
    spriteElem.style.backgroundPosition = "0px 0";
    
    frameContainer.appendChild(spriteElem);
    btrWrapper.appendChild(frameContainer);
	startT80IdleAnimation(spriteElem);
    setTimeout(() => {
      const originalBTRActive = battleBTRActive;
      const originalCooldown = t80CannonOnCooldown;
      battleBTRActive = true;
      t80CannonOnCooldown = false;
      triggerT80Cannon(spriteElem);
      setTimeout(() => {
        battleBTRActive = originalBTRActive;
        t80CannonOnCooldown = originalCooldown;
      }, 100);
    }, 1000);
  } else {
    // BTRåŠ¨ç”»
    spriteElem = document.createElement("div");
    spriteElem.className = "btr-animation partner-btr";
    spriteElem.style.backgroundImage = `url("${spriteUrl}")`;
    btrWrapper.appendChild(spriteElem);
  }
  
  selfAnim.appendChild(btrWrapper);
  spriteElem.style.setProperty(
      "background-image",
      `url("${spriteUrl}")`,
      "important"
    );
  
  // 10ç§’åæ¸…ç†
  setTimeout(() => {
    if (selfAnim.contains(btrWrapper)) {
      selfAnim.removeChild(btrWrapper);
    }
  }, 10000);
  });
}

// é¡¯ç¤ºæˆ°é¬¥æ—¥èªŒæ¢ç›®
function displayBattleLogEntry(messageObj) {
  if (typeof messageObj !== 'object' || messageObj === null) return;
  
  const entry = document.createElement('div');
  entry.className = 'log-entry';
  
  // æ ¹æ“šç™¼é€è€…è¨­ç½®æ¨£å¼
  if (messageObj.senderRole === "system") {
    // ç³»ç»Ÿäº‹ä»¶ - ä½¿ç”¨ç³»ç»Ÿæ ·å¼
    entry.className += ' battle-system-entry';
    entry.innerHTML = `<span>[ç³»çµ±] ${messageObj.message}</span>`;
  } else if (messageObj.senderRole === "boss") {
    // Bossäº‹ä»¶ - ä½¿ç”¨æ•Œæ–¹æ ·å¼
    entry.className += ' battle-enemy-entry';
    entry.innerHTML = `<span>[${messageObj.sender}] ${messageObj.message}</span>`;
  } else {
    // ç©å®¶äº‹ä»¶ - ä½¿ç”¨å·±æ–¹æ ·å¼
    entry.className += ' battle-self-entry';
    entry.innerHTML = `<span>[${messageObj.sender}] ${messageObj.message}</span>`;
  }
  
  const logContainer = document.getElementById('battleLogContent');
  if (logContainer) {
    logContainer.appendChild(entry);
    logContainer.scrollTop = logContainer.scrollHeight;
  }
}

// å‘æˆ°é¬¥æ—¥èªŒæ·»åŠ æ¢ç›®ä¸¦ä¸Šå‚³åˆ°Firebase
function appendBattleLogEntry(messageObj) {
  if (typeof messageObj !== 'object' || messageObj === null) return;
  
  // æ·»åŠ PVEæ ‡è¯†
  if (!messageObj.battleMode) {
    messageObj.battleMode = "pve";
  }
  
  // é¡¯ç¤ºåœ¨æœ¬åœ°
  displayBattleLogEntry(messageObj);
  
  // ä¸Šå‚³åˆ°Firebase
  if (currentBattleRoomRef) {
    // ç”Ÿæˆå”¯ä¸€ID
    const newLogRef = currentBattleRoomRef.child('log').push();
    const messageId = newLogRef.key;
    
    // å·²å°‡æ­¤æ¶ˆæ¯æ¨™è¨˜ç‚ºå·²è™•ç†ï¼Œé˜²æ­¢é‡è¤‡é¡¯ç¤º
    processedMessages[messageId] = true;
    
    // ä¸Šå‚³æ¶ˆæ¯åˆ°Firebase
    newLogRef.set(messageObj);
  }
}
function enableBossLoop() {
    if (bossAttackInterval) return; // å·²ç»åœ¨è¿è¡Œ
    const cfg = bossConfigs[selectedBoss];
    // Soloï¼šuserA æ‰§è¡Œï¼›Coopï¼šåªæœ‰ userA æ´»ç€æˆ– userB æ¥æ‰‹åæ‰æ‰§è¡Œ
    if (
      pveMode === 'solo' && window.myRole === 'userA'
      || pveMode === 'coop' && (
           !latestRoomData.userA?.isDown && window.myRole === 'userA'
        ||  latestRoomData.userA?.isDown && window.myRole === 'userB'
      )
    ) {
      bossAttackInterval = setInterval(() => {
        // å¦‚æœæ¸¸æˆç»“æŸæˆ–è‡ªå·±å·²å€’åœ°ï¼Œè·³è¿‡
        if (pveEnded || latestRoomData?.[window.myRole]?.isDown) return;
        triggerBossAttack();
      }, cfg.attackInterval);
    }
  }
// é–‹å§‹æˆ°é¬¥å¾ªç’°
function startCombatLoop() {
  // æ¸…é™¤ç¾æœ‰è¨ˆæ™‚å™¨
  clearCombatTimers();
  
  // ç©å®¶æ”»æ“Šå¾ªç’° - æ¯5ç§’
  pveInterval = setInterval(() => {
    if (pveEnded || playerIsDown) return;
    triggerPlayerAttack();
  }, 5000);
  
  // BOSSæ”»æ“Šå¾ªç’°
  enableBossLoop();
  
  // BTR/T80äº‹ä»¶ - æ¯30ç§’æª¢æŸ¥ä¸€æ¬¡ï¼Œèˆ‡PVPä¸€è‡´
  battleBTREventTimer = setInterval(() => {
    if (pveEnded || playerIsDown) return;
    checkBTREvent();
  }, 30000);
}



// æª¢æŸ¥BTRäº‹ä»¶
function checkBTREvent() {
  // ç›´æ¥å¾gameStateç²å–è£ç”²è»Šåº«ï¼ˆæ‹–æ‹‰æ©Ÿå» ï¼‰
  try {
    const garages = gameState.buildings.filter(b => 
      b && b.type.toLowerCase() === "armoredgarage"
    );
    
    if (garages.length > 0 && BUILDINGS && BUILDINGS.armoredGarage) {
      const garageInfo = BUILDINGS.armoredGarage.getUpgradeInfo(garages[0].level);
      
      // æª¢æŸ¥è§¸ç™¼æ©Ÿç‡
      if (Math.random() < garageInfo.effect.btrChance) {
        triggerBtrSupport();
      }
    }
  } catch (error) {
    // éœé»˜è™•ç†éŒ¯èª¤
  }
}

// æ¸…é™¤æˆ°é¬¥è¨ˆæ™‚å™¨
function clearCombatTimers() {
  if (pveInterval) clearInterval(pveInterval);
  if (bossAttackInterval) clearInterval(bossAttackInterval);
  if (battleBTREventTimer) clearInterval(battleBTREventTimer);
  if (battleBTRInterval) clearInterval(battleBTRInterval);
  if (t80IdleInterval) clearInterval(t80IdleInterval);
  if (t80CannonTimeout) clearTimeout(t80CannonTimeout);
  
  pveInterval = null;
  bossAttackInterval = null;
  battleBTREventTimer = null;
  battleBTRInterval = null;
  t80IdleInterval = null;
  t80CannonTimeout = null;
}

// è§¸ç™¼ç©å®¶æ”»æ“Š
function triggerPlayerAttack() {
  let centerLevel = 1;
  
  try {
    // ç›´æ¥å¾gameStateç²å–ä¸­å¿ƒåŸºåœ°ç­‰ç´š
    const centerBuilding = gameState.buildings.find(b => 
      b && b.type.toLowerCase() === "center"
    );
    if (centerBuilding) {
      centerLevel = centerBuilding.level || 1;
    }
  } catch (error) {
    centerLevel = 1;
  }
  
  // èˆ‡PVPä¸€è‡´çš„å‘½ä¸­ç‡è¨ˆç®—ï¼š40 + centerLevel * 0.5ï¼Œæœ€é«˜85%
  const hitChanceVal = Math.min(40 + centerLevel * 0.5, 85);
  const hitRoll = Math.random() * 100;
  const hit = (hitRoll < hitChanceVal);
  
  // å‚·å®³è¨ˆç®—
  const baseDamage = hit ? (Math.floor(Math.random() * 10) + 1) : 0;
  
  // åƒµå°¸æŒ‡æ®ä¸­å¿ƒåŠ æˆ
  let commandCenterLevel = 0;
  try {
    const commandCenter = gameState.buildings.find(b => 
      b && b.type.toLowerCase() === "zombiecommandcenter"
    );
    if (commandCenter) {
      commandCenterLevel = commandCenter.level;
    }
  } catch (error) {
    commandCenterLevel = 0;
  }
  
  // å‚·å®³åŠ æˆ
  const multiplier = 1 + commandCenterLevel * 0.01;
  const damage = Math.round(baseDamage * multiplier);
  
  // ç²å–æ”»æ“ŠçŸ­èª
  const phrase = pveAttackPhrases.normal[Math.floor(Math.random() * pveAttackPhrases.normal.length)];
  
  // è™•ç†æˆ°é¬¥çµæœ
  if (hit && damage > 0) {
    appendBattleLogEntry({
      sender: window.myUid,
      senderRole: window.myRole,
      message: `æ´¾é£çš„ ${phrase}ï¼ˆå‘½ä¸­ï¼‰ï¼Œ${bossConfigs[selectedBoss].name} å—åˆ° ${damage} é»å‚·å®³`,
      targetType: "boss",
      battleMode: "pve"
    });
    
    // æ›´æ–°BOSSç”Ÿå‘½å€¼
    if (window.myRole === "userA") {
      // æ›´æ–°BOSSç”Ÿå‘½å€¼
      bossHp = Math.max(0, bossHp - damage);
      totalPlayerDamage += damage;
    
    // åŒæ­¥åˆ°Firebase
    if (currentBattleRoomRef) {
        currentBattleRoomRef.update({ 
          bossHealth: bossHp,
          lastDamageBy: "userA",
          lastDamageAmount: damage,
          lastUpdateTime: firebase.database.ServerValue.TIMESTAMP
        });
      }
    
    // æª¢æŸ¥BOSSæ˜¯å¦è¢«æ“Šæ•—
    if (bossHp <= 0) {
        endPveBattle(true);
      }
    } else {
      // userBåªæ›´æ–°è‡ªå·±çš„æœ¬åœ°ä¼¤å®³ç»Ÿè®¡ï¼Œä¸ä¿®æ”¹bossHp
      totalPlayerDamage += damage;
    }
  } else {
    appendBattleLogEntry({
      sender: window.myUid,
      senderRole: window.myRole,
      message: `æ´¾é£çš„ ${phrase}ï¼ˆæœªå‘½ä¸­ï¼‰`,
      targetType: "boss",
      battleMode: "pve"
    });
  }
  
  // æ›´æ–°ç”Ÿå‘½å€¼é¡¯ç¤º
  updateHealthDisplay();
}


function triggerBossAttack() {
  const cfg = bossConfigs[selectedBoss];

  // Soloï¼šåªè®© userA å‘èµ·ï¼›Coopï¼šç”±å­˜æ´»è€…æ¥æ‰‹
  if (pveMode === 'solo') {
    if (window.myRole !== 'userA') return;
  } else {
    if (latestRoomData?.[window.myRole]?.isDown) return;
    if (latestRoomData.userA?.isDown && latestRoomData.userB?.isDown) return;
  }

  // 1) å‘½ä¸­åˆ¤å®š
  const hitChance = cfg.hitChance ?? 75;
  const hit = Math.random() * 100 < hitChance;

  // 2) å•ä½“ vs AOE
  const singleRate = cfg.singleAttackRate ?? 0.7;
  const isSingle  = Math.random() < singleRate;

  // â€”â€” 3) é€‰è¯åº“ï¼šå•ä½“æ”»å‡»ï¼ˆæˆ– Solo æ¨¡å¼ï¼‰ä¸€å®šå– single è¯åº“ â€”â€” 
  const useSinglePool = isSingle || pveMode === 'solo';
  const pool = useSinglePool
    ? cfg.attackPhrases.single
    : (cfg.attackPhrases.aoe || cfg.attackPhrases.single);
  const phrase = pool[Math.floor(Math.random() * pool.length)];

  // 4) è®¡ç®—ä¼¤å®³
  let damage = 0;
  if (hit) {
    const raw = Math.floor(
      cfg.damageRange.min +
      Math.random() * (cfg.damageRange.max - cfg.damageRange.min)
    );
    damage = isSingle ? raw : Math.floor(raw * 0.8);
  }

  // 5) æ‰£è¡€ & æ—¥å¿—
  if (hit && damage > 0) {
    if (useSinglePool) {
      // å•ä½“ï¼šéšæœºé€‰ä¸ªå­˜æ´»ç©å®¶æˆ– Solo
      let targets = [];
      if (pveMode === 'solo') {
        targets.push('userA');
      } else {
        if (!latestRoomData.userA?.isDown) targets.push('userA');
        if (!latestRoomData.userB?.isDown) targets.push('userB');
      }
      if (targets.length === 0) return;

      const role = targets[Math.floor(Math.random() * targets.length)];
      const uid  = latestRoomData[role].uid;

      appendBattleLogEntry({
        sender: cfg.name,
        senderRole: 'boss',
        message: `${phrase}${uid}ï¼ˆå‘½ä¸­ï¼‰ï¼Œé€ æˆ ${damage} é»å‚·å®³ï¼`,
        timestamp: Date.now(),
        battleMode: 'pve',
        aoe: false
      });

      // æ‰£è¡€
      const ref = currentBattleRoomRef.child(role);
      ref.once('value').then(snap => {
	    const data = snap.val() || {};
		if (data.isDown) return;
        const prev = snap.val()||{};
        const newHp = Math.max(0, (prev.health||playerMaxHp) - damage);
        ref.update({ health: newHp, isDown: newHp<=0 });
        if (role === window.myRole && newHp <= 0 && !playerIsDown) {
          handlePlayerDown();
        }
      });
    } else {
      // ç¾¤ä½“
      appendBattleLogEntry({
        sender: cfg.name,
        senderRole: 'boss',
        message: `${phrase}ï¼ˆç¯„åœæ”»æ“Šï¼‰â†’ æˆ‘æ–¹å„å— ${damage} é»å‚·å®³ï¼`,
        timestamp: Date.now(),
        battleMode: 'pve',
        aoe: true
      });

      ['userA','userB'].forEach(role => {
        if (pveMode==='solo' && role!=='userA') return;
        const ref = currentBattleRoomRef.child(role);
        ref.once('value').then(snap => {
		  const data = snap.val() || {};
		  if (data.isDown) return; 
          const prev = snap.val()||{};
          const newHp = Math.max(0, (prev.health||playerMaxHp) - damage);
          ref.update({ health: newHp, isDown: newHp<=0 });
          if (role === window.myRole && newHp <= 0 && !playerIsDown) {
            handlePlayerDown();
          }
        });
      });
    }
  } else {
    // æœªå‘½ä¸­ä¹Ÿèµ°åŒä¸€ pool
    appendBattleLogEntry({
      sender: cfg.name,
      senderRole: "boss",
      message: `${phrase}ï¼ˆæœªå‘½ä¸­ï¼‰ï¼`,
      timestamp: Date.now(),
      battleMode: "pve",
      aoe: !useSinglePool
    });
  }

  // 6) åˆ·æ–°è¡€æ¡
  updateAllPlayerHealth(latestRoomData || { userA:{ health:playerHp, maxHp:playerMaxHp, isDown:playerIsDown, uid:window.myUid } });
}



// è§¸ç™¼BTR/T80æ”¯æ´
function triggerBtrSupport() {
  // éš¨æ©Ÿé¸æ“‡T80æˆ–BTR (40%æ©Ÿç‡ä½¿ç”¨T80)
  const useT80 = (Math.random() < 0.4);
  battleBTRType = useT80 ? "t80" : "btr";
  
  // ç²å–å‹•ç•«å®¹å™¨
  const selfAnim = document.getElementById('battleSelfAnim');
  if (!selfAnim) return;
  
  // å‹•æ…‹è¨ˆç®—ä½ç½®
  const containerWidth = selfAnim.clientWidth;
  const offset = 50;
  const rootStyles = getComputedStyle(document.documentElement);
  
  let frameWidth;
  if (useT80) {
    frameWidth = 480;
  } else {
    frameWidth = parseFloat(rootStyles.getPropertyValue('--btr-frame-width')) || 240;
  }
  const centerStart = containerWidth + offset + 0.5 * frameWidth;
  const centerStop = window.myRole === "userA" ? containerWidth * 0.4 : containerWidth * 0.6;
  const startLeft = centerStart - 0.5 * frameWidth;
  const stopLeft  = centerStop - 0.5 * frameWidth;
  
  // å‰µå»ºé—œéµå¹€å‹•ç•«
  const keyframesText = `
    @keyframes btrMoveDynamicBattle {
      0%   { left: ${startLeft}px; }
      20%  { left: ${stopLeft}px; }
      60%  { left: ${stopLeft}px; }
      100% { left: ${startLeft}px; }
    }
  `;
  
  let styleElem = document.getElementById("btrKeyframesBattle");
  if (!styleElem) {
    styleElem = document.createElement("style");
    styleElem.id = "btrKeyframesBattle";
    document.head.appendChild(styleElem);
  }
  styleElem.textContent = keyframesText;
  
  // å‰µå»ºå‹•ç•«å®¹å™¨
  const btrWrapper = document.createElement("div");
  btrWrapper.className = "btr-wrapper";
  btrWrapper.style.position = "absolute";
  btrWrapper.style.top = "25%";
  btrWrapper.style.left = startLeft + "px";
  btrWrapper.style.animation = "btrMoveDynamicBattle 10s ease-in-out forwards";
  btrWrapper.style.zIndex = window.myRole === "userA" ? "10" : "5";
  let spriteElem;
  if (useT80) {
    // T80å‹•ç•«
    const frameContainer = document.createElement("div");
    frameContainer.className = "frameContainer";
    frameContainer.style.width = frameWidth + "px";
    frameContainer.style.height = rootStyles.getPropertyValue('--btr-frame-height') || "120px";
    frameContainer.style.overflow = "hidden";
    
    spriteElem = document.createElement("div");
    spriteElem.className = "t80-animation";
    spriteElem.style.backgroundImage = "url('" + window.currentT80Sprite + "')";
    spriteElem.style.backgroundPosition = "0px 0";
    
    frameContainer.appendChild(spriteElem);
    btrWrapper.appendChild(frameContainer);
    
    // å•Ÿå‹•T-80é–’ç½®å‹•ç•«
    startT80IdleAnimation(spriteElem);
  } else {
    // BTRå‹•ç•«
    spriteElem = document.createElement("div");
    spriteElem.className = "btr-animation";
    spriteElem.style.backgroundImage = "url('" + window.currentBtrSprite + "')";
    btrWrapper.appendChild(spriteElem);
  }
  
  selfAnim.appendChild(btrWrapper);
  
  // è¨­ç½®BTRæ´»èºæ¨™å¿—
  battleBTRActive = true;
  
  // å•Ÿå‹•ç‰¹æ®Šæ”»æ“Š - æ¯5ç§’æ”»æ“Šä¸€æ¬¡
  startBtrSpecialAttack();
  
  if (useT80) {
    setTimeout(() => {
      triggerT80Cannon(spriteElem);
    }, 1000);
  }
  
  // 10ç§’å¾Œæ¸…ç†
  setTimeout(() => {
    battleBTRActive = false;
    
    if (selfAnim.contains(btrWrapper)) {
      selfAnim.removeChild(btrWrapper);
    }
    
    if (t80IdleInterval) {
      clearInterval(t80IdleInterval);
      t80IdleInterval = null;
    }
    
    if (battleBTRInterval) {
      clearInterval(battleBTRInterval);
      battleBTRInterval = null;
    }
    
  }, 10000);
  
  // åˆä½œæ¨¡å¼æ™‚é€šçŸ¥ä¼™ä¼´
  if (pveMode === 'coop' && currentBattleRoomRef) {
    currentBattleRoomRef.child('events').push({
      type: 'btrSupport',
      btrType: battleBTRType,
      sender: window.myRole,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });
  }
}

// å•Ÿå‹•T80é–’ç½®å‹•ç•«
function startT80IdleAnimation(spriteElem) {
  if (!spriteElem) return;
  
  // æ¸…é™¤ç¾æœ‰çš„é–’ç½®è¨ˆæ™‚å™¨
  if (t80IdleInterval) {
    clearInterval(t80IdleInterval);
  }
  
  // åˆå§‹è¨­ç‚ºç¬¬1å¹€
  spriteElem.style.backgroundPosition = "0px 0";
  
  // ä½¿ç”¨èˆ‡PVPæ¨¡å¼ç›¸åŒçš„å‹•ç•«é‚è¼¯
  let t80IdleToggle = false;
  t80IdleInterval = setInterval(() => {
    t80IdleToggle = !t80IdleToggle;
    spriteElem.style.backgroundPosition = t80IdleToggle ? "-1440px 0" : "0px 0";
  }, 250);
}

// è§¸ç™¼T80é–‹ç‚®å‹•ç•«
function triggerT80Cannon(spriteElem) {
  if (!spriteElem || !spriteElem.parentNode || t80CannonOnCooldown) return;
  
  // è¨­ç½®å†·å»æ¨™å¿—
  t80CannonOnCooldown = true;
  
  // æš«åœé–’ç½®å‹•ç•«
  if (t80IdleInterval) {
    clearInterval(t80IdleInterval);
    t80IdleInterval = null;
  }
  
  // æ’­æ”¾å®Œæ•´é–‹ç‚®å‹•ç•«åºåˆ—
  spriteElem.style.backgroundPosition = "0px 0"; // frame1
  setTimeout(() => { spriteElem.style.backgroundPosition = "-480px 0"; }, 250); // frame2
  setTimeout(() => { spriteElem.style.backgroundPosition = "-960px 0"; }, 500); // frame3
  setTimeout(() => { spriteElem.style.backgroundPosition = "-1440px 0"; }, 750); // frame4
  
  // 1ç§’å¾Œæ¢å¾©é–’ç½®å‹•ç•«
  setTimeout(() => {
    if (spriteElem && spriteElem.parentNode) {
      spriteElem.style.backgroundPosition = "0px 0";
      startT80IdleAnimation(spriteElem);
    }
  }, 1000);
  
  // 4.25ç§’å¾Œå…è¨±å†æ¬¡é–‹ç‚®
  setTimeout(() => {
    t80CannonOnCooldown = false;
    // å¦‚æœBTRä»ç„¶æ´»èºï¼Œä¸”å…ƒç´ å­˜åœ¨ï¼Œå†æ¬¡é–‹ç‚®
    if (battleBTRActive && spriteElem && spriteElem.parentNode) {
      triggerT80Cannon(spriteElem);
    }
  }, 4250);
}

// å•Ÿå‹•BTRç‰¹æ®Šæ”»æ“Š
function startBtrSpecialAttack() {
  if (pveEnded || playerIsDown) return;
  if (battleBTRInterval) clearInterval(battleBTRInterval);
  
  // ç«‹å³åŸ·è¡Œç¬¬ä¸€æ¬¡æ”»æ“Š
  triggerBtrSpecialAttack();
  
  // ä¹‹å¾Œæ¯5ç§’åŸ·è¡Œä¸€æ¬¡
  battleBTRInterval = setInterval(() => {
    if (!pveEnded && !playerIsDown && battleBTRActive) {
      triggerBtrSpecialAttack();
    }
  }, 5000);
}

// åŸ·è¡ŒBTRç‰¹æ®Šæ”»æ“Š
function triggerBtrSpecialAttack() {
  if (pveEnded || !battleBTRActive) return;
  
  // å¾gameStateç²å–ä¸­å¿ƒå»ºç¯‰ç­‰ç´šè¨ˆç®—å‘½ä¸­ç‡
  let centerLevel = 1;
  try {
    const centerBuilding = gameState.buildings.find(b => 
      b && b.type.toLowerCase() === "center"
    );
    if (centerBuilding) {
      centerLevel = centerBuilding.level || 1;
    }
  } catch (error) {
    centerLevel = 1;
  }
  
  // èˆ‡PVPæ¨¡å¼ä½¿ç”¨ç›¸åŒçš„å‘½ä¸­ç‡è¨ˆç®—
  const baseHitChance = 40;
  const hitChanceVal = Math.min(baseHitChance + centerLevel * 0.5, 85);
  
  // è¨ˆç®—å‚·å®³
  const hitRoll = Math.random() * 100;
  const baseDamage = battleBTRType === "t80" ? 
    Math.floor(Math.random() * 20) + 15 :  // T-80ä¼¤å®³15-35
    Math.floor(Math.random() * 15) + 10;   // BTRä¼¤å®³10-25
  
  // è®€å–è£ç”²è»Šåº«ç­‰ç´šè¨ˆç®—åŠ æˆ
  let tractorLevel = 0;
  try {
    const tractor = gameState.buildings.find(b => 
      b && b.type.toLowerCase() === "armoredgarage"
    );
    if (tractor) {
      tractorLevel = tractor.level;
    }
  } catch (error) {
    tractorLevel = 0;
  }
  
  // æ¯ç´š0.5%çš„åŠ æˆ
  const multiplier = 1 + tractorLevel * 0.005;
  const damage = Math.round(baseDamage * multiplier);
  
  // å‘½ä¸­åˆ¤å®š
  const hitSuccess = hitRoll < hitChanceVal;
  
  // ç²å–æ”»æ“ŠçŸ­èª
  let type = battleBTRType === "t80" ? "t80" : "btr";
  let phrase = pveAttackPhrases[type][Math.floor(Math.random() * pveAttackPhrases[type].length)];
  
  if (hitSuccess) {
    // å‘½ä¸­
    appendBattleLogEntry({
      sender: window.myUid,
      senderRole: window.myRole,
      message: `æ´¾é£çš„ ${phrase}ï¼ˆå‘½ä¸­ï¼‰ï¼Œ${bossConfigs[selectedBoss].name} å—åˆ° ${damage} é»å‚·å®³`,
      timestamp: Date.now(),
      targetType: "boss",
      battleMode: "pve"
    });
    
    // æ›´æ–°BOSSç”Ÿå‘½å€¼
    if (window.myRole === "userA") {
      // æ›´æ–°BOSSç”Ÿå‘½å€¼
      bossHp = Math.max(0, bossHp - damage);
      totalPlayerDamage += damage;
      
      // åŒæ­¥åˆ°Firebase
      if (currentBattleRoomRef) {
        currentBattleRoomRef.update({ 
          bossHealth: bossHp,
          lastDamageBy: "userA_btr",
          lastDamageAmount: damage
        });
      }
    
    // æª¢æŸ¥BOSSæ˜¯å¦è¢«æ“Šæ•—
   if (bossHp <= 0) {
        endPveBattle(true);
      }
    } else {
      // userBåªæ›´æ–°è‡ªå·±çš„ä¼¤å®³ç»Ÿè®¡
      totalPlayerDamage += damage;
    }
  } else {
    // æœªå‘½ä¸­
    appendBattleLogEntry({
      sender: window.myUid,
      senderRole: window.myRole,
      message: `æ´¾é£çš„ ${phrase}ï¼ˆæœªå‘½ä¸­ï¼‰`,
      timestamp: Date.now(),
      targetType: "boss",
      battleMode: "pve"
    });
  }
  
  // æ›´æ–°ç”Ÿå‘½å€¼é¡¯ç¤º
  updateHealthDisplay();
}

// ç©å®¶å€’åœ°è™•ç†
function handlePlayerDown() {
  if (playerIsDown) return; // é˜²æ­¢é‡å¤å¤„ç†
  playerIsDown = true;
  updatePlayerSpriteToDead(window.myRole);
  // åŒæ­¥åˆ°Firebase
  if (currentBattleRoomRef) {
    currentBattleRoomRef.child(window.myRole).update({
      isDown: true
    });
  }
  // å–®äººæ¨¡å¼ç›´æ¥æˆ°æ•—
  if (pveMode === 'solo') {
    endPveBattle(false);
  }
}

// çµæŸPVEæˆ°é¬¥
function endPveBattle(isVictory) {
  if (pveEnded) return;
  pveEnded = true;
  
  // åœæ­¢æ‰€æœ‰è¨ˆæ™‚å™¨
  clearCombatTimers();
  
  // çµç®—çå‹µ
  const bossConfig = bossConfigs[selectedBoss];
  let rewardRatio = isVictory ? 1.0 : Math.min(totalPlayerDamage / bossMaxHp, 0.75);
  
  // è¨ˆç®—æœ€çµ‚çå‹µ
  const rewards = {};
  for (const resource in bossConfig.rewards) {
    rewards[resource] = Math.round(bossConfig.rewards[resource] * rewardRatio);
  }
  
  // é¡¯ç¤ºçµæœ
  const damagePercentage = Math.round((totalPlayerDamage / bossMaxHp) * 100);
  
  let resultMessage = `æˆ°é¬¥${isVictory ? 'å‹åˆ©' : 'å¤±æ•—'}ï¼\n`;
  resultMessage += `BOSS: ${bossConfig.name}\n`;
  resultMessage += `é€ æˆå‚·å®³: ${totalPlayerDamage}/${bossMaxHp} (${damagePercentage}%)\n\n`;
  resultMessage += `çå‹µè³‡æº:\n`;
  resultMessage += `é£Ÿç‰©: +${rewards.food}\n`;
  resultMessage += `ææ–™: +${rewards.materials}\n`;
  resultMessage += `æ­¦å™¨: +${rewards.weapons}\n`;
  resultMessage += `ç§‘æŠ€: +${rewards.tech}\n`;
  
  appendBattleLogEntry({
    sender: "ç³»çµ±",
    senderRole: "system",
    message: resultMessage,
    battleMode: "pve"
  });
  
   // æ·»åŠ çå‹µè³‡æº
  try {
    if (gameState && gameState.resources) {
      gameState.resources.food += rewards.food;
      gameState.resources.materials += rewards.materials;
      gameState.resources.weapons += rewards.weapons;
      gameState.resources.tech += rewards.tech;
      
      // ä¿å­˜éŠæˆ²ç‹€æ…‹
      if (typeof saveGameState === 'function') {
        saveGameState();
      }
      if (typeof updateResourceDisplays === 'function') {
        updateResourceDisplays();
      }
    }
  } catch (e) {}
  
  // æ¨™è¨˜æˆ°é¬¥çµæŸ
  if (currentBattleRoomRef) {
    currentBattleRoomRef.update({
      status: 'ended',
      result: isVictory ? 'victory' : 'defeat',
      endTime: firebase.database.ServerValue.TIMESTAMP
    });
  }
}
async function exitPveBattle() {
  const pin = window.currentBattleRoom;
  if (!pin) return;
  const roomRef = firebase.database().ref(`pveBattles/${pin}`);

  // 1) å–æ¶ˆç›‘å¬
  roomRef.off();
  roomRef.child('log').off();
  roomRef.child('events').off();

  // 2) çœŸåˆ é™¤è‡ªå·± userA/userB èŠ‚ç‚¹
  await roomRef.child(window.myRole).remove();

  // 3) æ£€æŸ¥å‰©ä½™ç©å®¶ï¼Œè‹¥éƒ½ä¸å­˜åœ¨åˆ™åˆ æˆ¿é—´
  const snap = await roomRef.once('value');
  const data = snap.val() || {};
  if (!data.userA && !data.userB) {
    await roomRef.remove();
  }

  // 4) æœ¬åœ°æ¸…ç†
  clearCombatTimers();
  document.getElementById('battleOverlay').style.display = 'none';
  document.body.style.overflow = '';
  pveActive   = false;
  pveMatched  = false;
  pveEnded    = false;
  playerIsDown= false;
  window.currentBattleRoom = null;
  window.myRole            = null;
}


})();

	
	</script>
</body>
</html>
