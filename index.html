<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æœ«æ—¥æ§åˆ¶ä¸­å¿ƒ - é—œéµç‰ˆæœ¬æ“´å±•èª¿æ•´ç‰ˆ</title>
  <style>
    /* å½ˆçª—ç³»çµ± */
       .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: #2d2d2d;
      padding: 2rem;
      border-radius: 12px;
      width: min(90vw, 500px);
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
	/* æ”¶è—å½ˆçª—ç¹¼æ‰¿ç¾æœ‰ modal çš„æ¨£å¼ï¼Œè‹¥éœ€è¦èˆ‡è¡Œå‹•æ—¥èªŒå€é‡åˆï¼Œå¯åŠ å…¥å¦‚ä¸‹è¨­å®š */
	#favoritesModal .modal-content,
	#productionCollectionModal .modal-content {
	  width: 90%;         /* æˆ–ç›´æ¥èˆ‡è¡Œå‹•æ—¥èªŒå€åŒå¯¬ */
	  max-width: 600px;    /* æ ¹æ“šè¡Œå‹•æ—¥èªŒæ‰€åœ¨å€åŸŸèª¿æ•´ */
	}
	html {
	  touch-action: manipulation;
	}
	html, body {
	  overscroll-behavior: none;
	}
	


    :root {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --border-color: #4a4a4a;
      --hover-bg: #333333;
       /* åŸºç¡€çº§åˆ« - æå‡äº®åº¦å’Œé¥±å’Œåº¦ */
	  --junk: #A1887F;     /* äº®æ£•è‰² (åŸè‰²äº®åº¦â†‘35%) */
	  --old: #BCAAA4;      /* æµ…ç°æ£• (åŸè‰²äº®åº¦â†‘30%) */
	  --damaged: #D7CCC8;  /* æµ…ç±³ç° (åŸè‰²äº®åº¦â†‘25%) */
	  
	  /* æ™®é€šçº§åˆ« - å¢å¼ºå¯¹æ¯”åº¦ */
	  --common: #BDBDBD;   /* äº®ç°è‰² (åŸè‰²äº®åº¦â†‘30%) */
	  --decent: #66BB6A;   /* é²œç»¿è‰² (åŸè‰²äº®åº¦â†‘15%) */
	  --sealed: #26A69A;   /* äº®é’ç»¿ (åŸè‰²äº®åº¦â†‘20%) */
	  
	  /* ç²¾è‰¯çº§åˆ« - ä¿æŒä¸“ä¸šæ„Ÿä½†æäº® */
	  --selected: #42A5F5; /* äº®è“è‰² (åŸè‰²äº®åº¦â†‘15%) */
	  --tested: #5C6BC0;   /* æµ…ç¾¤é’ (åŸè‰²äº®åº¦â†‘10%) */
	  
	  /* é«˜çº§åˆ« - å¢å¼ºå‘å…‰æ•ˆæœ */
	  --rare: #AB47BC;     /* äº®ç´«è‰² (åŸè‰²äº®åº¦â†‘10%) */
	  --epic: #EC407A;     /* å“çº¢è‰² (åŸè‰²äº®åº¦â†‘10%) */
	  
	  /* é¡¶çº§çº§åˆ« - ä¿æŒé†’ç›®ç‰¹æ€§ */
	  --legendary: #FF9800; /* äº®æ©™è‰² (åŸè‰²äº®åº¦â†‘5%) */
	  --divine: #FFEE58;    /* è§å…‰é»„ (åŸè‰²äº®åº¦â†‘15%) */
      --danger: #d32f2f;
      --warning: #fbc02d;
      --efficiency-green: #66BB6A;
      --production-blue: #42A5F5;
    }
	.log-entry.zombie-event {
	  background-color: rgba(255, 69, 0, 0.2); /* åŠé€æ˜æ©™ç´…è‰²èƒŒæ™¯ */
	  color: #DAA520; /* Goldenrodï¼Œè¼ƒæŸ”å’Œçš„é‡‘è‰² */
	  font-weight: bold;
	  border-left: 4px solid #ff4500; /* ç”¨ä¸€æ¢é†’ç›®çš„é‚Šæ¡†åšå¼·èª¿ */
	}

    /* åŸºç¤å¸ƒå±€ */
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
      min-height: 100vh;
    }
    .container {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 25px;
      max-width: 1400px;
      margin: 0 auto;
    }
    /* è³‡æºå„€è¡¨ç›¤ */
	.main-grid-container {
	  display: grid;
	  grid-template-columns: 1fr 1fr;         /* å…©åˆ—ç­‰åˆ† */
	  grid-template-rows: auto auto auto;      /* ä¸‰è¡Œï¼Œç¬¬äºŒè¡Œçš„é«˜åº¦è‡ªå‹•èª¿æ•´ï¼Œç¬¬ä¸€è¡Œèˆ‡ç¬¬äºŒè¡Œä¿æŒç­‰é«˜ */
	  gap: 20px;
	  margin-top: 20px;
	}
	.grid-container {
	  display: grid;
	  grid-template-columns: 1fr 1fr;
	  grid-auto-rows: minmax(300px, auto);
	  gap: 20px;
	  margin-top: 20px;
	}
	.grid-item {
	  background: #262626;
	  padding: 1rem;
	  border-radius: 12px;
	  border: 1px solid var(--border-color);
	  box-sizing: border-box;
	}
	/* ç¬¬ä¸€è¡Œèˆ‡ç¬¬äºŒè¡Œçš„ grid-item  */
	#resourceDashboard,
	#zombieCommand,
	#explorationLogContainer,
	#productionLogContainer {
	  position: relative;
	  /* å›ºå®šé«˜åº¦ï¼ˆæ ¹æ“šéœ€æ±‚èª¿æ•´æ•¸å€¼ï¼‰ï¼Œä¾‹å¦‚ 350px */
	  height: 600px;
	  overflow: hidden;  /* è‹¥å…§å®¹è¶…å‡ºï¼Œå¯è‡ªè¡ŒåŠ å…¥ overflow è¨­å®š */
	}
	/* åŸºåœ°å»ºè¨­å®¹å™¨ï¼Œè·¨å…©åˆ— */
	.building-system-container {
	  position: relative;
	  grid-column: 1 / span 2; /* è·¨è¶Šç¬¬1-2åˆ— */
	  /* å›ºå®šé«˜åº¦ï¼Œä¾‹å¦‚ 300pxï¼Œå¯æ ¹æ“šéœ€è¦èª¿æ•´ */
	  height: 600px;
	  overflow: auto;
	}
    .dashboard {
      background: #262626;
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      height: fit-content;
    }
    .resource-group {
      margin-bottom: 1rem;
      background: #2d2d2d;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .resource-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      cursor: pointer;
      transition: background 0.3s ease;
      background: #373737;
    }
    .resource-header:hover {
      background: var(--hover-bg);
    }
    .resource-details {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .resource-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 15px;
      font-size: 0.9em;
      background: linear-gradient(to right, #2d2d2d 50%, #373737);
      border-top: 1px solid var(--border-color);
    }
    /* éƒ¨é–€ç®¡ç†ç•Œé¢ */
    .operations-panel {
      display: flex;
      flex-direction: column;
	  gap: 10px;          /* å¡ç‰‡é–“è· */
	  height: 100%;       /* æˆ–æŒ‡å®šå›ºå®šé«˜åº¦ï¼Œå¦‚350px */
      box-sizing: border-box;
    }
    .department-card {
	  flex: 1;
      background: #262626;
      padding: 0.5rem;
      border-radius: 5px;
	  height:80px
    }
	.dept-header h3 {
	  font-size: 1em;        /* èª¿å°æ¨™é¡Œå­—é«” */
	  margin: 0;
	  line-height: 1.2;
	}
    .department {
      background: #2d2d2d;
      border-left: 4px solid;
      border-radius: 8px;
      margin: 1rem 0;
      padding: 1rem;
      transition: transform 0.2s;
    }
    .department:hover {
      transform: translateX(5px);
    }
    #exploration { border-color: var(--danger); }
    #farming { border-color: var(--uncommon); }
    #recycling { border-color: var(--warning); }
    #research { border-color: var(--rare); }
    .zombie-control {
      display: flex;
	  justify-content: space-evenly;
      align-items: center;
      gap: 10px;
	  padding: 0 10px;
      margin-top: 12px;
    }
    .zombie-btn {
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 50%;
      background: #404040;
      color: white;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s;
    }
    .zombie-btn:hover {
      background: #4a4a4a;
      transform: scale(1.1);
    }
	.large-btn {
	  font-size: 1.2em;
	  padding: 0.6em 1em;
	}

    /* å»ºç¯‰ç³»çµ± */
    .building-system {
      background: #262626;
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }
    .construction-grid {
      display: grid;
      grid-template-columns: repeat(3, 120px);
      gap: 15px;
      justify-content: center;
    }
    .tile {
      width: 120px;
      height: 120px;
      background: #2d2d2d;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      position: relative;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tile:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .upgradable {
      border-color: var(--uncommon);
      animation: pulse-border 2s infinite;
    }
    .building-icon {
      font-size: 2.5rem;
      margin-bottom: 8px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }
    .building-info { text-align: center; }
    .building-name {
      font-weight: 500;
      font-size: 0.9em;
    }
    .building-level {
      font-size: 0.8em;
      color: var(--common);
    }
    .upgrade-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--uncommon);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      box-shadow: 0 0 10px var(--uncommon);
    }
	 .build-box {
	  border: 1px solid var(--border-color);  /* å§‹çµ‚é¡¯ç¤ºé‚Šæ¡† */
	  background-color: #2d2d2d;
	  border-radius: 8px;
	  padding: 10px;
	  margin: 10px 0;
	  transition: background 0.2s;
	  cursor: pointer;
	}

	/* æ‡¸åœæ™‚åƒ…æ”¹è®ŠèƒŒæ™¯è‰²ï¼Œä½†é‚Šæ¡†ä¿æŒä¸è®Š */
	.build-box:hover {
	  background-color: #3a3a3a;
	}

	.build-top {
	  display: flex;
	  align-items: center;
	  gap: 10px;
	  margin-bottom: 5px;
	}

	.build-icon {
	  font-size: 2rem;
	  width: 50px;
	  text-align: center;
	}

	.build-name {
	  font-size: 1.1rem;
	  font-weight: bold;
	}


	.cost-item {
	  display: inline-block;
	  margin-right: 8px;
	}
	
	
	/* å›ºå®šæ¯å€‹å»ºé€ å¡ç‰‡é«˜åº¦ */
	.build-box {
	  height: 150px;
	  display: flex;
	  flex-direction: column;
	  border: 1px solid var(--border-color);
	  border-radius: 8px;
	  margin-bottom: 10px;
	  padding: 10px;
	  cursor: pointer;
	}

	/* ä¸ŠåŠéƒ¨åˆ†å®¹å™¨ï¼Œä½”æ»¿å‰©é¤˜ç©ºé–“ä¸¦å‚ç›´å±…ä¸­ */
	.build-top-container {
	  flex: 1;
	  display: flex;
	  align-items: center;  /* å‚ç›´å±…ä¸­ */
	  justify-content: center;
	}

	/* ä¸‹æ–¹è³‡æºä¿¡æ¯éƒ¨åˆ†ï¼Œä¸è®Š */
	.build-resources {
	  text-align: center;
	  margin-top: 5px;
	}

	/* å·¦å³å®¹å™¨ï¼Œå…§éƒ¨åˆ†æ¬„ */
	.build-row {
	  display: flex;
	  width: 100%;
	}

	/* å·¦é‚Šï¼šå»ºç¯‰åœ–ç¤ºèˆ‡åç¨±ï¼Œ50% å¯¬åº¦ï¼Œå·¦å°é½Šï¼Œå³å´æœ‰åˆ†ç•Œç·š */
	.build-left {
	  flex: 1;
	  text-align: left;
	  border-right: 1px solid var(--border-color);
	  padding-right: 10px;
	}

	/* å³é‚Šï¼šåŠ æˆæè¿°ï¼Œ50% å¯¬åº¦ï¼Œå·¦å°é½Š */
	.build-right {
	  flex: 1;
	  text-align: left;
	  padding-left: 10px;
	}
	.building-info {
	  display: flex;
	  flex-direction: column;
	  justify-content: center; /* å‚ç›´å±…ä¸­ */
	  text-align: center;
	}




	
    /* äº‹ä»¶æ—¥èªŒç³»çµ± */
    .log {
      height: 320px;
      background: #1f1f1f;
      border-radius: 8px;
      padding: 15px;
      margin-top: 1.5rem;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border-color) transparent;
    }
    .log-entry {
      padding: 10px;
      margin: 8px 0;
      background: #2d2d2d;
      border-left: 3px solid;
      border-radius: 4px;
      animation: fadeIn 0.4s ease;
      display: flex;
      align-items: baseline;
      gap: 8px;
      font-size: 0.9em;
    }
    .log-entry::before {
      content: "â€¢";
      color: currentColor;
      font-weight: bold;
    }
	
	}
    /* ç¨€æœ‰åº¦é¡è‰² */
    /* åŸºç¡€çº§åˆ« */
	.junk { color: var(--junk); }
	.old { color: var(--old); }
	.damaged { color: var(--damaged); }

	/* æ™®é€šçº§åˆ« */
	.common { color: var(--common); }
	.decent { color: var(--decent); }
	.sealed { 
	  color: var(--sealed);
	  animation: pulse 1.5s infinite;
	}

	/* ç²¾è‰¯çº§åˆ« */
	.selected { 
	  color: var(--selected);
	  text-shadow: 0 0 5px rgba(30, 136, 229, 0.5);
	}
	.tested {
	  color: var(--tested);
	  animation: float 2s ease-in-out infinite;
	}

	/* é«˜çº§åˆ« */
	.rare {
	  color: var(--rare);
	  animation: rare-glow 2s infinite alternate;
	}
	.epic {
	  color: var(--epic);
	  text-shadow: 0 0 8px rgba(142, 36, 170, 0.7);
	  animation: epic-pulse 1.5s infinite;
	}

	/* é¡¶çº§çº§åˆ« */
	.legendary {
	  color: var(--legendary);
	  animation: 
		legendary-glow 2s infinite alternate,
		shake 0.5s infinite alternate;
	}
	.divine {
	  color: var(--divine);
	  text-shadow: 
		0 0 10px rgba(255, 214, 0, 0.8),
		0 0 20px rgba(255, 214, 0, 0.4);
	  animation: 
		divine-shine 3s infinite alternate;
	}

	/* åŠ¨ç”»å®šä¹‰ */
	@keyframes pulse {
	  0%, 100% { opacity: 0.9; }
	  50% { opacity: 1; transform: scale(1.02); }
	}
	@keyframes float {
	  0%, 100% { transform: translateY(0); }
	  50% { transform: translateY(-3px); }
	}
	@keyframes rare-glow {
	  from { text-shadow: 0 0 5px rgba(142, 36, 170, 0.3); }
	  to { text-shadow: 0 0 15px rgba(142, 36, 170, 0.7); }
	}
	@keyframes epic-pulse {
	  0%, 100% { transform: scale(1); }
	  50% { transform: scale(1.05); }
	}
	@keyframes legendary-glow {
	  from { text-shadow: 0 0 5px rgba(245, 124, 0, 0.5); }
	  to { text-shadow: 0 0 20px rgba(245, 124, 0, 0.9); }
	}
	@keyframes shake {
	  0% { transform: translateX(-1px); }
	  100% { transform: translateX(1px); }
	}
	@keyframes divine-shine {
	  from { 
		filter: brightness(1);
		text-shadow: 0 0 10px rgba(255, 214, 0, 0.8);
	  }
	  to { 
		filter: brightness(1.2);
		text-shadow: 0 0 25px rgba(255, 214, 0, 1);
	  }
	}
    }
    
  
    @keyframes pulse-border {
      0% { border-color: var(--uncommon); }
      50% { border-color: rgba(76,175,80,0.5); }
      100% { border-color: var(--uncommon); }
    }
    @keyframes resource-glow {
      0% { box-shadow: 0 0 5px currentColor; }
      50% { box-shadow: 0 0 15px currentColor; }
      100% { box-shadow: 0 0 5px currentColor; }
    }
    @media (max-width: 768px) {
      .container { grid-template-columns: 1fr; padding: 10px; }
      .construction-grid { grid-template-columns: repeat(3, 1fr); }
      .tile { width: 100%; height: 100px; }
      .zombie-control { flex-wrap: wrap; }
	}
    @media (max-width: 480px) {
      .building-system { padding: 1rem; }
      .construction-grid { grid-template-columns: repeat(2, 1fr); }
    }
    .efficiency-badge {
      color: var(--efficiency-green);
      font-size: 0.8em;
      padding: 2px 8px;
      border-radius: 4px;
      background: rgba(76,175,80,0.1);
    }
    .production-rate {
      color: var(--production-blue);
      font-size: 0.9em;
      margin-top: 5px;
    }
    .pending-zombies {
      color: var(--warning);
      animation: resource-glow 1.5s infinite;
    }
  </style>
</head>
<body>
  <div class="main-grid-container">
   <!-- ä¸Šæ’ï¼šå·¦ - æœ«æ—¥æŒ‡æ®ä¸­å¿ƒï¼›å³ - å°¸ç¾¤æŒ‡æ®ç³»çµ± -->
   <div class="grid-item" id="resourceDashboard">
    <!-- å·¦å´è³‡æºé¢æ¿ -->
    <div class="dashboard">
      <h2 class="section-title">ğŸšï¸ æœ«æ—¥æŒ‡æ®ä¸­å¿ƒ</h2>
      <div class="resource-panel">
        <div class="resource-group">
          <div class="resource-header" onclick="toggleResource('food')">
            <span class="resource-icon">ğŸ–</span>
            <span class="resource-name">é£Ÿç‰©</span>
            <span class="resource-count" id="foodCount">0</span>
          </div>
          <div class="resource-details" id="foodDetails"></div>
        </div>
        <div class="resource-group">
          <div class="resource-header" onclick="toggleResource('materials')">
            <span class="resource-icon">ğŸ”©</span>
            <span class="resource-name">ææ–™</span>
            <span class="resource-count" id="materialsCount">0</span>
          </div>
          <div class="resource-details" id="materialsDetails"></div>
        </div>
        <div class="resource-group">
          <div class="resource-header" onclick="toggleResource('weapons')">
            <span class="resource-icon">ğŸ”«</span>
            <span class="resource-name">æ­¦å™¨</span>
            <span class="resource-count" id="weaponsCount">0</span>
          </div>
          <div class="resource-details" id="weaponsDetails"></div>
        </div>
        <div class="resource-group">
          <div class="resource-header" onclick="toggleResource('tech')">
            <span class="resource-icon">ğŸ’¾</span>
            <span class="resource-name">ç§‘æŠ€</span>
            <span class="resource-count" id="techCount">0</span>
          </div>
          <div class="resource-details" id="techDetails"></div>
        </div>
      </div>
	</div>
   </div>	
	   <div class="grid-item" id="zombieCommand">
		<!-- å°¸ç¾¤æŒ‡æ®ç³»çµ±ï¼šæ“ä½œæ§åˆ¶å€åŸŸ -->
		<div class="operations-panel">
		  <h2 class="section-title">ğŸ§Ÿ å°¸ç¾¤æŒ‡æ®ç³»çµ±</h2>
		  <div class="production-grid">
			<div class="department-card" id="exploration">
			  <div class="dept-header">
				<h3>ğŸ” åµå¯Ÿè»åœ˜</h3>
				<div class="efficiency-badge" id="exploreEfficiency">æ•ˆç‡: 100%</div>
			  </div>
			  <div class="zombie-control">
				<button class="zombie-btn" onclick="adjustZombies('exploration', -1)">âˆ’</button>
				<span class="zombie-count" id="explorationCount">0</span>
				<button class="zombie-btn" onclick="adjustZombies('exploration', 1)">+</button>
			  </div>
			</div>
			  <div class="department-card" id="farming">
				<div class="dept-header">
				  <h3>ğŸŒ¾ ç¨®æ¤éƒ¨é–€</h3>
				  <div class="efficiency-badge" id="farmEfficiency">+0%</div>
				</div>
				<div class="zombie-control">
				  <button class="zombie-btn" onclick="adjustZombies('farming', -1)">âˆ’</button>
				  <span class="zombie-count" id="farmingCount">0</span>
				  <button class="zombie-btn" onclick="adjustZombies('farming', 1)">+</button>
				</div>
			  </div>
			  <div class="department-card" id="recycling">
				<div class="dept-header">
				  <h3>â™» å›æ”¶å·¥å» </h3>
				  <div class="efficiency-badge" id="recycleEfficiency">+0%</div>
				</div>
				<div class="zombie-control">
				  <button class="zombie-btn" onclick="adjustZombies('recycling', -1)">âˆ’</button>
				  <span class="zombie-count" id="recyclingCount">0</span>
				  <button class="zombie-btn" onclick="adjustZombies('recycling', 1)">+</button>
				</div>
			  </div>
			  <div class="department-card" id="research">
				<div class="dept-header">
				  <h3>ğŸ”¬ ç§‘ç ”ä¸­å¿ƒ</h3>
				  <div class="efficiency-badge" id="researchEfficiency">+0%</div>
				</div>
				<div class="zombie-control">
				  <button class="zombie-btn" onclick="adjustZombies('research', -1)">âˆ’</button>
				  <span class="zombie-count" id="researchCount">0</span>
				  <button class="zombie-btn" onclick="adjustZombies('research', 1)">+</button>
				</div>
			  </div>
			</div>
		 </div>
	  </div>
      <!-- ä¸‹æ’ï¼šå·¦ - è¡Œå‹•æ—¥èªŒï¼›å³ - ç”Ÿç”¢æ—¥èªŒ -->
	  <div class="grid-item" id="explorationLogContainer">
		<h3 class="log-title">
		  ğŸ“œ è¡Œå‹•æ—¥èªŒ
		 <!-- åœ¨æ¨™é¡Œå³å´åŠ å…¥æ”¶è—æŒ‰éˆ• -->
		 <button id="favoritesBtn">æ”¶è—</button>
		</h3>
		<div class="log-header">
          <span class="zombie-status">å¾…åˆ†é…åƒµå°¸: <span id="pendingZombies">0</span></span>
          <span class="total-zombies">ç¸½æ•¸: <span id="totalZombies">10</span></span>
        </div>
		<div class="log" id="explorationLog">
		  <div class="log-entry uncommon">âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆ</div>
		</div>
	 </div>
	  <div class="grid-item" id="productionLogContainer">
	   <h3 class="log-title">ğŸ›  ç”Ÿç”¢æ—¥èªŒ
	   <button id="productionFavoritesBtn" class="modal-btn" onclick="showProductionCollection()">æ”¶è—</button>
	   </h3>
	   	<div id="timerContainer" class="timer-container">
          <span class="timer-label">ç”¨æ™‚</span>
          <span id="timerValue">00:00:00</span>
        </div>
	   <div class="log" id="productionLog">
		 <!-- ç”Ÿç”¢äº‹ä»¶å°‡åœ¨æ­¤é¡¯ç¤º -->
	   </div>
	 </div>
    <div class="grid-item building-system-container" id="buildingSystem">
      <div class="building-system">
        <h2 class="section-title">ğŸ—ï¸ åŸºåœ°å»ºè¨­</h2>
        <div class="construction-grid" id="buildingGrid">
          <!-- å‹•æ…‹ç”Ÿæˆçš„å»ºç¯‰æ ¼å­ -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- å»ºé€ å½ˆçª— -->
  <div id="buildModal" class="modal-overlay">
    <div class="modal-content">
      <h3>é¸æ“‡å»ºé€ é …ç›®</h3>
      <div class="build-options" id="buildOptions"></div>
    </div>
  </div>
  
 
  <!-- å‡ç´šå½ˆçª— -->
	<div id="upgradeModal" class="modal-overlay">
	  <div class="modal-content">
		<h3 id="upgradeTitle"></h3>
		<!-- ä¸ŠåŠéƒ¨åˆ†ï¼šé¡¯ç¤ºç•¶å‰åŠ æˆä¿¡æ¯èˆ‡å‡ç´šæ‰€éœ€è³‡æº -->
		<div id="upgradeInfo" style="white-space: pre-wrap; margin-bottom: 1em;"></div>
		<!-- ä¸‹åŠéƒ¨åˆ†ï¼šä½¿ç”¨ Flex å°é½Šå…©å€‹æŒ‰éµ -->
		<div class="button-row" style="display: flex; justify-content: space-between;">
		  <button id="confirmUpgradeBtn" class="modal-btn large-btn" onclick="confirmUpgrade()" style="flex: 1; margin-right: 5px;">å‡ç´š</button>
		  <button id="demolishBtn" class="modal-btn large-btn" onclick="confirmBuildingRemoval(currentUpgradeIndex)" style="flex: 1; margin-left: 5px;">æ‹†é™¤</button>
		</div>
	  </div>
	</div>




  <!-- æ”¶è—å½ˆçª— -->
   <div id="favoritesModal" class="modal-overlay">
	 <div class="modal-content">
	 <h3 style="display: flex; justify-content: space-between; align-items: center;">æ”¶è—è¨˜éŒ„
	 <!-- æ–°å¢æ”¶è—å®Œæˆåº¦ -->
       <div id="collectionCompletion" style="display: inline-block; margin-left: 10px; font-weight: bold;"></div>
	 </h3>
	 <div class="collection-content" id="collectionContent">
		  <!-- æ”¶è—å…§å®¹å°‡åœ¨æ­¤å¡«å…… -->
	 </div>
	</div>
   </div>
   <div id="productionCollectionModal" class="modal-overlay">
    <div class="modal-content">
		<h3>ç”Ÿç”¢è¨˜éŒ„</h3>
		<div id="productionCollectionContent"></div>
	  </div>
	</div>

   
  <!-- å»ºç¯‰äº’å‹•å½ˆçª—ï¼ˆç®¡ç†å»ºç¯‰è³‡è¨Šï¼æ‹†é™¤ï¼‰ -->
	<div id="interactionModal" class="modal-overlay">
	  <div class="modal-content">
		<h3 id="interactionTitle">å»ºç¯‰ç®¡ç†</h3>
		<div id="interactionContent"></div>
	  </div>
	</div>
  <!-- çµæœæç¤ºå½ˆçª— -->
	<div id="resultModal" class="modal-overlay">
	  <div class="modal-content">
		<p id="resultMessage"></p>
		<button class="modal-btn" onclick="closeResultModal()">ç¢ºå®š</button>
	  </div>
	</div>



  
  <script>
    let ITEM_DATA = {
	  food: {
		names: ['ç½é ­é£Ÿå“', 'å£“ç¸®é¤…ä¹¾', 'è»ç”¨å£ç³§', 'è„«æ°´è”¬èœ', 'è‚‰é¡ç½é ­', 'æ°´æœä¹¾', 'èƒ½é‡æ£’', 'å³é£Ÿéº¥ç‰‡', 'å¥¶ç²‰', 'é€Ÿé£Ÿæ¹¯åŒ…', 'çœŸç©ºåŒ…è£ç±³', 'ä¹¾ç‡¥è±†é¡', 'å …æœæ··åˆç‰©', 'å·§å…‹åŠ›å¡Š', 'èœ‚èœœ', 'æœé†¬', 'é­šç½é ­', 'é†ƒè£½è‚‰é¡', 'ä¹¾ç‡¥éºµæ¢', 'é€Ÿé£Ÿé¦¬éˆ´è–¯æ³¥', 'å³é£Ÿç²¥', 'å’–å•¡ç²‰', 'èŒ¶åŒ…', 'ç³–', 'é¹½', 'é£Ÿç”¨æ²¹', 'èŠ±ç”Ÿé†¬', 'ä¹¾é…ª', 'é¤…ä¹¾', 'æ³¡éºµ', 'ä¹¾ç‡¥è˜‘è‡', 'é¢¨ä¹¾è‚‰æ¢', 'ç©€ç‰©æ£’', 'ä¹¾ç‡¥æ¹¯å¡Š', 'ç‡•éº¥ç‰‡', 'ç‰ç±³ç½é ­', 'ç•ªèŒ„ç½é ­', 'ç‡‰ç…®è±†ç½é ­', 'å£“ç¸®ä¹¾ç³§', 'é»‘ç³–', 'è‘¡è„ä¹¾', 'æ¤°å­ç²‰', 'èŠéº»ç³Š', 'é€Ÿé£Ÿè›‹èŠ±æ¹¯', 'ä¹¾ç‡¥æµ·å¸¶', 'å‡ä¹¾æ°´æœ', 'ç‰›è‚‰ä¹¾', 'è±¬è‚‰é¬†', 'å³é£Ÿå¸ƒä¸', 'ä¹¾ç‡¥é¦¬éˆ´è–¯', 'é€Ÿé£Ÿå’–å“©', 'ç½è£ç…‰ä¹³', 'ä¹¾ç‡¥é¦™è…¸', 'é€Ÿé£Ÿå‘³å™Œæ¹¯', 'ç½è£ç‰ç±³æ¿ƒæ¹¯', 'ä¹¾ç‡¥å—ç“œ', 'é€Ÿé£Ÿç‡‰é£¯', 'ç½è£ç‡‰è‚‰', 'ä¹¾ç‡¥æ´‹è”¥', 'é€Ÿé£Ÿé¦¬éˆ´è–¯é¤…', 'ç½è£è”¬èœæ¹¯', 'ä¹¾ç‡¥èƒ¡è˜¿è””', 'é€Ÿé£Ÿç¾©å¤§åˆ©éºµ', 'ç½è£é®ªé­š', 'ä¹¾ç‡¥é«˜éº—èœ', 'é€Ÿé£Ÿæ¿ƒæ¹¯', 'ç½è£ç´…è±†', 'ä¹¾ç‡¥é’è±†', 'é€Ÿé£Ÿç‚’é£¯', 'ç½è£æ²™ä¸é­š', 'ä¹¾ç‡¥è èœ', 'é€Ÿé£Ÿç‰ç±³ç²¥', 'ç½è£å¥¶æ²¹è˜‘è‡æ¹¯', 'ä¹¾ç‡¥ç”œæ¤’', 'é€Ÿé£Ÿç‡‰è”¬èœ', 'ç½è£é›è‚‰', 'ä¹¾ç‡¥è˜‹æœ', 'é€Ÿé£Ÿå—ç“œæ¹¯', 'ç½è£ç‰›è‚‰é†¬', 'ä¹¾ç‡¥é¦™è•‰ç‰‡', 'é€Ÿé£Ÿé¦¬éˆ´è–¯æ²™æ‹‰', 'ç½è£ç¾Šè‚‰', 'ä¹¾ç‡¥é³³æ¢¨', 'é€Ÿé£Ÿè”¬èœæ³¥', 'ç½è£æµ·é®®æ¿ƒæ¹¯', 'ä¹¾ç‡¥è—è“', 'é€Ÿé£Ÿç‡‰ç‰›è‚‰', 'ç½è£ç«è…¿', 'ä¹¾ç‡¥èŠ’æœ', 'é€Ÿé£Ÿç‡‰è±†', 'ç½è£å¥¶æ²¹ç‰ç±³', 'ä¹¾ç‡¥è‰è“', 'é€Ÿé£Ÿç‡‰é›', 'ç½è£ç•ªèŒ„é†¬', 'ä¹¾ç‡¥å¥‡ç•°æœ', 'é€Ÿé£Ÿç‡‰é­š', 'ç½è£å¥¶æ²¹å—ç“œæ¹¯', 'ä¹¾ç‡¥è¦†ç›†å­', 'é€Ÿé£Ÿç‡‰é¦¬éˆ´è–¯'],
		modifiers: [
		   { name: 'å†·å‡ä¹¾ç‡¥çš„', effect: 1.3 },   // ä¿å­˜æŠ€è¡“
		   { name: 'è¼»å°„è®Šç•°çš„', effect: 0.8 },  // ç’°å¢ƒå½±éŸ¿
		   { name: 'è»ç”¨å¯†å°çš„', effect: 1.5 },  // åŒ…è£è¦æ ¼
		   { name: 'éƒ¨åˆ†éœ‰è®Šçš„', effect: 0.7 },  // ç‰©ç†ç‹€æ…‹
		   { name: 'ç‡Ÿé¤Šå¼·åŒ–çš„', effect: 1.4 },   // åŠŸèƒ½å±¬æ€§
		   { name: 'é‡æˆ°çƒ¹è£½çš„', effect: 1.1 },  // è£½ä½œæ–¹å¼
		   { name: 'é»ç¨ æ¶²åŒ–çš„', effect: 0.6 },  // è®Šè³ªç‹€æ…‹
		   { name: 'æŠ—è¼»å°„è™•ç†çš„', effect: 1.25 }, // ç‰¹æ®Šè™•ç†
		   { name: 'åˆæˆå†é€ çš„', effect: 1.15 }, // ç”Ÿç”¢æ–¹å¼
		   { name: 'çœŸç©ºè„«æ°´çš„', effect: 1.35 }  // åŠ å·¥æŠ€è¡“
		]
	  },
	  materials: {
		names: ['å»¢é‡‘å±¬', 'é›»å­å…ƒä»¶', 'èšåˆç‰©', 'éˆ¦åˆé‡‘', 'é‹æ', 'éŠ…ç·š', 'é‹¼æ¿', 'æ©¡è† ', 'ç»ç’ƒ', 'é™¶ç“·', 'æ··å‡åœŸ', 'æœ¨æ', 'å¡‘æ–™', 'çº–ç¶­å¸ƒ', 'çŸ³å¢¨', 'çŸ½è† ', 'é‚åˆé‡‘', 'é‰›å¡Š', 'é‹…æ¿', 'é³ç‰‡', 'éŒ«ç®”', 'ç¢³çº–ç¶­', 'ä¸é½é‹¼', 'å½ˆç°§', 'è»¸æ‰¿', 'é½’è¼ª', 'èºçµ²', 'èºæ¯', 'èºæ “', 'éµçµ²', 'é‹¼çºœ', 'é‹ç®”', 'éŠ…ç®¡', 'é‹¼ç®¡', 'PVCç®¡', 'é›»ç·š', 'çµ•ç·£è† å¸¶', 'ç„ŠéŒ«', 'æ½¤æ»‘æ²¹', 'ç ‚ç´™', 'ç£¨åˆ€çŸ³', 'ç ‚è¼ª', 'é‘½é ­', 'é‹¸ç‰‡', 'é‰—å­', 'æ‰³æ‰‹', 'éŒ˜é ­', 'èºçµ²åˆ€', 'éµé‡˜', 'é‰šé‡˜', 'éµéŠ', 'æ›é‰¤', 'æ»‘è¼ª', 'çš®å¸¶', 'å½ˆç°§é‹¼', 'é‹åˆé‡‘', 'é»ƒéŠ…', 'é’éŠ…', 'é‘„éµ', 'éé‹…é‹¼', 'é¢çµ²', 'é‰¬ç‰‡', 'éˆ·ç²‰', 'ç¨€åœŸç£éµ', 'é‹°é›»æ± ', 'å¤ªé™½èƒ½æ¿', 'é›»è·¯æ¿', 'é›»å®¹å™¨', 'é›»é˜»å™¨', 'äºŒæ¥µç®¡', 'æ™¶é«”ç®¡', 'é›†æˆé›»è·¯', 'é¦¬é”', 'ç™¼é›»æ©Ÿ', 'è®Šå£“å™¨', 'é›»ç£éµ', 'çµ•ç·£æ¼†', 'é˜²ç«æ£‰', 'éš”ç†±æ¿', 'é˜²æ°´å¸ƒ', 'é˜²å½ˆç»ç’ƒ', 'ç¢³åŒ–çŸ½', 'æ°§åŒ–é‹', 'æ°®åŒ–ç¡¼', 'çŸ³æ£‰', 'ç»ç’ƒçº–ç¶­', 'ç’°æ°§æ¨¹è„‚', 'èšæ°¨é…¯', 'å°¼é¾ç¹©', 'å‡±å¤«æ‹‰çº–ç¶­', 'èšä¹™çƒ¯', 'èšä¸™çƒ¯', 'èšç¢³é…¸é…¯', 'èšé…¯è–„è†œ', 'çŸ½é‹¼ç‰‡', 'ç£æ€§ææ–™', 'è¶…å°ææ–™', 'é™¶ç“·çº–ç¶­', 'è€ç«ç£š', 'æ°´æ³¥', 'çŸ³è†æ¿', 'ç€é’', 'ç ‚çŸ³', 'é»åœŸ', 'çŸ³ç°', 'ç£šå¡Š', 'å¤§ç†çŸ³', 'èŠ±å´—å²©', 'çŸ³è‹±ç ‚', 'çŸ½è—»åœŸ'],
		modifiers: [
		  { name: 'ä¿ºæ‹¾çš„', effect: 2.0 },
		  { name: 'å»¢æ£„çš„', effect: 1.8 },
		  { name: 'é«˜æº«é›å£“çš„', effect: 1.9 },  // åŠ å·¥å·¥è—
		  { name: 'é½è•è„†åŒ–çš„', effect: 0.7 },  // åŠ£åŒ–ç‹€æ…‹
		  { name: 'é›»éå¼·åŒ–çš„', effect: 2.0 },  // è¡¨é¢è™•ç†
		  { name: 'å›æ”¶å†é€ çš„', effect: 1.5 },  // ä¾†æºé¡å‹
		  { name: 'è¼»å°„ç¡¬åŒ–çš„', effect: 1.8 },  // ç’°å¢ƒé©æ‡‰
		  { name: 'ç²¾å¯†é‘„é€ çš„', effect: 2.2 },  // è£½é€ ç²¾åº¦
		  { name: 'æ‡‰åŠ›æ–·è£‚çš„', effect: 0.5 },  // çµæ§‹ç¼ºé™·
		  { name: 'ç¢³çº–ç¶­è¤‡åˆ', effect: 2.3 },  // ææ–™é¡å‹
		  { name: 'æˆ°å‰åº«å­˜çš„', effect: 1.7 },  // æ™‚ä»£èƒŒæ™¯
		  { name: 'æ¶²å£“æˆå‹çš„', effect: 2.1 }   // æˆå‹æŠ€è¡“
		]
	  },
	  weapons: {
		names: ['é•·åŠ', 'çŸ­åŠ', 'å½åˆ€', 'æˆ°æ–§', 'é›™æ‰‹æ–§', 'åŒ•é¦–', 'é•·çŸ›', 'çŸ­çŸ›', 'æˆ°éŒ˜', 'é‡˜é ­éŒ˜', 'éˆæ·', 'é®åˆ€', 'é‰¤é®', 'æˆŸ', 'é•·æŸ„æ–§', 'æ­¦å£«åˆ€', 'å¤ªåˆ€', 'è‚‹å·®', 'è¥¿æ´‹åˆºåŠ', 'é—ŠåŠ', 'æ‰‹åŠåŠ', 'ç¾…é¦¬çŸ­åŠ', 'ç¶­äº¬æ–§', 'é£›æ–§', 'æŠ•çŸ›', 'é£›åˆ€', 'ç‹¼ç‰™æ£’', 'æµæ˜ŸéŒ˜', 'æˆ°é®', 'é›™æˆªæ£', 'ä¸‰ç¯€æ£', 'éµé­', 'éµå°º', 'å³¨çœ‰åˆº', 'é‰¤çˆª', 'è¢–ç®­', 'å¼©ç®­', 'è¤‡åˆå¼“', 'åæ›²å¼“', 'é•·å¼“', 'AK-74M', 'AK-105', 'AK-12', 'AK-101', 'AK-103', 'AKS-74U', 'RPK-16', 'SKS', 'VPO-136', 'VPO-209', 'ADAR 2-15', 'TX-15 DML', 'M4A1', 'HK416', 'SCAR-L', 'FN FAL', 'SR-25', 'M1A', 'RSASS', 'SV-98', 'Mosin Nagant', 'VSS Vintorez', 'AS VAL', 'SR-3M', '9A-91', 'VSK-94', 'MP5', 'MP7', 'P90', 'UMP45', 'Vector', 'PP-19-01 Vityaz', 'PP-91 Kedr', 'MPX', 'MP9', 'MP-155', 'Saiga-12', 'TOZ-106', 'Remington 870', 'Mossberg 590', 'Glock 17', 'Glock 18C', 'M9A3', 'P226', 'TT-33', 'APS', 'Five-seveN', 'Desert Eagle', 'RSh-12', 'SVD', 'DVL-10', 'T-5000', 'M700', 'MK18', 'HK G36', 'AUG A3', 'DT MDR', 'MCX', 'SA-58', 'RPD', 'PKM'],
		modifiers: [
		  { name: 'ç”Ÿé½çš„', effect: 0.9 },
		  { name: 'é›·å°„æ ¡æº–çš„', effect: 1.6 },  // èª¿è©¦ç‹€æ…‹
		  { name: 'å¡å½ˆæ”¹è£çš„', effect: 0.6 },  // æ•…éšœé¡å‹
		  { name: 'æˆ°è¡“æ¶ˆéŸ³çš„', effect: 1.4 },  // åŠŸèƒ½æ”¹è£
		  { name: 'é½è•é»é€£çš„', effect: 0.5 },  // æå£ç¨‹åº¦
		  { name: 'è¤‡åˆææ–™çš„', effect: 1.7 },  // æè³ªç‰¹æ€§
		  { name: 'å¼·åŒ–å°„é€Ÿçš„', effect: 1.8 },  // å°„æ“Šæ¨¡å¼
		  { name: 'é˜²åå…‰è™•ç†çš„', effect: 1.3 },  // è¡¨é¢è™•ç†
		  { name: 'é›™å½ˆåŒ£ç³»çµ±', effect: 1.5 },  // çµæ§‹è¨­è¨ˆ
		  { name: 'ç†±èƒ½ç„å…·çš„', effect: 1.9 },  // é…ä»¶å‡ç´š
		  { name: 'å¹³è¡¡é…é‡çš„', effect: 1.2 }   // äººé«”å·¥å­¸
		]
	  },
	  tech: {
		names: ['é›»è·¯æ¿', 'åŠ å¯†èŠ¯ç‰‡', 'AIæ ¸å¿ƒ', 'é‡å­è™•ç†å™¨', 'å‚³æ„Ÿå™¨æ¨¡çµ„', 'ä¼ºæœé¦¬é”', 'å›ºæ…‹ç¡¬ç›¤', 'å…§å­˜æ¢', 'GPUèŠ¯ç‰‡', 'CPUæ•£ç†±å™¨', 'é›»æºæ¨¡å¡Š', 'è—ç‰™æ¨¡çµ„', 'WiFiå¤©ç·š', 'å°„é »èŠ¯ç‰‡', 'å…‰çº–æ”¶ç™¼å™¨', 'è§¸æ§é¢æ¿', 'æ¶²æ™¶å±å¹•', 'OLEDé¡¯ç¤ºå™¨', 'æ”åƒé ­æ¨¡çµ„', 'æŒ‡ç´‹è­˜åˆ¥å™¨', 'è²æ³¢é¦¬é”', 'å¾®å‹éº¥å…‹é¢¨', 'æšè²å™¨å–®å…ƒ', 'æŒ¯å‹•é›»æ©Ÿ', 'é™€èºå„€å‚³æ„Ÿå™¨', 'åŠ é€Ÿåº¦è¨ˆ', 'æ°£å£“å‚³æ„Ÿå™¨', 'æº«åº¦å‚³æ„Ÿå™¨', 'æ¿•åº¦å‚³æ„Ÿå™¨', 'ç´…å¤–ç·šç™¼å°„å™¨', 'æ¿€å…‰é›·é”', 'æ¯«ç±³æ³¢é›·é”', 'NFCèŠ¯ç‰‡', 'RFIDæ¨™ç±¤', 'ç”Ÿç‰©è­˜åˆ¥æ¨¡çµ„', 'èªéŸ³è­˜åˆ¥èŠ¯ç‰‡', 'ç¥ç¶“ç¶²çµ¡è™•ç†å™¨', 'é‚Šç·£è¨ˆç®—å–®å…ƒ', '5GåŸºå¸¶èŠ¯ç‰‡', 'è¡›æ˜Ÿé€šä¿¡æ¨¡å¡Š', 'ç„¡äººæ©Ÿé£›æ§', 'æ©Ÿæ¢°è‡‚æ§åˆ¶å™¨', 'å·¥æ¥­PLC', 'æ©Ÿå™¨è¦–è¦ºé¡é ­', '3Dæ‰“å°å™´é ­', 'CNCæ§åˆ¶æ¿', 'æ¿€å…‰åˆ‡å‰²é ­', 'é›»åŒ–å­¸å‚³æ„Ÿå™¨', 'å…‰ä¼é›»æ± æ¿', 'é‹°é›»æ± é›»èŠ¯', 'è¶…ç´šé›»å®¹å™¨', 'ç‡ƒæ–™é›»æ± å †', 'ç„¡ç·šå……é›»ç·šåœˆ', 'é€†è®Šå™¨æ¨¡å¡Š', 'è®Šå£“å™¨çµ„ä»¶', 'ç¹¼é›»å™¨é–‹é—œ', 'é›»ç£é–¥é–€', 'æ­¥é€²é›»æ©Ÿ', 'ä¼ºæœé©…å‹•å™¨', 'æ©Ÿå™¨äººé—œç¯€æ¨¡çµ„', 'è‡ªå‹•é§•é§›ECU', 'è»Šè¼‰é›·é”', 'è»Šè¦ç´šèŠ¯ç‰‡', 'èˆªç©ºé›»å­çµ„ä»¶', 'è¡›æ˜Ÿå§¿æ§ç³»çµ±', 'ç«ç®­å°èˆªèŠ¯ç‰‡', 'æ·±ç©ºé€šä¿¡çµ‚ç«¯', 'é‡å­åŠ å¯†æ©Ÿ', 'å€å¡Šéˆç¤¦æ©Ÿ', 'é›²æœå‹™å™¨ä¸»æ¿', 'æ•¸æ“šä¸­å¿ƒäº¤æ›æ©Ÿ', 'å…‰åˆ»æ©Ÿé¡é ­', 'åŠå°é«”è•åˆ»æ©Ÿ', 'ç´ç±³å£“å°è¨­å‚™', 'åˆ†å­ç¯©è†œ', 'ç¢³ç´ç±³ç®¡ææ–™', 'çŸ³å¢¨çƒ¯æ™¶ç‰‡', 'è¶…å°é«”ææ–™', 'æŸ”æ€§é›»å­è–„è†œ', 'æ™ºèƒ½çº–ç¶­ç¹”ç‰©', 'é›»å­çš®è†š', 'è…¦æ©Ÿæ¥å£æ¢é‡', 'é†«ç™‚å½±åƒæ¢é ­', 'åŸºå› æ¸¬åºå„€', 'ç´ç±³æ©Ÿå™¨äºº', 'å¾®æµæ§èŠ¯ç‰‡', 'ç”Ÿç‰©å‚³æ„Ÿå™¨', 'äººå·¥æ™¶ç‹€é«”', 'ä»¿ç”Ÿç¾©è‚¢', 'æ™ºèƒ½å‡è‚¢', 'å¤–éª¨éª¼é©…å‹•å™¨', 'ARé¡¯ç¤ºæ¨¡çµ„', 'VRå®šä½å‚³æ„Ÿå™¨', 'å…¨æ¯æŠ•å½±å„€', 'æ¿€å…‰æŠ•å½±é¡é ­', 'æ™ºèƒ½å®¶å±…ä¸­æ¨', 'ç‰©è¯ç¶²ç¶²é—œ', 'é‚Šç·£æœå‹™å™¨', 'AIè¨“ç·´é›†ç¾¤', 'è¶…ç´šè¨ˆç®—æ©Ÿç¯€é»', 'é‡å­è¨ˆç®—å–®å…ƒ'],
		modifiers: [
		  { name: 'å¯¦é©—æ€§çš„', effect: 1.5 },
		  { name: 'é˜²ç«ç‰†ç ´è§£', effect: 1.8 },   // è»Ÿé«”ç‹€æ…‹
		  { name: 'è»ç”¨åŠ å¯†çš„', effect: 2.4 },   // å®‰å…¨ç­‰ç´š
		  { name: 'éè¼‰ç‡’æ¯€çš„', effect: 0.3 },   // æå£é¡å‹
		  { name: 'æ¨¡çµ„åŒ–è¨­è¨ˆ', effect: 1.7 },   // çµæ§‹ç‰¹æ€§
		  { name: 'é‡å­åŠ å¯†çš„', effect: 2.6 },   // æŠ€è¡“å±¤ç´š
		  { name: 'è¼»å°„å±è”½çš„', effect: 1.5 },   // é˜²è­·åŠŸèƒ½
		  { name: 'åŸå‹æ©Ÿç‰ˆæœ¬çš„', effect: 1.9 },   // é–‹ç™¼éšæ®µ
		  { name: 'ç”Ÿç‰©è­˜åˆ¥çš„', effect: 2.1 },   // é©—è­‰æ–¹å¼
		  { name: 'å¤ªé™½èƒ½ä¾›é›»çš„', effect: 1.4 },   // èƒ½æºé¡å‹
		  { name: 'å…¨æ¯æŠ•å½±çš„', effect: 2.0 }    // é¡¯ç¤ºæŠ€è¡“
		]
	  }
	};

	let LOCATIONS = ["åºŸå¼ƒè¶…å¸‚", "æ ¸ç”µç«™åºŸå¢Ÿ", "åœ°é“éš§é“", "å†›äº‹åŸºåœ°", "åŒ»é™¢åœ°ä¸‹å®¤", "ç§‘ç ”æ‰€é—å€", "åŠ æ²¹ç«™", "å†œåœºè°·ä»“", "å»¢æ£„è³¼ç‰©ä¸­å¿ƒ", "æ ¸åæ‡‰çˆå†·å»æ± ", "åœ°éµç¶­ä¿®é€šé“", "é€€å½¹å°å½ˆç™¼å°„äº•", "ç²¾ç¥ç—…é™¢åœå°¸é–“", "åŒ–å·¥å¯¦é©—å®¤å»¢å¢Ÿ", "æ¼æ²¹åŠ æ²¹ç«™", "ç©€ç‰©é»´è®Šå€‰åº«", "éŠ¹è•è¼¸æ²¹ç®¡é“", "åå¡Œç¤¦å±±éš§é“", "å»¢æ£„å†·å‡é£Ÿå“å» ", "æ”¾å°„æ€§å»¢æ–™å‘", "åŸå¸‚é˜²ç©ºæ´ç¾¤", "è»ç”¨é›·é”ç«™éºå€", "ç„šåŒ–çˆè™•ç†è»Šé–“", "æ°´åº«æ§åˆ¶å¡”", "å ±å»¢ç«è»Šèª¿åº¦å ´", "æŠ—ç”Ÿç´ ç”Ÿç”¢ç·š", "é‹¼éµå» é«˜çˆå€", "æµ·åº•éš§é“æ»²æ°´æ®µ", "èˆªç©ºç‡ƒæ–™å„²ç½å€", "ç”Ÿç‰©è£½åŠ‘å¯¦é©—å®¤", "æ™¶åœ“å» ç„¡å¡µå®¤", "çºœè»Šä¸­è½‰æ©Ÿæˆ¿", "é€ ç´™å» æ±™æ°´æ± ", "åœ°ä¸‹éˆ¾ç¤¦è±äº•", "è·¨æµ·å¤§æ©‹æ©‹å¢©", "é›»å¼§çˆç…‰é‹¼è»Šé–“", "ç©€ç‰©å‡é™æ©Ÿç­’å€‰", "çŸ³åŒ–ç®¡ç·šåŠ å£“ç«™", "å ±å»¢èˆ¹èˆ¶æ‹†è§£å ´", "æ”¾å°„æ€§æ±™æ°´äº•", "å±±å€çºœè»Šå¡”æ¶", "æ··å‡åœŸé æ‹Œå·¥å» ", "åœ°ä¸‹é…é›»ç¸½ç«™", "æˆ°å‚™ç³§é£Ÿå„²è—åº«", "éµè·¯ä¿¡è™Ÿæ§åˆ¶å¡”", "è£½è—¥å» ç™¼é…µè»Šé–“", "å»¢æ£„ç´¡ç¹”å°æŸ“å» ", "å±±é«”æ»‘å¡æ©åŸ‹æ‘", "å†·æˆ°æ™‚æœŸè§€å¯Ÿå“¨", "åœ°ä¸‹ç¨®å­åŸºå› åº«", "æ¸¯å£è²¨æ«ƒåŠè£å€", "é‹é›»è§£è»Šé–“å»¢å¢Ÿ", "æ²³å·ç–æµšè¨­å‚™å ´", "ç«åŠ›ç™¼é›»ç…¤å€‰", "å»¢æ£„æ±½è»Šå£“ç¸®å» ", "æ·±å±¤åœ°è³ªé‘½æ¢äº•", "æˆ°æ™‚åœ°ä¸‹å°åˆ·æ‰€", "æ”¾å°„æ€§é†«ç™‚å™¨æ¢°åº«"];
	let currentUpgradeIndex;
    
	let productionCollection = {};
	
	// æ–°å®šç¾©æ± ï¼šå¢åŠ äº‹ä»¶æ™‚ï¼Œåƒµå°¸é‡åˆ°çš„å°è±¡
	const ZOMBIE_ENCOUNTER_POOL = [
	  "æµæµªçš„åƒµå°¸","å­¤ç¨çš„æ—…è¡Œè€…","å¤©çœŸçš„å€–å­˜è€…","è¿·é€”çš„è¡Œè€…","å—å‚·çš„é€€ä¼è»äºº","å¸¶è‘—æŸ“è¡€ç­†è¨˜çš„ç§‘å­¸å®¶","ç‹‚ç†±çš„æœ«æ—¥æ•™å¾’","æ”¹é€ æ©Ÿè»Šçš„æš´å¾’","å›¤è—¥è—¥åŠ‘å¸«","å¤±èªæˆ°åœ°è¨˜è€…","é»‘å¸‚åœ°åœ–å•†äºº","å›é€ƒç ”ç©¶å“¡","å…ç–«é«”æµæµªå…’","ç„¦æ…®ç›´å‡æ©Ÿå·¥ç¨‹å¸«", "ç˜‹ç™²å°¸é«”ç•«å®¶", "é …åœˆå¯¦é©—é«”", "æ¨‚å™¨ç›’ç‹™æ“Šæ‰‹", "è¨Šè™Ÿå¡”å»£æ’­å“¡", "æ€¥è¨ºå®¤ç„šå°¸é†«","è¢«æ„ŸæŸ“çš„è­·æ—å“¡", "è®Šç•°æµæµªçŠ¬", "è…çˆ›æ•‘è­·å“¡", "å¯„ç”Ÿè—¤å®¿ä¸»", "å˜¶å¼è·¯ç‡ˆåŠå°¸"  // å¯æ“´å……æ›´å¤šé¸é …
	];

	// æ–°å®šç¾©æ± ï¼šæ¸›å°‘äº‹ä»¶æ™‚ï¼Œåƒµå°¸é­é‡çš„ä¸åˆ©äº‹ä»¶
	const ZOMBIE_DISASTER_POOL = [
	  "æš´èµ°çš„è®Šç•°ç¸","å¤§è¦æ¨¡çš„åå¡Œ", "å¼·é›·é›¨å¤©æ°£","çªå¦‚å…¶ä¾†çš„é¢¶é¢¨","è¢«æ„ŸæŸ“çš„è­¦çŠ¬ç¾¤","å·¨å‹è…çˆ›çƒé´‰ç‹","å¯„ç”Ÿè—¤è”“åƒµå°¸æ¨¹","æˆç¾¤å°¸é¼ é·å¾™","é»èŒè¦†è“‹çš„è…åŒ–ç†Š","é£Ÿå°¸ç¦¿é·²ç¾¤è¥²æ“Š","è»æ–¹ç‡ƒç‡’å½ˆåœ°æ¯¯è½Ÿç‚¸","è‡ªå‹•å“¨æˆ’æ©Ÿæ§é™£åˆ—å•Ÿå‹•","åœ°ä¸‹ç“¦æ–¯ç®¡ç·šå¤§çˆ†ç‚¸","é«˜å£“é›»ç¶²æ„å¤–éè¼‰","è‡´å‘½æŠ—é«”ç©ºæ°£å‚³æ’­","æ™ºèƒ½ç„¡äººæ©Ÿç¾¤æƒè•©","ç”ŸåŒ–æº¶å°¸é…¸é›¨é›²åœ˜","ç²¾ç¥å¹²æ“¾æ³¢ç„¡å·®åˆ¥æ”»æ“Š","ååƒµå°¸çœŸèŒå¿«é€Ÿè”“å»¶","ç•°ç¨®æ•é£Ÿè€…é›†åœ˜ç‹©çµ" // å¯æ“´å……æ›´å¤šé¸é …
	];
	
	/***** å…¨å±€è®Šé‡å®šç¾© *****/
	function updateResourceCardsBorder() {
	  // å®šç¾©ç¨€æœ‰åº¦åˆ—è¡¨ï¼Œé †åºå¾ä½åˆ°é«˜
	  const rarityList = [
		"junk", "old", "damaged", "common",
		"decent", "sealed", "selected", "tested",
		"rare", "epic", "legendary", "divine"
	  ];
	  
	  // æ ¹æ“š gameState.resetCountsï¼Œåˆ†åˆ¥ç‚ºå„è³‡æºè¨ˆç®—é‡ç½®æ¬¡æ•¸å°æ‡‰çš„ç´¢å¼•
	  const foodRarity = rarityList[ gameState.resetCounts.food % rarityList.length ];
	  const materialsRarity = rarityList[ gameState.resetCounts.materials % rarityList.length ];
	  const weaponsRarity = rarityList[ gameState.resetCounts.weapons % rarityList.length ];
	  const techRarity = rarityList[ gameState.resetCounts.tech % rarityList.length ];
	  
	  // æ ¹æ“šæ‚¨çš„ HTML çµæ§‹ï¼Œæ­¤è™•å‡å®šè³‡æºå¡çš„çˆ¶å…ƒç´ ç‚ºé¡¯ç¤ºå€ï¼ˆä¾‹å¦‚ resource-header çš„å®¹å™¨ï¼‰
	  const foodCard = document.getElementById("foodCount")?.parentElement;
	  const materialsCard = document.getElementById("materialsCount")?.parentElement;
	  const weaponsCard = document.getElementById("weaponsCount")?.parentElement;
	  const techCard = document.getElementById("techCount")?.parentElement;
	  
	  if (foodCard) {
		// æ­¤è™•å‹•æ…‹çµ„åˆ CSS è®Šæ•¸åï¼Œå½¢å¦‚ "var(--junk)"ã€"var(--old)" ç­‰
		foodCard.style.border = "2px solid var(--" + foodRarity + ")";
	  }
	  if (materialsCard) {
		materialsCard.style.border = "2px solid var(--" + materialsRarity + ")";
	  }
	  if (weaponsCard) {
		weaponsCard.style.border = "2px solid var(--" + weaponsRarity + ")";
	  }
	  if (techCard) {
		techCard.style.border = "2px solid var(--" + techRarity + ")";
	  }
	}


	
	// å›ºå®šç¨€æœ‰åº¦æ•¸çµ„ï¼ˆå…± 12 å€‹ç­‰ç´šï¼‰
	const RARITIES = [
	  "junk", "old", "damaged", "common", "decent",
	  "sealed", "selected", "tested", "rare", "epic",
	  "legendary", "divine"
	];

	function calculateTotalCombinations() {
	  let total = 0;
	  // éæ­· ITEM_DATA ä¸­æ‰€æœ‰è³‡æºé¡å‹
	  for (let res in ITEM_DATA) {
		if (ITEM_DATA.hasOwnProperty(res)) {
		  const data = ITEM_DATA[res];
		  // ç‰©å“åç¨±æ•¸é‡
		  const namesCount = Array.isArray(data.names) ? data.names.length : 0;
		  // è©ç¶´æ•¸é‡ï¼Œå¦‚æœ modifiers ä¸å­˜åœ¨å‰‡é»˜èªç‚º 0
		  const modifiersCount = Array.isArray(data.modifiers) ? data.modifiers.length : 0;
		  const rarityCount = RARITIES.length; // å›ºå®šç‚º12

		  // è¨ˆç®—ï¼šç‰©å“å+ç¨€æœ‰åº¦ èˆ‡ ç‰©å“å+è©ç¶´+ç¨€æœ‰åº¦
		  const countNameRarity = namesCount * rarityCount;
		  const countNameModifierRarity = namesCount * modifiersCount * rarityCount;

		  const resourceTotal = countNameRarity + countNameModifierRarity;
		  
		  console.log(`${res}ï¼šç‰©å“åç¨±æ•¸é‡ = ${namesCount}, è©ç¶´æ•¸é‡ = ${modifiersCount}, çµ„åˆæ•¸ = ${resourceTotal}`);
		  total += resourceTotal;
		}
	  }
	  return total;
	}

	// å¾ ITEM_DATA ä¸­å‹•æ…‹è¨ˆç®—æ‰€æœ‰å¯èƒ½çš„æ”¶è—çµ„åˆæ•¸
	let ALL_COMBINATIONS = calculateTotalCombinations();
	console.log(`ITEM_DATA å…¨éƒ¨æ”¶è—çµ„åˆæ•¸ = ${ALL_COMBINATIONS}`);


	// æ›´æ–°æ”¶è—è¨˜éŒ„å®Œæˆåº¦çš„å‡½æ•¸
	function updateCollectionCompletion() {
	  // å·²æ”¶è—é …ç›®æ•¸é‡ï¼šä»¥ collectedItems çš„éµæ•¸é‡ä½œç‚ºè¨ˆæ•¸
	  const obtained = Object.keys(collectedItems).length;
	  // è¨ˆç®—æ”¶è—å®Œæˆç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰ï¼Œé¿å…é™¤æ•¸ç‚º 0 çš„æƒ…æ³
	  const total = ALL_COMBINATIONS || 1;
	  const percentage = (obtained / total) * 100;

	  const completionElem = document.getElementById("collectionCompletion");
	  if (completionElem) {
		// å³ä½¿æ•¸å€¼ç‚º 0ï¼Œä¹Ÿé¡¯ç¤º0/ç¸½æ•¸: 0.0%
		completionElem.textContent = `æ”¶é›†é€²åº¦: ${obtained}/${total}(${percentage.toFixed(3)}%)`;
	  }
	}

	
	function showTempMessage(message) {
	  let tempDiv = document.createElement("div");
	  tempDiv.style.position = "fixed";
	  tempDiv.style.top = "20%"; // å¯æ ¹æ“šéœ€è¦èª¿æ•´é¡¯ç¤ºä½ç½®
	  tempDiv.style.left = "50%";
	  tempDiv.style.transform = "translate(-50%, 0)";
	  tempDiv.style.background = "#333";
	  tempDiv.style.color = "#FFF";
	  tempDiv.style.padding = "1em 2em";
	  tempDiv.style.borderRadius = "12px";
	  tempDiv.style.zIndex = "1100"; // æ¯”å‡ç´šå½ˆçª—å±¤æ¬¡é«˜
	  tempDiv.style.boxShadow = "0 4px 12px rgba(0,0,0,0.3)";
	  tempDiv.textContent = message;
	  document.body.appendChild(tempDiv);
	  setTimeout(function() {
		tempDiv.parentNode.removeChild(tempDiv);
	  }, 300);
	}


	
	//ç”Ÿç”¢æ”¶è—å½ˆçª—
	function showProductionCollection() {
	  // å°‡ productionCollection è½‰æ›ç‚ºé™£åˆ—å¾Œæ’åºï¼ˆå¦‚ä¾ç²å–æ¬¡æ•¸å¾é«˜åˆ°ä½æ’åºï¼‰
	  let prodItems = Object.keys(productionCollection).map(key => ({
		name: key,
		count: productionCollection[key]
	  }));
	  
	  prodItems.sort((a, b) => b.count - a.count);
	  
	  // ç”Ÿæˆè¡¨æ ¼ HTML
	  let html = `<table style="width:100%; border-collapse:collapse;"> 
		<thead>
		  <tr>
			<th style="border:1px solid var(--border-color); padding:5px;">ç‰©å“åç¨±</th>
			<th style="border:1px solid var(--border-color); padding:5px;">ç²å¾—æ¬¡æ•¸</th>
		  </tr>
		</thead>
		<tbody>`;
	  
	  prodItems.forEach(item => {
		html += `<tr>
		  <td style="border:1px solid var(--border-color); padding:5px;">${item.name}</td>
		  <td style="border:1px solid var(--border-color); padding:5px; text-align:right;">${item.count}</td>
		</tr>`;
	  });
	  html += `</tbody></table>`;
	  
	  // å°‡ç”Ÿæˆçš„ HTML å¡«å…¥ç”Ÿç”¢æ”¶è—é é¢çš„å…§å®¹å€åŸŸä¸­
	  document.getElementById("productionCollectionContent").innerHTML = html;
	  
	  // é¡¯ç¤ºç”Ÿç”¢æ”¶è—å½ˆçª—
	  showModal("productionCollectionModal");
	}

	


	const RESOURCE_CAP = 900000000000;  // æ‰€æœ‰è³‡æºé”åˆ°æ­¤å€¼å³èªç‚ºâ€œé”åˆ°ä¸Šé™â€
	const RESET_VALUE = 100000;     // é‡ç½®å¾Œæ¯é …è³‡æºé‡
	let collectedItems = {};
	let gameState = {
	  resources: { food: 100, materials: 100, weapons: 50, tech: 20 },
	  // æ–°å¢ï¼šé‡ç½®æ¬¡æ•¸è¨˜éŒ„ï¼Œåˆå§‹å€¼ç‚º 0
	  resetCounts: { food: 0, materials: 0, weapons: 0, tech: 0 },
	  totalZombies: 10,
	  allocations: { exploration: 4, farming: 4, recycling: 1, research: 1 },
	  buildings: new Array(9).fill(null).map((_, i) =>
		i === 4 ? { type: 'center', level: 1, upgradable: true } : null
	  ),
	  explorationMilestone: 10,
	  efficiency: { food: 1, materials: 1, weapons: 1, tech: 1, exploration: 1 }
	};

	let BUILDINGS = {
	  center: {
		name: 'ä¸­å¿ƒåŸºåœ°',
		buildable: false,
		baseCost: { materials: 200, tech: 50 },
		costMultiplier: 1.5,      // æ¯å‡ç´šä¸€æ¬¡ï¼Œæˆæœ¬ä¹˜ä»¥1.5
		baseEffect: { capacity: 10, explorationBoost: 0.05 },
		effectMultiplier: 1.02,    // æ¯å‡ç´šä¸€æ¬¡ï¼Œæ•ˆæœä¹˜ä»¥1.2
		getUpgradeInfo: function(currentLevel) {
		  // currentLevel ä»£è¡¨ç›®æ¨™å‡ç´šå¾Œçš„ç­‰ç´š
		  return {
			cost: {
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
			  tech: Math.floor(this.baseCost.tech * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  capacity: this.baseEffect.capacity * Math.pow(this.effectMultiplier, currentLevel - 1),
			  explorationBoost: this.baseEffect.explorationBoost * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },

	  barracks: {
		name: 'åƒµå°¸å…µç‡Ÿ',
		baseCost: { food: 300, materials: 200 },
		costMultiplier: 1.5,
		baseEffect: { production: 1 },
		// æ–°å¢ï¼š1çº§æ—¶æ¯ç§’æ¶ˆè€—æ­¦å™¨èµ„æºæ¯”ä¾‹ (ä¾‹å¦‚ 0.05)
		baseWeaponConsumptionRate: 0.05,
		effectMultiplier: 1.02,
		getUpgradeInfo: function(currentLevel) {
		  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  // å¦‚æœç›®æ¨™ç­‰ç´šè¶…éä¸­å¿ƒåŸºåœ°ç­‰ç´šå‰‡è¿”å› null è¡¨ç¤ºç„¡æ³•å‡ç´š
		  if (currentLevel > centerLevel) return null;
		  return {
			cost: {
			  food: Math.floor(this.baseCost.food * Math.pow(this.costMultiplier, currentLevel - 1)),
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  production: this.baseEffect.production * Math.pow(this.effectMultiplier, currentLevel - 1),
			  // è¨ˆç®—ç­‰ç´šèª¿æ•´å¾Œçš„æ­¦å™¨è³‡æºæ¶ˆè€—ç‡ï¼ˆä¾‹å¦‚ 1 çº§æ—¶ä¸º baseWeaponConsumptionRate, åç»­ä»¥ effectMultiplier æŒ‡æ•¸å¢é•·ï¼‰
			  weaponConsumptionRate: this.baseWeaponConsumptionRate * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },


	  greenhouse: {
		name: 'æº«å®¤å¤§æ£š',
		baseCost: { materials: 150, tech: 50 },
		costMultiplier: 1.5,
		baseEffect: { food: 0.1 },
		effectMultiplier: 1.02,
		getUpgradeInfo: function(currentLevel) {
		  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  if (currentLevel > centerLevel) return null;
		  return {
			cost: {
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
			  tech: Math.floor(this.baseCost.tech * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  food: this.baseEffect.food * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },
	  recyclingFactory: {
	    name: 'å›æ”¶å·¥å» ',
	    baseCost: { materials: 150, tech: 50 }, // èˆ‡æº«å®¤å¤§æ£šç›¸ä¼¼çš„æˆæœ¬
	    costMultiplier: 1.5,                   // æ¯æ¬¡å‡ç´šæˆæœ¬ä¹˜ä»¥1.5
	    baseEffect: { materials: 0.1 },         // åˆå§‹æ•ˆæœï¼šç‚ºææ–™ç”¢é‡åŠ æˆ10%
	    effectMultiplier: 1.02,                 // æ¯å‡ç´šä¸€æ¬¡æ•ˆæœä¹˜ä»¥1.2
	    getUpgradeInfo: function(currentLevel) {
		  // å–å¾—ä¸­å¿ƒåŸºåœ°çš„ç­‰ç´šï¼Œä½œç‚ºå…¶ä»–å»ºç¯‰å‡ç´šä¸Šé™çš„åƒè€ƒ
		  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  // å¦‚æœç›®æ¨™ç­‰ç´šè¶…éä¸­å¿ƒåŸºåœ°ç­‰ç´šï¼Œå‰‡è¿”å› null è¡¨ç¤ºç„¡æ³•å‡ç´š
		  if (currentLevel > centerLevel) return null;
		  return {
		    cost: {
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
			  tech: Math.floor(this.baseCost.tech * Math.pow(this.costMultiplier, currentLevel - 1))
	        },
		    effect: {
			  // æ•ˆæœè½‰ç‚ºå½±éŸ¿ææ–™ç”¢é‡åŠ æˆ
			  materials: this.baseEffect.materials * Math.pow(this.effectMultiplier, currentLevel - 1)
		    }
		  };
	    }
	  },

	  armory: {
		name: 'è»æ¢°å·¥åŠ',
		baseCost: { materials: 200, weapons: 50 },
		costMultiplier: 1.5,
		baseEffect: { weapons: 0.15 },
		effectMultiplier: 1.02,
		getUpgradeInfo: function(currentLevel) {
		  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  if (currentLevel > centerLevel) return null;
		  return {
			cost: {
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
			  weapons: Math.floor(this.baseCost.weapons * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  weapons: this.baseEffect.weapons * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },

	  laboratory: {
		name: 'ç§‘ç ”å¯¦é©—å®¤',
		baseCost: { materials: 300, tech: 100 },
		costMultiplier: 1.5,
		baseEffect: { tech: 0.2 },
		effectMultiplier: 1.02,
		getUpgradeInfo: function(currentLevel) {
		  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  if (currentLevel > centerLevel) return null;
		  return {
			cost: {
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
			  tech: Math.floor(this.baseCost.tech * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  tech: this.baseEffect.tech * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },

	  // æ–°å¢ï¼šè³‡æºå¢å¹…ç«™ï¼Œå¢åŠ æ‰€æœ‰è³‡æºçš„ç”¢é‡åŠ æˆ
	  resourceAmplifier: {
		name: 'è³‡æºå¢å¹…ç«™',
		baseCost: { materials: 250, tech: 75 },
		costMultiplier: 1.6,
		baseEffect: { resourceBonus: 0.05 },  // åˆå§‹ +5%
		effectMultiplier: 1.02,
		getUpgradeInfo: function(currentLevel) {
		  // å°æ–¼é€™é¡å»ºç¯‰ï¼Œå¯ä»¥ä¸å—ä¸­å¿ƒåŸºåœ°ç­‰ç´šçš„é™åˆ¶ï¼ˆæˆ–å¦å¤–è¨­å®šé™åˆ¶ï¼‰
		  return {
			cost: {
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
			  tech: Math.floor(this.baseCost.tech * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  resourceBonus: this.baseEffect.resourceBonus * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },

	  // æ–°å¢ï¼šåƒµå°¸æŒ‡æ®ä¸­å¿ƒï¼Œæé«˜ç²å¾—åƒµå°¸çš„æ©Ÿç‡èˆ‡æ•¸é‡ï¼ŒåŒæ™‚æ¸›å°‘æå¤±
	  // ä¸¦å¢åŠ æ­¦å™¨è³‡æºæ¶ˆè€—ï¼š1ç´šæ™‚æ¯ç§’æ¶ˆè€—0.5%ï¼Œéš¨ç­‰ç´šæå‡ï¼Œæ¶ˆè€—ç‡æŒ‰ effectMultiplier å¢é•·
	  zombieCommandCenter: {
	    name: 'åƒµå°¸æŒ‡æ®ä¸­å¿ƒ',
	    baseCost: { materials: 300, weapons: 50 },
	    costMultiplier: 1.5,
	    baseEffect: { 
	      zombieBoost: 0.05, 
		  zombieLossReduction: 0.1 
	    },
	    // æ–°å¢ï¼š1ç´šæ™‚æ¯ç§’æ¶ˆè€—æ­¦å™¨è³‡æº 0.5%ï¼ˆå³ 0.005ï¼‰
	    baseWeaponConsumptionRate: 0.05,
	    effectMultiplier: 1.015,
	    getUpgradeInfo: function(currentLevel) {
	  	  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  if (currentLevel > centerLevel) return null;
		  return {
		    cost: {
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
			  weapons: Math.floor(this.baseCost.weapons * Math.pow(this.costMultiplier, currentLevel - 1))
		    },
		    effect: {
			  zombieBoost: this.baseEffect.zombieBoost * Math.pow(this.effectMultiplier, currentLevel - 1),
			  zombieLossReduction: this.baseEffect.zombieLossReduction * Math.pow(this.effectMultiplier, currentLevel - 1),
			  // å‹•æ…‹è¨ˆç®—æ­¦å™¨è³‡æºæ¶ˆè€—ç‡ï¼š1ç´šç‚º baseWeaponConsumptionRateï¼Œä¹‹å¾ŒæŒ‰ effectMultiplier æŒ‡æ•¸å¢é•·
			  weaponConsumptionRate: this.baseWeaponConsumptionRate * Math.pow(this.effectMultiplier, currentLevel - 1)
		    }
		  };
	    }
	  },


	  // æ–°å¢ï¼šçç¨€åº«ï¼Œæé«˜é«˜ç¨€æœ‰åº¦ç‰©å“ç²å¾—ç‡
	  rareVault: {
		name: 'çç¨€åº«',
		baseCost: { tech: 200, materials: 150 },
		costMultiplier: 1.55,
		baseEffect: { rareChanceBoost: 0.05 },  // åˆå§‹ +5%
		effectMultiplier: 1.02,
		getUpgradeInfo: function(currentLevel) {
		  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  if (currentLevel > centerLevel) return null;
		  return {
			cost: {
			  tech: Math.floor(this.baseCost.tech * Math.pow(this.costMultiplier, currentLevel - 1)),
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  rareChanceBoost: this.baseEffect.rareChanceBoost * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },

	  // æ–°å¢ï¼šæ­¦å™¨å½±éŸ¿ä¸­æ¨ï¼Œçµ¦äºˆå¼·åŠ›ç”Ÿç”¢åŠ æˆï¼Œä½†æŒçºŒæ¶ˆè€—æ­¦å™¨è³‡æº
	  weaponConsumptionFacility: {
		name: 'æ­¦å™¨å½±éŸ¿ä¸­æ¨',
		baseCost: { weapons: 100, materials: 300 },
		costMultiplier: 1.7,
		baseEffect: { productionBonus: 0.1, weaponConsumptionRate: 0.02 },
		effectMultiplier: 1.02,
		getUpgradeInfo: function(currentLevel) {
		  const center = gameState.buildings.find(b => b && b.type === "center");
		  const centerLevel = center ? center.level : 1;
		  if (currentLevel > centerLevel) return null;
		  return {
			cost: {
			  weapons: Math.floor(this.baseCost.weapons * Math.pow(this.costMultiplier, currentLevel - 1)),
			  materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1))
			},
			effect: {
			  productionBonus: this.baseEffect.productionBonus * Math.pow(this.effectMultiplier, currentLevel - 1),
			  weaponConsumptionRate: this.baseEffect.weaponConsumptionRate * Math.pow(this.effectMultiplier, currentLevel - 1)
			}
		  };
		}
	  },
	  safetyCenter: {
		  name: 'å®‰å…¨ä¸­å¿ƒ',
		  // å¯æ ¹æ“šéœ€æ±‚è‡ªè¨‚æˆæœ¬ï¼Œé€™è£¡åƒ…æä¾›ä¸€å€‹ç¤ºä¾‹
		  baseCost: { materials: 400, tech: 150, weapons: 200 },
		  costMultiplier: 1.6,
		  baseEffect: {
			accidentReduction: 0.05,        // 1ç´šæ™‚é™ä½5%
			resourceConsumptionRate: 0.05     // 1ç´šæ™‚ï¼Œæ¯ç§’æ¶ˆè€—0.05Ã—ç¸½åƒµå°¸æ•¸çš„è³‡æº
		  },
		  effectMultiplier: 1.01,  // å‡ç´šæ™‚æ•ˆæœä¹˜å­ï¼Œä¾‹å¦‚æ¯å‡ç´šä¸€æ¬¡æ•ˆæœä¹˜ä»¥1.1
		  getUpgradeInfo: function(currentLevel) {
			const accidentReduction = Math.min(this.baseEffect.accidentReduction * Math.pow(this.effectMultiplier, currentLevel - 1), 0.50);
			const resourceConsumptionRate = Math.min(this.baseEffect.resourceConsumptionRate * Math.pow(this.effectMultiplier, currentLevel - 1), 0.4);
			return {
			  cost: {
				materials: Math.floor(this.baseCost.materials * Math.pow(this.costMultiplier, currentLevel - 1)),
				tech: Math.floor(this.baseCost.tech * Math.pow(this.costMultiplier, currentLevel - 1)),
				weapons: Math.floor(this.baseCost.weapons * Math.pow(this.costMultiplier, currentLevel - 1))
			  },
			  effect: {
				accidentReduction: accidentReduction,
				resourceConsumptionRate: resourceConsumptionRate
			  }
			};
		  }
		}  
	  
	};
	

	/***** æ¢ç´¢éšŠåŠåƒµå°¸äº‹ä»¶è™•ç† *****/
	function addEventLog(message, rarity, eventType = "exploration", applyZombieStyle = false) {
	  let logContainerId = (eventType === "production") ? "productionLog" : "explorationLog";
	  const logElem = document.getElementById(logContainerId);
	  if (logElem) {
		 const maxLogs = 100;
		while (logElem.childElementCount >= maxLogs) {
		  logElem.removeChild(logElem.firstChild);
		}
		// å®šç¾©ç¨€æœ‰åº¦æ˜ å°„å°è±¡
		const rarityMapping = {
		  junk: "[ç ´çˆ›çš„]",
		  old: "[é™³èˆŠçš„]",
		  damaged: "[ç ´æçš„]",
		  common: "[æ­£å¸¸çš„]",
		  decent: "[çœ‹èµ·ä¾†ä¸éŒ¯çš„]",
		  sealed: "[æœªé–‹å°çš„]",
		  selected: "[ç²¾æŒ‘ç´°é¸çš„]",
		  tested: "[æ­·ç¶“è€ƒé©—çš„]",
		  rare: "[ç¨€æœ‰çš„]",
		  epic: "[å²è©©çš„]",
		  legendary: "[å‚³å¥‡çš„]",
		  divine: "[ç¥è–çš„]"
		};
		const formattedMessage = message.replace(
		  new RegExp(rarity + "\\b"), 
		  rarityMapping[rarity] || rarity
		);
		
		const div = document.createElement("div");
		div.className = `log-entry ${rarity}`;
		if(eventType === "zombie") {
		  div.className += " zombie-event";
		}
		if(applyZombieStyle) {
		  div.className += " zombie-event";
		}
		div.textContent = formattedMessage;
		
		logElem.appendChild(div);
		logElem.scrollTop = logElem.scrollHeight;
	  }
	}

	function logResource(resource, itemName, amount, eventType = "production") {
	  addEventLog(`ç”Ÿç”¢: ${itemName} +${amount} ${resource}`, 'common', eventType);
	  if (!productionCollection[itemName]) {
		productionCollection[itemName] = 0;
	  }
	  productionCollection[itemName] += 1;
	}

    function checkUpgradable(type, level) {
	  const centerBuilding = gameState.buildings.find(b => b && b.type.toLowerCase() === "center");
	  const centerLevel = centerBuilding ? centerBuilding.level : 1;

	  if (type === "center") {
		return true; // è®“ä¸­å¿ƒåŸºåœ°ç„¡é™åˆ¶å‡ç´š
	  } else {
		return level < centerLevel; // å…¶ä»–å»ºç¯‰ç­‰ç´šä¸èƒ½è¶…éä¸­å¿ƒåŸºåœ°
	  }
	}

	// æ ¹æ“šç¨€æœ‰åº¦æ¬Šé‡éš¨æ©Ÿé¸å–ä¸€å€‹ç¨€æœ‰åº¦
	function weightedRandomRarity() {
	  const weights = {
		junk: 25,
		old: 20,
		damaged: 15,
		common: 15,
		decent: 10,
		sealed: 5,
		selected: 4,
		tested: 3,
		rare: 2,
		epic: 0.5,
		legendary: 0.3,
		divine: 0.2
	  };
	  let total = Object.values(weights).reduce((a, b) => a + b, 0);
	  let rand = Math.random() * total;
	  return Object.keys(weights).find(key => (rand -= weights[key]) < 0);
	}

	// æ ¹æ“šç¨€æœ‰åº¦å€ç‡è¨ˆç®—æœ€çµ‚æ•¸å€¼
	function applyRarityMultiplier(base, rarity) {
	  const multipliers = {
		junk: 1,
		old: 1.5,
		damaged: 2,
		common: 2.5,
		decent: 3,
		sealed: 3.5,
		selected: 4,
		tested: 5,
		rare: 6,
		epic: 8,
		legendary: 10,
		divine: 12
	  };
	  return base * multipliers[rarity];
	}

	// æ ¹æ“šéšŠä¼è¦æ¨¡ç”¢ç”Ÿåƒµå°¸è®ŠåŒ–ï¼ˆå¢åŠ æˆ–æå¤±ï¼‰
	function generateZombieChange(teamSize) {
	  if (Math.random() < 0.4) {
		return Math.random() < 0.6
		  ? Math.floor(teamSize * (0.001 + Math.random() * 1.9))
		  : -Math.floor(teamSize * (0.001 + Math.random() * 0.7));
	  }
	  return 0;
	}
	
	/**
	 * æ ¹æ“šé¡å‹å’Œæ•¸é‡ç”Ÿæˆæ¢ç´¢äº‹ä»¶ä¸­çš„åƒµå°¸è®ŠåŒ–æè¿°
	 * @param {string} type - "increase" æˆ– "decrease"
	 * @param {number} quantity - è®ŠåŒ–çš„åƒµå°¸æ•¸é‡ï¼ˆæ­£æ•¸ï¼Œè‹¥æ¸›å°‘å‰‡å‚³å…¥çµ•å°å€¼ï¼‰
	 * @returns {string} - æ ¼å¼åŒ–çš„æè¿°å­—ç¬¦ä¸²
	 */
	function generateZombieEventDescription(type, quantity) {
	  // éš¨æ©Ÿé¸ç”¨ä¸€å€‹åœ°é»
	  const location = LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)];
	  
	  if (type === "increase") {
		const encounter = ZOMBIE_ENCOUNTER_POOL[Math.floor(Math.random() * ZOMBIE_ENCOUNTER_POOL.length)];
		return `ä½ æ´¾å‡ºçš„åƒµå°¸åœ¨ ${location} é‡åˆ° ${encounter}ï¼Œç²å¾— ${quantity} åƒµå°¸ã€‚`;
	  } else if (type === "decrease") {
		const disaster = ZOMBIE_DISASTER_POOL[Math.floor(Math.random() * ZOMBIE_DISASTER_POOL.length)];
		return `ä½ æ´¾å‡ºçš„åƒµå°¸åœ¨ ${location} é­é‡ ${disaster}ï¼Œæå¤± ${quantity} åƒµå°¸ã€‚`;
	  } else {
		return "";
	  }
	}

	// ç”Ÿæˆæ¢ç´¢çµæœï¼ŒåŒ…æ‹¬ç²å¾—è³‡æºã€æ•¸é‡èˆ‡å¯èƒ½çš„åƒµå°¸è®ŠåŒ–
	function generateExplorationResult(teamSize) {
	  const location = LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)];
	  const resourceTypes = ['food', 'materials', 'weapons', 'tech'];
	  const resource = resourceTypes[Math.floor(Math.random() * resourceTypes.length)];
	  const rarity = weightedRandomRarity();
	  const baseAmount = Math.floor(Math.random() * 11) + 5;
	  const multiplier = Math.pow(1.005, teamSize);
	  const computed = applyRarityMultiplier(baseAmount, rarity) * multiplier;
	  const amount = convertProduction(computed);
	  const itemName = getRandomItemName(resource);
	  const modifier = getRandomModifier(resource);
	  const zombieChange = generateZombieChange(teamSize);
	  
	  return {
		resource,
		amount,
		rarity,
		zombieChange,
		log: {
		  text: `æ¢ç´¢ ${location} ç²å¾— ${modifier.name} ${itemName} +${amount} ${resource}`,
		  zombieText: zombieChange > 0 
					? `âš¡ ç²å¾— ${zombieChange} åƒµå°¸`
					: zombieChange < 0 
					  ? `â˜ ï¸ æå¤± ${Math.abs(zombieChange)} åƒµå°¸`
					  : null,
		  rarity
		}
	  };
	}

    /***** è¼”åŠ©å‡½æ•¸ *****/
    function convertProduction(val) {
      return (val > 0 && val < 1) ? 1 : Math.floor(val);
    }
    function formatNumber(num) {
	  if (num < 10000) {
		return parseFloat(num.toFixed(3));
	  } else if (num < 100000000) {
		// è¬ ~ å„„
		if (num < 1000000) {
		  let wan = num / 10000;
		  return wan.toFixed(Math.max(3 - Math.floor(wan).toString().length, 0)) + "è¬";
		} else if (num < 10000000) {
		  let baiwan = num / 1000000;
		  return baiwan.toFixed(Math.max(3 - Math.floor(baiwan).toString().length, 0)) + "ç™¾è¬";
		} else {
		  let qianwan = num / 10000000;
		  return qianwan.toFixed(Math.max(3 - Math.floor(qianwan).toString().length, 0)) + "åƒè¬";
		}
	  } else if (num < 1000000000000) {
		// å„„ ~ å…†
		if (num < 10000000000) {
		  let yi = num / 100000000;
		  return yi.toFixed(Math.max(3 - Math.floor(yi).toString().length, 0)) + "å„„";
		} else if (num < 100000000000) {
		  let shiyi = num / 1000000000;
		  return shiyi.toFixed(Math.max(3 - Math.floor(shiyi).toString().length, 0)) + "åå„„";
		} else {
		  let baiyi = num / 10000000000;
		  return baiyi.toFixed(Math.max(3 - Math.floor(baiyi).toString().length, 0)) + "ç™¾å„„";
		}
	  } else if (num < 10000000000000000) {
		// å…† ~ äº¬
		if (num < 100000000000000) {
		  let zhao = num / 1000000000000;
		  return zhao.toFixed(Math.max(3 - Math.floor(zhao).toString().length, 0)) + "å…†";
		} else if (num < 1000000000000000) {
		  let shizhao = num / 10000000000000;
		  return shizhao.toFixed(Math.max(3 - Math.floor(shizhao).toString().length, 0)) + "åå…†";
		} else {
		  let baizhao = num / 100000000000000;
		  return baizhao.toFixed(Math.max(3 - Math.floor(baizhao).toString().length, 0)) + "ç™¾å…†";
		}
	  } else {
		// äº¬åŠä»¥ä¸Š
		if (num < 1000000000000000000) {
		  let jing = num / 10000000000000000;
		  return jing.toFixed(Math.max(3 - Math.floor(jing).toString().length, 0)) + "äº¬";
		} else if (num < 10000000000000000000) {
		  let shijing = num / 100000000000000000;
		  return shijing.toFixed(Math.max(3 - Math.floor(shijing).toString().length, 0)) + "åäº¬";
		} else {
		  // è¶…å‡ºJavaScriptå®‰å…¨æ•´æ•¸ç¯„åœæ™‚æ”¹ç”¨ç§‘å­¸è¨ˆæ•¸æ³•
		  return num.toExponential(3).replace('e+', 'Ã—10^');
		}
	  }
	}
    function canAfford(cost) {
      return Object.entries(cost).every(([res, val]) => gameState.resources[res] >= val);
    }
    function payCost(cost) {
      Object.entries(cost).forEach(([res, val]) => {
        gameState.resources[res] -= val;
      });
    }
    function getRandomItemName(resource) {
      return ITEM_DATA[resource].names[Math.floor(Math.random() * ITEM_DATA[resource].names.length)];
    }
    function getRandomModifier(resource) {
      const modifiers = ITEM_DATA[resource].modifiers;
      return modifiers[Math.floor(Math.random() * modifiers.length)];
    }

    /***** æ¢ç´¢éšŠè‡ªå‹•é‡åˆ†é…äº‹ä»¶ *****/
    function checkExplorationMilestone() {
      while (gameState.allocations.exploration >= gameState.explorationMilestone) {
        let remove = Math.min(5, gameState.allocations.exploration);
        let gained = remove;
        let toExploration = Math.round(gained * 0.5);
        let toFarming = Math.round(gained * 0.3);
        let toRecycling = Math.round(gained * 0.1);
        let toResearch = Math.round(gained * 0.1);
        let sum = toExploration + toFarming + toRecycling + toResearch;
        if(sum < gained) {
          toExploration += (gained - sum);
        } else if(sum > gained) {
          toExploration -= (sum - gained);
        }
        gameState.allocations.exploration -= remove;
        gameState.allocations.exploration += toExploration;
        gameState.allocations.farming += toFarming;
        gameState.allocations.recycling += toRecycling;
        gameState.allocations.research += toResearch;
        addEventLog(`æ¢ç´¢éšŠé”åˆ° ${gameState.explorationMilestone} éš»ï¼Œè‡ªå‹•é‡åˆ†é…ï¼šæ¢ç´¢ä¿ç•™ ${toExploration}, ç¨®æ¤+${toFarming}, å›æ”¶+${toRecycling}, ç§‘ç ”+${toResearch}`, 'uncommon');
        gameState.explorationMilestone += 10;
      }
    }
  
    /***** å…µç‡Ÿç”¢ç”Ÿåƒµå°¸ *****/
    function produceZombies() {
      const production = gameState.buildings.reduce((sum, b) => {
        if (b && b.type === 'barracks') {
           const info = BUILDINGS.barracks.getUpgradeInfo(b.level);
		  // å¦‚æœ info å­˜åœ¨ï¼Œä½¿ç”¨å…¶ effect.productionï¼›å¦å‰‡è¦–ç‚º 0
		  const prod = info && info.effect && info.effect.production ? info.effect.production : 0;
		  return sum + prod;
		}
		return sum;
	  }, 0);
	  const newZombies = Math.floor(production);
      if (newZombies > 0) {
        let gained = newZombies;
        let toExploration = Math.round(gained * 0.7);
        let toFarming = Math.round(gained * 0.1);
        let toRecycling = Math.round(gained * 0.1);
        let toResearch = Math.round(gained * 0.1);
        let sum = toExploration + toFarming + toRecycling + toResearch;
        if(sum < gained) {
          toExploration += (gained - sum);
        } else if(sum > gained) {
          toExploration -= (sum - gained);
        }
        gameState.totalZombies += gained;
        gameState.allocations.exploration += toExploration;
        gameState.allocations.farming += toFarming;
        gameState.allocations.recycling += toRecycling;
        gameState.allocations.research += toResearch;
        addEventLog(`å…µç‡Ÿç”Ÿç”¢ï¼šæ–°å¢ ${gained} åƒµå°¸ï¼Œæ¢ç´¢ä¿ç•™ ${toExploration}, ç¨®æ¤+${toFarming}, å›æ”¶+${toRecycling}, ç§‘ç ”+${toResearch}`, 'uncommon');
      }
      updateResourceDisplays();
    }
  
    /***** æ¢ç´¢äº‹ä»¶è™•ç† *****/
	function generateExplorationResult(teamSize) {
	  const location = LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)];
	  const resourceTypes = ['food', 'materials', 'weapons', 'tech'];
	  const resource = resourceTypes[Math.floor(Math.random() * resourceTypes.length)];
	  const rarity = weightedRandomRarity();
	  const baseAmount = Math.floor(Math.random() * 5) + 5;
	  const multiplier = Math.pow(1.05, teamSize);
	  const computed = applyRarityMultiplier(baseAmount, rarity) * multiplier;
	  const amount = convertProduction(computed);
	  const itemName = getRandomItemName(resource);
	  const modifier = getRandomModifier(resource);
	  const zombieChange = generateZombieChange(teamSize);

	  return {
		resource,
		amount,
		rarity,
		zombieChange,
		// å°‡ç²å¾—ç‰©å“åç¨±æ•´åˆå¾Œå­˜å…¥ item å±¬æ€§
		item: `${modifier.name} ${itemName}`,
		log: {
		  text: `æ¢ç´¢ ${location} ç²å¾— ${rarity} ${modifier.name} ${itemName} +${amount} ${resource}`,
		  zombieText: zombieChange > 0 
			? `âš¡ ç²å¾— ${zombieChange} åƒµå°¸` 
			: zombieChange < 0 
			  ? `â˜ ï¸ æå¤± ${Math.abs(zombieChange)} åƒµå°¸` 
			  : null,
		  rarity
		}
	  };
	}

    function handleExploration() {
       // ...å…¶ä»–è™•ç†é‚è¼¯
	  const teamSize = gameState.allocations.exploration;
	  if (teamSize < 1) return;
	  const result = generateExplorationResult(teamSize);
	  // é€²è¡Œè³‡æºåŠ æ¸›ç­‰ç­‰
	  gameState.resources[result.resource] += result.amount;
	  addEventLog(result.log.text, result.rarity, "exploration");
	  
	  // æ›´æ–°æ”¶è—è¨˜éŒ„
	  if (result.item) {
		if (collectedItems[result.item]) {
		  collectedItems[result.item].count += 1;
		} else {
		  collectedItems[result.item] = { count: 1, rarity: result.rarity };
		}
	  }
	  
	  // è™•ç†åƒµå°¸è®ŠåŒ–æè¿°ï¼ˆå¢åŠ æˆ–æ¸›å°‘ï¼‰
	  if (result.zombieChange !== 0) {
		let desc = "";
		if (result.zombieChange > 0) {
		  desc = generateZombieEventDescription("increase", result.zombieChange);
		  // å¢åŠ åƒµå°¸é‚è¼¯
		  gameState.totalZombies += result.zombieChange;
		  gameState.allocations.exploration += result.zombieChange; // ä¾å¯¦éš›é‚è¼¯åˆ†é…
		} else {
		  const loss = Math.abs(result.zombieChange);
		  desc = generateZombieEventDescription("decrease", loss);
		  // æ¸›å°‘åƒµå°¸é‚è¼¯
		  gameState.totalZombies -= loss;
		  gameState.allocations.exploration = Math.max(0, gameState.allocations.exploration - loss);
		}
		// åŠ å…¥æ—¥èªŒé¡¯ç¤ºæ–°çš„æè¿°å…§å®¹
		addEventLog(desc, "uncommon", "zombie");
	  }
	  
	  updateAllDisplays();
	}
  
    /***** è³‡æºç”Ÿç”¢ *****/
    function produceResources(dept, resource, baseRate) {
      const count = gameState.allocations[dept];
      if (count <= 0) return;
      const multiplier = Math.pow(1.0005, count);
      const computed = baseRate * multiplier * gameState.efficiency[resource];
      const amount = convertProduction(computed);
      if (Math.random() < 0.05) {
        const modifier = getRandomModifier(resource);
        const modAmount = convertProduction(amount * modifier.effect);
        logResource(resource, `${modifier.name} ${getRandomItemName(resource)}`, modAmount, "production");
      } else {
        logResource(resource, getRandomItemName(resource), amount, "production");
      }
      gameState.resources[resource] += amount;
	  
	  // æ–°å¢éš¨æ©Ÿäº‹ä»¶ï¼šåƒµå°¸æå¤±ï¼ˆåƒ…å°ç¨®æ¤ã€å›æ”¶ã€ç§‘ç ”éƒ¨é–€ï¼‰
	  if (dept === "farming" || dept === "recycling" || dept === "research") {
	  const baseEventProbability = 0.005; // åŸºç¤äº‹æ•…è§¸ç™¼æ©Ÿç‡
	  // æ ¹æ®éƒ¨é–€åƒµå°¸æ•¸é‡ï¼Œåœ¨åŸºç¤æ¦‚ç‡ä¸ŠåŠ æˆï¼Œå‡è¨­æ¯éš»åƒµå°¸å¢åŠ  0.01 çš„æ¦‚ç‡
	  const deptZombies = gameState.allocations[dept] || 0;
	  let eventProbability = baseEventProbability + (deptZombies * 0.001);
	  // é˜²æ­¢æ©Ÿç‡è¶…é 100%
	  eventProbability = Math.min(eventProbability, 0.8);

	  let lossMultiplier = 1;
	  
	  // å¦‚å®‰å…¨ä¸­å¿ƒå­˜åœ¨ï¼Œå‰‡æŒ‰å…¶æ•ˆæœé™ä½äº‹æ•…è§¸ç™¼æ©Ÿç‡
	  const safety = gameState.buildings.find(b => b && b.type.toLowerCase() === "safetycenter");
	  if (safety) {
		const safetyInfo = BUILDINGS.safetyCenter.getUpgradeInfo(safety.level);
		const reduction = safetyInfo.effect.accidentReduction; // å¦‚é™å¹… 0.05 è¡¨ç¤ºäº‹æ•…æ©Ÿç‡ä¹˜ä»¥ 0.95
		eventProbability *= (1 - reduction);
		lossMultiplier = (1 - reduction);
	  }
	  
	  if (Math.random() < eventProbability) {
		// éš¨æ©Ÿæå¤±æ¯”ä¾‹ä»‹æ–¼ 5% åˆ° 80%
		const lossPercentage = 0.01 + Math.random() * 0.8;
		// æ ¹æ“šè©²éƒ¨é–€åƒµå°¸æ•¸è¨ˆç®—æå¤±é‡ï¼ˆlossMultiplier å¯åœ¨æœªä¾†ç”¨æ–¼é€²ä¸€æ­¥èª¿æ•´æå¤±é‡ï¼‰
		let lost = Math.floor(gameState.allocations[dept] * lossPercentage * lossMultiplier);
		// è‹¥è¨ˆç®—å¾Œçš„æå¤±ç‚º 0ï¼Œä½†éƒ¨é–€ä¸­ä»æœ‰åƒµå°¸ï¼Œæœ€ä½å¯ä»¥è€ƒæ…®æå¤± 1ï¼ˆæˆ–ä¿æŒ 0 è¦–å…·é«”éœ€æ±‚è€Œå®šï¼‰
		if (lost < 1 && gameState.allocations[dept] > 0) {
		  lost = 1;
		}
		gameState.allocations[dept] -= lost;
		gameState.totalZombies -= lost;
		
		let eventMsg = "";
		if (dept === "farming") {
		  eventMsg = `ç™¼ç”Ÿé£Ÿç‰©ä¸­æ¯’ï¼šç¨®æ¤éƒ¨é–€æå¤± ${lost} åƒµå°¸ (${(lossPercentage * 100).toFixed(1)}%)`;
		} else if (dept === "recycling") {
		  eventMsg = `ç™¼ç”Ÿæ„å¤–äº‹æ•…ï¼šå›æ”¶éƒ¨é–€æå¤± ${lost} åƒµå°¸ (${(lossPercentage * 100).toFixed(1)}%)`;
		} else if (dept === "research") {
		  eventMsg = `ç™¼ç”Ÿçˆ†ç‚¸äº‹æ•…ï¼šç§‘ç ”éƒ¨é–€æå¤± ${lost} åƒµå°¸ (${(lossPercentage * 100).toFixed(1)}%)`;
		}
		addEventLog(eventMsg, "warning", "production", true);
	  }
	}	  
      updateResourceDisplays();
    }
	function updateSafetyCenterConsumption() {
	  // æª¢æŸ¥å®‰å…¨ä¸­å¿ƒæ˜¯å¦å­˜åœ¨
	  const safety = gameState.buildings.find(b => b && b.type.toLowerCase() === "safetycenter");
	  if (!safety) return;
	  
	  const safetyInfo = BUILDINGS.safetyCenter.getUpgradeInfo(safety.level);
	  const consumptionRate = safetyInfo.effect.resourceConsumptionRate; // æ¯ç§’æ¶ˆè€—ç™¾åˆ†æ¯”ï¼Œå¦‚åŸºç¤ 0.05ï¼Œæœ€é«˜ 0.4
	  
	  // æ ¹æ“šåƒµå°¸ç¸½æ•¸ï¼Œå°å››ç¨®è³‡æºè¨ˆç®—æ¶ˆè€—é‡
	  const resourceList = ["food", "materials", "weapons", "tech"];
	  resourceList.forEach(res => {
		// æ¶ˆè€—é‡ = consumptionRate * totalZombies
		const toConsume = consumptionRate * gameState.totalZombies;
		gameState.resources[res] = Math.max(0, gameState.resources[res] - toConsume);
	  });
	  
	  updateResourceDisplays();
	}
	function updateBarracksWeaponConsumption() {
	  // ç¯©é¸å‡ºæ‰€æœ‰â€œbarracksâ€å»ºç¯‰
	  const barracksBuildings = gameState.buildings.filter(b => b && b.type.toLowerCase() === "barracks");
	  if (barracksBuildings.length === 0) return;
	  
	  let totalConsumption = 0;
	  
	  // å°æ¯æ£Ÿåƒµå°¸å…µç‡Ÿä¾æ“šå…¶ç­‰ç´šè¨ˆç®—æ¶ˆè€—ç‡ï¼ˆå– getUpgradeInfo è¨ˆç®—çš„æ¶ˆè€—ç‡ï¼‰
	  barracksBuildings.forEach(b => {
		// è‹¥åƒµå°¸å…µç‡Ÿçš„å‡ç´šè³‡è¨Šå¯æ±‚å¾—ï¼Œå‰‡è®€å–è©²æ£Ÿå»ºç¯‰çš„æ­¦å™¨è³‡æºæ¶ˆè€—ç‡
		const upgradeInfo = (typeof BUILDINGS[b.type].getUpgradeInfo === "function") 
							 ? BUILDINGS[b.type].getUpgradeInfo(b.level)
							 : null;
		if (upgradeInfo && upgradeInfo.effect.weaponConsumptionRate) {
		  totalConsumption += upgradeInfo.effect.weaponConsumptionRate;
		}
	  });
	  
	  // ä»¥ç¸½åƒµå°¸æ•¸ç‚ºåŸºç¤ï¼Œè¨ˆç®—ç´¯è¨ˆçš„æ­¦å™¨è³‡æºæ¶ˆè€—é‡
	  // ä¾‹å¦‚ï¼šç¸½æ¶ˆè€— = totalConsumption * gameState.totalZombies
	  const consumption = totalConsumption * gameState.totalZombies;
	  
	  // å¾ç©å®¶çš„æ­¦å™¨è³‡æºä¸­æ‰£é™¤
	  gameState.resources.weapons = Math.max(0, gameState.resources.weapons - consumption);
	  
	  // æ›´æ–°è³‡æºé¡¯ç¤º
	  updateResourceDisplays();
	}


    function checkResourceCap() {
	// æª¢æŸ¥æ‰€æœ‰è³‡æºæ˜¯å¦å‡é”åˆ° RESOURCE_CAP
	  if (
		gameState.resources.food >= RESOURCE_CAP &&
		gameState.resources.materials >= RESOURCE_CAP &&
		gameState.resources.weapons >= RESOURCE_CAP &&
		gameState.resources.tech >= RESOURCE_CAP
	  ) {
		// é‡ç½®æ‰€æœ‰è³‡æºç‚º RESET_VALUE
		gameState.resources.food = RESET_VALUE;
		gameState.resources.materials = RESET_VALUE;
		gameState.resources.weapons = RESET_VALUE;
		gameState.resources.tech = RESET_VALUE;
		
		// ç´¯åŠ æ¯ä¸€é …è³‡æºçš„é‡ç½®æ¬¡æ•¸
		gameState.resetCounts.food++;
		gameState.resetCounts.materials++;
		gameState.resetCounts.weapons++;
		gameState.resetCounts.tech++;

		// æ›´æ–°è³‡æºå¡çš„é‚Šæ¡†æ¨£å¼
		updateResourceCardsBorder();
	  }
	}

    /***** é£Ÿç‰©æ¶ˆè€—èˆ‡åƒµå°¸æå¤± *****/
    function updateFoodConsumption() {
      let foodNeeded = Math.floor(gameState.totalZombies * 0.6);
      if (foodNeeded > 0 && gameState.resources.food >= foodNeeded) {
        gameState.resources.food -= foodNeeded;
        addEventLog(`æ¶ˆè€—é£Ÿç‰©ï¼š${foodNeeded}`, 'common');
      } else if (gameState.resources.food <= 0) {
        let removeNum = Math.ceil(gameState.totalZombies * 0.2);
        if (removeNum < 1) removeNum = 1;
        let priorities = ['exploration', 'research', 'recycling', 'farming'];
        for (let dept of priorities) {
          let available = gameState.allocations[dept] || 0;
          if (available >= removeNum) {
            gameState.allocations[dept] -= removeNum;
            gameState.totalZombies -= removeNum;
            addEventLog(`é£Ÿç‰©è€—ç›¡ï¼Œ${dept}å¤±å» ${removeNum} åƒµå°¸`, 'epic');
            removeNum = 0;
            break;
          } else {
            gameState.totalZombies -= available;
            addEventLog(`é£Ÿç‰©è€—ç›¡ï¼Œ${dept}å¤±å» ${available} åƒµå°¸`, 'epic');
            removeNum -= available;
            gameState.allocations[dept] = 0;
          }
        }
        if (gameState.totalZombies <= 0) {
          addEventLog("æ‰€æœ‰åƒµå°¸å‡å·²æ­»äº¡ï¼ŒéŠæˆ²çµæŸï¼", "epic");
          clearInterval(gameLoopInterval);
        }
      }
      updateResourceDisplays();
    }
  
    /***** æ›´æ–°é¡¯ç¤º *****/
    function updateResourceDisplays() {
      document.getElementById("foodCount").textContent = formatNumber(gameState.resources.food);
      document.getElementById("materialsCount").textContent = formatNumber(gameState.resources.materials);
      document.getElementById("weaponsCount").textContent = formatNumber(gameState.resources.weapons);
      document.getElementById("techCount").textContent = formatNumber(gameState.resources.tech);
      document.getElementById("totalZombies").textContent = formatNumber(gameState.totalZombies);
      const totalAllocated = gameState.allocations.exploration +
                             gameState.allocations.farming +
                             gameState.allocations.recycling +
                             gameState.allocations.research;
      document.getElementById("pendingZombies").textContent = formatNumber(gameState.totalZombies - totalAllocated);
    
	// æª¢æŸ¥ä¸¦ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰é‡ç½®è³‡æº
	checkResourceCap();
	}
  
    function updateEfficiencyDisplays() {
      document.getElementById("exploreEfficiency").textContent = "æ•ˆç‡: " + Math.floor(gameState.efficiency.exploration * 100) + "%";
      document.getElementById("farmEfficiency").textContent = "+" + Math.floor((gameState.efficiency.food - 1) * 100) + "%";
      document.getElementById("recycleEfficiency").textContent = "+" + Math.floor((gameState.efficiency.materials - 1) * 100) + "%";
      document.getElementById("researchEfficiency").textContent = "+" + Math.floor((gameState.efficiency.tech - 1) * 100) + "%";
    }
  
    function updateAllDisplays() {
      updateResourceDisplays();
      document.getElementById("explorationCount").textContent = gameState.allocations.exploration;
      document.getElementById("farmingCount").textContent = gameState.allocations.farming;
      document.getElementById("recyclingCount").textContent = gameState.allocations.recycling;
      document.getElementById("researchCount").textContent = gameState.allocations.research;
      updateEfficiencyDisplays();
      initBuildingGrid();
      checkExplorationMilestone();
    }
  
    /***** å»ºç¯‰ç®¡ç†ç³»çµ± *****/
    function initBuildingGrid() {
      const grid = document.getElementById('buildingGrid');
      grid.innerHTML = '';
      gameState.buildings.forEach((building, index) => {
        const tile = document.createElement('div');
        tile.className = `tile ${building?.upgradable ? 'upgradable' : ''}`;
        tile.setAttribute('data-index', index);
        tile.onclick = () => {
          console.log("Tile clicked, index:", index);
          handleBuildingClick(index);
        };
        if (building) {
          const config = BUILDINGS[building.type];
          tile.innerHTML = `
            <div class="building-icon">${getBuildingIcon(building.type)}</div>
            <div class="building-info">
              <div>${config.name}</div>
              <div class="building-level">Lv.${building.level}</div>
            </div>
            ${building.upgradable ? '<div class="upgrade-indicator">â†‘</div>' : ''}
          `;
        } else {
          tile.innerHTML = `
            <div class="empty-plot">ğŸŸ¦</div>
            <div class="plot-label">ç©ºåœ°</div>
          `;
        }
        grid.appendChild(tile);
      });
    }
  
    function handleBuildingClick(index) {
	  const building = gameState.buildings[index];
	  if (!building) {
		return showBuildMenu(index);
	  }
	  // ç›´æ¥ä½¿ç”¨å‡ç´šå½ˆçª—é¡¯ç¤ºè³‡è¨Šå’Œæ“ä½œï¼ˆæ‹†é™¤æŒ‰éˆ•ä¹Ÿæ•´åˆé€²ä¾†ï¼‰
	  showUpgradeMenu(index);
	}

  
	function showBuildMenu(index) {
	  // éæ¿¾å…·æœ‰ baseCost çš„å»ºç¯‰ï¼Œæ’é™¤ä¸­å¿ƒåŸºåœ°ï¼ˆcenterï¼‰
	  const available = Object.entries(BUILDINGS)
		.filter(([key, cfg]) => cfg.baseCost && key.toLowerCase() !== "center");

	  const modalContent = available.map(([key, cfg]) => {
		// å–å¾—1ç´šåŠ æˆä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
		let bonusInfo = "";
		if (typeof cfg.getUpgradeInfo === "function") {
		  const info = cfg.getUpgradeInfo(1);
		  if (info && info.effect) {
			bonusInfo = Object.entries(info.effect)
			  .map(([attr, value]) => `${attr}: +${value}`)
			  .join("<br>");
		  }
		}
		return `
		  <div class="build-box" onclick="startBuilding('${key}', ${index})">
			<div class="build-top-container">
			  <div class="build-row">
				<!-- å·¦å´ 50%ï¼šå»ºç¯‰åœ–ç¤ºèˆ‡åç¨± -->
				<div class="build-left">
				  <span class="build-icon">${getBuildingIcon(key)}</span>
				  <span class="build-name" style="margin-left:5px; font-weight:bold;">${cfg.name}</span>
				</div>
				<!-- å³å´ 50%ï¼š1ç´šåŠ æˆæè¿° -->
				<div class="build-right">
				  ${bonusInfo}
				</div>
			  </div>
			</div>
			<!-- ä¸‹æ–¹é¡¯ç¤ºå»ºé€ æ‰€éœ€ç‰©è³‡ -->
			<div class="build-resources">
			  ${Object.entries(cfg.baseCost)
				.map(([res, val]) => `<span class="cost-item" style="margin-right: 8px;">${res}: ${val}</span>`)
				.join(' ')}
			</div>
		  </div>
		`;
	  }).join('');
		
	  document.getElementById('buildOptions').innerHTML = modalContent;
	  showModal("buildModal");
	}





	function startBuilding(type, index) {
	  const config = BUILDINGS[type];
	  // ä½¿ç”¨ baseCost ä¾†åˆ¤å®šåˆå§‹å»ºé€ æˆæœ¬
	  if (!canAfford(config.baseCost)) {
		addEventLog(`âŒ è³‡æºä¸è¶³ï¼Œç„¡æ³•å»ºé€  ${config.name}`, 'epic');
		return;
	  }
	  payCost(config.baseCost);
	  gameState.buildings[index] = {
		type,
		level: 1,
		upgradable: checkUpgradable(type, 1)
	  };
	  updateEfficiencies();
	  addEventLog(`ğŸ—ï¸ æˆåŠŸå»ºé€  ${config.name}`, 'uncommon');
	  closeModal('buildModal');
	  updateAllDisplays();
	  
	  // é€éå½ˆçª—æç¤ºå»ºé€ æˆåŠŸ
	  showResultModal(`æˆåŠŸå»ºé€  ${config.name}`);
	}

  
    function updateEfficiencies() {
	  // é‡ç½®æ‰€æœ‰æ•ˆç‡
	  Object.keys(gameState.efficiency).forEach(k => gameState.efficiency[k] = 1);

	  // ç²å–ä¸­å¿ƒåŸºåœ°ç­‰ç´šï¼ˆè‹¥ä¸å­˜åœ¨å‰‡ç‚º1ï¼‰
	  const centerBuilding = gameState.buildings.find(b => b?.type === "center");
	  const centerLevel = centerBuilding ? centerBuilding.level : 1;

	  // åˆå§‹åŒ–åŠ æˆè®Šæ•¸
	  let explorationBoost = 0;
	  let researchBoost = 0;
	  let zombieEfficiency = 0;
	  let productionBonus = 0;

	  gameState.buildings.forEach(b => {
		if (!b) return; // è·³éç©ºåœ°

		const upgradeInfo = (typeof BUILDINGS[b.type].getUpgradeInfo === "function")
                      ? BUILDINGS[b.type].getUpgradeInfo(b.level)
                      : null;
		const effects = upgradeInfo?.effect || {};


		// ç¢ºä¿ä¸€èˆ¬æ•ˆç‡è¢«æ›´æ–°
		Object.entries(effects).forEach(([key, value]) => {
		  gameState.efficiency[key] = (gameState.efficiency[key] || 1) + value;
		});

		// è‹¥æ˜¯ä¸­å¿ƒåŸºåœ°ï¼Œç´¯ç©ç‰¹æ®ŠåŠ æˆ
		if (b.type === "center") {
		  explorationBoost += effects.explorationBoost || 0;
		  researchBoost += effects.researchBoost || 0;
		  zombieEfficiency += effects.zombieEfficiency || 0;
		  productionBonus += effects.productionBonus || 0;
		}
	  });

	  // æ‡‰ç”¨ä¸­å¿ƒåŸºåœ°åŠ æˆ
	  gameState.explorationEfficiency = 1 + explorationBoost;
	  gameState.researchEfficiency = 1 + researchBoost;
	  gameState.zombieEfficiency = 1 + zombieEfficiency;
	  gameState.productionEfficiency = 1 + productionBonus;

	  // é™åˆ¶å…¶ä»–å»ºç¯‰çš„æœ€é«˜ç­‰ç´š
	  gameState.buildings.forEach(b => {
		if (b && b.type !== "center" && b.level > centerLevel) {
		  b.level = centerLevel; // é™åˆ¶æœ€å¤§ç­‰ç´š
		}
	  });
	}

  
    function getBuildingIcon(type) {
	  const icons = {
		center: "ğŸ°",
		barracks: "ğŸ«",
		greenhouse: "ğŸŒ¿",
		armory: "ğŸ”§",
		laboratory: "ğŸ”¬",
		resourceamplifier: "ğŸ“ˆ",       // æ›¿æ›ç‚ºæ›´å¸¸è¦‹çš„ç¬¦è™Ÿ
		zombiecommandcenter: "ğŸ§Ÿ",
		rarevault: "ğŸ’",
		weaponconsumptionfacility: "âš”ï¸", // æ”¹ç‚ºäº¤å‰åŠ
		safetycenter: "ğŸ›¡ï¸",
		recyclingfactory: "â™»ï¸"
	  };
	  return icons[type.toLowerCase()] || "ğŸŸ¦";
	}


	
	// æ›´æ–°æ‰€æœ‰å»ºç¯‰çš„å‡ç´šç‹€æ…‹ï¼Œæ ¹æ“šä¸»åŸºåœ°ç•¶å‰ç­‰ç´šä¾†æ±ºå®š
	function updateBuildingsAfterMainBaseUpgrade() {
	  // æ‰¾å‡ºä¸»åŸºåœ°ä¸¦ç²å–ç•¶å‰ç­‰ç´šï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
	  const centerBuilding = gameState.buildings.find(b => b && b.type.toLowerCase() === "center");
	  const centerLevel = centerBuilding ? centerBuilding.level : 1;

	  // éæ­·æ‰€æœ‰å»ºç¯‰ï¼Œéä¸»åŸºåœ°çš„ upgradable ç‹€æ…‹ç”±è‡ªèº«ç­‰ç´šèˆ‡ä¸»åŸºåœ°ç­‰ç´šæ±ºå®š
	  gameState.buildings.forEach(b => {
		if (b && b.type.toLowerCase() !== "center") {
		  b.upgradable = (b.level < centerLevel);
		}
	  });
	}
	
	function confirmUpgrade() {
	  if (typeof currentUpgradeIndex === "undefined") return;
	  
	  const index = currentUpgradeIndex;
	  const building = gameState.buildings[index];
	  const config = BUILDINGS[building.type];
	  const nextUpgrade = (typeof config.getUpgradeInfo === "function")
							? config.getUpgradeInfo(building.level + 1)
							: null;
							
	  if (!nextUpgrade || !nextUpgrade.cost) {
		// ç„¡æ³•å‡ç´šï¼ˆå¯èƒ½å·²é”é ‚ç´šï¼‰
		showTempMessage("å‡ç´šå¤±æ•—");
		return;
	  }
	  
	  if (!canAfford(nextUpgrade.cost)) {
		showTempMessage("å‡ç´šå¤±æ•—");
		return;
	  }
	  
	  payCost(nextUpgrade.cost);
	  building.level++;
	  building.upgradable = checkUpgradable(building.type, building.level);
	  if (building.type.toLowerCase() === "center") {
		updateBuildingsAfterMainBaseUpgrade();
	  }
	  updateEfficiencies();
	  updateAllDisplays();
	  
	  showTempMessage("å‡ç´šæˆåŠŸ");
	  // æ³¨æ„ï¼šæ­¤è™•ä¸è‡ªå‹•é—œé–‰å‡ç´šå½ˆçª—ï¼Œä¾¿æ–¼é€£çºŒå‡ç´š
	}





	// æ–°å¢ï¼šçµæœæç¤ºå½ˆçª—å‡½æ•¸
	function showResultModal(message) {
	  document.getElementById("resultMessage").textContent = message;
	  showModal("resultModal");
	}

	function closeResultModal() {
	  closeModal("resultModal");
	}

	// åŸæœ‰çš„å‡ç´šèœå–®å‡½æ•¸ï¼ˆä¿®æ”¹å¾Œä½¿ç”¨å‹•æ…‹å‡ç´šè³‡è¨Šï¼‰
	function showUpgradeMenu(index) {
	  currentUpgradeIndex = index;
	  const building = gameState.buildings[index];
	  if (!building) return;
	  const config = BUILDINGS[building.type];
	  
	  // å–å¾—ç•¶å‰åŠ æˆä¿¡æ¯ï¼ˆä½¿ç”¨ç•¶å‰ç­‰ç´šï¼‰
	  let currentInfo = "";
	  if (typeof config.getUpgradeInfo === "function") {
		const currentUpgrade = config.getUpgradeInfo(building.level);
		if (currentUpgrade && currentUpgrade.effect) {
		  currentInfo = Object.entries(currentUpgrade.effect)
						 .map(([attr, value]) => `${attr}: +${value}`)
						 .join(", ");
		}
	  }
	  
	  // å–å¾—ä¸‹ä¸€ç´šå‡ç´šä¿¡æ¯ï¼ˆç„¡è«–æ˜¯å¦æ»¿è¶³éƒ½é¡¯ç¤ºï¼‰
	  let nextInfo = "";
	  const nextUpgrade = (typeof config.getUpgradeInfo === "function")
							? config.getUpgradeInfo(building.level + 1)
							: null;
	  if (nextUpgrade && nextUpgrade.cost) {
		nextInfo = " ";
		for (let [res, val] of Object.entries(nextUpgrade.cost)) {
		  nextInfo += ` ${res}: ${val}`;
		}
		// åˆ¤æ–·è³‡æºæ˜¯å¦æ»¿è¶³ï¼Œå¦‚æœä¸æ»¿è¶³å‰‡æ·»åŠ æç¤º
		if (!canAfford(nextUpgrade.cost)) {
		  nextInfo += " (æœªæ»¿è¶³)";
		}
	  } else {
		nextInfo = "å·²é”æœ€é«˜ç´š";
	  }
	  
	  // çµ„åˆä¸ŠåŠéƒ¨åˆ†å…§å®¹
	  const upperContent = `ç•¶å‰åŠ æˆ: ${currentInfo}\nå‡ç´šæ‰€éœ€: ${nextInfo}`;
	  
	  document.getElementById("upgradeTitle").textContent = config.name;
	  document.getElementById("upgradeInfo").textContent = upperContent;
	  
	  // æŒ‰éˆ•éƒ¨åˆ†ï¼šç¢ºèªå‡ç´šæŒ‰éˆ•å§‹çµ‚é¡¯ç¤ºï¼›æ‹†é™¤æŒ‰éˆ•å°ä¸­å¿ƒåŸºåœ°éš±è—
	  document.getElementById("confirmUpgradeBtn").style.display = "inline-block";
	  if (building.type.toLowerCase() === "center") {
		document.getElementById("demolishBtn").style.display = "none";
	  } else {
		document.getElementById("demolishBtn").style.display = "inline-block";
	  }
	  
	  showModal("upgradeModal");
	}


	function closeUpgradeModal() {
	  closeModal("upgradeModal");
	}

		function startBuilding(type, index) {
	  const config = BUILDINGS[type];
	  if (!canAfford(config.baseCost)) {
		addEventLog(`âŒ è³‡æºä¸è¶³ï¼Œç„¡æ³•å»ºé€  ${config.name}`, 'epic');
		showResultModal(`å»ºé€ å¤±æ•—ï¼šè³‡æºä¸è¶³ä»¥å»ºé€  ${config.name}`);
		return;
	  }
	  payCost(config.baseCost);
	  gameState.buildings[index] = {
		type,
		level: 1,
		upgradable: checkUpgradable(type, 1)
	  };
	  updateEfficiencies();
	  addEventLog(`ğŸ—ï¸ æˆåŠŸå»ºé€  ${config.name}`, 'uncommon');
	  closeModal("buildModal");
	  updateAllDisplays();
	  // ä»¥è‡¨æ™‚æç¤ºæ–¹å¼å‘ŠçŸ¥å»ºé€ æˆåŠŸï¼ˆ0.3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±ï¼Œä¸éœ€ç¢ºèªæŒ‰éµï¼‰
	  showTempMessage(`æˆåŠŸå»ºé€  ${config.name}`);
	}

	// å»ºç¯‰äº’å‹•ï¼ˆåŒ…æ‹¬æ‹†é™¤ã€æŸ¥çœ‹è³‡è¨Šç­‰ï¼‰èˆ‡æ‹†é™¤å»ºç¯‰çš„é‚è¼¯

	function showBuildingInteractionMenu(index) {
	  const building = gameState.buildings[index];
	  if (!building) return;
	  const config = BUILDINGS[building.type];

	  // ç”Ÿæˆé¡¯ç¤ºåŸºæœ¬è³‡è¨Šçš„å­—ä¸²
	  const infoStr = `<div class="building-info-popup">
							<p><strong>${config.name}</strong></p>
							<p>ç›®å‰ç­‰ç´šï¼šLv.${building.level}</p>
						</div>`;

	  // å¦‚æœå»ºç¯‰å¯å‡ç´šï¼Œå‰‡æ·»åŠ å‡ç´šæŒ‰éˆ•
	  let buttonContent = "";
	  if (building.upgradable) {
		buttonContent += `<button class="modal-btn" onclick="showUpgradeMenu(${index})">å‡ç´šå»ºç¯‰</button>`;
	  }
	  // åƒ…ç•¶è©²å»ºç¯‰ä¸æ˜¯ä¸­å¿ƒåŸºåœ°æ™‚æ‰é¡¯ç¤ºæ‹†é™¤æŒ‰éˆ•
	  if (building.type.toLowerCase() !== "center") {
		buttonContent += `<button class="modal-btn danger" onclick="confirmBuildingRemoval(${index})">æ‹†é™¤å»ºç¯‰</button>`;
	  }

	  // æ‹¼æ¥æœ€çµ‚çš„äº’å‹•å…§å®¹
	  const interactionContent = infoStr + buttonContent;

	  document.getElementById("interactionContent").innerHTML = interactionContent;
	  document.getElementById("interactionTitle").textContent = config.name;
	  showModal("interactionModal");
	}


	function confirmBuildingRemoval(index) {
	  const building = gameState.buildings[index];
	  if (!building) return;
	  let confirmRemoval = confirm(`ç¢ºå®šè¦æ‹†é™¤ ${BUILDINGS[building.type].name}ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`);
	  if (!confirmRemoval) return;
	  
	  gameState.buildings[index] = null;
	  addEventLog(`ğŸ—ï¸ ${BUILDINGS[building.type].name} å·²è¢«æ‹†é™¤`, "warning");
	  updateAllDisplays();
	  closeModal("interactionModal");
	  showResultModal(`å·²æ‹†é™¤ ${BUILDINGS[building.type].name}`);
	}

	function showBuildingInfo(index) {
	  const building = gameState.buildings[index];
	  if (building) {
		const config = BUILDINGS[building.type];
		addEventLog(`${config.name} ç­‰ç´š ${building.level}`, "common");
		showResultModal(`${config.name} çš„ç›®å‰ç­‰ç´šï¼š${building.level}`);
	  }
	}


  
    function toggleResource(resource) {
      const detailsElem = document.getElementById(resource + "Details");
      if (detailsElem.style.maxHeight && detailsElem.style.maxHeight !== "0px") {
        detailsElem.style.maxHeight = "0";
      } else {
        detailsElem.style.maxHeight = "100px";
      }
    }
  
    function adjustZombies(dept, amount) {
      if (!gameState.allocations[dept]) gameState.allocations[dept] = 0;
      let newVal = gameState.allocations[dept] + amount;
      if (newVal < 0) newVal = 0;
      const totalAllocated = gameState.allocations.exploration +
                             gameState.allocations.farming +
                             gameState.allocations.recycling +
                             gameState.allocations.research;
      if (totalAllocated + amount > gameState.totalZombies) {
        addEventLog("æ²’æœ‰è¶³å¤ çš„åƒµå°¸åˆ†é…", "warning");
        return;
      }
      gameState.allocations[dept] = newVal;
      updateAllDisplays();
    }
  
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.style.display = "flex";
    }
  
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.style.display = "none";
    }
  
    function closeBuildModal() {
      closeModal("buildModal");
    }
    /***** è¼”åŠ©å‡½æ•¸ çµæŸ *****/
  
    // éŠæˆ²åˆå§‹åŒ–èˆ‡æ ¸å¿ƒå¾ªç’°
    function initGame() {
      updateAllDisplays();
      initBuildingGrid();
      startGameLoops();
    }
  
    function startGameLoops() {
      gameLoopInterval = setInterval(() => {
        produceResources('farming', 'food', 1.5*5);
        produceResources('recycling', 'materials', 0.5*5);
        produceResources('research', 'tech', 0.2*5);
        produceZombies();
        updateFoodConsumption();
      }, 5000);
      setInterval(() => {
        if (gameState.allocations.exploration > 0) {
          handleExploration();
        }
      }, 5000);
	  setInterval(updateSafetyCenterConsumption, 5000);
	  // æ¯ç§’æ›´æ–°åƒµå°¸å…µç‡Ÿçš„æ­¦å™¨æ¶ˆè€—
	  setInterval(updateBarracksWeaponConsumption, 5000);

    }
	
	
    function loadSave() {
      // å¦‚æœ‰éœ€è¦ï¼Œå¯åœ¨æ­¤è®€å–å­˜æª”ï¼Œæœ¬ä¾‹ä¸­ç›´æ¥è¨­å®šåˆå§‹éƒ¨é–€åˆ†é…
      gameState.allocations.exploration = 4;
      gameState.allocations.farming = 4;
      gameState.allocations.recycling = 1;
      gameState.allocations.research = 1;
    }
  
    function autoSave() {
      console.log("éŠæˆ²å·²è‡ªå‹•å­˜æª”");
    }
  
	 
	function showCollection() {
	  // å®šç¾©ä¾ç¨€æœ‰åº¦æ’åºçš„é †åº
	  const rarityOrder = { 
		  divine: 12,      // ç¥è–çš„
		  legendary: 11,   // å‚³å¥‡çš„
		  epic: 10,        // å²è©©çš„
		  rare: 9,         // ç¨€æœ‰çš„
		  tested: 8,       // æ­·ç¶“è€ƒé©—çš„
		  selected: 7,     // ç²¾æŒ‘ç´°é¸çš„
		  sealed: 6,       // æœªé–‹å°çš„
		  decent: 5,       // çœ‹èµ·ä¾†ä¸éŒ¯çš„
		  common: 4,       // æ­£å¸¸çš„
		  damaged: 3,      // ç ´æçš„
		  old: 2,          // é™³èˆŠçš„
		  junk: 1     
	  };
	  // å°‡ collectedItems è½‰æ›æˆé™£åˆ—ï¼Œæ¯å€‹é …ç›®åŒ…å«ï¼šåç¨±ã€ç²å¾—æ¬¡æ•¸èˆ‡ç¨€æœ‰åº¦
	  let items = Object.keys(collectedItems).map(key => ({
		  name: key,
		  count: collectedItems[key].count,
		  rarity: collectedItems[key].rarity
	  }));
	  // æŒ‰ç…§ç¨€æœ‰åº¦ç”±é«˜åˆ°ä½æ’åº
	  items.sort((a, b) => (rarityOrder[b.rarity] || 0) - (rarityOrder[a.rarity] || 0));

	  // çµ„åˆ HTMLï¼šåªé¡¯ç¤ºç‰©å“åç¨±å’Œç²å¾—æ¬¡æ•¸
	  let html = `<table style="width:100%; border-collapse:collapse;"> 
		<thead>
		  <tr>
			<th style="border:1px solid var(--border-color); padding:5px;">ç‰©å“åç¨±</th>
			<th style="border:1px solid var(--border-color); padding:5px;">ç²å¾—æ¬¡æ•¸</th>
		  </tr>
		</thead>
		<tbody>`;
	  items.forEach(item => {
		  html += `<tr class="${item.rarity}">
			<td style="border:1px solid var(--border-color); padding:5px;">${item.name}</td>
			<td style="border:1px solid var(--border-color); padding:5px;">${item.count}</td>
		  </tr>`;
	  });
	  html += `</tbody></table>`;

	  // å°‡ç”Ÿæˆçš„ HTML å¡«å…¥å½ˆçª—å…§å®¹å®¹å™¨ä¸­
	  document.getElementById("collectionContent").innerHTML = html;
	  updateCollectionCompletion();
	  // å°‡æ”¶è—å½ˆçª—æ‰“é–‹
	  showModal('favoritesModal');
	}

	
	// ç•¶æ–‡ä»¶å…§å®¹å®Œå…¨åŠ è¼‰å¾Œå•Ÿå‹•éŠæˆ²
	document.addEventListener("DOMContentLoaded", function() {
		initGame();
		// å‡è¨­æ‚¨çš„æ”¶è—æŒ‰éˆ• ID ç‚º favoritesBtn
	     const favBtn = document.getElementById("favoritesBtn");
		  if (favBtn) {
			favBtn.addEventListener("click", showCollection);
		  }
		// è¨˜éŒ„è¨ˆæ™‚é–‹å§‹çš„æ™‚é–“
		let startTime = Date.now();

		// æ›´æ–°è¨ˆæ™‚å™¨é¡¯ç¤º
		function updateTimer() {
		  const now = Date.now();
		  const elapsed = now - startTime; // æ¯«ç§’æ•¸
		  const seconds = Math.floor((elapsed / 1000) % 60);
		  const minutes = Math.floor((elapsed / 60000) % 60);
		  const hours = Math.floor(elapsed / 3600000);

		  // è£œé½Šå…©ä½æ•¸æ ¼å¼
		  const formattedTime = 
			String(hours).padStart(2, '0') + ":" +
			String(minutes).padStart(2, '0') + ":" +
			String(seconds).padStart(2, '0');
		  
		  // æ›´æ–° DOM ä¸­è¨ˆæ™‚å™¨é¡¯ç¤º
		  const timerElem = document.getElementById('timerValue');
		  if (timerElem) {
			timerElem.textContent = formattedTime;
		  }
		}

		// æ¯ç§’æ›´æ–°ä¸€æ¬¡
		setInterval(updateTimer, 1000);
		
		
		// ç‚ºæ‰€æœ‰ modal-overlay æ·»åŠ äº‹ä»¶ç›£è½å™¨
		document.querySelectorAll('.modal-overlay').forEach(overlay => {
		  overlay.addEventListener('click', function(event) {
			// ç²¾ç¡®åˆ¤æ–­ç‚¹å‡»åŒºåŸŸæ˜¯å¦ä¸ºé®ç½©å±‚æœ¬èº«
			if (event.target === overlay) { 
			  closeModal(overlay.id);
			}
		  });
		});
	});
	</script>
</body>
</html>